<!DOCTYPE html> 
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<base target="_top">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<title>PJãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
<!-- Markdown + Mermaid (usage docs) -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
<style>
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯æ®ºã—ã¦ã€æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å„ã‚¨ãƒªã‚¢ã§ */
  html, body { overflow-x: hidden; }

  /* å¿µã®ãŸã‚ï¼šã‚¬ãƒ³ãƒˆã®å¤–å´ã§ã¯åºƒãŒã‚‰ãªã„ã‚ˆã†ã« */
  #gantt-container { overflow: hidden; }

  /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼ˆæ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’æ´»ç”¨ï¼‰ */
  .gantt-right.show-scrollbars,
  .gantt-head.show-scrollbars { max-width: 100%; overflow: auto; }
  /* è‰²ãƒ‰ãƒƒãƒˆï¼ˆä¸€è¦§/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨/ã‚«ãƒ³ãƒãƒ³ã§ä½¿ç”¨ï¼‰ */
  .color-swatch{
    display:inline-block; width:10px; height:10px; border-radius:50%;
    margin-right:6px; vertical-align:middle; box-shadow:0 0 0 1px rgba(0,0,0,.06) inset;
  }

  :root{
    --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --ink:#111827;
    --muted:#6b7280; --accent:#0ea5e9; --pill:#eef2ff; --pill-ink:#3730a3;
    --shadow: 0 1px 2px rgba(0,0,0,.05);

    /* Sticky UI offsets (fallbacks; JS will refine) */
    --header-h: 56px;
    --toolbar-h: 0px;
    --filters-h: 46px;
  }
  select { background-color: #fff; }
  html, body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; margin:0; background:var(--bg); color:var(--ink); }
  header {
      padding: 6px 6px;
      background: #0f172a;
      color: #fff;
      display: flex;
      gap: 12px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 30;
      width: 100%;
  }
  :root{
    /* è¡Œã®åŸºæœ¬é«˜ã•ã¨ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰ */
    --row-h: 44px;
    --cell-py: 6px;
  }

  /* è¡Œé«˜ã‚’æƒãˆã‚‹ */
  #taskTable tbody tr,
  #projTable tbody tr{
    height: var(--row-h);
  }

  /* ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æƒãˆã‚‹ */
  #taskTable td, #taskTable th,
  #projTable td, #projTable th{
    padding-top: var(--cell-py);
    padding-bottom: var(--cell-py);
  }

  /* ãƒ¡ãƒ¢ã‚»ãƒ«ï¼ˆè¡Œé«˜å›ºå®šãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã¯ä¸­ã§å‡¦ç†ï¼‰ */
  td.cell-memo{
    position: relative;
    height: var(--row-h);
  }

  /* memo default editors */
  .memo-edit{
    display:block;
    box-sizing: border-box;
    width:100%;
    /* ã‚»ãƒ«ã®ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å¼•ã„ãŸé«˜ã•ã«å›ºå®š */
    height: calc(var(--row-h) - var(--cell-py)*2 + 8px);
    min-height: 0;         /* â€œä¼¸ã³ã‚‹â€ä½™åœ°ã‚’ãªãã™ */
    max-height: none;
    line-height: 1.35;
    font: inherit;
    padding:1px 6px;
    border:1px solid #d1d5db;
    border-radius:4px;
    resize: none;          /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ä¼¸ã°ã•ã›ãªã„ */
    overflow: auto;        /* æ–‡å­—ãŒå¢—ãˆãŸã‚‰ä¸­ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    background: inherit;
  }


  header h1 { font-size:16px; margin:0; font-weight:700; }
  nav { display:flex; gap:8px; margin-left:auto; }
  nav button { background:#1f2937; border:1px solid #334155; }
  nav button.active { background:#0ea5e9; border-color:#0ea5e9; }
  .container { padding:16px; }
  .page { display:none; }
  .page.active { display:block; }
  .grid { display:grid; grid-template-columns: 360px 1fr; gap:16px; transition: grid-template-columns .2s ease; }
  .grid.collapsed-left { grid-template-columns: 44px 1fr; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow); position:relative; }
  .card h2 { font-size:14px; margin:0; padding:12px 12px 0; color:#111827; display:flex; align-items:center; justify-content:space-between; }
  .card .body { padding:12px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
  label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
  input, select, textarea { width:100%; border:1px solid #d1d5db; border-radius:8px; padding:8px; font-size:14px; background:#fff; }
  textarea { min-height: 120px; }
  button { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#111827; color:#fff; cursor:pointer; }
  button.secondary { background:#fff; color:#111827; }
  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { padding:8px; border-bottom:1px solid #f3f4f6; text-align:left; }
  th { color:#6b7280; font-weight:600; }
  .pill { padding:2px 8px; font-size:12px; border-radius:999px; background:var(--pill); color:var(--pill-ink); }
  .muted { color:var(--muted); }
  .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .list { max-height: 600px; overflow:auto; }
  .tabs {
    display:flex;
    gap:8px;
    border-bottom:1px solid var(--border);
    margin-bottom:8px;
    position: sticky;
    top: calc(var(--header-h) + var(--toolbar-h));
    z-index: 58;
    background: var(--bg);
  }
  .tab { padding:8px 12px; border-radius:10px 10px 0 0; background:#e5e7eb; cursor:pointer; }
  .tab.active { background:var(--card); border:1px solid var(--border); border-bottom:1px solid var(--card); }

  /* ===== Usage docs (Markdown) ===== */
  .md-docs-nav{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 10px 0; }
  .md-docs-nav button{ padding:6px 10px; border-radius: 8px; }
  .md-docs-nav button.active{ background: var(--accent); color: #fff; border-color: transparent; }
  .md-docs{ line-height: 1.75; }
  .md-docs h1, .md-docs h2, .md-docs h3{ margin: 0.8em 0 0.35em; }
  .md-docs pre{ overflow:auto; padding:10px; background: rgba(0,0,0,.04); border-radius: 10px; }
  .md-docs code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .md-docs table{ border-collapse: collapse; width:100%; }
  .md-docs th, .md-docs td{ border:1px solid var(--border); padding:6px 8px; }
  .kanban { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; min-height: 380px; }
  .col { background:#f9fafb; border:1px solid var(--border); border-radius:12px; padding:8px; min-height:320px; }
  .col h3 { font-size:13px; margin:0 0 8px 0; display:flex; justify-content:space-between; align-items:center; }
  .cardlet { background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px; margin:6px 0; box-shadow: var(--shadow); cursor:grab; font-size:12px; line-height:1.35; }
  .dropping { outline:2px dashed var(--accent); outline-offset:-4px; }
  .filters { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; }
  .filters.sticky { position: sticky; top: 56px; z-index: 25; border:1px solid var(--border); border-radius:10px; padding:8px; }
  .help { line-height:1.8; }
  @media (max-width: 1200px) {
    .grid { grid-template-columns: 1fr; }
    .row, .row-3 { grid-template-columns: 1fr; }
    .filters { grid-template-columns: 1fr 1fr; }
    .kanban { grid-template-columns: 1fr; }
  }
  .card--glass{
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(4px);
  }
  /* compact density */
  body { font-size: 14px; }
  .card { padding: 12px; border-radius: 10px; }
  .toolbar { gap: 8px; }
  button, .tab { padding: 6px 10px; border-radius: 8px; }
  input, select, textarea { padding: 6px 8px; }
  .filters > * { margin-right: 6px; }
  .cardlet { padding: 8px; }
  .pill { padding: 2px 6px; font-size: 12px; }

  /* æœŸé™åˆ—ï¼ˆã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼‰ã‚’ä¸­å¤®å¯„ã› */
  #taskTable th:nth-child(1),
  #taskTable td.cell-due { text-align: center; }

  /* gantt visibility guard */
  #view-gantt[style*="display:none"] { pointer-events:none; height:0; overflow:hidden; }



  /* Docsãƒãƒƒã‚¸ */
  .doc-badge{ margin-left:4px; cursor:pointer; opacity:.9; display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:12px; line-height:1.2; white-space:nowrap; }
  .doc-badge:hover{ opacity:1; transform: translateY(-1px); }

  /* ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è©°ã‚ */
  .toolbar .mini{ padding:4px 8px; font-size:12px; border-radius:6px; }
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ */
  #brandmark{
    height:22px; margin-left:8px; object-fit:contain;
    opacity:.85; filter: invert(1) brightness(1.4) grayscale(1);
  }

  /* å·¦ã‚µã‚¤ãƒ‰ï¼ˆã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ï¼‰æŠ˜ã‚ŠãŸãŸã¿ */
  #quick-panel { position: sticky; top: 64px; align-self:start; overflow:hidden; }
  #quick-panel.collapsed { width: 44px; padding: 8px 4px; }
  #quick-panel.collapsed h2 { writing-mode: vertical-rl; transform: rotate(180deg); margin:0; padding: 8px 0; font-size:12px; }
  #quick-panel.collapsed .body { display:none; }
  #qp-toggle { position:absolute; top:8px; right:8px; }

  /* ã‚¬ãƒ³ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆå¾©æ´»ï¼‹è¦‹ã‚„ã™ãï¼‰ */
  .show-scrollbars{ scrollbar-gutter: auto; }
  .show-scrollbars::-webkit-scrollbar{ height:10px; width:10px; }
  .show-scrollbars::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:6px; }
  .show-scrollbars::-webkit-scrollbar-track{ background: #f1f5f9; }

  /* ç›®çš„ç®‡æ‰€ã®é€æ˜åŒ–ï¼ˆé€ã‹ã—ã‚’è¦‹ã›ã‚‹ï¼‰ */
  .see-through{ background: rgba(255,255,255,.7) !important; backdrop-filter: blur(1px); }
  /* â–¼NEW: å„ªå…ˆåº¦ã®ç¶²æ›ã‘ï¼ˆä¸€è¦§ã‚»ãƒ«ï¼‹ãƒãƒƒã‚¸ï¼‰ */
  .cell-prio { text-align:center; }
  .cell-prio.prio-high { background: rgba(239,68,68,.12); }   /* èµ¤: é«˜ */
  .cell-prio.prio-mid  { background: rgba(234,179,8,.16); }   /* é»„: ä¸­ */
  .cell-prio.prio-low  { background: rgba(34,197,94,.12); }   /* ç·‘: ä½ */

  .prio-badge { border:1px solid transparent; }
  .prio-badge.prio-high { background: rgba(239,68,68,.18); color:#991b1b; border-color: rgba(239,68,68,.35); }
  .prio-badge.prio-mid  { background: rgba(234,179,8,.20); color:#854d0e; border-color: rgba(234,179,8,.35); }
  .prio-badge.prio-low  { background: rgba(34,197,94,.18); color:#065f46; border-color: rgba(34,197,94,.35); }
  /* â–¼NEW: Grid å­ã®æœ€å°å¹…ã‚’ 0 ã«ã—ã¦è¦ªå¹…ã‚’è¶…ãˆãªã„ */
  .grid > * { min-width: 0; }

  /* â–¼NEW: ã‚¬ãƒ³ãƒˆã¯ã‚«ãƒ¼ãƒ‰ã®ä¸­ã ã‘ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  #gantt-container, .gantt-wrap, .gantt-head, .gantt-main, .gantt-right { max-width: 100%; }
  .gantt-right { overflow: auto; min-width: 0; }
  /* æ·»ä»˜ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡Œ */
  .att-row td { background: #fff; }
  .inline-attachments{ padding:8px 12px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; }
  /* æ—¥å ±ä¸€è¦§ã‚’ã‚°ãƒªãƒƒãƒ‰æ¨ªæ–­ã§è¡¨ç¤º */
  #page-daily #daily-list-card { grid-column: 1 / -1; }
  /* æ¤œç´¢ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚‚å›ºå®šï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã®ç›´ä¸‹ã«é‡ãªã‚‰ãªã„ä½ç½®ï¼‰ */
  .toolbar.sticky-head {
    position: sticky;
    top: 102px;           /* header(ç´„56px)+filters(ç´„46px)ã®ä¸‹ã«é…ç½® */
    z-index: 24;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
  }
  /* inline edit controls */
  .inline-ctl { display:inline-flex; gap:6px; margin-left:6px; vertical-align:middle; }
  .inline-ctl button{ padding:2px 6px; font-size:12px; border-radius:6px; }
  .inline-ctl .ok { background:#10b981; border-color:#10b981; }
  .inline-ctl .ng { background:#ef4444; border-color:#ef4444; }
  .cell-flash { animation: flashBg 1.2s ease-out 1; }
  @keyframes flashBg { 0%{ background:#fef08a; } 100%{ background:transparent; } }

  /* toast */
  #toast-stack{ position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
  .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow: var(--shadow); max-width: 360px; }
  .toast.ok{ background:#065f46; }
  .toast.ng{ background:#7f1d1d; }
  /* aging colors */
  .age-3  { box-shadow: inset 0 0 0 2px rgba(234,179,8,.35); }   /* 3æ—¥è¶… é»„è‰² */
  .age-7  { box-shadow: inset 0 0 0 2px rgba(249,115,22,.5); }   /* 7æ—¥è¶… æ©™ */
  .age-14 { box-shadow: inset 0 0 0 2px rgba(239,68,68,.6); }    /* 14æ—¥è¶… èµ¤ */

  /* === Attendance UI (look recreation) === */
  /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã¯ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’å…¨å¹…ã«ã™ã‚‹ */
  #page-attendance.att-layout-dashboard .grid{ grid-template-columns: 1fr; }
  #att-cards{ display:flex; flex-direction:column; gap:4px; }
  .att-card{ padding: 6px 10px; border-radius: 10px; box-shadow: 0 1px 3px rgba(17, 24, 39, 0.04); }
  .att-card .body{ padding: 0; }
  .att-avatar{ width:22px; height:22px; border-radius:50%; background:#cbd5e1; flex: 0 0 auto; }
  .att-name{ font-weight:800; font-size:20px; line-height:1.05; }
  .att-role{ color:#6b7280; font-size:12px; line-height:1.05; margin-left:8px; }
  .att-status-pill{ margin-left:auto; padding:2px 6px; border-radius:999px; font-weight:800; font-size:11px; border:1px solid rgba(17,24,39,.08); background: rgba(255,255,255,.7); white-space:nowrap; }

  .att-line{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; background: rgba(255,255,255,.6); border-radius: 10px; padding: 6px; }
  .att-line + .att-line{ margin-top:4px; }
  .att-k{ color:#374151; font-size:12px; font-weight:700; white-space:nowrap; }
  .att-v{ color:#111827; font-size:12px; white-space:nowrap; }
  .att-person{ display:flex; align-items:baseline; gap:0; margin-right:6px; }
  .att-ctl{ padding:4px 8px; font-size:13px; border-radius:8px; width:auto; min-width: 120px; }
  .att-ctl.small{ min-width: 0; width: auto; }
  .att-ctl.wide{ min-width: 240px; max-width: 420px; }
  .att-actions{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .att-card button{ padding:6px 10px; border-radius:8px; }
  .att-muted{ color: var(--muted); font-size:12px; }
  .att-status-pill.tone-green{ background:#dcfce7; color:#166534; border-color: rgba(22,101,52,.25); }
  .att-status-pill.tone-yellow{ background:#fef3c7; color:#92400e; border-color: rgba(146,64,14,.25); }
  .att-status-pill.tone-red{ background:#fee2e2; color:#991b1b; border-color: rgba(153,27,27,.25); }
  .att-status-pill.tone-gray{ background:#e5e7eb; color:#374151; border-color: rgba(55,65,81,.20); }

  .att-card.card-state-working-office{ border-left: 6px solid #16a34a; background: #d1fae5; }
  .att-card.card-state-working-remote{ border-left: 6px solid #075985; background: #e0f2fe; }
  .att-card.card-state-event{ border-left: 6px solid #f59e0b; background: #fef3c7; }
  .att-card.card-state-done{ border-left: 6px solid #9ca3af; background: #e5e7eb; }
  .att-card.card-state-not-clocked{ border-left: 6px solid #ef4444; background: #fee2e2; }

  .att-card.card-state-working-office .row,
  .att-card.card-state-working-remote .row,
  .att-card.card-state-event .row,
  .att-card.card-state-done .row,
  .att-card.card-state-not-clocked .row{ background: rgba(255,255,255,.6); border-radius: 10px; padding: 6px; margin-bottom: 4px; }

  /* é€ã‹ã—ã‚ˆã‚Šå‰é¢ã«å‡ºã™å¯¾è±¡ã‚’è¿½åŠ ï¼ˆheader ã ã‘ã§ãªã toolbar ã‚‚ï¼‰ */
  header, #global-toolbar, .container { position: relative; z-index: 1; }

  /* ç”»é¢ä¸Šéƒ¨ã«å›ºå®šã™ã‚‹ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
  #global-toolbar.toolbar--global{
    position: sticky;
    top: var(--header-h);
    z-index: 29;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 6px 12px;
    display: flex;
    gap: 8px;
    align-items: center;
    box-shadow: var(--shadow);
  }


  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šUIã®ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆ†ã‚’è€ƒæ…®ï¼‰ */
  .filters.sticky { top: calc(var(--header-h) + var(--toolbar-h)); }
  .toolbar.sticky-head { top: calc(var(--header-h) + var(--toolbar-h) + var(--filters-h)); }
  /* é€ã‹ã—ãƒ­ã‚´ */
  #watermark{
    position: fixed;
    inset: 0;
    pointer-events: none;
    background-repeat: no-repeat;
    background-position: center 45%;
    background-size: var(--wm-size, 820px);
    opacity: var(--wm-opacity, 0.03);
    filter: grayscale(1);
    mix-blend-mode: normal;
    z-index: 0; /* å‰æ™¯ã¯ header ã® z-index ã§ååˆ†ä¸Šã«æ¥ã‚‹ */
  }
  /* è¿½åŠ  */
  #view-board .kanban.is-swim{
    display:block;
    grid-template-columns: 1fr; /* å…ƒã® repeat(4,1fr) ã‚’ç„¡åŠ¹åŒ– */
    gap: 0;
  }
  #view-board .kanban.is-swim .lane-wrap{
    margin-bottom:12px;
  }
  /* ====== é‡ãªã‚Šè§£æ¶ˆãƒ‘ãƒƒãƒï¼ˆæœ€å¾Œã«è¿½è¨˜ï¼‰ ====== */


  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯é€šå¸¸ã® sticky ã«ï¼ˆå›ºå®šåŒ–ã®æ‰“ã¡æ¶ˆã—ï¼‰ */
  header{
    position: sticky !important;
    top: 0;
    z-index: 60;          /* é€ã‹ã—ã‚ˆã‚Šå‰é¢ã« */
  }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é€šå¸¸ãƒ•ãƒ­ãƒ¼ã«æˆ»ã™ï¼ˆå›ºå®šåŒ–ã®æ‰“ã¡æ¶ˆã—ï¼‰ */
  .container{
    position: relative !important;
    z-index: 1;
    /* ä½™ç™½ã¯æ—¢å­˜ã® .container { padding:16px; } ã‚’æ´»ã‹ã™ã®ã§è¿½åŠ ä¸è¦ */
  }

  /* å·¦ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒ‘ãƒãƒ«ã®stickyä½ç½®ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼é«˜ã«åˆã‚ã›ã¦ãšã‚‰ã™ */
  #quick-panel{
    top: calc(var(--header-h) + 8px) !important;  /* ä¾‹ï¼š56px + 8px = 64px ã¨åŒç­‰ */
  }

  /* å¿µã®ãŸã‚ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®å›ºå®šUIã®åŸºæº–ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼/å†…éƒ¨ãƒªãƒ³ã‚¯ç”¨ï¼‰ */
  html{
    scroll-padding-top: calc(var(--header-h) + 8px);
  }
  /* bottom-right busy indicator */
  .busy{
    position: fixed; right:14px; bottom:14px;
    background:#111827; color:#fff;
    padding:8px 10px; border-radius:10px;
    box-shadow: var(--shadow); z-index: 1200;
    font-size: 13px;
  }
  .busy::before{ content:'â³ '; }
  /* select ã®ãƒ—ãƒ¬ã‚¤ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºç”¨ï¼ˆå€¤ãŒç©ºã®ã¨ãï¼‰ */
  select.is-placeholder { color: var(--muted); }
  /* === ãƒ¡ãƒ¢å…¨æ–‡è¡¨ç¤ºã®ãŸã‚ã®è‡ªå‹•é«˜ã•ãƒ‘ãƒƒãƒ === */

  /* è¡Œï¼šå›ºå®š height ã‚’ã‚„ã‚ã€min-height ãƒ™ãƒ¼ã‚¹ã« */
  #taskTable tbody tr,
  #projTable tbody tr{
    height: auto !important;
    min-height: var(--row-h);
  }

  /* ãƒ¡ãƒ¢ã‚»ãƒ«ã‚‚å›ºå®šé«˜ã•ã‚’è§£é™¤ */
  td.cell-memo{
    height: auto !important;
    vertical-align: top;
  }

  /* ãƒ¡ãƒ¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯å†…å®¹ã«åˆã‚ã›ã¦ä¼¸ç¸® */
  .memo-edit{
    display: block;
    width: 100%;
    box-sizing: border-box;

    /* é«˜ã•ã¯è‡ªå‹•ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¯åŸºæœ¬å‡ºã•ãªã„ï¼ˆscrollHeightã§ä¼¸ã°ã™ï¼‰ */
    height: max-content;
    min-height: 28px;        /* 1è¡Œã¶ã‚“ã®æœ€ä½å€¤ã ã‘ä¸ãˆã‚‹ */
    max-height: none;
    overflow: hidden;        /* ä¸­ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãšä¼¸ã°ã™ */
    resize: none;            /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºã¯ç„¡åŠ¹ */

    /* æ—¢å­˜ã®è¦‹ãŸç›®ã¯ãã®ã¾ã¾ç¶­æŒ */
    line-height: 1.35;
    font: inherit;
    padding: 1px 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: inherit;
  }
/* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆdata-tipå±æ€§ã§æœ‰åŠ¹ï¼‰ ===== */
.tooltip-bubble{
  position: fixed;            /* â† viewportåŸºæº–ã§ãƒã‚¦ã‚¹è¿½éš */
  z-index: 20000;
  max-width: 280px;
  font-size: 12px;
  line-height: 1.5;
  background: #111827;
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  white-space: normal;
  pointer-events: none;
}

.tooltip-bubble::after{
  content:"";
  position:absolute;
  left: 12px;                 /* çŸ¢å°ã®åŸºæº–ä½ç½®ï¼ˆå³å¯„ã›æ™‚ã«åˆ‡æ›¿ï¼‰ */
  bottom: -6px;               /* é€šå¸¸ã¯â€œä¸Šå‘ãâ€ã®å¹ãå‡ºã—ã«ã™ã‚‹ã®ã§ä¸‹è¾ºã«çŸ¢å° */
  border: 6px solid transparent;
  border-top-color: #111827;  /* ä¸Šå‘ãçŸ¢å°ï¼ˆãƒãƒ–ãƒ«ã¯ä¸Šã€çŸ¢å°ã¯ä¸‹ã«å‡ºã™ï¼‰ */
}

/* ç”»é¢å³ç«¯ã§å·¦å¯„ã›ã«ãƒ•ãƒªãƒƒãƒ—ã—ãŸã¨ãã®çŸ¢å° */
.tooltip-bubble.left::after{
  left: auto;
  right: 12px;
}

/* ç”»é¢ä¸Šç«¯ã§â€œä¸‹å´ã«å‡ºã™â€ã¨ãã®çŸ¢å° */
.tooltip-bubble.below::after{
  bottom: auto;
  top: -6px;
  border-top-color: transparent;
  border-bottom-color: #111827;
}


/* ===== å³ä¸‹ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°FAB ===== */
#fab-stack{
  position: fixed; right:16px; bottom:16px; z-index:1100;
  display:flex; flex-direction:column; gap:10px;
}
.fab-btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:12px 14px; border-radius:999px; border:1px solid #e5e7eb;
  background:#0ea5e9; color:#fff; font-weight:600; cursor:pointer;
  box-shadow: 0 6px 16px rgba(14,165,233,.35);
}
.fab-btn:active{ transform: translateY(1px); }

/* ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ ===== */
.flyout-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1099; display:none;
}
.flyout{
  position:fixed; top:0; right:-420px; width:420px; max-width:92vw; height:100%;
  background:var(--card); border-left:1px solid var(--border); box-shadow: -6px 0 20px rgba(0,0,0,.12);
  z-index:1101; display:flex; flex-direction:column; transition:right .24s ease;
}
.flyout.open{ right:0; }
.flyout header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px; background:#f8fafc; border-bottom:1px solid var(--border);
}
.flyout .content{ padding:12px; overflow:auto; }
.flyout .actions{ margin-top:auto; display:flex; gap:8px; justify-content:flex-end; padding:12px; border-top:1px solid var(--border); }
.flyout .hint{ font-size:12px; color:var(--muted); margin-top:4px; }
/* â–¼ è¿½åŠ ï¼šãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®æ–¹ä½ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨å¹…æŒ‡å®š */
.tooltip-bubble.bottom{ transform: translate(-50%, 6px); }
.tooltip-bubble.bottom::after{
  bottom:auto; top:-6px; border-top-color:transparent; border-bottom-color:#111827;
}
.tooltip-bubble.left{ left:auto; right:100%; transform: translate(-8px, -6px); }
.tooltip-bubble.left::after{
  left:auto; right:-6px; bottom:10px; border-top-color:transparent; border-left-color:#111827;
}
.tooltip-bubble.wide{ max-width: 420px; }
/* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®æ”¹è¡Œã«å¯¾å¿œï¼ˆ\nã‚’<br>ã«å¤‰æ›ã™ã‚‹ã®ã§ä½™ç™½ã‚’å°‘ã—ï¼‰ */
.tooltip-bubble p{ margin:0; }
.tooltip-bubble p + p{ margin-top:6px; }

/* â–¼ è¿½åŠ ï¼šãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã®æš—å¹•ON/OFF */
.flyout-mask.open{ display:block; }
body.flyout-open{ overflow:hidden; } /* èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢ */
/* ======== Center Modal ======== */
#modal-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.28);
  display:none; align-items:center; justify-content:center; z-index:1300;
}
#modal{
  width:min(720px, 94vw); max-height:86vh; overflow:auto;
  background:#fff; border:1px solid var(--border); border-radius:14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.2);
}
#modal header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid var(--border); background:#f8fafc;
}
#modal .content{ padding:12px; }
#modal .close{
  border:none; background:transparent; color:#111827; font-size:18px; cursor:pointer;
}
/* ãƒªãƒ³ã‚¯é¢¨ã®å°ãƒœã‚¿ãƒ³ */
button.link {
  background: transparent;
  border: none;
  padding: 4px 8px;
  cursor: pointer;
  text-decoration: underline;
  font: inherit;
}
button.link:hover { opacity: .8; }

</style>

</head>
<body>
  <div id="watermark"></div>
<header>
  <h1>
    PJãƒã‚¤ãƒ³ãƒ€ãƒ¼
    <span id="app-version" class="muted" style="font-weight:500; margin-left:8px;"></span>
    <img id="brandmark" alt="" />
  </h1>

  <div class="toolbar" id="debug-bar" style="display:none"></div>
  <div class="muted" id="sheet-chip" style="display:none"></div>
  <div class="muted" id="debug-snapshot" style="display:none"></div>
  <div class="toolbar">
    <button class="secondary" onclick="refresh()">æœ€æ–°åŒ–</button>
    <button class="secondary" id="nav-help"    onclick="openUsageGuide('BEGINNER')">ä½¿ã„æ–¹</button>
  </div>
  <nav>
    <button class="active" id="nav-dashboard" onclick="goto('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
    <button id="nav-minutes" onclick="goto('minutes')">è­°äº‹éŒ²</button>
    <button id="nav-daily"   onclick="goto('daily')">æ—¥å ±</button>
    <button id="nav-attendance" onclick="goto('attendance')">å‹¤æ€ </button>
    <button id="nav-shared"  onclick="goto('shared')">å…±æœ‰è³‡æ–™</button>
    <button id="nav-users"   onclick="goto('users')">ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
    <button id="nav-vault"   onclick="goto('vault')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é‡‘åº«</button>
    <button id="nav-subs"    onclick="goto('subs')">ã‚µãƒ–ã‚¹ã‚¯</button>
    <button id="nav-budget"  onclick="goto('budget')">äºˆç®—</button>
    <button id="nav-ledger"  onclick="goto('ledger')">å…¥å‡ºé‡‘</button>
    <button id="nav-projects" onclick="goto('projects')">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</button>
    <button id="nav-facility" data-tip="æœªå®Ÿè£…">è¨­å‚™äºˆç´„</button>
    <button id="nav-workflow" data-tip="æœªå®Ÿè£…">æ±ºæ¸ˆç”³è«‹</button>
    <button id="nav-debug"   onclick="goto('debug')">ãƒ‡ãƒãƒƒã‚°</button>
  </nav>
</header>

  <div id="toast-stack"></div>
  <!-- budget/subs/ledger/debug pages -->
    <section class="page" id="page-budget">
    <div class="grid">
      <div class="card">
        <h2>äºˆç®—ã‚µãƒãƒª</h2>
        <div class="body" id="budget-summary"></div>
      </div>
      <div class="card">
        <h2>è²¬ä»»è€…åˆ¥ äºˆç®—é›†è¨ˆ</h2>
        <div class="body">
          <table id="budget-by-owner"><thead><tr><th>è²¬ä»»è€…</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°</th><th>äºˆç®—åˆè¨ˆ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>
  <div id="busy-indicator" class="busy" aria-live="polite" style="display:none">Loading...</div>


  <section class="page" id="page-subs">
    <div class="grid">
      <div class="card">
        <h2>ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²</h2>
        <div class="body">
          <div class="row">
            <div><label>ã‚µãƒ¼ãƒ“ã‚¹å</label><input id="s_service"/></div>
            <div><label>ãƒ™ãƒ³ãƒ€ãƒ¼</label><input id="s_vendor"/></div>
          </div>
          <div class="row">
            <div><label>é‡‘é¡</label><input id="s_amount" type="number" min="0"/></div>
            <div><label>ç¨è¾¼ã¿ï¼Ÿ</label><select id="s_taxIncl"><option value="true">ç¨è¾¼</option><option value="false">ç¨æŠœ</option></select></div>
          </div>
          <div class="row">
            <div><label>ç¨åŒºåˆ†</label><input id="s_taxCode" placeholder="ä¾‹: 10%"/></div>
            <div><label>å‹˜å®šç§‘ç›®</label><input id="s_account" placeholder="ä¾‹: ã‚µãƒ–ã‚¹ã‚¯è²»ç”¨"/></div>
          </div>
          <div class="row">
            <div><label>ã‚µã‚¤ã‚¯ãƒ«</label><select id="s_cycle"><option value="monthly">æ¯æœˆ</option><option value="quarterly">å››åŠæœŸ</option><option value="yearly">æ¯å¹´</option></select></div>
            <div><label>æ¬¡å›èª²é‡‘æ—¥</label><input id="s_nextBill" type="date"/></div>
          </div>
          <div class="row">
            <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="s_project"></select></div>
            <div><label>è‡ªå‹•ä»•è¨³</label><select id="s_autoJournal"><option value="false">ã—ãªã„</option><option value="true">ã™ã‚‹</option></select></div>
          </div>
          <div class="row"><div><label>ãƒ¡ãƒ¢</label><input id="s_memo"/></div></div>
          <div class="toolbar" style="margin-top:8px;"><button class="primary" onclick="addSubscription()">ç™»éŒ²</button></div>
        </div>
      </div>
      <div class="card">
        <h2>ã‚µãƒ–ã‚¹ã‚¯ä¸€è¦§</h2>
        <div class="body">
          <table id="subsTable"><thead><tr><th>ã‚µãƒ¼ãƒ“ã‚¹</th><th>ãƒ™ãƒ³ãƒ€ãƒ¼</th><th>é‡‘é¡</th><th>ã‚µã‚¤ã‚¯ãƒ«</th><th>æ¬¡å›èª²é‡‘æ—¥</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="page-projects">
    <div class="card">
      <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <input id="proj_f_keyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåç§°/ãƒ¡ãƒ¢ï¼‰"/>
          <select id="proj_f_owner"></select>
          <select id="proj_f_priority">
            <option value="">å…¨å„ªå…ˆåº¦</option>
            <option>é«˜</option><option>ä¸­</option><option>ä½</option>
          </select>
          <select id="proj_f_status">
            <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
            <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
          </select>
          <button class="secondary" onclick="clearProjectsFilters()">ã‚¯ãƒªã‚¢</button>
          <button onclick="applyProjectsFilters()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
        </div>

        <div class="body list" style="padding:0;">
          <table id="projAllTable">
            <thead>
              <tr>
                <th>åç§°</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>è¦ª</th><th>è²¬ä»»è€…</th>
                <th>å„ªå…ˆåº¦</th><th>äºˆç®—</th><th>æœŸé–“</th>
                <th>æœªå®Œäº†</th><th>å®Œäº†</th><th>æ·»ä»˜</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px;">ã€Œé–¢é€£ã‚¿ã‚¹ã‚¯ã€ãƒœã‚¿ãƒ³ã§ã€ãã®å ´ã§ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ãƒˆã‚°ãƒ«è¡¨ç¤ºã§ãã¾ã™ã€‚</div>
      </div>
    </div>
  </section>

  <section class="page" id="page-ledger">
    
    <div class="grid">
      <div class="card">
        <h2>å…¥å‡ºé‡‘ç™»éŒ²</h2>
        <div class="row">
          <div><label>åç§°</label><input id="l_title" placeholder="ä¾‹: 7æœˆ åºƒå‘Šè²»"/></div>
          <div></div>
        </div>
        <div class="body">
          <div class="row">
            <div><label>æ—¥ä»˜</label><input id="l_date" type="date"/></div>
            <div><label>åŒºåˆ†</label><select id="l_type"><option>income</option><option>expense</option></select></div>
          </div>
          <div class="row">
            <div><label>é‡‘é¡</label><input id="l_amount" type="number" min="0"/></div>
            <div><label>å‹˜å®šç§‘ç›®</label><input id="l_account" placeholder="ä¾‹: åºƒå‘Šè²»"/></div>
          </div>
          <div class="row">
            <div><label>ç›¸æ‰‹å…ˆ</label><input id="l_counterpart" placeholder="ä¾‹: ã€‡ã€‡æ ªå¼ä¼šç¤¾"/></div>
            <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="l_project"></select></div>
          </div>
          <div class="row">
            <div><label>ãƒ¡ãƒ¢</label><input id="l_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addLedgerEntry()">ç™»éŒ²</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>å®šæœŸå…¥å‡ºé‡‘ï¼ˆRRULEï¼‰</h2>
        <div class="body">
          <div class="row">
            <div><label>åç§°</label><input id="lp_title" placeholder="ä¾‹: å®¶è³ƒ/åºƒå‘Šè²»æœˆæ¬¡ ãªã©"/></div>
            <div><label>åŒºåˆ†</label><select id="lp_type"><option>income</option><option>expense</option></select></div>
          </div>
          <div class="row">
            <div><label>é‡‘é¡</label><input id="lp_amount" type="number" min="0"/></div>
            <div><label>å‹˜å®šç§‘ç›®</label><input id="lp_account" placeholder="ä¾‹: åœ°ä»£å®¶è³ƒ"/></div>
          </div>
          <div class="row">
            <div><label>ç›¸æ‰‹å…ˆ</label><input id="lp_counterpart"/></div>
            <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="lp_project"></select></div>
          </div>
          
  <div class="row">
    <div>
      <label>RRULE</label>
      <div style="display:flex; gap:6px; align-items:center;">
        <select id="lp_rrule_mode">
          <option value="">ï¼ˆé¸æŠï¼‰</option>
          <option value="DAILY">æ¯æ—¥</option>
          <option value="WEEKLY">æ¯é€±</option>
          <option value="BIWEEKLY">éš”é€±</option>
          <option value="MONTHLY">æ¯æœˆ</option>
          <option value="BIMONTHLY">éš”æœˆ</option>
          <option value="QUARTERLY">å››åŠæœŸ</option>
          <option value="YEARLY">æ¯å¹´</option>
        </select>
        <input id="lp_rrule" placeholder="FREQ=MONTHLY;INTERVAL=1;BYMONTHDAY=25" style="flex:1;"/>
      </div>
      <div class="muted" style="font-size:11px; margin-top:4px;">ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§è‡ªå‹•å…¥åŠ›ï¼æ‰‹å‹•ç·¨é›†ã‚‚å¯</div>
    </div>
    <div><label>æ¬¡å›ç™ºç”Ÿæ—¥ï¼ˆåˆæœŸï¼‰</label><input id="lp_next" type="date"/></div>
  </div>

          <div class="row">
            <div><label>ãƒ¡ãƒ¢</label><input id="lp_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addLedgerPlan()">å®šæœŸç™»éŒ²</button>
          </div>

          <hr/>
          <table id="ledgerPlanTable">
            <thead><tr><th>åç§°</th><th>åŒºåˆ†</th><th>é‡‘é¡</th><th>RRULE</th><th>æ¬¡å›</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>å…¥å‡ºé‡‘ä¸€è¦§ï¼ˆæœ€æ–°50ä»¶ï¼‰</h2>
        <div class="body list" style="padding:0;">
          <table id="ledgerTableFull">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th><th>ç¨®åˆ¥</th><th>åŒºåˆ†</th><th>åç§°</th><th>é‡‘é¡</th>
                <th>ç§‘ç›®</th><th>ç›¸æ‰‹å…ˆ</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th><th>ãƒ¡ãƒ¢</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="page-debug" class="page">
    <div class="card">
      <h2>è¨ºæ–­ï¼ˆDiagnosticsï¼‰</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap;">
          <button onclick="runDiagnostics()">æƒ…å ±åé›†</button>
          <button class="secondary" onclick="forceResync()">å¼·åˆ¶å†åŒæœŸï¼ˆUsers/Projectsï¼‰</button>
          <button class="secondary" onclick="refresh()">ãƒ‡ãƒ¼ã‚¿å†å–å¾—</button>
          <button class="secondary" onclick="renderAll()">å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°</button>
        </div>
        <div class="row">
          <div><label>æ¥ç¶šå…ˆã‚·ãƒ¼ãƒˆ</label><pre id="dbg_sheet"></pre></div>
          <div><label>ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚µãƒ¼ãƒ/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰</label><pre id="dbg_counts"></pre></div>
        </div>
        <div class="row">
          <div><label>Usersï¼ˆå…ˆé ­5è¡Œï¼‰</label><pre id="dbg_users" style="max-height:220px; overflow:auto;"></pre></div>
          <div><label>Projectsï¼ˆå…ˆé ­5è¡Œï¼‰</label><pre id="dbg_projects" style="max-height:220px; overflow:auto;"></pre></div>
        </div>
        <div><label>getAllDataãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label><pre id="dbg_all" style="max-height:300px; overflow:auto;"></pre></div>
        <div><label>ãƒ­ã‚°</label><pre id="dbg_log" style="white-space:pre-wrap; background:#111827; color:#e5e7eb; padding:8px; border-radius:8px; max-height:240px; overflow:auto;"></pre></div>
      </div>
    </div>
  </section>
  <!-- æœ€è¿‘ã®æ›´æ–°ï¼ˆæœ€å¤§10ä»¶ï¼‰ -->
  <div class="card see-through" id="updates-panel" style="display:none;">
    <details>
      <summary style="cursor:pointer; font-weight:600;">æœ€è¿‘ã®æ›´æ–°</summary>
      <div class="body" id="updates-feed" style="margin-top:8px;"></div>
    </details>
  </div>
  

  <!-- DASHBOARD -->
  <section class="page active" id="page-dashboard">
    <div class="grid" id="dashboard-grid">
      <!-- å·¦ã‚µã‚¤ãƒ‰ï¼šã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ -->
      <div class="card" id="quick-panel">
        <h2>
          ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ 
          <button id="qp-toggle" class="secondary mini" onclick="toggleQuickPanel()" title="æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹">â—€</button>
        </h2>
        <div class="body">
          <!-- Projects -->
          <div class="row">
            <button class="secondary" onclick="openUsageGuide()">ä½¿ã„æ–¹</button>
            <div>
              <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
              <input type="hidden" id="p_editing_id"/>
              <input id="p_name" placeholder="ä¾‹: 2025ä¸ŠæœŸ æ–°è£½å“A"/>
            </div>
            <div>
              <label>è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä»»æ„ï¼‰</label>
              <select id="p_parent_select"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>è²¬ä»»è€…ï¼ˆUsersï¼‰</label>
              <select id="p_owner_select"></select>
            </div>
            <div>
              <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå„ªå…ˆåº¦</label>
              <select id="p_priority"><option value="">-</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
            </div>
            <div class="row">
              <div>
                <label>ã‚«ãƒ©ãƒ¼</label>
                <input id="p_color" type="color" value="#ffffff"/>
              </div>
              <div><label>äºˆç®—ï¼ˆå††ï¼‰</label><input id="p_budget" type="number"/></div>
              <div></div>
            </div>

          </div>
          <div class="row">
            <div><label>é–‹å§‹æ—¥</label><input id="p_start" type="date"/></div>
            <div><label>çµ‚äº†æ—¥</label><input id="p_end" type="date"/></div>
          </div>
          <div class="row">
            <div>
              <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
              <textarea id="p_memo"></textarea>
            </div>
            <div>
              <label>Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æº</label>
              <div class="toolbar">
                <button class="secondary" onclick="openUsageGuide()">ä½¿ã„æ–¹</button>
                <button onclick="openProjectDoc()">Docsã‚’é–‹ã</button>
                <button class="secondary" onclick="openAttachDialog('project')">ğŸ“æ·»ä»˜</button>
              </div>
              <div class="muted" id="p_doc_status">æœªä½œæˆ</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="secondary" id="btn_reset_project" onclick="resetProjectForm()">æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿</button>
            <button id="btn_add_project" onclick="addProject()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ </button>
          </div>


          <hr/>
          <!-- Tasks -->
          <div class="row">
            <button class="secondary" onclick="openUsageGuide()">ä½¿ã„æ–¹</button>
            <div>
              <label>ã‚¿ã‚¹ã‚¯å</label>
              <input type="hidden" id="t_editing_id"/>
              <input id="t_title" placeholder="ä¾‹: å–èª¬ãƒ‰ãƒ©ãƒ•ãƒˆ"/>
            </div>
            <div>
              <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
              <select id="t_project_select"></select>
            </div>
          </div>
          <div class="row">
            <div><label>ç¨®åˆ¥</label>
              <select id="t_type">
                <option value="single">å˜ç™º</option>
                <option value="recurring">å®šæœŸ</option>
              </select>
            </div>
            <div><label>æœŸé™</label><input id="t_due" type="date"/></div>
          </div>
          <div class="row">
            <div>
              <label>è²¬ä»»è€…ï¼ˆUsersï¼‰</label>
              <select id="t_owner_select"></select>
            </div>
            <div>
              <label>æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <select id="t_assignees_select" multiple="" size="3"></select>
            </div>
          </div>
          
<div class="row">
  <div>
    <label>å„ªå…ˆåº¦</label>
    <select id="t_prio">
      <option value="">-</option>
      <option>é«˜</option><option>ä¸­</option><option>ä½</option>
    </select>
  </div>
  <div>
    <label>RRULEï¼ˆå®šæœŸã®å ´åˆï¼‰</label>
    <div style="display:flex; gap:6px; align-items:center;">
      <select id="t_rrule_mode">
        <option value="">ï¼ˆé¸æŠï¼‰</option>
        <option value="DAILY">æ¯æ—¥</option>
        <option value="WEEKLY">æ¯é€±</option>
        <option value="BIWEEKLY">éš”é€±</option>
        <option value="MONTHLY">æ¯æœˆ</option>
        <option value="BIMONTHLY">éš”æœˆ</option>
        <option value="QUARTERLY">å››åŠæœŸ</option>
        <option value="YEARLY">æ¯å¹´</option>
      </select>
    </div>
  </div>
</div>

          <div class="row">
            <div>
              <label>ã‚«ãƒ©ãƒ¼</label>
              <input id="t_color" type="color" value="#ffffff"/>
            </div>
            <div></div>
          </div>
          <div class="row">
            <div>
              <label>ã‚¿ã‚¹ã‚¯ãƒ¡ãƒ¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
              <textarea id="t_memo"></textarea>
            </div>
            <div>
              <label>Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æº</label>
              <div class="toolbar">

                <button onclick="openTaskDoc()">Docsã‚’é–‹ã</button>
                <button class="secondary" onclick="openAttachDialog('task')">ğŸ“æ·»ä»˜</button>
              </div>
              <div class="muted" id="t_doc_status">æœªä½œæˆ</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="secondary" id="btn_reset_task" onclick="resetTaskForm()">æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿</button>
            <button id="btn_add_task" onclick="addTask()">ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
          </div>

        </div>
      </div>

      <div class="card card--glass" id="main-work-card">
        <div class="body">
          <div class="tabs">
            <div class="tab active" id="tab-list"  onclick="switchTab('list')">ã‚¿ã‚¹ã‚¯ä¸€è¦§</div>
            <div class="tab"          id="tab-board" onclick="switchTab('board')">ã‚«ãƒ³ãƒãƒ³</div>
            <div class="tab"          id="tab-gantt" onclick="switchTab('gantt')">ã‚¬ãƒ³ãƒˆ</div>
          </div>

          <div class="filters sticky see-through">
            <input id="f_keyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/ãƒ¡ãƒ¢ç­‰ï¼‰"/>
            <select id="f_project"></select>
            <select id="f_assignee"></select>
            <div><label class="muted">æœŸé™(From)</label><input id="f_from" type="date"/></div>
            <div><label class="muted">æœŸé™(To)</label><input id="f_to" type="date"/></div>
            <div>
              <label class="muted">å„ªå…ˆåº¦</label>
              <select id="f_priority">
                <option value="">å…¨å„ªå…ˆåº¦</option>
                <option>é«˜</option><option>ä¸­</option><option>ä½</option>
              </select>
            </div>
          </div>
          <div class="toolbar sticky-head" style="justify-content:flex-end; margin-bottom:8px;">
            <div class="toolbar" style="justify-content:flex-end; margin-bottom:8px;">
              <select id="f_status">
                <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                <option value="todo">æœªç€æ‰‹</option>
                <option value="doing">é€²è¡Œä¸­</option>
                <option value="blocked">ä¿ç•™ä¸­</option>
                <option value="done">å®Œäº†</option>
                <option value="notdone">å®Œäº†ä»¥å¤–</option>
              </select>
              <button class="secondary" onclick="clearFilters()">ã‚¯ãƒªã‚¢</button>
              <button onclick="applyFilters()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
              <button class="secondary" onclick="quickOverdue()">é…å»¶</button>
              <button class="secondary mini" onclick="exportCSV('tasks')">CSV(Tasks)</button>
              <button class="secondary mini" onclick="exportCSV('projects')">CSV(Projects)</button>
            </div>
          </div>
          <!-- ä¸€è¦§ -->
          <div id="view-list">
            <div class="body list see-through" style="padding:0;">
              <table id="taskTable">
                <thead>
                  <tr>
                    <th>æœŸé™</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ç¨®åˆ¥</th><th>æ‹…å½“</th><th>å„ªå…ˆåº¦</th><th>çŠ¶æ…‹</th><th>ãƒ¡ãƒ¢</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- ã‚«ãƒ³ãƒãƒ³ -->
          <div id="view-board" style="display:none;">
            <div class="toolbar" style="margin-bottom:8px;">
              <label><input type="checkbox" id="opt_swimlane" onchange="renderKanban()"> æ‹…å½“è€…åˆ¥ã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³</label>
            </div>
            <div class="kanban">
              <div class="col see-through" data-status="todo" ondragover="allowDrop(event)" ondrop="onDrop(event, 'todo')">
                <h3>æœªç€æ‰‹ <span class="muted" id="cnt_todo">0</span></h3>
                <div id="col_todo"></div>
              </div>
              <div class="col see-through" data-status="doing" ondragover="allowDrop(event)" ondrop="onDrop(event, 'doing')">
                <h3>é€²è¡Œä¸­ <span class="muted" id="cnt_doing">0</span></h3>
                <div id="col_doing"></div>
              </div>
              <div class="col see-through" data-status="blocked" ondragover="allowDrop(event)" ondrop="onDrop(event, 'blocked')">
                <h3>ä¿ç•™ä¸­ <span class="muted" id="cnt_blocked">0</span></h3>
                <div id="col_blocked"></div>
              </div>
              <div class="col see-through" data-status="done" ondragover="allowDrop(event)" ondrop="onDrop(event, 'done')">
                <h3>å®Œäº† <span class="muted" id="cnt_done">0</span></h3>
                <div id="col_done"></div>
              </div>
            </div>
          </div>

          <!-- ã‚¬ãƒ³ãƒˆ -->
          <div id="view-gantt" style="display:none;">
            <div class="toolbar" style="margin:6px 0;">
              <label class="muted" style="margin-right:6px;">ã‚¹ã‚±ãƒ¼ãƒ«</label>
              <select id="gantt-scale-mode" onchange="setGanttScale(this.value)" style="margin-right:8px;">
                <option value="day">æ—¥å˜ä½</option>
                <option value="week">é€±å˜ä½</option>
                <option value="month">æœˆå˜ä½</option>
              </select>
              <label class="muted" style="margin:0 6px 0 12px;">è¡¨ç¤ºç¯„å›²</label>
              <input id="gantt-start" type="date"/> <span class="muted">ã€œ</span> <input id="gantt-end" type="date"/>
              <button class="secondary" onclick="applyGanttRange()">é©ç”¨</button>
            </div>
            <div id="gantt-container"></div>
          </div>

          <hr/>
          <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
          <div class="body list see-through" style="padding:0;">
            <table id="projTable">
              <thead><tr>
                <th>åç§°</th><th>è¦ª</th><th>è²¬ä»»è€…</th><th>å„ªå…ˆåº¦</th>
                <th>ã‚¿ã‚¹ã‚¯(æœª/å®Œ)</th>  <!-- â† è¿½åŠ  -->
                <th>ãƒ¡ãƒ¢</th>
                <th>äºˆç®—</th><th>æœŸé–“</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ã‚µãƒ–ã‚¹ã‚¯ä¸€è¦§</h2>
        <div class="body list">
          <table id="subTable">
            <thead><tr><th>æ¬¡å›è«‹æ±‚æ—¥</th><th>ã‚µãƒ¼ãƒ“ã‚¹</th><th>é‡‘é¡</th><th>ã‚µã‚¤ã‚¯ãƒ«</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>å…¥å‡ºé‡‘ï¼ˆæœ€æ–°20ä»¶ï¼‰</h2>
        <div class="body list">
          <table id="ledTable">
            <thead><tr><th>æ—¥ä»˜</th><th>ç¨®åˆ¥</th><th>åŒºåˆ†</th><th>åç§°</th><th>é‡‘é¡</th><th>ç§‘ç›®</th><th>ç›¸æ‰‹å…ˆ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <!-- USERS -->
  <section class="page" id="page-users">
    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
      <div class="body">
        <div class="row">
          <div><label>æ°å</label><input id="u_name"/></div>
          <div><label>ãƒ¡ãƒ¼ãƒ«</label><input id="u_email"/></div>
        </div>
        <div class="row">
          <div><label>ãƒ­ãƒ¼ãƒ«</label>
            <select id="u_role"><option>ä¸€èˆ¬</option><option>è²¬ä»»è€…</option><option>ç®¡ç†è€…</option></select>
          </div>
          <div><label>æ‰€å±</label><input id="u_dept"/></div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button onclick="addUser()">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
      <div class="body list">
        <table id="userTable">
          <thead><tr><th>æ°å</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ãƒ­ãƒ¼ãƒ«</th><th>æ‰€å±</th><th>å‹¤æ€ ã«è¡¨ç¤º</th><th>freeeå¾“æ¥­å“¡ç•ªå·</th><th>å€‹äººã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼(ICS)</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- VAULT (Credentials) -->
  <section class="page" id="page-vault">
    <div class="card">
      <h2>èªè¨¼æƒ…å ±ï¼ˆé‡‘åº«ï¼‰â€” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯<b>ãƒ–ãƒ©ã‚¦ã‚¶å´ã§æš—å·åŒ–</b>ã—ã¦ä¿å­˜</h2>
      <div class="body">
        <div class="muted" style="margin-bottom:8px;">
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¹³æ–‡ä¿å­˜ã¯å±é™ºã§ã™ã€‚æœ¬æ©Ÿèƒ½ã¯ <b>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´AES-GCMæš—å·</b>ã§æš—å·åŒ–ã—ãŸæ–‡å­—åˆ—ã®ã¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚<br/>
          å¾©å·ã«ä½¿ã†<b>ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã¯ã‚µãƒ¼ãƒã«ä¿å­˜ã—ã¾ã›ã‚“</b>ã€‚ç¤¾å†…ã§å…±æœ‰ã™ã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®ç®¡ç†ã«ã”æ³¨æ„ãã ã•ã„ã€‚
        </div>
        <div class="row">
          <div><label>ã‚µãƒ¼ãƒ“ã‚¹å</label><input id="c_service"/></div>
          <div><label>URL</label><input id="c_url" placeholder="https://..."/></div>
        </div>
        <div class="row">
          <div><label>ãƒ­ã‚°ã‚¤ãƒ³ID</label><input id="c_login"/></div>
          <div><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input id="c_password" type="password"/></div>
        </div>
        <div class="row">
          <div><label>ç™»éŒ²è€…ï¼ˆUsersï¼‰</label><select id="c_owner"></select></div>
          <div><label>å‚™è€ƒ</label><input id="c_note"/></div>
        </div>
        <div class="row">
          <div><label>æš—å·åŒ–ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º</label><input id="c_passphrase" placeholder="ä¿å­˜æ™‚ãƒ»å¾©å·æ™‚ã«ä½¿ç”¨" type="password"/></div>
          <div></div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button onclick="addCredential()">ä¿å­˜ï¼ˆæš—å·åŒ–ï¼‰</button>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>èªè¨¼æƒ…å ±ä¸€è¦§</h2>
      <div class="body list">
        <table id="credTable">
          <thead><tr><th>ã‚µãƒ¼ãƒ“ã‚¹</th><th>URL</th><th>ãƒ­ã‚°ã‚¤ãƒ³ID</th><th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th><th>ç™»éŒ²è€…</th><th>å‚™è€ƒ</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section class="page help" id="page-help">
    <div class="card">
    </div>
  </section>
  <section class="page" id="page-shared">
    <div class="grid">
      <div class="card">
        <h2>å…±æœ‰è³‡æ–™ã‚’ç™»éŒ²</h2>
        <div class="body">
          <div class="row">
            <div><label>åç§°</label><input id="sh_name" placeholder="ä¾‹: ç¤¾å†…è¦ç¨‹"/></div>
            <div><label>ã‚«ãƒ†ã‚´ãƒª</label><input id="sh_category" placeholder="ä¾‹: è¦ç¨‹/ãƒ†ãƒ³ãƒ—ãƒ¬/è³‡æ–™"/></div>
          </div>
          <div class="row">
            <div><label>ã‚ªãƒ¼ãƒŠãƒ¼ï¼ˆUsersï¼‰</label><select id="sh_owner"></select></div>
            <div><label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="sh_tags" placeholder="ä¾‹: è¦ç¨‹,åŠ´å‹™"/></div>
          </div>
          <div class="row">
            <div><label>ã‚«ãƒ©ãƒ¼</label><input id="sh_color" type="color" value="#ffffff"/></div>
            <div></div>
          </div>
          <div class="row">
            <div><label>ãƒ¡ãƒ¢</label><textarea id="sh_memo"></textarea></div>
            <div>
              <label>æ·»ä»˜URL</label>
              <div class="toolbar">
                <button class="secondary" onclick="openAttachDialog('shared')">ğŸ“æ·»ä»˜</button>
              </div>
              <div class="muted">Drive/URL ã‚’ç™»éŒ²ï¼ˆDocsè‡ªå‹•ä½œæˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <input type="hidden" id="sh_editing_id"/>
            <button class="secondary" onclick="resetSharedForm()">æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿</button>
            <button onclick="addShared()">å…±æœ‰è³‡æ–™è¿½åŠ </button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>å…±æœ‰è³‡æ–™ä¸€è¦§</h2>
        <div class="body list" style="padding:0;">
          <table id="sharedTable">
            <thead>
              <tr>
                <th>åç§°</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ã‚ªãƒ¼ãƒŠãƒ¼</th><th>ã‚¿ã‚°</th><th>æ·»ä»˜</th><th>çŠ¶æ…‹</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px;">ğŸ“ã‚¢ã‚¤ã‚³ãƒ³ã§æ·»ä»˜ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ä¸€è¦§ã‚’ãƒˆã‚°ãƒ«è¡¨ç¤ºã§ãã¾ã™ã€‚</div>
      </div>
    </div>
  </section>

  <section class="page" id="page-minutes">
    <div class="grid">
      <div class="card">
        <h2>è­°äº‹éŒ²ã‚’ç™»éŒ²</h2>
        <div class="body">
          <div class="row">
            <div><label>æ—¥ä»˜</label><input id="m_date" type="date"/></div>
            <div><label>ä»¶å</label><input id="m_title" placeholder="ä¼šè­°åãªã©"/></div>
          </div>
          <div class="row">
            <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="m_project" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã™ã‚‹ã¨ã€è‡ªå‹•ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ·»ä»˜URLã«è¿½åŠ ã•ã‚Œã¾ã™"></select></div>
            <div><label>é–¢é€£ã‚¿ã‚¹ã‚¯ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <select id="m_tasks" multiple size="5" style="min-height:110px;"></select>
            </div>

          </div>
          <div class="row">
            <div><label>å‚åŠ è€…ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå¯ï¼‰</label><input id="m_attendees" placeholder="å±±ç”°, ç”°ä¸­"/></div>
            <div></div>
          </div>
          <div class="toolbar">
            <button class="secondary" onclick="createMinuteDocFromForm()">ç™»éŒ²(Docsè‡ªå‹•ä½œæˆ)</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>è­°äº‹éŒ²ä¸€è¦§</h2>
        <div class="body list">
          <table id="minutesTable">
            <thead><tr><th>æ—¥ä»˜</th><th>ä»¶å</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ã‚¿ã‚¹ã‚¯</th><th>å‚åŠ è€…</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
</section>

<section class="page" id="page-daily">
  <div class="grid">
    <div class="card">
      <h2>æ—¥å ±ã‚’ç™»éŒ²</h2>
      <div class="body">
        <div class="row">
          <div><label>æ—¥ä»˜</label><input id="dr_date" type="date"/></div>
          <div><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼</label><select id="dr_user"></select></div>
        </div>
        
        <div class="toolbar">
          <button onclick="createDailyReportDocFromForm()">ç™»éŒ²</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>æ—¥å ±ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <div class="body">
        <div class="toolbar" style="margin-bottom:8px;">
          <input type="month" id="dr_month"/>
          <select id="dr_user_filter"></select>
          <button class="secondary" onclick="renderDailyCalendar()">æ›´æ–°</button>
        </div>
        <div id="daily-calendar"></div>
      </div>
    </div>

    <div class="card" id="daily-list-card">
      <h2>æ—¥å ±ä¸€è¦§</h2>
      
      <div class="body list">
        <table id="dailyTable">
          <thead><tr><th>æ—¥ä»˜</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>å·¥æ•°</th><th>å†…å®¹</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ã‚¿ã‚¹ã‚¯</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<section class="page" id="page-attendance">
  <div class="tabs" style="margin-bottom:8px;">
    <div class="tab active" id="att-view-tab-dashboard" onclick="setAttendanceView('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="tab" id="att-view-tab-summary" onclick="setAttendanceView('summary')">ã‚µãƒãƒªï¼ˆæœˆ/é€±ï¼‰</div>
  </div>
  <div class="grid">
    <div class="card" data-att-view="dashboard">
      <h2>å‹¤æ€ ï¼ˆä»Šæ—¥ï¼‰ <span class="muted" id="att-today-label"></span></h2>
      <div class="body">
        <div class="toolbar" style="justify-content:space-between;">
          <div class="toolbar">
            <button class="secondary" onclick="refreshAttendance()">æ›´æ–°</button>
            <label class="muted" style="display:flex; gap:6px; align-items:center; user-select:none;">
              <input type="checkbox" id="att_auto_refresh" /> è‡ªå‹•æ›´æ–°
            </label>
            <select id="att_auto_interval" class="secondary" style="max-width:140px;">
              <option value="10">10s</option>
              <option value="60">60s</option>
              <option value="120" selected>120s</option>
              <option value="300">300s</option>
            </select>
            <span class="muted" id="att-status"></span>
          </div>
          <div class="muted" style="font-size:12px;">æ‰“åˆ»ã¯ã‚µãƒ¼ãƒæ™‚åˆ»ã§è¨˜éŒ²</div>
        </div>
        <div id="att-cards" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="card" data-att-view="dashboard">
      <h2>å‹¤æ€ è¨­å®šï¼ˆä¼‘æ—¥/å€‹äººICSï¼‰</h2>
      <div class="body">
        <div class="row">
          <div><label>ç¥æ—¥ICS URL</label><input id="att_holiday_url" placeholder="https://...ics"/></div>
          <div><label>ä¼šç¤¾ä¼‘æ—¥ICS URLï¼ˆä»»æ„ï¼‰</label><input id="att_company_holiday_url" placeholder="https://...ics"/></div>
        </div>
        <div class="toolbar" style="margin-top:8px; justify-content:flex-end;">
          <button onclick="saveAttendanceSettings()">ä¿å­˜</button>
        </div>
        <hr/>
        <div class="muted" style="margin-top:6px;">å€‹äººICS / freeeå¾“æ¥­å“¡ç•ªå· / å‹¤æ€ ã¸ã®è¡¨ç¤º ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚¿ãƒ–ã§è¨­å®šã—ã¾ã™ã€‚</div>
      </div>
    </div>

    <div class="card" data-att-view="summary">
      <h2>æœˆæ¬¡CSV / é–²è¦§ï¼ˆfreeeé›†è¨ˆï¼‰</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap;">
          <input type="month" id="att_month"/>
          <button onclick="loadAttendanceMonth()">æœˆæ¬¡èª­ã¿è¾¼ã¿</button>
          <button class="secondary" onclick="exportFreeeAttendanceCsv()">freeeé›†è¨ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div class="muted" id="att-month-summary" style="margin-top:6px;"></div>
        <div class="body list" style="padding:0; margin-top:8px;">
          <table id="att-month-table">
            <thead><tr><th>æ—¥ä»˜</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>çŠ¶æ…‹</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th><th>å‹¤å‹™(æ¦‚ç®—)</th><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ã‚¿ã‚¹ã‚¯</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" data-att-view="summary">
      <h2>é€±æ¬¡ã‚µãƒãƒª</h2>
      <div class="body">
        <div class="muted" id="att-week-summary" style="margin-top:6px;"></div>
        <div class="body list" style="padding:0; margin-top:8px;">
          <table id="att-week-table">
            <thead><tr><th>é€±(é–‹å§‹)</th><th>é€±(çµ‚äº†)</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>å‹¤å‹™æ—¥æ•°</th><th>å‹¤å‹™(æ¦‚ç®—)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

</div>

<script>
// --- google.script.run polyfill (for Vercel/static hosting) ---
// GASã® `google.script.run.withSuccessHandler().withFailureHandler().fn(...args)` ã‚’
// `/api/rpc` POST ã«æ©‹æ¸¡ã—ã—ã¾ã™ã€‚
(function initGoogleScriptRunPolyfill(){
  const g = (window.google = window.google || {});
  const script = (g.script = g.script || {});
  if (script.run) return;

  function createRunner(){
    let onSuccess = null;
    let onFailure = null;

    const runner = new Proxy({}, {
      get(_target, prop){
        if (prop === 'withSuccessHandler') {
          return function(fn){ onSuccess = fn; return runner; };
        }
        if (prop === 'withFailureHandler') {
          return function(fn){ onFailure = fn; return runner; };
        }

        // google.script.run.<name>(...args)
        return async function(...args){
          const success = onSuccess;
          const failure = onFailure;
          onSuccess = null;
          onFailure = null;

          try{
            const resp = await fetch('/api/rpc', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ name: String(prop), args })
            });

            const raw = await resp.text().catch(() => '');
            let data = null;
            try { data = raw ? JSON.parse(raw) : null; } catch { data = { ok: false, error: raw || 'RPC error' }; }
            if (!resp.ok || !data || data.ok !== true) {
              throw new Error((data && data.error) ? data.error : `RPC failed: ${resp.status}`);
            }
            if (typeof success === 'function') success(data.result);
          } catch (e) {
            if (typeof failure === 'function') failure(e);
            else throw e;
          }
        };
      }
    });

    return runner;
  }

  script.run = createRunner();
})();

// === ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆã‚¢å·®åˆ†é©ç”¨ï¼ˆè¶…è»½é‡ï¼‰ ===
function patchRow(tableKey, row){
  const k = tableKey;             // 'tasks' / 'projects' / 'users' ãªã©
  const arr = safeArr(DATA[k]).slice();
  const i = arr.findIndex(x => String(x.id) === String(row.id));
  if (i >= 0) arr[i] = Object.assign({}, arr[i], row);
  else arr.unshift(row);
  DATA[k] = arr;
}
function dropRow(tableKey, id){
  DATA[tableKey] = safeArr(DATA[tableKey]).filter(x => String(x.id) !== String(id));
}

// æœ€å°é™ã ã‘å†æç”»ï¼ˆé‡ã„ refresh ã¯ç¦æ­¢ï¼‰
function rerenderAfter(tableKey){
  switch (tableKey){
    case 'tasks':
      renderTasksTable();
      if (ACTIVE_TAB === 'board') renderKanban();
      if (ACTIVE_TAB === 'gantt') renderGantt();
      renderProjects();           // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ã®ã€Œæœª/å®Œäº†æ•°ã€ã‚‚æ›´æ–°
      break;
    case 'projects':
      hydrateSelects();
      renderProjects();
      renderTasksTable();         // ã‚¿ã‚¹ã‚¯ã«è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§
      break;
    case 'users':
      hydrateSelects();
      renderUsers();
      break;
    case 'subs':
      renderSubs(); renderBudget();
      break;
    case 'ledger':
      renderLedger(); renderBudget();
      break;
    case 'ledgerPlans':
      // è¨ˆç”»â†’å®Ÿç¸¾ã«åæ˜ ã•ã‚Œã‚‹ã®ã¯æœã‚¸ãƒ§ãƒ–ãªã®ã§å³æç”»ã¯è»½ã‚ã§OK
      break;
    case 'credentials':
      renderCreds();
      break;
  }
}

function gas(name, ...args){return new Promise((res,rej)=>{try{google.script.run.withSuccessHandler(res).withFailureHandler(rej)[name](...args);}catch(e){rej(e)}});}
let APP_VERSION = null;

    window.addEventListener('load', () => {
    google.script.run
      .withSuccessHandler(v => {
        APP_VERSION = v;
        const el = document.getElementById('app-version');  // â† ver ã§ã¯ãªã app-version
        if (el) el.textContent = v ?? '(æœªè¨­å®š)';
      })
      .withFailureHandler(err => {
        console.error(err);
        const el = document.getElementById('app-version');  // â† åŒä¸Š
        if (el) el.textContent = 'å–å¾—ã‚¨ãƒ©ãƒ¼';
      })
      //.getVersion();
  });

// --- semver helperï¼ˆã‚µãƒ¼ãƒãŒå¤ã„verã§ã‚‚ä¸Šæ›¸ãã—ãªã„ï¼‰ ---
function parseSemver(v){
  if(!v) return null;
  const s=String(v).trim().replace(/^v/i,'');
  const [a,b,c] = s.split('.').map(x=>parseInt(x,10)||0);
  return {a,b,c,raw:String(v)};
}
function newerVersionPrefer(clientV, serverV){
  const c=parseSemver(clientV), s=parseSemver(serverV);
  if(!s) return c?.raw || clientV;
  if(!c) return s.raw;
  if(s.a>c.a) return s.raw;
  if(s.a<c.a) return c.raw;
  if(s.b>c.b) return s.raw;
  if(s.b<c.b) return c.raw;
  if(s.c>c.c) return s.raw;
  return c.raw;
}

// --- Navigation ---
function updateRouteParams(next, { replace=false } = {}){
  try{
    const url = new URL(window.location.href);
    Object.entries(next||{}).forEach(([k,v])=>{
      if (v === null || v === undefined || v === '') url.searchParams.delete(k);
      else url.searchParams.set(String(k), String(v));
    });
    const qs = url.searchParams.toString();
    const nextUrl = url.pathname + (qs ? ('?'+qs) : '') + url.hash;
    if (replace) history.replaceState({}, '', nextUrl);
    else history.pushState({}, '', nextUrl);
  }catch(_){ }
}

function readRouteParams(){
  const p = new URLSearchParams(location.search || '');
  const page = String(p.get('page') || '').trim();
  const view = String(p.get('view') || '').trim();
  const tab = String(p.get('tab') || '').trim();
  return { page, view, tab };
}

function applyRouteFromUrl(){
  const { page, view, tab } = readRouteParams();

  // IMPORTANT:
  // `tab` is the dashboard's task tab (list/board/gantt).
  // If we apply it while opening attendance, switchTab() may redirect to dashboard.
  // Therefore we:
  // 1) decide the target page first
  // 2) navigate to page
  // 3) apply tab only when the target page is dashboard

  const targetPage = page || PAGE || 'dashboard';
  if (targetPage === 'attendance') {
    ATT_VIEW = (view === 'summary') ? 'summary' : 'dashboard';
  }

  if (page) {
    goto(page, { skipRoute:true });
  }

  const effectivePage = page || PAGE;
  if (effectivePage === 'dashboard') {
    if (tab) {
      try { switchTab(tab); } catch(_){ }
    }
  }

  if (PAGE === 'attendance') {
    applyAttendanceViewUi();
    if (ATT_VIEW === 'summary') {
      try { loadAttendanceMonth?.(); } catch(_){ }
    }
  }
}

window.addEventListener('popstate', ()=>{ try{ applyRouteFromUrl(); }catch(_){ } });

function syncStickyOffsets(){
  try{
    const root = document.documentElement;
    const header = document.querySelector('header');
    const globalToolbar = document.getElementById('global-toolbar');
    const filters = document.querySelector('#page-dashboard .filters.sticky, #page-dashboard .filters');

    const headerH = header ? Math.round(header.getBoundingClientRect().height) : 56;
    const toolbarH = (globalToolbar && globalToolbar.offsetParent !== null)
      ? Math.round(globalToolbar.getBoundingClientRect().height)
      : 0;
    const filtersH = (filters && filters.offsetParent !== null)
      ? Math.round(filters.getBoundingClientRect().height)
      : 46;

    root.style.setProperty('--header-h', headerH + 'px');
    root.style.setProperty('--toolbar-h', toolbarH + 'px');
    root.style.setProperty('--filters-h', filtersH + 'px');
  }catch(_){ }
}

function goto(page, opts) {
  opts = opts || {};
  // æ­£è¦åŒ–ï¼ˆsharedsâ†’sharedï¼‰
  const aliases = { shareds:'shared' };
  page = aliases[page] || page;

  // Attendance auto-refresh must stop when leaving attendance.
  try {
    if (PAGE === 'attendance' && page !== 'attendance') {
      stopAttendanceAutoRefresh({ uncheck:true, reason:'navigate' });
    }
  } catch(_){ }

  // URL: query param deep-link
  if (!opts.skipRoute) {
    if (page === 'attendance') {
      // `tab` is for dashboard task tabs (list/board/gantt). Do not include it for attendance.
      updateRouteParams({ page:'attendance', view: (ATT_VIEW||'dashboard'), tab: null }, { replace:false });

      // Clear hash as well: it may contain #tab=list from dashboard bookmarks.
      try{
        if (location.hash) {
          const url = new URL(location.href);
          url.hash = '';
          const qs = url.searchParams.toString();
          history.replaceState({}, '', url.pathname + (qs ? ('?'+qs) : ''));
        }
      }catch(_){ }
    } else {
      updateRouteParams({ page, view: null, tab: ACTIVE_TAB }, { replace:false });
    }
  }

  const pages = ['dashboard','minutes','daily','attendance','users','vault','budget','subs','ledger','projects','debug','shared'];
  pages.forEach(p => {
    const pageEl = document.getElementById('page-'+p);
    if (pageEl) pageEl.classList.toggle('active', p===page);
    const navEl = document.getElementById('nav-'+p);
    if (navEl) navEl.classList.toggle('active', p===page);
  });
  const showDebug = (page === 'debug');
  ['debug-bar','debug-snapshot','sheet-chip'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = showDebug ? '' : 'none';
  });
  PAGE = page;
  try { renderAll(); } catch (e) {}
  try { setTimeout(syncStickyOffsets, 0); } catch(_){ }
  if (page === 'attendance') {
    applyAttendanceViewUi();
    try { loadAttendanceSettings?.(); } catch (e) {}
    if (ATT_VIEW === 'dashboard') {
      try { refreshAttendance?.(); } catch (e) {}
    } else {
      try { loadAttendanceMonth?.(); } catch (e) {}
    }
  }
}

// Navigate to dashboard and select a task tab (list/board/gantt).
// Used by shortcuts that may be clicked while on another page.
function gotoDashboardTab(tab){
  const t = (tab==='board' || tab==='gantt') ? tab : 'list';
  try{ goto('dashboard'); }catch(_){ }
  setTimeout(()=>{ try{ switchTab(t); }catch(_){ } }, 0);
}

// --- Data & Filters ---
let DATA = {users:[], projects:[], tasks:[], subs:[], ledger:[], ledgerPlans:[], credentials:[], attachments:[], minutes:[], dailyReports:[], shareds:[]};
let FILTERS = { keyword:'', project:'', assignee:'', from:'', to:'', priority:'', status:'' };
let PAGE = 'dashboard';
let ACTIVE_TAB = 'list';
let GANTT_SCALE = (localStorage.getItem('gantt_scale')||'day');
// æ·»ä»˜ä»¶æ•°
function countAttachments(kind, id){
  return safeArr(DATA.attachments).filter(a => a.parentType===kind && String(a.parentId)===String(id)).length;
}
const FILTERS_KEY = 'pm_filters_v1';
let OVERDUE = false; // é…å»¶ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿
const dayMs = 24*60*60*1000; // ã‚°ãƒ­ãƒ¼ãƒãƒ«æ—¥ãƒŸãƒªç§’ï¼ˆã‚¬ãƒ³ãƒˆ/æ—¥ä»˜è¨ˆç®—ã§ä½¿ç”¨ï¼‰

function saveFiltersToLS(){
  const payload = { ...FILTERS, overdue: OVERDUE ? 1 : 0 };
  try{ localStorage.setItem(FILTERS_KEY, JSON.stringify(payload)); }catch(_){}
}
function loadFiltersFromLS(){
  try{
    const raw = localStorage.getItem(FILTERS_KEY);
    if(!raw) return;
    const f = JSON.parse(raw)||{};
    OVERDUE = String(f.overdue||'0')==='1';
    FILTERS = {
      keyword: f.keyword||'',
      project: f.project||'',
      assignee: f.assignee||'',
      from: f.from||'',
      to: f.to||'',
      priority: f.priority||'',
      status: f.status||''
    };
    // UIã¸åæ˜ ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã¯ hydrateSelects ã§ã‚‚å†è¨­å®šã•ã‚Œã¾ã™ï¼‰
    const map = {keyword:'f_keyword', project:'f_project', assignee:'f_assignee', from:'f_from', to:'f_to', priority:'f_priority', status:'f_status'};
    Object.keys(map).forEach(k=>{ const e=el(map[k]); if(e) e.value=FILTERS[k]||''; });
  }catch(_){}
}

function setGanttScale(v){ GANTT_SCALE = (v==='month'?'month':(v==='week'?'week':'day')); localStorage.setItem('gantt_scale', GANTT_SCALE); renderGantt(); }

// display labels (status/priority)
const STATUS_LABELS = { todo:'æœªç€æ‰‹', doing:'é€²è¡Œä¸­', blocked:'ä¿ç•™ä¸­', done:'å®Œäº†' };
const PRIORITY_IN = { 'High':'é«˜', 'Middle':'ä¸­', 'Medium':'ä¸­', 'Low':'ä½', 'é«˜':'é«˜', 'ä¸­':'ä¸­', 'ä½':'ä½' };
function normPriority(p){ return PRIORITY_IN[String(p||'').trim()] || String(p||''); }
function labelStatus(code){ return STATUS_LABELS[String(code||'').toLowerCase()] || String(code||''); }

function emptyData(){ return {users:[], projects:[], tasks:[], subs:[], ledger:[], credentials:[]}; }
function safeArr(a){ return Array.isArray(a) ? a : []; }

// --- Busy indicator ---
const Busy = {
  _n: 0,
  show(){ const el = document.getElementById('busy-indicator'); if (el) el.style.display = ''; },
  hide(){ const el = document.getElementById('busy-indicator'); if (el) el.style.display = 'none'; },
  push(){ this._n++; this.show(); },
  pop(){ this._n = Math.max(0, this._n-1); if (this._n===0) this.hide(); },
  async wrap(p){ this.push(); try{ return await p; } finally{ this.pop(); } }
};

// â˜… æ—¢å­˜ refresh ã‚’ç½®ãæ›ãˆï¼ˆä¸­èº«ã¯ãã®ã¾ã¾ã€å‰å¾Œã« Busy ã‚’è¿½åŠ ï¼‰
function refresh() {
  Busy.push();
  google.script.run
    .withSuccessHandler((raw)=>{
      const d0 = (raw && typeof raw==='object') ? raw : {};
      const d = Object.fromEntries(Object.entries(d0).map(([k,v])=>[String(k).toLowerCase(), v]));
      const pick = (...keys)=> { for (const k of keys){ const v = d[String(k).toLowerCase()]; if (Array.isArray(v)) return v; } return []; };

      DATA = {
        users:        pick('users'),
        projects:     pick('projects'),
        tasks:        pick('tasks'),
        subs:         pick('subs','subscriptions'),
        ledger:       pick('ledger','ledgers'),
        ledgerPlans:  pick('ledgerplans'),
        credentials:  pick('credentials'),
        attachments:  pick('attachments'),
        minutes:      pick('minutes'),
        dailyReports: pick('dailyreports','daily_reports','daily'),
        shareds:      safeArr(d.shareds ?? d.Shareds ?? d.shared),
      };
      hydrateSelects();
      renderAll();
      Busy.pop();
    })
    .withFailureHandler(err => {
      console.error(err);
      showToast && showToast('ng','ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
      Busy.pop();
    })
    .getAllData();
}


// --- Helpers for names/lookup ---
function nameByUserId(id){ const u = safeArr(DATA.users).find(x=>x.id===id); return u ? (u.name || u.email || u.id) : id; }
function projectById(id){ return safeArr(DATA.projects).find(x=>x.id===id); }
function nameByProjectId(id){ const p = projectById(id); return p ? (p.name || p.id) : id; }

function getProjectDocUrl(pid){
  const p = projectById(pid); if (!p) return '';
  const url = p.docUrl || (p.docID||p.docId ? 'https://docs.google.com/document/d/'+(p.docID||p.docId) : '');
  return url || '';
}
function getTaskDocUrl(tid){
  const t = safeArr(DATA.tasks).find(x=>x.id===tid); if (!t) return '';
  const url = t.docUrl || (t.docID||t.docId ? 'https://docs.google.com/document/d/'+(t.docID||t.docId) : '');
  return url || '';
}
function openProjectDocById(pid){
  const url = getProjectDocUrl(pid);
  if (url) window.open(url,'_blank'); else alert('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Docsã¯æœªä½œæˆã§ã™');
}
function openTaskDocById(tid){
  const url = getTaskDocUrl(tid);
  if (url) window.open(url,'_blank'); else alert('ã“ã®ã‚¿ã‚¹ã‚¯ã®Docsã¯æœªä½œæˆã§ã™');
}
// æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ãƒ—ãƒ¬ã‚¤ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
const SELECT_PLACEHOLDERS = {
  f_project:   'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
  f_assignee:  'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
  proj_f_owner:'ãƒ¦ãƒ¼ã‚¶ãƒ¼'     // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚‚é©ç”¨
};
// --- Selects ---
function hydrateSelects(){
  const users     = safeArr(DATA.users);
  const projects  = safeArr(DATA.projects);
  const activePjs = projects.filter(p => String(p.status||'').toLowerCase() !== 'archived');

  // æ±ç”¨: ã‚»ãƒ¬ã‚¯ãƒˆã¸æµã—è¾¼ã¿ï¼ˆç©º=ãƒ—ãƒ¬ã‚¤ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ–‡è¨€ã‚’è¡¨ç¤ºï¼‰
  const set = (id, items, {empty=true, label=x=>x.name||x.title||x.id||'', value=x=>x.id}={})=>{
    const el = document.getElementById(id); if(!el) return;
    while(el.options.length) el.remove(0);

    if (empty) {
      const ph = SELECT_PLACEHOLDERS[id] || 'ï¼ˆæœªé¸æŠï¼‰';
      // ç©ºå€¤ã® option ã‚’å…ˆé ­ã«ï¼ˆé¸æŠå¯èƒ½ã®ã¾ã¾ï¼šç©º=ãƒ•ã‚£ãƒ«ã‚¿ç„¡åŠ¹ã®æ„å‘³ï¼‰
      const o = new Option(ph, '');
      el.add(o);
    }

    items.forEach(it => el.add(new Option(label(it), value(it))));

    // è¦‹ãŸç›®ã®è–„å­—åˆ‡æ›¿ï¼ˆå€¤ãŒç©ºãªã‚‰ is-placeholderï¼‰
    const applyPH = ()=>{
      if (!el) return;
      el.classList.toggle('is-placeholder', !el.value);
    };
    el.addEventListener('change', applyPH, { once:false });
    // åˆæœŸçŠ¶æ…‹ï¼ˆLSå¾©å…ƒç­‰ã§å€¤ãŒå…¥ã‚‹å‰ã«ä¸€æ—¦åˆ¤å®šï¼‰
    applyPH();
  };

  // --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠï¼ˆãƒ•ã‚©ãƒ¼ãƒ ç³»ã¯éã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ã¿ï¼‰ ---
  ['p_parent_select','t_project_select','s_project','l_project','lp_project','m_project','dr_project']
    .forEach(id => set(id, activePjs, {empty:true, label:p=>p.name||p.id, value:p=>p.id}));

  // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã¯å…¨ä»¶ï¼ˆéå»å‚ç…§ã®ãŸã‚ï¼‰
  set('f_project', projects, {empty:true, label:p=>p.name||p.id, value:p=>p.id});

  // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç³» ---
  ['p_owner_select','t_owner_select','f_assignee','dr_user','sh_owner','c_owner']
    .forEach(id => set(id, users, {empty:true, label:u=>u.name||u.email||u.id, value:u=>u.id}));

  // ã‚¿ã‚¹ã‚¯æ‹…å½“ï¼ˆè¤‡æ•°é¸æŠï¼‰
  const multi = document.getElementById('t_assignees_select');
  if (multi){
    while(multi.options.length) multi.remove(0);
    users.forEach(u => multi.add(new Option(u.name||u.email||u.id, u.id)));
    multi.size = Math.min(Math.max(users.length, 3), 10);
  }

  // --- Minutes/æ—¥å ±ã®ã€Œé–¢é€£ã‚¿ã‚¹ã‚¯ã€ï¼šæœªå®Œï¼‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–PJã®ã¿ ---
  const openTasks = safeArr(DATA.tasks).filter(t=>{
    const notDone  = String(t.status||'').toLowerCase() !== 'done';
    const pj       = projects.find(p=>String(p.id)===String(t.projectId));
    const pjActive = !pj || String(pj.status||'').toLowerCase() !== 'archived';
    return notDone && pjActive;
  });
  const setMulti = (id, items, min=5, max=12)=>{
    const el = document.getElementById(id); if(!el) return;
    while(el.options.length) el.remove(0);
    items.forEach(t => el.add(new Option(t.title || t.id, t.id)));
    el.size = Math.min(Math.max(items.length, min), max);
  };
  setMulti('m_tasks', openTasks, 5, 12);
  setMulti('dr_tasks', openTasks, 6, 12);

  // --- ãƒ•ã‚£ãƒ«ã‚¿ã®å€¤ã‚’UIã«å¾©å…ƒ ---
  const map = { project:'f_project', assignee:'f_assignee', priority:'f_priority', status:'f_status' };
  Object.keys(map).forEach(k => { const e = document.getElementById(map[k]); if(e) e.value = FILTERS[k] || ''; });
  ['f_keyword','f_from','f_to'].forEach(id => { const e = document.getElementById(id); if(e) e.value = (FILTERS[id.replace('f_','')] || ''); });

  // ï¼ˆä»»æ„ï¼‰ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
  const snap = document.getElementById('debug-snapshot');
  if (snap){
    const uShow = users.slice(0,2).map(u=>u.name||u.email||u.id).join(', ') || '-';
    const pShow = projects.slice(0,2).map(p=>p.name||p.id).join(', ') || '-';
    snap.textContent = `[Client] Users:${users.length} / Projects:${projects.length} | ${uShow} | ${pShow}`;
  }
}


// è¿½åŠ : DnDã§IDã‚’å®‰å…¨ã«å–ã‚Šå‡ºã™ï¼ˆtext/plain ã¨ text ä¸¡å¯¾å¿œï¼‰
function _dragId_(ev){
  if (!ev || !ev.dataTransfer) return '';
  return ev.dataTransfer.getData('text/plain') || ev.dataTransfer.getData('text') || '';
}

// ç½®æ›: allowDrop ã‚’å°‘ã—å¼·åŒ–
function allowDrop(ev){
  if (ev && ev.preventDefault) ev.preventDefault();
  if (ev && ev.dataTransfer) ev.dataTransfer.dropEffect = 'move';
}
function onDrop(ev, status){
  try{
    if (ev && ev.preventDefault) ev.preventDefault();
    const id = _dragId_(ev); 
    if(!id) return;

    // ä»ŠãŒã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³ã‹ï¼Ÿã©ã®ãƒ¬ãƒ¼ãƒ³ã«è½ã¡ãŸã‹ï¼Ÿ
    const isSwim = !!document.getElementById('opt_swimlane')?.checked;
    const laneEl = ev.target && ev.target.closest ? ev.target.closest('[data-lane-key]') : null;
    const laneKey = laneEl ? laneEl.getAttribute('data-lane-key') : '';

    // ã‚¹ã‚¤ãƒ ONã‹ã¤ laneKey ãŒå–ã‚ŒãŸã‚‰ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‹æ‹…å½“è€…(assignees)ã‚‚æ›´æ–°
    if (isSwim && laneKey){
      const t = safeArr(DATA.tasks).find(x=>x.id===id);
      if(!t){ moveStatus(id, status); return; }

      let ass = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);

      if (laneKey === '__NONE__'){
        // æœªå‰²å½“ãƒ¬ãƒ¼ãƒ³ã«è½ã¨ã—ãŸ â†’ æ‹…å½“è€…ã‚¯ãƒªã‚¢
        ass = [];
      } else {
        // å…ˆé ­ã‚’ãã®ãƒ¬ãƒ¼ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ï¼ˆé‡è¤‡ã¯æ’é™¤ï¼‰
        ass = [laneKey, ...ass.filter(a => a !== laneKey)];
      }

      const patch = Object.assign({}, t, {
        status,
        assignees: ass.join(',')
      });

      google.script.run
        .withSuccessHandler(()=>{ refresh(); })
        .withFailureHandler(err => {
          console.error(err);
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘ã§ã‚‚åæ˜ ã—ã¦ãŠã
          moveStatus(id, status);
        })
        .upsertTask(patch);
      return;
    }

    // ã‚¹ã‚¤ãƒ OFFï¼ˆå¾“æ¥é€šã‚Šï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘ï¼‰
    moveStatus(id, status);
  }catch(e){ console.error(e); }
}


// --- Updates (max 10) ---
function renderUpdates(){
  const elx = document.getElementById('updates-feed'); if (!elx) return;
  const items = [];
  safeArr(DATA.projects).forEach(p=>items.push({type:'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', title:p.name||p.id, when:p.updatedAt||p.createdAt||''}));
  safeArr(DATA.tasks).forEach(t=>items.push({type:'ã‚¿ã‚¹ã‚¯', title:t.title||t.id, when:t.updatedAt||t.createdAt||''}));
  items.sort((a,b)=>String(b.when||'').localeCompare(String(a.when||'')));
  elx.innerHTML = items.slice(0,10).map(it=>`<div class="row" style="justify-content:space-between;">
      <div>${it.type}ï¼š<b>${escapeHtml(it.title)}</b></div><div class="muted">${it.when||''}</div></div>`).join('')
    || '<div class="muted">æ›´æ–°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
}

// textarea ã‚’å†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•ã§ä¼¸ç¸®
function autosizeTA(ta){
  if (!ta) return;
  ta.style.height = 'auto';               // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
  ta.style.height = ta.scrollHeight + 'px';
}

// ä¸€è¦§ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ã«ã‚ã‚‹ .memo-edit ã‚’å…¨éƒ¨å¯¾è±¡ã«ã™ã‚‹
function attachDefaultMemoEditors(){
  const list = document.querySelectorAll('textarea.memo-edit');
  list.forEach(ta => {
    // åˆæœŸé«˜ã•
    requestAnimationFrame(() => autosizeTA(ta));
    // å…¥åŠ›ã®ãŸã³ã«ä¼¸ç¸®
    ta.removeEventListener?.(_autosizeHandlerName, ta._autosizeHandler); // å¤šé‡ãƒã‚¤ãƒ³ãƒ‰å›é¿
    ta._autosizeHandler = () => autosizeTA(ta);
    ta.addEventListener('input', ta._autosizeHandler);
  });
}
// ã‚¤ãƒ™ãƒ³ãƒˆåã®è¡çªå›é¿ç”¨
const _autosizeHandlerName = 'input';


// --- Rendering (tasks/kanban/projects/subs/ledger) ---
function renderAll() {
  renderBudget();
  renderUpdates();
  renderTasksTable();
  renderKanban();
  renderProjects();
  renderShareds?.();      // â† æœªå®šç¾©ã§ã‚‚è½ã¡ãªã„
  renderSubs();
  renderLedger();
  renderUsers();
  renderCreds();
  renderProjectsPage?.();
  renderAttendancePage?.();
  if (ACTIVE_TAB === 'gantt') renderGantt();

  // ã“ã“ã‚’è¿½åŠ ï¼ˆã‚¿ãƒ–å´ã§æ—©æœŸreturnã™ã‚‹å®‰å…¨ãªãƒ¬ãƒ³ãƒ€ãƒ©ï¼‰
  renderLedgerPage();
  renderMinutesPage();
  renderDailyPage();

  // ãƒ¡ãƒ¢ã®è‡ªå‹•ä¼¸ç¸®
  attachDefaultMemoEditors();
}

// è¿½åŠ ï¼šä»Šæ—¥ã‚’ "YYYY-MM-DD" ã§è¿”ã™
function todayStr(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// =============================
// Attendance (Vercel)
// =============================
const ATT = {
  dayRows: [],
  monthRows: [],
  settings: { holidayUrl: '', companyHolidayUrl: '' },
  holidayDates: new Set(),
  companyHolidayDates: new Set(),
  nextEventsByUser: {},
  currentEventsByUser: {},
};

let ATT_VIEW = 'dashboard'; // 'dashboard' | 'summary'

let ATT_AUTO_REFRESH_ENABLED = false;
let ATT_AUTO_REFRESH_INTERVAL_MS = 120000; // default 120s
let ATT_AUTO_REFRESH_TIMER = null;

function isAttendanceAutoRefreshEligible(){
  return (PAGE === 'attendance' && ATT_VIEW === 'dashboard');
}

function setAttendanceAutoRefreshUi(enabled){
  const cb = document.getElementById('att_auto_refresh');
  if (cb) cb.checked = !!enabled;
}

function readAttendanceAutoRefreshIntervalFromUi(){
  const sel = document.getElementById('att_auto_interval');
  const v = sel ? Number(sel.value) : NaN;
  if (!Number.isFinite(v) || v <= 0) return;
  ATT_AUTO_REFRESH_INTERVAL_MS = v * 1000;
}

function applyAttendanceAutoRefreshIntervalToUi(){
  const sel = document.getElementById('att_auto_interval');
  if (!sel) return;
  const sec = Math.round((ATT_AUTO_REFRESH_INTERVAL_MS||120000) / 1000);
  sel.value = String(sec);
}

function startAttendanceAutoRefresh(){
  ATT_AUTO_REFRESH_ENABLED = true;
  readAttendanceAutoRefreshIntervalFromUi();
  setAttendanceAutoRefreshUi(true);

  if (ATT_AUTO_REFRESH_TIMER) {
    clearInterval(ATT_AUTO_REFRESH_TIMER);
    ATT_AUTO_REFRESH_TIMER = null;
  }

  // Immediate refresh on start (best-effort)
  try { if (isAttendanceAutoRefreshEligible()) refreshAttendance?.(); } catch(_){ }

  ATT_AUTO_REFRESH_TIMER = setInterval(async ()=>{
    try {
      if (!ATT_AUTO_REFRESH_ENABLED) {
        stopAttendanceAutoRefresh({ uncheck:false, reason:'disabled' });
        return;
      }
      if (!isAttendanceAutoRefreshEligible()) {
        stopAttendanceAutoRefresh({ uncheck:true, reason:'not-eligible' });
        return;
      }
      await refreshAttendance?.();
    } catch(_){ }
  }, ATT_AUTO_REFRESH_INTERVAL_MS);
}

function stopAttendanceAutoRefresh({ uncheck=false, reason='' } = {}){
  ATT_AUTO_REFRESH_ENABLED = false;
  if (ATT_AUTO_REFRESH_TIMER) {
    clearInterval(ATT_AUTO_REFRESH_TIMER);
    ATT_AUTO_REFRESH_TIMER = null;
  }
  if (uncheck) setAttendanceAutoRefreshUi(false);
}

function applyAttendanceViewUi(){
  const d = document.getElementById('att-view-tab-dashboard');
  const s = document.getElementById('att-view-tab-summary');
  if (d) d.classList.toggle('active', ATT_VIEW === 'dashboard');
  if (s) s.classList.toggle('active', ATT_VIEW === 'summary');
  const page = document.getElementById('page-attendance');
  if (page) {
    page.classList.toggle('att-layout-dashboard', ATT_VIEW === 'dashboard');
    page.classList.toggle('att-layout-summary', ATT_VIEW === 'summary');
  }
  document.querySelectorAll('#page-attendance [data-att-view]').forEach(el=>{
    const v = el.getAttribute('data-att-view');
    el.style.display = (v === ATT_VIEW) ? '' : 'none';
  });
}

function setAttendanceView(view, opts){
  opts = opts || {};
  ATT_VIEW = (String(view) === 'summary') ? 'summary' : 'dashboard';
  applyAttendanceViewUi();

  // If user leaves dashboard view, stop auto-refresh.
  if (ATT_VIEW !== 'dashboard') {
    try { stopAttendanceAutoRefresh({ uncheck:true, reason:'view-change' }); } catch(_){ }
  }
  if (!opts.skipRoute) {
    updateRouteParams({ page:'attendance', view: ATT_VIEW, tab: ACTIVE_TAB }, { replace:false });
  }
  if (PAGE === 'attendance') {
    if (ATT_VIEW === 'dashboard') {
      try { refreshAttendance?.(); } catch(_){ }
    } else {
      try { loadAttendanceMonth?.(); } catch(_){ }
    }
  }
}

const fixedBreakMinutes = 90;
const defaultHolidayIcs = 'https://www.google.com/calendar/ical/ja.japanese%23holiday%40group.v.calendar.google.com/public/basic.ics';

function attStatusLabel(s){
  return ({'not-clocked':'æœªæ‰“åˆ»', working:'å‡ºå‹¤ä¸­', break:'ä¼‘æ†©ä¸­', out:'å¤–å‡ºä¸­', done:'é€€å‹¤æ¸ˆ'})[String(s||'not-clocked')] || String(s||'');
}
function attLocLabel(l){
  return ({office:'ã‚ªãƒ•ã‚£ã‚¹', remote:'ãƒ†ãƒ¬ãƒ¯ãƒ¼ã‚¯', out:'å¤–å‡º'})[String(l||'office')] || String(l||'');
}
function attFormatTime(iso){
  if(!iso) return '--:--';
  try{ return new Date(iso).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',hour12:false}); }catch(_){ return '--:--'; }
}
function attFormatMDHM(iso){
  if(!iso) return '--/-- --:--';
  try{ return new Date(iso).toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }catch(_){ return '--/-- --:--'; }
}
function minutesBetweenIso(startIso, endIso){
  if(!startIso) return 0;
  const end = endIso ? new Date(endIso) : new Date();
  const start = new Date(startIso);
  const ms = end.getTime() - start.getTime();
  return Math.max(0, Math.round(ms / 60000));
}
function minutesToLabel(mins){
  const h = Math.floor(mins/60);
  const m = mins%60;
  return `${h}æ™‚é–“${m}åˆ†`;
}

function normalizeUrl(url){ return String(url||'').trim().startsWith('http') ? String(url||'').trim() : `https://${String(url||'').trim()}`; }
function buildIcsProxyUrl(targetUrl){ return `/api/ics?url=${encodeURIComponent(targetUrl)}`; }
function canonicalizeIcsUrl(raw){
  const normalized = normalizeUrl(String(raw||'').trim());
  try{
    const u = new URL(normalized);
    if (u.pathname.includes('/calendar/embed')){
      const src = u.searchParams.get('src');
      if(src){ return `https://calendar.google.com/calendar/ical/${encodeURIComponent(src)}/public/basic.ics`; }
    }
  }catch(_){ }
  return normalized;
}

function parseIcsDate(raw){
  if(!raw) return undefined;
  if (/^\d{8}$/.test(raw)){
    return new Date(`${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}T00:00:00`);
  }
  const m = String(raw).match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
  if (m){
    const [,y,mo,d,hh,mm,ss,z] = m;
    if(z){ return new Date(Date.UTC(Number(y), Number(mo)-1, Number(d), Number(hh), Number(mm), Number(ss))); }
    return new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}`);
  }
  const parsed = Date.parse(raw);
  if (isNaN(parsed)) return undefined;
  return new Date(parsed);
}

function pickNextAndCurrentEventFromIcs(text){
  const now = new Date();
  const blocks = String(text||'').split('BEGIN:VEVENT').slice(1);
  let next = null;
  let current = null;
  blocks.forEach(block=>{
    const lines = String(block||'').split(/\r?\n/);
    const findLine = key => lines.find(l=>String(l||'').startsWith(key));
    const dtStartLine = findLine('DTSTART');
    if(!dtStartLine) return;
    const rawStart = String(dtStartLine).split(':').slice(1).join(':');
    const startDate = parseIcsDate(rawStart);
    if(!startDate || isNaN(startDate.getTime())) return;
    const dtEndLine = findLine('DTEND');
    const rawEnd = dtEndLine ? String(dtEndLine).split(':').slice(1).join(':') : '';
    const endDate = rawEnd ? parseIcsDate(rawEnd) : undefined;
    const summaryLine = findLine('SUMMARY');
    const summary = summaryLine ? String(summaryLine).split(':').slice(1).join(':') : undefined;
    const locationLine = findLine('LOCATION');
    const location = locationLine ? String(locationLine).split(':').slice(1).join(':') : undefined;
    const startIso = startDate.toISOString();
    const endIso = (endDate && !isNaN(endDate.getTime())) ? endDate.toISOString() : undefined;

    if (startDate <= now && (!endDate || endDate >= now)){
      const candidate = { start:startIso, end:endIso, summary, location };
      if(!current || new Date(candidate.start) < new Date(current.start)) current = candidate;
      return;
    }
    if (startDate > now){
      const candidate = { start:startIso, end:endIso, summary, location };
      if(!next || new Date(candidate.start) < new Date(next.start)) next = candidate;
    }
  });
  return { next, current };
}

const _icsCache = new Map(); // url -> {text, ts}
async function fetchIcsText(url){
  const raw = String(url||'').trim();
  if(!raw) throw new Error('Empty calendar URL');
  const target = canonicalizeIcsUrl(raw);
  const cached = _icsCache.get(target);
  const TTL = 5*60*1000;
  if(cached && (Date.now()-cached.ts) < TTL) return cached.text;

  const candidates = [ buildIcsProxyUrl(target), target ];
  let lastErr = null;
  for (let i=0;i<candidates.length;i++){
    const endpoint = candidates[i];
    try{
      const controller = new AbortController();
      const tid = setTimeout(()=>controller.abort(), 10000);
      const res = await fetch(endpoint, { signal: controller.signal });
      clearTimeout(tid);
      if(!res.ok) throw new Error(`ICS fetch failed: ${res.status}`);
      const text = await res.text();
      if(!String(text||'').trim()) throw new Error('ICS empty response');
      _icsCache.set(target, {text, ts: Date.now()});
      return text;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('ICS fetch failed');
}

function parseHolidayDatesFromIcs(text){
  const toLocalDateKey = d => {
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  const addDateRange = (start, endExclusive) => {
    const out=[];
    const cursor = new Date(start);
    cursor.setHours(0,0,0,0);
    const end = new Date(endExclusive);
    end.setHours(0,0,0,0);
    while(cursor < end){ out.push(toLocalDateKey(cursor)); cursor.setDate(cursor.getDate()+1); }
    return out;
  };

  const result = new Set();
  const blocks = String(text||'').split('BEGIN:VEVENT').slice(1);
  for (const block of blocks){
    const lines = String(block||'').split(/\r?\n/);
    const findLine = prefix => lines.find(l=>String(l||'').startsWith(prefix));
    const dtStartLine = findLine('DTSTART');
    if(!dtStartLine) continue;
    const startRaw = String(dtStartLine).split(':').slice(1).join(':');
    const startDate = parseIcsDate(startRaw);
    if(!startDate || isNaN(startDate.getTime())) continue;
    const dtEndLine = findLine('DTEND');
    const endRaw = dtEndLine ? String(dtEndLine).split(':').slice(1).join(':') : '';
    const endDate = endRaw ? parseIcsDate(endRaw) : undefined;
    const isAllDayStart = /^\d{8}$/.test(startRaw);
    const isAllDayEnd = /^\d{8}$/.test(endRaw);
    if(isAllDayStart && endDate && isAllDayEnd){
      for (const k of addDateRange(startDate, endDate)) result.add(k);
      continue;
    }
    result.add(toLocalDateKey(startDate));
  }
  return result;
}

const _holidayCache = new Map(); // url -> {dates:Set, ts}
async function loadHolidaySet(url){
  const raw = String(url||'').trim();
  if(!raw) return new Set();
  const target = canonicalizeIcsUrl(raw);
  const cached = _holidayCache.get(target);
  const TTL = 24*60*60*1000;
  if(cached && (Date.now()-cached.ts) < TTL) return cached.dates;
  const text = await fetchIcsText(target);
  const dates = parseHolidayDatesFromIcs(text);
  _holidayCache.set(target, {dates, ts: Date.now()});
  return dates;
}

async function refreshAttendance(){
  try{
    const d = todayStr();
    const rows = await gas('getAttendanceDay', d);
    ATT.dayRows = Array.isArray(rows) ? rows : [];
    document.getElementById('att-status').textContent = `å–å¾—: ${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}`;
    renderAttendancePage();
    // calendar events are best-effort and only when attendance page is open
    if (PAGE === 'attendance' && ATT_VIEW === 'dashboard') {
      await refreshAttendanceCalendars();
      renderAttendancePage();
    }
  }catch(e){
    console.error(e);
    document.getElementById('att-status').textContent = 'å–å¾—ã‚¨ãƒ©ãƒ¼';
    toast('å‹¤æ€ ã®å–å¾—ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

async function loadAttendanceSettings(){
  try{
    const s = await gas('getAttendanceSettings');
    ATT.settings = s || { holidayUrl:'', companyHolidayUrl:'' };
    if (!ATT.settings.holidayUrl) ATT.settings.holidayUrl = defaultHolidayIcs;
    const hu = document.getElementById('att_holiday_url');
    const cu = document.getElementById('att_company_holiday_url');
    if(hu) hu.value = ATT.settings.holidayUrl || '';
    if(cu) cu.value = ATT.settings.companyHolidayUrl || '';
  }catch(e){
    console.error(e);
    toast('å‹¤æ€ è¨­å®šã®å–å¾—ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

async function saveAttendanceSettings(){
  const hu = (document.getElementById('att_holiday_url')||{}).value || '';
  const cu = (document.getElementById('att_company_holiday_url')||{}).value || '';
  try{
    await gas('setAttendanceSettings', { holidayUrl: String(hu||'').trim(), companyHolidayUrl: String(cu||'').trim() });
    await loadAttendanceSettings();
    toast('å‹¤æ€ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
  }catch(e){
    console.error(e);
    toast('å‹¤æ€ è¨­å®šã®ä¿å­˜ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

function attFindRowForUser(userId){
  return (Array.isArray(ATT.dayRows)?ATT.dayRows:[]).find(r => String(r.user_id||r.user||'') === String(userId));
}

async function patchAttendance(userId, action){
  const date = todayStr();
  try{
    const saved = await gas('patchAttendance', userId, date, action);
    // merge into ATT.dayRows
    const arr = Array.isArray(ATT.dayRows) ? ATT.dayRows.slice() : [];
    const idx = arr.findIndex(r => String(r.user_id||r.user||'') === String(userId));
    if (idx >= 0) arr[idx] = saved;
    else arr.push(saved);
    ATT.dayRows = arr;
    renderAttendancePage();
  }catch(e){
    console.error(e);
    toast('å‹¤æ€ æ›´æ–°ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

function isUnsetUser(u){
  const name = String((u && (u.name||u.email||u.id))||'').trim();
  return !name;
}

function isAttendanceVisibleUser(u){
  // Default: visible. Allow explicit false to hide.
  if (!u || typeof u !== 'object') return true;
  if (Object.prototype.hasOwnProperty.call(u, 'attendance_visible')) {
    const v = u.attendance_visible;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  if (Object.prototype.hasOwnProperty.call(u, 'attendanceVisible')) {
    const v = u.attendanceVisible;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  // Backward/alternate field name safety.
  if (Object.prototype.hasOwnProperty.call(u, 'showAttendance')) {
    const v = u.showAttendance;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  return true;
}

function renderAttendanceUserSettings(){
  // Attendance tab no longer shows per-user settings.
  return;
}

function renderAttendancePage(){
  if (PAGE !== 'attendance') return;
  if (ATT_VIEW !== 'dashboard') return;
  const label = document.getElementById('att-today-label');
  if(label) label.textContent = todayStr();

  const wrap = document.getElementById('att-cards');
  if(!wrap) return;
  wrap.innerHTML = '';

  const users = safeArr(DATA.users)
    .filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u))
    .slice()
    .sort((a,b)=>{
      const anum = String(a.employeeNumber||'').replace(/\D/g,'');
      const bnum = String(b.employeeNumber||'').replace(/\D/g,'');
      const ai = anum ? parseInt(anum,10) : Number.POSITIVE_INFINITY;
      const bi = bnum ? parseInt(bnum,10) : Number.POSITIVE_INFINITY;
      if (ai !== bi) return ai - bi;
      const an = String(a.name||a.email||a.id||'');
      const bn = String(b.name||b.email||b.id||'');
      return an.localeCompare(bn, 'ja');
    });
  users.forEach(u=>{
    const uid = u.id;
    const row = attFindRowForUser(uid) || { user_id: uid, status:'not-clocked', location:'office', breaks:[], clock_in:'', clock_out:'', notes:'', project_id:'', task_id:'' };
    const status = String(row.status||'not-clocked');
    const location = String(row.location||'office');
    const clockIn = row.clock_in || '';
    const clockOut = row.clock_out || '';
    const worked = (clockIn ? Math.max(0, minutesBetweenIso(clockIn, clockOut) - fixedBreakMinutes) : 0);

    const currentEvent = (ATT.currentEventsByUser && ATT.currentEventsByUser[uid]) || null;
    const nextEvent = (ATT.nextEventsByUser && ATT.nextEventsByUser[uid]) || null;

    const avatarHue = (function(){
      // deterministic hue from id
      const s = String(uid||'');
      let h = 0;
      for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) % 360;
      return h;
    })();
    const tone = (function(){
      if(status==='working') return 'green';
      if(status==='break' || status==='out') return 'yellow';
      if(status==='done') return 'gray';
      return 'red';
    })();
    const stateClass = (function(){
      if(status==='done') return 'card-state-done';
      if(status==='not-clocked') return 'card-state-not-clocked';
      if(status==='out' || status==='break') return 'card-state-event';
      if(status==='working' && location==='remote') return 'card-state-working-remote';
      if(status==='working' && location==='office') return 'card-state-working-office';
      return 'card-state-not-clocked';
    })();

    const card = document.createElement('div');
    card.className = `card att-card ${stateClass}`;
    const projId = String(row.project_id||'');
    const taskId = String(row.task_id||'');

    const projOptions = ['<option value="">ï¼ˆæœªæŒ‡å®šï¼‰</option>']
      .concat(safeArr(DATA.projects).filter(p=>String(p.status||'active')!=='archived')
        .map(p=>`<option value="${escapeHtml(p.id)}" ${String(p.id)===projId?'selected':''}>${escapeHtml(p.name||p.id)}</option>`));

    const tasks = safeArr(DATA.tasks);
    const taskFiltered = projId ? tasks.filter(t=>String(t.projectId||'')===projId) : tasks;
    const taskOptions = ['<option value="">ï¼ˆæœªæŒ‡å®šï¼‰</option>']
      .concat(taskFiltered.map(t=>`<option value="${escapeHtml(t.id)}" ${String(t.id)===taskId?'selected':''}>${escapeHtml(t.title||t.id)}</option>`));

    const projName = projId ? (safeArr(DATA.projects).find(p=>String(p.id)===projId)?.name || projId) : '';
    const taskName = taskId ? (tasks.find(t=>String(t.id)===taskId)?.title || taskId) : '';

    const curLabel = currentEvent ? `${currentEvent.summary||'(äºˆå®š)'} ${attFormatMDHM(currentEvent.start)}` : '-';
    const nextLabel = nextEvent ? `${nextEvent.summary||'(äºˆå®š)'} ${attFormatMDHM(nextEvent.start)}` : '-';
    const roleLabel = String(u.role||'').trim();

    const breakBtnLabel = status==='break' ? 'ä¼‘æ†©æˆ»ã‚Š' : 'ä¼‘æ†©';
    const outBtnLabel = status==='out' ? 'å¤–å‡ºæˆ»ã‚Š' : 'å¤–å‡º';
    const canClockIn = (status==='not-clocked' || status==='done');
    const clockOutBtnLabel = status==='done' ? 'é€€å‹¤å–æ¶ˆ' : 'é€€å‹¤';

    card.innerHTML = `
      <div class="body">
        <div class="att-line">
          <div class="att-avatar" style="background: hsl(${avatarHue} 70% 45%);"></div>
          <div class="att-person">
            <span class="att-name">${escapeHtml(u.name||u.email||u.id)}</span>
            <span class="att-role">${escapeHtml(roleLabel)}</span>
          </div>
          <span class="att-k">å‹¤å‹™å ´æ‰€</span><span class="att-v">${escapeHtml(attLocLabel(location))}</span>
          <span class="att-k">å‡ºå‹¤</span><span class="att-v">${escapeHtml(attFormatTime(clockIn))}</span>
          <span class="att-k">é€€å‹¤</span><span class="att-v">${escapeHtml(attFormatTime(clockOut))}</span>
          <span class="att-k">å‹¤å‹™æ™‚é–“</span><span class="att-v">${escapeHtml(minutesToLabel(worked))}</span>
          <span class="att-status-pill tone-${tone}">${escapeHtml(attStatusLabel(status))}</span>
        </div>

        <div class="att-line">
          <span class="att-k">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span>
          <select class="att-ctl wide" data-att-uid="${escapeHtml(uid)}" data-att-field="project">${projOptions.join('')}</select>
          <span class="att-k">ã‚¿ã‚¹ã‚¯:</span>
          <select class="att-ctl wide" data-att-uid="${escapeHtml(uid)}" data-att-field="task">${taskOptions.join('')}</select>
          <span class="att-k">æ“ä½œ</span>
          <div class="att-actions">
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInOffice" ${canClockIn?'':'disabled'}>å‡ºå‹¤(ã‚ªãƒ•ã‚£ã‚¹)</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInRemote" ${canClockIn?'':'disabled'}>å‡ºå‹¤(ãƒ†ãƒ¬ãƒ¯ãƒ¼ã‚¯)</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInOut" ${canClockIn?'':'disabled'}>å‡ºå‹¤(å¤–å‡º)</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="toggleBreak">${escapeHtml(breakBtnLabel)}</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="toggleOut">${escapeHtml(outBtnLabel)}</button>
            <button data-att-uid="${escapeHtml(uid)}" data-att-action="clockOut">${escapeHtml(clockOutBtnLabel)}</button>
          </div>
        </div>

        <div class="att-line">
          <span class="att-k">ç¾åœ¨ã®äºˆå®š:</span>
          <span class="att-muted">${escapeHtml(curLabel)}</span>
          <span class="att-k">æ¬¡ã®äºˆå®š:</span>
          <span class="att-muted">${escapeHtml(nextLabel)}</span>
          <span class="att-k">ãƒ¡ãƒ¢:</span>
          <input class="att-ctl" data-att-uid="${escapeHtml(uid)}" data-att-field="notes" value="${escapeHtml(row.notes||'')}" placeholder=""/>
        </div>
      </div>
    `;

    // Wire events
    card.querySelectorAll('button[data-att-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const action = btn.getAttribute('data-att-action');
        if(action==='clockInOffice'){
          patchAttendance(uid, { type:'clockIn', location:'office' });
        }else if(action==='clockInRemote'){
          patchAttendance(uid, { type:'clockIn', location:'remote' });
        }else if(action==='clockInOut'){
          patchAttendance(uid, { type:'clockIn', location:'out' });
        }else if(action==='clockOut'){
          patchAttendance(uid, { type:'clockOut' });
        }else if(action==='toggleBreak'){
          patchAttendance(uid, { type:'toggleBreak' });
        }else if(action==='toggleOut'){
          patchAttendance(uid, { type:'toggleOut' });
        }
      });
    });
    const projSel = card.querySelector('select[data-att-field="project"]');
    const taskSel = card.querySelector('select[data-att-field="task"]');
    if(projSel){
      projSel.addEventListener('change', ()=>{
        // when project changes, clear task selection
        const pid = projSel.value || '';
        if(taskSel) taskSel.value = '';
        patchAttendance(uid, { type:'setProjectTask', projectId: pid, taskId: '' });
        // re-render to filter task options
        setTimeout(()=>{ renderAttendancePage(); }, 0);
      });
    }
    if(taskSel){
      taskSel.addEventListener('change', ()=>{
        const pid = projSel ? (projSel.value||'') : '';
        const tid = taskSel.value || '';
        patchAttendance(uid, { type:'setProjectTask', projectId: pid, taskId: tid });
      });
    }
    const notesInp = card.querySelector('input[data-att-field="notes"]');
    if(notesInp){
      let t=null;
      notesInp.addEventListener('input', ()=>{
        if(t) clearTimeout(t);
        t = setTimeout(()=>{ patchAttendance(uid, { type:'setNotes', notes: notesInp.value }); }, 600);
      });
    }

    wrap.appendChild(card);
  });

  // init month picker default
  const mi = document.getElementById('att_month');
  if(mi && !mi.value){ mi.value = todayStr().slice(0,7); }
}

async function refreshAttendanceCalendars(){
  const users = safeArr(DATA.users).filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u));
  const nextMap = {};
  const currentMap = {};
  await Promise.all(users.map(async u=>{
    const url = String(u.calendarUrl||'').trim();
    if(!url){ nextMap[u.id]=null; currentMap[u.id]=null; return; }
    try{
      const text = await fetchIcsText(url);
      const r = pickNextAndCurrentEventFromIcs(text);
      nextMap[u.id] = r.next;
      currentMap[u.id] = r.current;
    }catch(_){ nextMap[u.id]=null; currentMap[u.id]=null; }
  }));
  ATT.nextEventsByUser = nextMap;
  ATT.currentEventsByUser = currentMap;
}

async function loadAttendanceMonth(){
  const mi = document.getElementById('att_month');
  const month = mi && mi.value ? mi.value : todayStr().slice(0,7);
  try{
    const rows = await gas('getAttendanceMonth', month);
    ATT.monthRows = Array.isArray(rows) ? rows : [];
    renderAttendanceMonthTable(month);
    renderAttendanceWeekTable(month);
    toast('æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', true);
  }catch(e){
    console.error(e);
    toast('æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

function renderAttendanceMonthTable(month){
  const tb = document.querySelector('#att-month-table tbody');
  if(!tb) return;
  tb.innerHTML='';
  const rows = safeArr(ATT.monthRows).slice().sort((a,b)=>{
    const da = String(a.work_date||'');
    const db = String(b.work_date||'');
    if(da!==db) return da.localeCompare(db);
    return String(a.user_id||'').localeCompare(String(b.user_id||''));
  });
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const uid = String(r.user_id||r.user||'');
    const uname = nameByUserId(uid);
    const worked = (r.clock_in && r.clock_out) ? Math.max(0, minutesBetweenIso(r.clock_in, r.clock_out) - fixedBreakMinutes) : 0;
    const projName = r.project_id ? (safeArr(DATA.projects).find(p=>String(p.id)===String(r.project_id))?.name || r.project_id) : '';
    const taskName = r.task_id ? (safeArr(DATA.tasks).find(t=>String(t.id)===String(r.task_id))?.title || r.task_id) : '';
    const pt = projName && taskName ? `${projName} / ${taskName}` : (projName || taskName || '');
    tr.innerHTML = `
      <td>${escapeHtml(r.work_date||'')}</td>
      <td>${escapeHtml(uname||uid)}</td>
      <td>${escapeHtml(attStatusLabel(r.status||''))}</td>
      <td>${escapeHtml(attFormatTime(r.clock_in))}</td>
      <td>${escapeHtml(attFormatTime(r.clock_out))}</td>
      <td>${escapeHtml(worked?minutesToLabel(worked):'')}</td>
      <td>${escapeHtml(pt)}</td>
    `;
    tb.appendChild(tr);
  });
  const summary = document.getElementById('att-month-summary');
  if(summary){
    summary.textContent = `${month} / è¨˜éŒ² ${rows.length}ä»¶`;
  }
}

function mondayStart(dateKey){
  const d = new Date(`${dateKey}T00:00:00`);
  const dow = d.getDay(); // 0 Sun
  const diff = (dow + 6) % 7; // Mon=0
  d.setDate(d.getDate() - diff);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function addDaysKey(dateKey, add){
  const d = new Date(`${dateKey}T00:00:00`);
  d.setDate(d.getDate() + Number(add||0));
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function renderAttendanceWeekTable(month){
  const tb = document.querySelector('#att-week-table tbody');
  if(!tb) return;
  tb.innerHTML = '';

  const rows = safeArr(ATT.monthRows).slice();
  const groups = new Map(); // key -> {weekStart, weekEnd, userId, days, minutes}
  rows.forEach(r=>{
    const dateKey = String(r.work_date||'');
    if(!dateKey || dateKey.slice(0,7)!==String(month||'')) return;
    const uid = String(r.user_id||r.user||'');
    if(!uid) return;
    const worked = (r.clock_in && r.clock_out) ? Math.max(0, minutesBetweenIso(r.clock_in, r.clock_out) - fixedBreakMinutes) : 0;
    if(worked<=0) return;
    const ws = mondayStart(dateKey);
    const we = addDaysKey(ws, 6);
    const key = `${ws}|${uid}`;
    const prev = groups.get(key) || { weekStart: ws, weekEnd: we, userId: uid, days: 0, minutes: 0 };
    prev.days += 1;
    prev.minutes += worked;
    groups.set(key, prev);
  });

  const list = Array.from(groups.values()).sort((a,b)=>{
    if(a.weekStart!==b.weekStart) return String(a.weekStart).localeCompare(String(b.weekStart));
    return nameByUserId(a.userId).localeCompare(nameByUserId(b.userId));
  });

  list.forEach(g=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(g.weekStart)}</td>
      <td>${escapeHtml(g.weekEnd)}</td>
      <td>${escapeHtml(nameByUserId(g.userId) || g.userId)}</td>
      <td>${escapeHtml(String(g.days))}</td>
      <td>${escapeHtml(minutesToLabel(Math.round(g.minutes)))}</td>
    `;
    tb.appendChild(tr);
  });

  const summary = document.getElementById('att-week-summary');
  if(summary){
    summary.textContent = `${month} / é€±æ¬¡ ${list.length}ä»¶`;
  }
}

function overlapMinutes(aStart, aEnd, bStart, bEnd){
  const start = Math.max(aStart.getTime(), bStart.getTime());
  const end = Math.min(aEnd.getTime(), bEnd.getTime());
  if(end <= start) return 0;
  return (end-start)/60000;
}
function subtractInterval(interval, cut){
  const s=interval[0], e=interval[1];
  const cs=cut[0], ce=cut[1];
  if(ce<=s || cs>=e) return [interval];
  const out=[];
  const leftEnd = new Date(Math.min(cs.getTime(), e.getTime()));
  if(leftEnd > s) out.push([s, leftEnd]);
  const rightStart = new Date(Math.max(ce.getTime(), s.getTime()));
  if(e > rightStart) out.push([rightStart, e]);
  return out;
}
function computeWorkIntervals(att){
  if(!att.clock_in) return [];
  const start = new Date(att.clock_in);
  const end = new Date(att.clock_out || new Date().toISOString());
  if(!(end > start)) return [];
  let intervals=[[start,end]];
  const br = Array.isArray(att.breaks) ? att.breaks : [];
  for (const b of br){
    if(!b || !b.start) continue;
    const bStart = new Date(b.start);
    const bEnd = new Date(b.end || new Date().toISOString());
    if(!(bEnd > bStart)) continue;
    intervals = intervals.flatMap(iv => subtractInterval(iv, [bStart, bEnd]));
    if(intervals.length===0) break;
  }
  return intervals.filter(iv=>iv[1]>iv[0]);
}
function computeNightMinutes(att){
  const intervals = computeWorkIntervals(att);
  let total=0;
  for (const iv of intervals){
    const start=iv[0], end=iv[1];
    const cursor = new Date(start);
    cursor.setHours(0,0,0,0);
    while(cursor < end){
      const dayStart = new Date(cursor);
      const nextDayStart = new Date(dayStart); nextDayStart.setDate(nextDayStart.getDate()+1);
      const night1Start = new Date(dayStart); night1Start.setHours(0,0,0,0);
      const night1End = new Date(dayStart); night1End.setHours(5,0,0,0);
      const night2Start = new Date(dayStart); night2Start.setHours(22,0,0,0);
      const night2End = new Date(nextDayStart);
      total += overlapMinutes(start, end, night1Start, night1End);
      total += overlapMinutes(start, end, night2Start, night2End);
      cursor.setDate(cursor.getDate()+1);
      cursor.setHours(0,0,0,0);
    }
  }
  return Math.round(total);
}

function isScheduledWorkday(dateKey, holidaySet, companyHolidaySet){
  const date = new Date(`${dateKey}T00:00:00`);
  const dow = date.getDay();
  if(dow===0 || dow===6) return false;
  if(holidaySet && holidaySet.has(dateKey)) return false;
  if(companyHolidaySet && companyHolidaySet.has(dateKey)) return false;
  return true;
}

async function exportFreeeAttendanceCsv(){
  const mi = document.getElementById('att_month');
  const month = mi && mi.value ? mi.value : todayStr().slice(0,7);

  // Ensure month data loaded
  if(!Array.isArray(ATT.monthRows) || !ATT.monthRows.length || String(ATT.monthRows[0].work_date||'').slice(0,7)!==month){
    await loadAttendanceMonth();
  }

  try{
    // Settings & holiday feeds
    if(!ATT.settings || !ATT.settings.holidayUrl){ await loadAttendanceSettings(); }
    const holidayUrl = (ATT.settings && ATT.settings.holidayUrl) ? ATT.settings.holidayUrl : defaultHolidayIcs;
    const companyHolidayUrl = (ATT.settings && ATT.settings.companyHolidayUrl) ? ATT.settings.companyHolidayUrl : '';
    const [holidaySet, companySet] = await Promise.all([
      loadHolidaySet(holidayUrl),
      companyHolidayUrl ? loadHolidaySet(companyHolidayUrl) : Promise.resolve(new Set()),
    ]);
    ATT.holidayDates = holidaySet;
    ATT.companyHolidayDates = companySet;

    const freeeHeaders = [
      'å¾“æ¥­å“¡ç•ªå·','æ°å','æ‰€å®šåŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','æ³•å®šå†…æ®‹æ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰','æ™‚é–“å¤–åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','æ‰€å®šä¼‘æ—¥åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','æ·±å¤œåŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','æ³•å®šä¼‘æ—¥åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','ç·åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','ç·åŠ´åƒæ—¥æ•°','æ‰€å®šåŠ´åƒå‡ºå‹¤æ—¥æ•°','æ‰€å®šä¼‘æ—¥å‡ºå‹¤æ—¥æ•°','æ³•å®šä¼‘æ—¥å‡ºå‹¤æ—¥æ•°','é…åˆ»æ™‚é–“ï¼ˆåˆ†ï¼‰','æ—©é€€æ™‚é–“ï¼ˆåˆ†ï¼‰','æ¬ å‹¤æ—¥æ•°','é…åˆ»æ—¥æ•°','æ—©é€€æ—¥æ•°','æœ‰ä¼‘å–å¾—æ—¥æ•°','é›†è¨ˆé–‹å§‹æ—¥','é›†è¨ˆçµ‚äº†æ—¥','ã¿ãªã—å¤–ã®æ³•å®šå†…æ®‹æ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰','ã¿ãªã—å¤–ã®æ™‚é–“å¤–åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰','ä¸è¶³æ™‚é–“ï¼ˆåˆ†ï¼‰'
    ];
    const csvEscape = (value) => {
      const raw = (value===null||value===undefined) ? '' : String(value);
      if(raw.includes('"') || raw.includes(',') || raw.includes('\n') || raw.includes('\r')) return '"'+raw.replaceAll('"','""')+'"';
      return raw;
    };

    const monthStart = new Date(`${month}-01T00:00:00`);
    const monthEnd = new Date(monthStart);
    monthEnd.setMonth(monthEnd.getMonth()+1);
    monthEnd.setDate(0);
    monthEnd.setHours(0,0,0,0);

    const toDateKey = (d) => {
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };
    const formatYmdSlash = (dateKey) => {
      const parts = dateKey.split('-').map(v=>Number(v));
      return `${parts[0]}/${parts[1]}/${parts[2]}`;
    };

    let scheduledWorkdayCount = 0;
    for(let d=new Date(monthStart); d<=monthEnd; d.setDate(d.getDate()+1)){
      if(isScheduledWorkday(toDateKey(d), holidaySet, companySet)) scheduledWorkdayCount += 1;
    }

    const users = safeArr(DATA.users).filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u));
    // Group attendance by user
    const byUser = {};
    safeArr(ATT.monthRows).forEach(r=>{
      const uid = String(r.user_id||r.user||'');
      if(!uid) return;
      if(!byUser[uid]) byUser[uid] = [];
      byUser[uid].push(r);
    });

    const lines = users.map(u=>{
      const uid = String(u.id);
      const items = (byUser[uid]||[]).slice().sort((a,b)=>String(a.work_date||'').localeCompare(String(b.work_date||'')));
      const workedByDay = new Map();
      items.forEach(att=>{
        const dateKey = String(att.work_date||'');
        if(!dateKey) return;
        const workedMinutes = (att.clock_in && att.clock_out) ? Math.max(0, minutesBetweenIso(att.clock_in, att.clock_out) - fixedBreakMinutes) : 0;
        const nightMinutes = computeNightMinutes(att);
        const prev = workedByDay.get(dateKey);
        if(!prev) workedByDay.set(dateKey, { workedMinutes, nightMinutes });
        else workedByDay.set(dateKey, { workedMinutes: prev.workedMinutes + workedMinutes, nightMinutes: prev.nightMinutes + nightMinutes });
      });

      let totalWorkMinutes=0;
      let totalNightMinutes=0;
      let totalWorkDays=0;
      let scheduledWorkAttendanceDays=0;
      let prescribedHolidayAttendanceDays=0;
      let legalHolidayAttendanceDays=0;

      for (const [dateKey, day] of workedByDay.entries()){
        if(day.workedMinutes <= 0) continue;
        totalWorkMinutes += day.workedMinutes;
        totalNightMinutes += day.nightMinutes;
        totalWorkDays += 1;
        const date = new Date(`${dateKey}T00:00:00`);
        const dow = date.getDay();
        const scheduled = isScheduledWorkday(dateKey, holidaySet, companySet);
        if(scheduled) scheduledWorkAttendanceDays += 1;
        else if(dow===0) legalHolidayAttendanceDays += 1;
        else prescribedHolidayAttendanceDays += 1;
      }

      const scheduledWorkMinutes = (540 - fixedBreakMinutes) * scheduledWorkdayCount;
      const overtimeMinutes = Math.max(0, totalWorkMinutes - scheduledWorkMinutes);
      const shortageMinutes = Math.max(0, scheduledWorkMinutes - totalWorkMinutes);

      const startKey = toDateKey(monthStart);
      const endKey = toDateKey(monthEnd);

      const row = [
        u.employeeNumber || '',
        (u.name||u.email||u.id),
        scheduledWorkMinutes,
        '',
        overtimeMinutes,
        '',
        totalNightMinutes,
        '',
        totalWorkMinutes,
        totalWorkDays,
        scheduledWorkAttendanceDays,
        prescribedHolidayAttendanceDays,
        legalHolidayAttendanceDays,
        '', '', '', '', '', '',
        formatYmdSlash(startKey),
        formatYmdSlash(endKey),
        '', '',
        shortageMinutes,
      ];
      return row.map(v=>csvEscape(v)).join(',');
    });

    const csv = [freeeHeaders.map(h=>csvEscape(h)).join(','), ...lines].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `freee-attendance-${month}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    console.error(e);
    toast('freee CSVå‡ºåŠ›ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
  }
}

// Attendance init hooks (load settings, poll only on attendance page)
window.addEventListener('load', ()=>{
  try{
    // Dashboard task tabs (list/board/gantt) - ensure click handlers are bound.
    try { bindDashboardTabs?.(); } catch(_){ }

    try { syncStickyOffsets(); } catch(_){ }
    try { window.addEventListener('resize', ()=>{ try { syncStickyOffsets(); } catch(_){ } }); } catch(_){ }

    const mi = document.getElementById('att_month');
    if(mi && !mi.value) mi.value = todayStr().slice(0,7);
    loadAttendanceSettings();

    // Auto-refresh UI (opt-in)
    try {
      applyAttendanceAutoRefreshIntervalToUi();

      const cb = document.getElementById('att_auto_refresh');
      const sel = document.getElementById('att_auto_interval');

      if (sel) sel.addEventListener('change', ()=>{
        readAttendanceAutoRefreshIntervalFromUi();
        if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh();
      });

      if (cb) cb.addEventListener('change', ()=>{
        if (cb.checked) {
          startAttendanceAutoRefresh();
        } else {
          stopAttendanceAutoRefresh({ uncheck:false, reason:'unchecked' });
        }
      });

      document.addEventListener('visibilitychange', ()=>{
        if (document.hidden) {
          stopAttendanceAutoRefresh({ uncheck:true, reason:'hidden' });
        }
      });
      window.addEventListener('beforeunload', ()=>{
        stopAttendanceAutoRefresh({ uncheck:false, reason:'unload' });
      });
    } catch(_){ }
  }catch(_){ }
});


function bindDashboardTabs(){
  const defs = [
    ['tab-list','list'],
    ['tab-board','board'],
    ['tab-gantt','gantt'],
  ];
  defs.forEach(([id, tab])=>{
    const el = document.getElementById(id);
    if (!el) return;
    // Avoid duplicate binding in case of multiple init paths.
    if (el.dataset && el.dataset.boundSwitchTab === '1') return;
    if (el.dataset) el.dataset.boundSwitchTab = '1';
    el.addEventListener('click', (e)=>{
      try { e.preventDefault?.(); } catch(_){ }
      try { switchTab(tab); } catch(_){ }
    });
  });
}

// ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆlist/board/ganttï¼‰
function switchTab(tab) {
  // æ—§GASç‰ˆã®æŒ™å‹•ã«å¯„ã›ã¦ã€
  // 1) è¡¨ç¤ºåˆ‡æ›¿
  // 2) å¿…è¦ãªå†æç”»ï¼ˆlist/board/ganttï¼‰
  // 3) çŠ¶æ…‹ä¿å­˜ï¼ˆhash / queryï¼‰
  // ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œã™ã‚‹ã€‚

  tab = (tab === 'board' || tab === 'gantt') ? tab : 'list';
  ACTIVE_TAB = tab;

  // ã‚‚ã—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä»¥å¤–ã‹ã‚‰å‘¼ã°ã‚ŒãŸã‚‰ã€è¦‹ãˆã‚‹ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¦ã‹ã‚‰åˆ‡æ›¿
  // ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ/URLåæ˜ ãªã©ã®å°ç·šã§ã€Œåˆ‡æ›¿ã—ãŸã®ã«è¦‹ãˆãªã„ã€ã‚’é˜²ãï¼‰
  try {
    if (typeof PAGE === 'string' && PAGE !== 'dashboard') {
      try { gotoDashboardTab?.(tab); } catch(_){ }
      // gotoDashboardTab å†…ã§å†åº¦ switchTab ã•ã‚Œã‚‹ã®ã§ã“ã“ã§çµ‚äº†
      return;
    }
  } catch(_){ }

  const tl = document.getElementById('tab-list');
  const tb = document.getElementById('tab-board');
  const tg = document.getElementById('tab-gantt');
  if (tl) tl.classList.toggle('active', tab==='list');
  if (tb) tb.classList.toggle('active', tab==='board');
  if (tg) tg.classList.toggle('active', tab==='gantt');

  const vl = document.getElementById('view-list');
  const vb = document.getElementById('view-board');
  const vg = document.getElementById('view-gantt');
  if (vl) vl.style.display = (tab==='list')  ? '' : 'none';
  if (vb) vb.style.display = (tab==='board') ? '' : 'none';
  if (vg) vg.style.display = (tab==='gantt') ? '' : 'none';

  try {
    // list: ä¸€è¦§ã‚’ç¢ºå®Ÿã«æ›´æ–°
    if (tab === 'list') {
      try { renderTasksTable?.(); } catch(_){ }
    }

    // board: ã‚«ãƒ³ãƒãƒ³ã‚’ç¢ºå®Ÿã«æ›´æ–°
    // æ—§GASç‰ˆåŒæ§˜ã€ã‚¿ãƒ–åˆ‡æ›¿æ™‚ã«å¿…ãšå†æç”»ã—ã¦æ•´åˆã‚’å–ã‚‹
    try { renderKanban?.(); } catch(_){ }

    // gantt: é¸æŠæ™‚ã«å¿…ãšä»Šæ—¥å§‹ã¾ã‚Šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¸
    if (tab === 'gantt') {
      try { renderGantt?.(true); } catch(_){ }
    }
  } catch(_){ }

  if (tab !== 'gantt'){
    const gc = document.getElementById('gantt-container');
    if (gc) gc.innerHTML = '';
  }

  try { updateHashFromState(); } catch(_){ }
  try { updateRouteParams?.({ tab: ACTIVE_TAB }, { replace:true }); } catch(_){ }
}

function updateHashFromState(){
  const qs = new URLSearchParams();
  qs.set('tab', ACTIVE_TAB);
  Object.entries(FILTERS).forEach(([k,v])=>{ if(v) qs.set(k, v); });
  if (OVERDUE) qs.set('overdue','1');
  location.hash = qs.toString();
}

function applyHash(){
  // Hash state is used for dashboard task filters/tabs.
  // Never apply it on other pages (e.g., attendance) to avoid unintended redirects.
  try { if (PAGE !== 'dashboard') return; } catch(_){ }
  const raw = location.hash.replace(/^#/,''); if(!raw) return;
  const p = new URLSearchParams(raw);
  const tab = p.get('tab'); if(tab) switchTab(tab);

  ['keyword','project','assignee','from','to','priority','status'].forEach(k=>{
    const v = p.get(k)||''; if(v){ FILTERS[k]=v; const id='f_'+(k==='keyword'?'keyword':k); const e=el(id); if(e) e.value=v; }
  });
  OVERDUE = p.get('overdue')==='1';
}

window.addEventListener('hashchange', ()=>{
  try{ if (PAGE !== 'dashboard') return; }catch(_){ return; }
  applyHash();
  renderTasksTable();
  renderKanban();
  if (ACTIVE_TAB==='gantt') renderGantt();
});

// filters
function applyFilters() {
  FILTERS = {
    keyword: document.getElementById('f_keyword').value.trim(),
    project: document.getElementById('f_project').value,
    assignee: document.getElementById('f_assignee').value,
    from: document.getElementById('f_from').value,
    to: document.getElementById('f_to').value,
    priority: document.getElementById('f_priority').value,
    status: document.getElementById('f_status').value
  };
  renderTasksTable();
  renderKanban();
  if (ACTIVE_TAB==='gantt') renderGantt();
  saveFiltersToLS();
  updateHashFromState();
}
function quickOverdue(){
  OVERDUE = true;
  ['f_from','f_to','f_status'].forEach(id=>{ const e=el(id); if(e) e.value=''; });
  saveFiltersToLS();
  updateHashFromState();
  renderTasksTable(); renderKanban(); if (ACTIVE_TAB==='gantt') renderGantt();
}
function clearFilters() {
  ['f_keyword','f_project','f_assignee','f_from','f_to','f_priority','f_status'].forEach(id=>{ const elx=document.getElementById(id); if (elx) elx.value=''; });
  OVERDUE = false;
  applyFilters();
  saveFiltersToLS();
  updateHashFromState();
}
function filterTasks(list) {
  let rows = list.slice();
  const f = FILTERS;
  if (f.keyword) {
    const k = f.keyword.toLowerCase();
    rows = rows.filter(x => String(x.title||'').toLowerCase().includes(k) || String(x.memoText||'').toLowerCase().includes(k));
  }
  if (f.project)  rows = rows.filter(x => String(x.projectId||'') === String(f.project));
  if (f.assignee) rows = rows.filter(x => String(x.assignees||'').split(',').map(s=>s.trim()).includes(f.assignee));
  if (f.from)     rows = rows.filter(x => x.dueDate && x.dueDate >= f.from);
  if (f.to)       rows = rows.filter(x => x.dueDate && x.dueDate <= f.to);
  if (f.status === 'notdone') {
    rows = rows.filter(x => String(x.status||'').toLowerCase() !== 'done');
  } else if (f.status) {
    rows = rows.filter(x => (x.status||'todo') === f.status);
  }
  if (f.priority) rows = rows.filter(x => normPriority(x.priority||'') === f.priority);

  // é…å»¶(OVERDUE)ãƒ¢ãƒ¼ãƒ‰ï¼šæœŸé™ãŒä»Šæ—¥ã‚ˆã‚Šå‰ã€ã‹ã¤æœªå®Œäº†
  if (OVERDUE) {
    const today = new Date(); today.setHours(0,0,0,0);
    const y = today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    const tstr = `${y}-${m}-${d}`;
    rows = rows.filter(x => x.dueDate && x.dueDate < tstr && String(x.status||'').toLowerCase()!=='done');
  }
  return rows;
}

// --- Budget (å¾©æ´»ã•ã›ãŸé–¢æ•°) ---
function renderBudget(){
  if (PAGE !== 'budget') return;
  const rows = safeArr(DATA.projects);
  const subs = safeArr(DATA.subs);
  const active = rows.filter(p => String(p.status||'').toLowerCase() !== 'archived');
  const sum = xs => xs.reduce((a,b)=> a + (Number(b.budget||0)||0), 0);
  const total = sum(rows);
  const totalActive = sum(active);
  // Subscriptions
  const subsMonthly = subs.reduce((a,s)=>{
    const cyc=String(s.cycle||'monthly');
    const amt=Number(s.amount||0)||0;
    if(cyc==='yearly') return a + amt/12;
    if(cyc==='quarterly') return a + amt/3;
    return a + amt;
  }, 0);
  const subsYearly  = subs.reduce((a,s)=>{
    const cyc=String(s.cycle||'monthly');
    const amt=Number(s.amount||0)||0;
    if(cyc==='yearly') return a + amt;
    if(cyc==='quarterly') return a + amt*4;
    return a + amt*12;
  }, 0);
  const elx = document.getElementById('budget-summary'); if (elx) {
    elx.innerHTML = `<div class="row"><div>ç·äºˆç®—åˆè¨ˆ</div><div><b>${total.toLocaleString()}</b> å††</div></div>
      <div class="row"><div>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–äºˆç®—åˆè¨ˆ</div><div><b>${totalActive.toLocaleString()}</b> å††</div></div>
      <hr style="margin:8px 0; border:none; border-top:1px solid var(--border);"/>
      <div class="row"><div>ã‚µãƒ–ã‚¹ã‚¯åˆè¨ˆï¼ˆæœˆæ¬¡ï¼‰</div><div><b>${Math.round(subsMonthly).toLocaleString()}</b> å††/æœˆ</div></div>
      <div class="row"><div>ã‚µãƒ–ã‚¹ã‚¯åˆè¨ˆï¼ˆå¹´æ¬¡ï¼‰</div><div><b>${Math.round(subsYearly).toLocaleString()}</b> å††/å¹´</div></div>
      <div class="muted" style="margin-top:6px;">â€» cycleï¼ˆmonthly/quarterly/yearlyï¼‰ã‹ã‚‰æ›ç®—</div>`;
  }
  const tb = document.querySelector('#budget-by-owner tbody'); if (tb) {
    tb.innerHTML = '';
    const byOwner = {};
    active.forEach(p => {
      const k = p.ownerUserId || '';
      if (!byOwner[k]) byOwner[k] = { count:0, budget:0 };
      byOwner[k].count += 1; byOwner[k].budget += Number(p.budget||0)||0;
    });
    Object.keys(byOwner).sort((a,b)=> (byOwner[b].budget - byOwner[a].budget)).forEach(uid => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(nameByUserId(uid))}</td><td>${byOwner[uid].count}</td><td>${byOwner[uid].budget.toLocaleString()}</td>`;
      tb.appendChild(tr);
    });
  }
}

// tasks table (with Docs buttons)
function renderTasksTable() {
  const tb = document.querySelector('#taskTable tbody'); if (!tb) return;
  tb.innerHTML='';
  let rows = filterTasks(safeArr(DATA.tasks));
  rows = rows.sort((a,b)=>String(a.dueDate||'9999-12-31').localeCompare(String(b.dueDate||'9999-12-31'))).slice(0,500);

  for (const r of rows) {
    const assignees = String(r.assignees||'').split(',').filter(Boolean).map(s=>nameByUserId(s)).join(', ');
    const tDocUrl = getTaskDocUrl(r.id);
    const pDocUrl = getProjectDocUrl(r.projectId||'');
    const docsBtns = [
      tDocUrl ? `<button class="secondary" data-tip="ã‚¿ã‚¹ã‚¯ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openTaskDocById('${r.id}')">ğŸ“„ã‚¿ã‚¹ã‚¯Doc</button>` : '',
      pDocUrl ? `<button class="secondary" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±é€šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openProjectDocById('${r.projectId||''}')">ğŸ“„PJ Doc</button>` : ''
    ].filter(Boolean).join(' ');

    const tr = document.createElement('tr');
    tr.dataset.id = r.id;

    const docBadges = [
      tDocUrl ? `<span class="doc-badge" title="Task Doc" data-tip="ã‚¿ã‚¹ã‚¯ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openTaskDocById('${r.id}')">ğŸ“„ã‚¿ã‚¹ã‚¯Doc</span>` : '',
      pDocUrl ? `<span class="doc-badge" title="Project Doc" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openProjectDocById('${r.projectId||''}')">ğŸ“„PJDoc</span>` : ''
    ].join('');

    // â˜… ã“ã“ã§å…ˆã«ãƒ†ãƒ¼ãƒè‰²ã‚’è¨ˆç®—ã™ã‚‹
    const theme = themeFor(r.projectId||'', r);
    const prioLabel = normPriority(r.priority||'');
    const prc = prioLabel==='é«˜' ? 'high'
               : prioLabel==='ä¸­' ? 'mid'
               : prioLabel==='ä½' ? 'low' : '';
    const attN = countAttachments('task', r.id);
    const attBadge = attN
  ? `<span class="doc-badge" title="æ·»ä»˜ ${attN}ä»¶" onclick="toggleAttachmentList('task','${r.id}', this)">ğŸ“${attN}</span>`
  : '';

    const bg = ` style="background:${theme.bg}"`;
    tr.innerHTML = `
      <td class="cell-due" data-field="dueDate"${bg}>${r.dueDate||''}</td>
      <td${bg}>
        <span class="cell-title" data-field="title">${escapeHtml(r.title||'')}</span>
        ${docBadges} ${attBadge}
        <div class="muted" style="font-size:12px;">${escapeHtml(nameByProjectId(r.projectId||''))}</div>
        ${docsBtns ? '<div class="toolbar" style="margin-top:4px;">'+docsBtns+'</div>' : ''}
      </td>
      <td${bg}><span class="pill">${r.type||''}</span></td>
      <td${bg}>${escapeHtml(assignees||'')}</td>
      <td class="cell-prio ${prc?('prio-'+prc):''}" data-field="priority">
        <span class="pill prio-badge ${prc?('prio-'+prc):''}">${escapeHtml(prioLabel)}</span>
      </td>
      <td${bg}>${escapeHtml(labelStatus(r.status||''))}</td>
      <td class="cell-memo"${bg}>
        <textarea class="memo-edit" data-kind="task" data-id="${r.id}" placeholder="ãƒ¡ãƒ¢...">${escapeHtml(r.memoText||'')}</textarea>
      </td>

      <td style="white-space:nowrap;">
        <button class="secondary" data-tip="ã“ã®é …ç›®ã‚’ç·¨é›†ã—ã¾ã™" onclick="editTask('${r.id}')">ç·¨é›†</button>
        <button class="secondary" onclick="moveStatus('${r.id}','doing')">â†’é€²è¡Œä¸­</button>
        <button class="secondary" onclick="moveStatus('${r.id}','done')">âœ“å®Œäº†</button>
        <button class="secondary" onclick="editTaskMemo('${r.id}')">ãƒ¡ãƒ¢</button>
        <button class="secondary" onclick="delTask('${r.id}')">å‰Šé™¤</button>
      </td>
    `;

    tb.appendChild(tr);
  }
  attachTaskInlineEditHandlers();
}
let INLINE_BOUND = false;
function attachTaskInlineEditHandlers(){
  if (INLINE_BOUND) return; INLINE_BOUND = true;
  const tb = document.querySelector('#taskTable tbody'); if(!tb) return;

  // æ—¢å­˜: ã‚¿ã‚¤ãƒˆãƒ«/æœŸé™/å„ªå…ˆåº¦ã¯ "ã‚¯ãƒªãƒƒã‚¯" ã§ç·¨é›†
  tb.addEventListener('click', (e)=>{
    const cell = closestSafe(e.target, '.cell-title, .cell-due, .cell-prio');
    if(!cell || cell.dataset.editing==='1') return;
    const tr = cell.closest('tr'); const id = tr?.dataset.id; if(!id) return;
    const field = cell.dataset.field;
    const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;

    cell.dataset.editing='1';
    const oldHTML = cell.innerHTML;

    let input;
    if(field==='title'){
      input = document.createElement('input');
      input.type='text'; input.value=t.title||''; input.style.width='100%';
    }else if(field==='dueDate'){
      input = document.createElement('input');
      input.type='date'; input.value=t.dueDate||'';
    }else if(field==='priority'){
      input = document.createElement('select');
      ['','é«˜','ä¸­','ä½'].forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v||'-';
        if(normPriority(t.priority||'')===v) o.selected=true; input.appendChild(o);
      });
    }
    const ctl = document.createElement('span');
    ctl.className = 'inline-ctl';
    const ok = document.createElement('button'); ok.className='ok'; ok.textContent='âœ”ï¸';
    const ng = document.createElement('button'); ng.className='ng'; ng.textContent='âœ–ï¸';
    const wrap = document.createElement('span');
    wrap.appendChild(input); wrap.appendChild(ctl);
    ctl.appendChild(ok); ctl.appendChild(ng);
    cell.innerHTML=''; cell.appendChild(wrap); input.focus();

    const cancel=()=>{ cell.innerHTML = oldHTML; cell.dataset.editing=''; };
    const commit=()=>{
      const patch={};
      if(field==='title')    patch.title = input.value.trim();
      if(field==='dueDate')  patch.dueDate = input.value;
      if(field==='priority') patch.priority = input.value;
      const send = Object.assign({}, t, patch);

      try{
        google.script.run
          .withSuccessHandler(()=>{
            showToast('ok','ä¿å­˜ã—ã¾ã—ãŸ');
            cell.classList.add('cell-flash'); setTimeout(()=>cell.classList.remove('cell-flash'),1200);
            refresh();
          })
          .withFailureHandler(err=>{ showToast('ng', (err && err.message) ? err.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); cancel(); })
          .upsertTask(send);
      }catch(e){
        showToast('ng','é€šä¿¡ã‚¨ãƒ©ãƒ¼'); cancel();
      }
      cell.dataset.editing='';
    };

    input.addEventListener('keydown', ev=>{ if(ev.key==='Escape'){ ev.preventDefault(); cancel(); } if(ev.key==='Enter'){ ev.preventDefault(); commit(); } });
    ok.addEventListener('click', commit);
    ng.addEventListener('click', cancel);
    input.addEventListener('blur', ()=> setTimeout(()=>{ if(cell.dataset.editing==='1') cancel(); }, 10));
  });

  // â˜… è¿½åŠ : ãƒ¡ãƒ¢ã¯ "ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯" ã§ç·¨é›†ï¼ˆtextareaï¼‰
  tb.addEventListener('dblclick', (e)=>{
    const cell = closestSafe(e.target, '.cell-memo');
    if(!cell || cell.dataset.editing==='1') return;
    const tr = cell.closest('tr'); const id = tr?.dataset.id; if(!id) return;
    const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;

    cell.dataset.editing='1';
    const oldHTML = cell.innerHTML;

    const ta = document.createElement('textarea');
    ta.value = t.memoText || '';
    ta.style.width = '100%';
    ta.style.minHeight = '88px';

    const ctl = document.createElement('span');
    ctl.className = 'inline-ctl';
    const ok = document.createElement('button'); ok.className='ok'; ok.textContent='âœ”ï¸';
    const ng = document.createElement('button'); ng.className='ng'; ng.textContent='âœ–ï¸';

    const wrap = document.createElement('div');
    wrap.appendChild(ta);
    wrap.appendChild(ctl);
    ctl.appendChild(ok); ctl.appendChild(ng);
    cell.innerHTML = '';
    cell.appendChild(wrap);
    ta.focus();

    const cancel = ()=>{ cell.innerHTML = oldHTML; cell.dataset.editing=''; };
    const commit  = ()=>{
      const newMemo = ta.value;
      try{
        google.script.run
          .withSuccessHandler(()=>{
            showToast('ok','ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            // è»½é‡åæ˜ ï¼ˆå³æ™‚è¦‹ãŸç›®æ›´æ–°ï¼‰
            const idx = safeArr(DATA.tasks).findIndex(x=>x.id===id);
            if (idx>=0) DATA.tasks[idx].memoText = newMemo;
            cell.innerHTML = escapeHtml(String(newMemo).replace(/\n/g,' '));
            cell.title = newMemo || '';
            cell.classList.add('cell-flash'); setTimeout(()=>cell.classList.remove('cell-flash'),1200);
            cell.dataset.editing='';
          })
          .withFailureHandler(err=>{ showToast('ng', (err && err.message) ? err.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); cancel(); })
          .saveTaskMemo(id, newMemo);  // â† æ—¢å­˜ã®ãƒ¡ãƒ¢ä¿å­˜APIã‚’ä½¿ç”¨
      }catch(e){
        showToast('ng','é€šä¿¡ã‚¨ãƒ©ãƒ¼'); cancel();
      }
    };

    // ã‚­ãƒ¼æ“ä½œ: Esc=ã‚­ãƒ£ãƒ³ã‚»ãƒ« / Ctrl+Enter=ä¿å­˜
    ta.addEventListener('keydown', ev=>{
      if(ev.key==='Escape'){ ev.preventDefault(); cancel(); }
      if(ev.key==='Enter' && (ev.ctrlKey || ev.metaKey)){ ev.preventDefault(); commit(); }
    });
    ok.addEventListener('click', commit);
    ng.addEventListener('click', cancel);
    // textarea ã¯èª¤æ“ä½œé˜²æ­¢ã®ãŸã‚ blur ã§ã¯ä¿å­˜ã›ãšã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯„ã‚Šã«
    ta.addEventListener('blur', ()=> setTimeout(()=>{ if(cell.dataset.editing==='1') cancel(); }, 10));
  });
}

// è¿½åŠ : é€šå¸¸ï¼ˆã‚¹ã‚¤ãƒ OFFï¼‰æ™‚ã¯å†…å´ã® #col_xxx è‡ªä½“ã«ã‚‚ drop/dragover ã‚’ä»˜ä¸
function _wireInnerDrops_(){
  const map = { col_todo:'todo', col_doing:'doing', col_blocked:'blocked', col_done:'done' };
  Object.entries(map).forEach(([id, st])=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('dragover', e => allowDrop(e));
    el.addEventListener('drop', e => onDrop(e, st));
  });
}
// Kanban (é€šå¸¸/ã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³ ä¸¡å¯¾å¿œ)
function renderKanban() {
  if (ACTIVE_TAB !== 'board') return;

  const host = document.querySelector('#view-board .kanban');
  if (!host) return;

  const useSwim = !!document.getElementById('opt_swimlane')?.checked;
  const rows = filterTasks(safeArr(DATA.tasks));
  const cols = ['todo', 'doing', 'blocked', 'done'];

  // ---- helpers (ã“ã®é–¢æ•°å†…ã ã‘ã§ä½¿ç”¨) ----
  const safeId = s => String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_') || 'none';
  const primaryAssigneeKey = t => {
    const arr = String(t.assignees || '').split(',').map(s => s.trim()).filter(Boolean);
    return arr[0] || '__NONE__';
  };
  const displayNameFromKey = k => (k === '__NONE__' ? 'æœªå‰²å½“' : (nameByUserId(k) || k));
  const assigneesLabel = r => String(r.assignees || '').split(',')
                          .map(s => s.trim()).filter(Boolean).map(nameByUserId).join(', ');

  function buildCard(r, rightLabelHtml) {
    const theme = themeFor(r.projectId || '', r);
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel === 'é«˜' ? 'high' : prioLabel === 'ä¸­' ? 'mid' : prioLabel === 'ä½' ? 'low' : '';
    const aging = ageClass(r);

    const tDocUrl = getTaskDocUrl(r.id);
    const pDocUrl = getProjectDocUrl(r.projectId || '');
    const docsBtns = [
      tDocUrl ? `<button class="secondary" onclick="openTaskDocById('${r.id}')">Task Docs</button>` : '',
      pDocUrl ? `<button class="secondary" onclick="openProjectDocById('${r.projectId || ''}')">Proj Docs</button>` : ''
    ].filter(Boolean).join(' ');

    const attN = countAttachments('task', r.id);
    const attBadge = attN
      ? `<span class="doc-badge" title="æ·»ä»˜ ${attN}ä»¶" onclick="openAttachmentManager('task','${r.id}')">ğŸ“${attN}</span>`
      : '';

    const card = document.createElement('div');
    card.className = 'cardlet ' + aging;
    card.style.background = theme.bg;
    card.style.borderColor = theme.border;
    card.setAttribute('draggable','true');
    card.addEventListener('dragstart', ev => {
      if (ev && ev.dataTransfer) {
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData('text/plain', r.id);
        ev.dataTransfer.setData('text', r.id); // â˜…ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      }
    });
    

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:6px;align-items:center;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="color-swatch" style="background:${theme.border}"></span>
          <strong style="font-size:12px;">${escapeHtml(r.title || '')}</strong>
        </div>
        <span class="pill prio-badge ${prc ? ('prio-' + prc) : ''}"
              style="font-size:11px;padding:1px 6px;">${escapeHtml(prioLabel)}</span>
      </div>
      <div class="muted" style="margin-top:2px;font-size:11px;display:flex;justify-content:space-between;">
        <span>${r.dueDate || ''}</span>
        <span>${rightLabelHtml}</span>
      </div>
      ${attBadge ? `<div style="margin-top:2px;font-size:11px;">${attBadge}</div>` : ''}
      ${docsBtns ? `<div class="toolbar" style="margin-top:4px;">${docsBtns}</div>` : ''}
      <div style="margin-top:4px;display:flex;gap:4px;justify-content:flex-end;">
        <button class="secondary mini" onclick="moveStatus('${r.id}','todo')">æœªç€æ‰‹</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','doing')">é€²è¡Œä¸­</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','blocked')">ä¿ç•™ä¸­</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','done')">å®Œäº†</button>
      </div>`;
    return card;
  }

  // ==== é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³ OFFï¼‰====
  if (!useSwim) {
    host.classList.remove('is-swim');

    const colMap = {
      todo:    document.getElementById('col_todo'),
      doing:   document.getElementById('col_doing'),
      blocked: document.getElementById('col_blocked'),
      done:    document.getElementById('col_done'),
    };
    const cntMap = {
      todo:    document.getElementById('cnt_todo'),
      doing:   document.getElementById('cnt_doing'),
      blocked: document.getElementById('cnt_blocked'),
      done:    document.getElementById('cnt_done'),
    };

    // éª¨çµ„ã¿ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆå®‰å…¨ç­–ï¼‰
    for (const c of cols) {
      if (!colMap[c] || !cntMap[c]) return;
      colMap[c].innerHTML = '';
      cntMap[c].textContent = '0';
    }

    rows.forEach(r => {
      const st = (r.status || 'todo').toLowerCase();
      const col = colMap[st] || colMap.todo;
      const right = assigneesLabel(r); // å³å´ã¯æ‹…å½“è€…åè¡¨ç¤º
      col.appendChild(buildCard(r, escapeHtml(right)));
    });

    // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    for (const c of cols) {
      const cntEl = cntMap[c];
      const colEl = colMap[c];
      if (cntEl && colEl) cntEl.textContent = String(colEl.children.length);
    }
    _wireInnerDrops_();
    return;
  }

  // ==== ã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‹…å½“è€…ã”ã¨ã«4åˆ— Ã— ãƒ¬ãƒ¼ãƒ³ï¼‰====
  host.classList.add('is-swim');
  host.innerHTML = '';

  // ãƒ¬ãƒ¼ãƒ³ä½œæˆï¼ˆä¸»æ‹…å½“ï¼assignees ã®å…ˆé ­ã€‚ã„ãªã‘ã‚Œã° __NONE__ï¼‰
  const lanesMap = new Map();
  rows.forEach(t => {
    const key = primaryAssigneeKey(t);
    if (!lanesMap.has(key)) lanesMap.set(key, { key, name: displayNameFromKey(key), tasks: [] });
    lanesMap.get(key).tasks.push(t);
  });

  // ãƒ¬ãƒ¼ãƒ³ã”ã¨ã«æç”»
  Array.from(lanesMap.values())
    .sort((a, b) => a.name.localeCompare(b.name, 'ja'))
    .forEach(lane => {
      const wrap = document.createElement('div');
      wrap.className = 'lane-wrap see-through';
      wrap.style.cssText = 'border:1px solid var(--border); border-radius:12px; padding:8px; background:#f9fafb;';
      wrap.setAttribute('data-lane-key', lane.key);

      // 4ã‚«ãƒ©ãƒ ã®éª¨çµ„ã¿
      wrap.innerHTML = `
        <h3 style="margin:0 0 6px 0;">ğŸ‘¤ ${escapeHtml(lane.name)}</h3>
        <div class="kanban" style="grid-template-columns:repeat(4,1fr); gap:8px;">
          ${cols.map(c => {
            const sid = `lane_${safeId(lane.key)}_${c}`;
            return `
              <div class="col" data-status="${c}" data-lane-key="${lane.key}"
                   ondragover="allowDrop(event)" ondrop="onDrop(event, '${c}')">
                <h3>${labelStatus(c)} <span class="muted">0</span></h3>
                <div id="${sid}"></div>
              </div>`;
          }).join('')}
        </div>`;
      host.appendChild(wrap);

      // ã‚«ãƒ¼ãƒ‰æŒ¿å…¥
      cols.forEach(c => {
        const slot = wrap.querySelector(`#lane_${safeId(lane.key)}_${c}`);
        if (!slot) return;

        lane.tasks
          .filter(t => String(t.status || 'todo').toLowerCase() === c)
          .forEach(r => {
            // å³å´ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆã‚¹ã‚¤ãƒ æ™‚ã¯æ‹…å½“ã¯è¦‹å‡ºã—ã§åˆ†ã‹ã‚‹ãŸã‚ï¼‰
            const right = nameByProjectId(r.projectId || '') || '';
            slot.appendChild(buildCard(r, escapeHtml(right)));
          });

        // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        const cntSpan = slot.parentElement.querySelector('h3 .muted');
        if (cntSpan) cntSpan.textContent = String(slot.children.length);
      });
    });
}


// Projects table
function renderProjects() {
  const tb = document.querySelector('#projTable tbody'); if (!tb) return;

  tb.innerHTML = '';
  let rows = safeArr(DATA.projects)
    .filter(p => String(p.status||'').toLowerCase() !== 'archived')
    .slice(0,500);

  for (const r of rows) {
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel === 'é«˜' ? 'high'
            : prioLabel === 'ä¸­' ? 'mid'
            : prioLabel === 'ä½' ? 'low' : '';

    // Docs ã® URLï¼ˆæœªå®šç¾©å¯¾ç­–ï¼‰
    const pDocUrl = getProjectDocUrl(r.id);

    const attBtn = '<button class="secondary" data-tip="æ·»ä»˜URLä¸€è¦§ã‚’é–‹ãã¾ã™ã€‚"  onclick="toggleAttachmentList(\'project\',\''+r.id+'\', this)">æ·»ä»˜URL</button>';
    const badge  = pDocUrl ? '<span class="doc-badge" title="Project Doc" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™ã€‚" onclick="openProjectDocById(\''+r.id+'\')">ğŸ“„Doc</span>' : '';

    const tr = document.createElement('tr');

    const attN = countProjectAttachmentsDeep(r.id);
    const attBadge = attN
      ? '<span class="doc-badge" data-tip="æ·»ä»˜URLä¸€è¦§ã‚’é–‹ãã¾ã™ã€‚" title="æ·»ä»˜ '+attN+'ä»¶" onclick="toggleAttachmentList(\'project\',\''+r.id+'\', this)">ğŸ“'+attN+'</span>'
      : '';

    // è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒã‚§ã‚¤ãƒ‹ãƒ³ã‚°ãªã—ï¼‰
    var parent = safeArr(DATA.projects).find(function(p){ return String(p.id) === String(r.parentProjectId); });
    var parentName = parent ? (parent.name || '') : '';

    // ã‚¿ã‚¹ã‚¯æ•°
    const projTasks    = safeArr(DATA.tasks).filter(t => String(t.projectId) === String(r.id));
    const doneCount    = projTasks.filter(t => String(t.status||'').toLowerCase() === 'done').length;
    const notDoneCount = projTasks.length - doneCount;

    const theme = themeFor(r.id, null);
    const bg = ' style="background:'+theme.bg+'"';

    // ã€Œä¸€è¦§ã€ãƒœã‚¿ãƒ³ï¼ˆå…¥ã‚Œå­ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå›é¿ï¼‰
    const listBtn = projTasks.length
      ? '<button class="secondary mini" style="margin-left:6px;" data-tip="ã‚¿ã‚¹ã‚¯ä¸€è¦§/çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¾ã™" onclick="toggleProjectTaskList(\''+r.id+'\', this)">ä¸€è¦§</button>'
      : '';

    const hardBtn = (String(PAGE||'') === 'projects')
      ? ' <button class="secondary" data-tip="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é–¢é€£ã‚¿ã‚¹ã‚¯/æ·»ä»˜URLã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰ã€‚" onclick="deleteProjectHard(\''+r.id+'\')">å®Œå…¨å‰Šé™¤</button>'
      : '';

    tr.innerHTML =
      '<td'+bg+'>'+escapeHtml(r.name||'')+badge+' '+attBadge+'</td>'+
      '<td'+bg+'>'+escapeHtml(parentName)+'</td>'+
      '<td'+bg+'>'+escapeHtml(nameByUserId(r.ownerUserId||''))+'</td>'+
      '<td class="cell-prio '+(prc?('prio-'+prc):'')+'">'+
        '<span class="pill prio-badge '+(prc?('prio-'+prc):'')+'">'+
          escapeHtml(prioLabel || '')+
        '</span>'+
      '</td>'+
      '<td'+bg+'>'+notDoneCount+' / '+doneCount+' '+listBtn+'</td>'+
      '<td class="cell-memo"'+bg+'>'+
        '<textarea class="memo-edit" data-kind="project" data-id="'+r.id+'" placeholder="ãƒ¡ãƒ¢...">'+escapeHtml(r.memoText||'')+'</textarea>'+
      '</td>'+
      '<td'+bg+'>'+(r.budget||'')+'</td>'+
      '<td'+bg+'>'+(r.startDate||'')+'-'+(r.endDate||'')+'</td>'+
      '<td>'+
        attBtn+
        ' <button class="secondary" data-tip="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦ç·¨é›†ã—ã¾ã™ã€‚" onclick="editProject(\''+r.id+'\')">ç·¨é›†</button>'+
        hardBtn+
        ' <button class="secondary" data-tip="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†æ‰±ã„ã¨ã—ã¦ã€éå»ãƒ­ã‚°ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã€‚ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚¿ãƒ–ã§é–²è¦§ãƒ»å¾©æ´»ã§ãã¾ã™ã€‚" onclick="toggleArchiveProject(\''+r.id+'\')">'+
          ((String(r.status||'').toLowerCase()==='archived')?'å¾©æ´»':'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–')+
        '</button>'+
      '</td>';

    tb.appendChild(tr);
  }
}



function openAttachDialogFor(kind, id){
  const sample = 'ä¾‹)\nè¨­è¨ˆè³‡æ–™,https://docs.google.com/document/d/xxxxxxxx';
  const txt = prompt(`æ·»ä»˜ã™ã‚‹URL/Driveãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ”¹è¡Œã§è¤‡æ•°å…¥åŠ›ã§ãã¾ã™ã€‚\n"${sample}"\n`, '');
  if (txt === null) return;
  const items = parseAttachmentLines(txt);
  if (!items.length) return;
  gsr().withSuccessHandler(()=>refresh()).upsertAttachments(kind, id, items);
}


// Subs / Ledger list
function renderSubs() {
  const tb = document.querySelector('#subTable tbody'); if (!tb) return;
  tb.innerHTML='';
  const rows = safeArr(DATA.subs).slice().sort((a,b)=>String(a.nextBillDate).localeCompare(String(b.nextBillDate)));
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.nextBillDate||''}</td>
      <td>${escapeHtml(r.serviceName||'')}</td>
      <td>${r.amount||''}</td>
      <td>${r.cycle||''}</td>
      <td><button class="secondary" onclick="delSub('${r.id}')">å‰Šé™¤</button></td>`;
    tb.appendChild(tr);
  }
}
function renderLedger() {
  const tb = document.querySelector('#ledTable tbody'); if (!tb) return;
  tb.innerHTML = '';
  const rows = combinedLedgerRows().slice(0, 20);
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.kind}</td>
      <td>${r.type||''}</td>
      <td>${escapeHtml(r.title || '')}</td>
      <td>${(Number(r.amount||0)).toLocaleString()}</td>
      <td>${escapeHtml(r.account||'')}</td>
      <td>${escapeHtml(r.counterpart||'')}</td>`;
    tb.appendChild(tr);
  }
}


// --- Users ---
function addUser() {
  const u = { name: val('u_name'), email: val('u_email'), role: val('u_role'), department: val('u_dept') };
  if(!u.name || !u.email){ alert('æ°åã¨ãƒ¡ãƒ¼ãƒ«ã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(row => { patchRow('users', row); rerenderAfter('users'); }).upsertUser(u);
}
function renderUsers() {
  const tb = document.querySelector('#userTable tbody'); if (!tb) return;
  tb.innerHTML='';
  safeArr(DATA.users).forEach(u=>{
    const tr = document.createElement('tr');
    const checked = isAttendanceVisibleUser(u) ? 'checked' : '';
    tr.innerHTML = `
      <td>${escapeHtml(u.name||'')}</td>
      <td>${escapeHtml(u.email||'')}</td>
      <td>${escapeHtml(u.role||'')}</td>
      <td>${escapeHtml(u.department||'')}</td>
      <td style="text-align:center;"><input type="checkbox" data-uid="${escapeHtml(u.id)}" data-field="attendanceVisible" ${checked}/></td>
      <td><input data-uid="${escapeHtml(u.id)}" data-field="employeeNumber" value="${escapeHtml(u.employeeNumber||'')}" placeholder="12345"/></td>
      <td><input data-uid="${escapeHtml(u.id)}" data-field="calendarUrl" value="${escapeHtml(u.calendarUrl||'')}" placeholder="https://calendar.google.com/.../basic.ics"/></td>
      <td><button class="secondary" onclick="delUser('${u.id}')">å‰Šé™¤</button></td>
    `;
    tb.appendChild(tr);
  });

  // Save user settings on change.
  tb.querySelectorAll('input[data-uid]').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const uid = inp.getAttribute('data-uid');
      const field = inp.getAttribute('data-field');
      if(!uid || !field) return;

      let value = null;
      if (inp.type === 'checkbox') value = !!inp.checked;
      else value = inp.value;

      const patch = { id: uid };
      patch[field] = value;
      gsr().withSuccessHandler(row=>{ patchRow('users', row); rerenderAfter('users'); toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', true); })
          .withFailureHandler(e=>{ toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä¿å­˜ã«å¤±æ•—: '+(e && e.message ? e.message : e), false); })
          .upsertUser(patch);
    }, { once:false });
  });
}
function delUser(id) { gsr().withSuccessHandler(()=>{ dropRow('users', id); rerenderAfter('users'); }).deleteUser(id); }
function delMinute(id) { gsr().withSuccessHandler(()=>{ dropRow('minutes', id); rerenderAfter('minutes'); }).deleteMinute(id); }

function deleteProjectHard(id){
  const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
  const name = p ? (p.name||p.id) : String(id);
  const ok = confirm(`âš  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã€‚\né–¢é€£ã‚¿ã‚¹ã‚¯/æ·»ä»˜URLã‚‚å‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\n\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
  if(!ok) return;

  gsr()
    .withSuccessHandler((r)=>{
      // Drop project
      dropRow('projects', String(id));

      // Drop related tasks (client-side)
      const removedTaskIds = new Set(
        safeArr(DATA.tasks).filter(t=>String(t.projectId)===String(id)).map(t=>String(t.id))
      );
      DATA.tasks = safeArr(DATA.tasks).filter(t=>String(t.projectId)!==String(id));

      // Drop attachments for project and those tasks
      DATA.attachments = safeArr(DATA.attachments).filter(a=>{
        const pt = String(a.parentType||'');
        const pid = String(a.parentId||'');
        if (pt==='project' && pid===String(id)) return false;
        if (pt==='task' && removedTaskIds.has(pid)) return false;
        return true;
      });

      rerenderAfter('projects');
      toast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸ', true);
    })
    .withFailureHandler((e)=>{
      toast('å®Œå…¨å‰Šé™¤ã«å¤±æ•—: '+(e && e.message ? e.message : e), false);
    })
    .deleteProjectHard(String(id));
}

// --- Vault (AES-GCM) ---
async function deriveKey(passphrase, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'PBKDF2', salt:salt, iterations:100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}
function b64e(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64d(str){ return Uint8Array.from(atob(str), c=>c.charCodeAt(0)); }
async function encryptText(passphrase, plaintext){
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase, salt);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv:iv}, key, enc.encode(plaintext));
  return JSON.stringify({v:1, alg:'AES-GCM', salt:b64e(salt), iv:b64e(iv), ct:b64e(ct)});
}
async function decryptText(passphrase, blob){
  const o = JSON.parse(blob);
  const salt = b64d(o.salt);
  const iv = b64d(o.iv);
  const key = await deriveKey(passphrase, salt);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv:iv}, key, b64d(o.ct));
  return new TextDecoder().decode(pt);
}
function renderCreds() {
  const tb = document.querySelector('#credTable tbody'); if (!tb) return;
  tb.innerHTML='';
  safeArr(DATA.credentials).forEach(c=>{
    const owner = nameByUserId((c && c.ownerUserId) || '');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.serviceName||'')}</td>
      <td><a href="${escapeHtml(c.url||'')}" target="_blank">${escapeHtml(c.url||'')}</a></td>
      <td>${escapeHtml(c.loginId||'')}</td>
      <td><button class="secondary" onclick="revealPassword('${c.id}')">å¾©å·</button></td>
      <td>${escapeHtml(owner||'')}</td>
      <td>${escapeHtml(c.note||'')}</td>
      <td><button class="secondary" onclick="delCredential('${c.id}')">å‰Šé™¤</button></td>`;
    tb.appendChild(tr);
  });
}
async function addCredential() {
  const pass = val('c_passphrase');
  if (!pass) { alert('æš—å·åŒ–ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const cipher = await encryptText(pass, val('c_password')||'');
  const c = {
    serviceName: val('c_service'),
    url: val('c_url'),
    loginId: val('c_login'),
    passwordCipher: cipher,
    ownerUserId: sel('c_owner'),
    note: val('c_note')
  };

  // â˜… row ã« id ãŒç„¡ã„å ´åˆã¯å·®åˆ†é©ç”¨ã›ãš refresh() ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  gsr()
    .withSuccessHandler(row => {
      if (row && row.id) {
        patchRow('credentials', row);
        rerenderAfter('credentials');
      } else {
        refresh();
      }
    })
    .upsertCredential(c);
}

async function revealPassword(id) {
  const pass = prompt('å¾©å·ç”¨ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›'); if (pass===null) return;
  const c = safeArr(DATA.credentials).find(x=>x.id===id);
  if (!c) return;
  try {
    const pwd = await decryptText(pass, c.passwordCipher);
    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ' + pwd);
  } catch(e) {
    alert('å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
  }
}
function delCredential(id) { gsr().withSuccessHandler(()=>{ dropRow('credentials', id); rerenderAfter('credentials'); }).deleteCredential(id); }

// --- Project/Task CRUD & Docs ---
function addProject() {
  const editId   = el('p_editing_id')?.value || '';
  const origName = el('p_editing_id')?.dataset?.orig || '';
  const nameNow  = val('p_name').trim();

  // â˜…åç§°ã‚’å¤‰ãˆãŸã¾ã¾æ›´æ–°ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ â†’ ä¸Šæ›¸ãç¢ºèª
  if (editId && origName && nameNow && nameNow !== origName) {
    const ok = confirm(
      `âš  æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${origName}ã€(ID:${editId}) ã‚’ã€Œ${nameNow}ã€ã«ãƒªãƒãƒ¼ãƒ ã—ã¦ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚\n` +
      `æœ¬å½“ã«ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\n\næ–°è¦è¿½åŠ ã«ã—ãŸã„å ´åˆã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€Œæ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`
    );
    if (!ok) return; // ä¸­æ–­
  }

  let pc = val('p_color');
  if (!editId && pc === '#ffffff') pc = ''; // æ–°è¦ï¼†ç™½â†’ç„¡æŒ‡å®šæ‰±ã„

  const p = {
    id: editId,
    name: nameNow,
    parentProjectId: sel('p_parent_select'),
    ownerUserId: sel('p_owner_select'),
    priority: val('p_priority'),
    color: pc,
    budget: val('p_budget'),
    startDate: val('p_start'),
    endDate: val('p_end'),
    memoText: val('p_memo'),
    status: 'active',
    fiscalYear: new Date().getFullYear()
  };
  resetProjectForm();
  
  gsr().withSuccessHandler(row => { patchRow('projects', row); rerenderAfter('projects'); }).upsertProject(p);
  
}


function addTask() {
  const editId    = el('t_editing_id')?.value || '';
  const origTitle = el('t_editing_id')?.dataset?.orig || '';
  const titleNow  = val('t_title').trim();

  // â˜…ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰ãˆãŸã¾ã¾æ›´æ–°ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ â†’ ä¸Šæ›¸ãç¢ºèª
  if (editId && origTitle && titleNow && titleNow !== origTitle) {
    const ok = confirm(
      `âš  æ—¢å­˜ã‚¿ã‚¹ã‚¯ã€Œ${origTitle}ã€(ID:${editId}) ã‚’ã€Œ${titleNow}ã€ã«ãƒªãƒãƒ¼ãƒ ã—ã¦ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚\n` +
      `æœ¬å½“ã«ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\n\næ–°è¦è¿½åŠ ã«ã—ãŸã„å ´åˆã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€Œæ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`
    );
    if (!ok) return; // ä¸­æ–­
  }

  let assigneesArr = selMulti('t_assignees_select');
  const ownerId = sel('t_owner_select');
  if (ownerId && !assigneesArr.includes(ownerId)) assigneesArr.push(ownerId);

  let tc = val('t_color');
  if (!editId && tc === '#ffffff') tc = ''; // æ–°è¦ï¼†ç™½â†’ç„¡æŒ‡å®šæ‰±ã„

  const t = {
    id: editId,
    projectId: sel('t_project_select'),
    parentTaskId: '',
    type: val('t_type'),
    title: titleNow,
    ownerUserId: sel('t_owner_select'),
    assignees: assigneesArr.join(','),
    dueDate: val('t_due'),
    status: 'todo',
    priority: val('t_prio'),
    color: tc,
    memoText: val('t_memo'),
    estimateHours: '',
    actualHours: '',
    rrule: (el('t_rrule')?.value) || '',
    nextOccurrence: ''
  };

  gsr().withSuccessHandler(row => { patchRow('tasks', row); rerenderAfter('tasks'); }).upsertTask(t);
}
function editTask(id){
  const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;
  el('t_title').value = t.title||'';
  el('t_project_select').value = t.projectId||'';
  el('t_type').value = t.type||'single';
  el('t_due').value = t.dueDate||'';
  el('t_owner_select').value = t.ownerUserId||'';

  const ms = el('t_assignees_select');
  if (ms) { Array.from(ms.options).forEach(o=>o.selected = String(t.assignees||'').split(',').includes(o.value)); }

  el('t_prio').value = normPriority(t.priority||'')||'';

  // â† ã“ã“ã‚’ä¿®æ­£ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼‰
  const rr = el('t_rrule'); if (rr) rr.value = t.rrule||'';

  if(el('t_color')) el('t_color').value = (t.color && /^#[0-9a-fA-F]{6}$/.test(t.color)) ? t.color : '#ffffff';
  el('t_memo').value = t.memoText||'';
  if (el('t_editing_id')) el('t_editing_id').value = t.id||'';
  el('t_editing_id').dataset.orig = t.title || '';
  const btn = el('btn_add_task'); if(btn) btn.textContent='ã‚¿ã‚¹ã‚¯æ›´æ–°';
}


function editTaskMemo(id) {
  const t = safeArr(DATA.tasks).find(x=>x.id===id); if (!t) return;
  const newMemo = prompt('ã‚¿ã‚¹ã‚¯ãƒ¡ãƒ¢ã‚’ç·¨é›†', t.memoText||'');
  if (newMemo===null) return;
  gsr().withSuccessHandler(()=>refresh()).saveTaskMemo(id, newMemo);
}

// Docs for Project: create & open (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å·®åˆ†é©ç”¨ã®ã¿)
async function createProjectDoc() {
  await ensureUsersLoaded();

  const projs = DATA.projects || [];
  const name  = val('p_name').trim();
  const target = projs.find(p => p.name === name) || projs[projs.length - 1];
  if (!target) { alert('å…ˆã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }

  gsr()
    .withSuccessHandler((res) => {
      // ã‚µãƒ¼ãƒã¯ { ok:true, project, url } ã‚’è¿”ã™æƒ³å®š
      if (res && res.project) { patchRow('projects', res.project); }
      rerenderAfter('projects');
      if (res && res.url) window.open(res.url, '_blank');
    })
    .withFailureHandler((err) => {
      alert('Docs ä½œæˆã‚¨ãƒ©ãƒ¼: ' + (err && err.message ? err.message : err));
    })
    .createProjectDoc(target.id);
}


function syncProjectDoc(mode) {
  const ds = document.getElementById('p_doc_status').dataset||{};
  const docId = ds.docid;
  if (!docId) { alert('å…ˆã«Docsä½œæˆ/å–å¾—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
  const memo = val('p_memo');
  const fn = (mode==='replace') ? 'replaceDocWithMemo' : 'appendDocWithMemo';
  gsr().withSuccessHandler(()=>alert('Docsã¸åŒæœŸã—ã¾ã—ãŸ'))[fn](docId, memo);
}
function openProjectDoc() {
  const ds = document.getElementById('p_doc_status')?.dataset||{};
  if (ds.docurl) window.open(ds.docurl, '_blank'); else alert('DocsãŒæœªä½œæˆã§ã™');
}

// Docs for Task: create & auto header
async function createTaskDoc() {
  await ensureUsersLoaded();

  const tasks = safeArr(DATA.tasks);
  const title = val('t_title');
  let target = tasks.find(t => t.title === title) || tasks[tasks.length - 1];
  if (!target) { alert('å…ˆã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }

  gsr().withSuccessHandler(function (res) {
    const idx = DATA.tasks.findIndex(t => t.id === target.id);
    if (idx >= 0) { DATA.tasks[idx].docId = res.docId; DATA.tasks[idx].docUrl = res.url; renderTasksTable(); renderKanban(); }

    const proj = projectById(target.projectId || '');
    const parentProj = proj ? projectById(proj.parentProjectId || '') : null;
    const parentName = parentProj?.name || '';
    const owner = displayUser(target.ownerUserId || '');
    const assignees = Array.from(new Set(String(target.assignees||'').split(',').map(s=>s.trim()).filter(Boolean))).map(displayUser).join(', ');

    const now = new Date(); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');

    const projName = proj?.name || '-';
    const projStart = proj?.startDate || '-';
    const projEnd   = proj?.endDate   || '-';
    const projBudgetNum = Number(proj?.budget||0);

    let body = '# ã‚¿ã‚¹ã‚¯: ' + (target.title || '') + '\n';
    body += 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ' + projName + (parentName ? 'ï¼ˆè¦ª: ' + parentName + 'ï¼‰' : '') + '\n';
    body += 'Docsä½œæˆæ—¥æ™‚: ' + `${y}-${m}-${d} ${hh}:${mm}` + 'ã€€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé–“: ' + projStart + 'ã€œ' + projEnd + '\n';
    if (projBudgetNum) body += 'äºˆç®—: ' + projBudgetNum.toLocaleString() + ' å††\n';
    body += 'è²¬ä»»è€…: ' + (owner || '-') + 'ã€€æ‹…å½“è€…: ' + (assignees || '-') + '\n\n---';

    gsr().withSuccessHandler(function () { }).replaceDocWithMemo(res.docId, body);

    const st = document.getElementById('t_doc_status');
    if (st) { st.textContent = 'ä½œæˆæ¸ˆã¿'; st.dataset.docid = res.docId; st.dataset.docurl = res.url; }
  }).createTaskDoc(target.id);
}


function syncTaskDoc(mode) {
  const ds = document.getElementById('t_doc_status').dataset||{};
  const docId = ds.docid;
  if (!docId) { alert('å…ˆã«Docsä½œæˆ/å–å¾—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
  const memo = val('t_memo');
  const fn = (mode==='replace') ? 'replaceDocWithMemo' : 'appendDocWithMemo';
  gsr().withSuccessHandler(()=>alert('Docsã¸åŒæœŸã—ã¾ã—ãŸ'))[fn](docId, memo);
}
function openTaskDoc() {
  const ds = document.getElementById('t_doc_status')?.dataset||{};
  if (ds.docurl) window.open(ds.docurl, '_blank'); else alert('DocsãŒæœªä½œæˆã§ã™');
}

// Status & deletion
function moveStatus(id, status) {
  gsr().withSuccessHandler((t)=>{
    const idx = safeArr(DATA.tasks).findIndex(x=>x.id===id);
    if (DATA && Array.isArray(DATA.tasks) && idx >= 0) DATA.tasks[idx].status = t.status;
    renderTasksTable(); renderKanban(); if (ACTIVE_TAB==='gantt') renderGantt();
  }).setTaskStatus(id, status);
}
function delTask(id) { gsr().withSuccessHandler(()=>{ dropRow('tasks', id); rerenderAfter('tasks'); }).deleteTask(id); }
function delSub(id)  { gsr().withSuccessHandler(()=>refresh()).deleteSubscription(id); }

// Edit/Archive project
function editProject(id){
  const p = safeArr(DATA.projects).find(x=>x.id===id); if(!p) return;
  el('p_name').value = p.name||'';
  el('p_parent_select').value = p.parentProjectId||'';
  el('p_owner_select').value = p.ownerUserId||'';
  el('p_priority').value = normPriority(p.priority||'')||'';
  el('p_budget').value = p.budget||'';
  el('p_start').value = p.startDate||'';
  el('p_end').value = p.endDate||'';
  el('p_memo').value = p.memoText||'';
  el('p_editing_id').value = p.id||'';
  if (el('p_color')) {
    el('p_color').value = (p.color && /^#[0-9a-fA-F]{6}$/.test(p.color)) ? p.color : '#ffffff';
  }
  el('p_editing_id').value = p.id||'';
  // â–¼ è¿½åŠ ï¼šç·¨é›†é–‹å§‹æ™‚ã®å…ƒåç§°ã‚’ä¿æŒ
  el('p_editing_id').dataset.orig = p.name || '';
  const btn = el('btn_add_project'); if (btn) btn.textContent='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°';
}
function toggleArchiveProject(id){
  const p = safeArr(DATA.projects).find(x=>x.id===id); if(!p) return;
  const ns = (String(p.status||'').toLowerCase()==='archived') ? 'active' : 'archived';
  gsr().withSuccessHandler(()=>refresh()).upsertProject(Object.assign({}, p, {status: ns}));
}

// Subs page
function addSubscription(){
  const s = {
    serviceName: val('s_service'),
    vendor: val('s_vendor'),
    startDate: '',
    amount: Number(val('s_amount')||0),
    taxIncluded: (sel('s_taxIncl')==='true'),
    projectId: sel('s_project'),
    taxCode: val('s_taxCode'),
    account: val('s_account')||'ã‚µãƒ–ã‚¹ã‚¯è²»ç”¨',
    cycle: sel('s_cycle')||'monthly',
    nextBillDate: val('s_nextBill'),
    autoJournal: (sel('s_autoJournal')==='true'),
    memoText: val('s_memo')
  };
  gsr().withSuccessHandler(()=>refresh()).upsertSubscription(s);
}
function renderSubsPage(){
  if (PAGE !== 'subs') return;
  const tb = document.querySelector('#subsTable tbody'); if (!tb) return;
  tb.innerHTML='';
  const rows = safeArr(DATA.subs).slice(0,500);
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.serviceName||'')}</td><td>${escapeHtml(r.vendor||'')}</td><td>${Number(r.amount||0).toLocaleString()}</td><td>${r.cycle||''}</td><td>${r.nextBillDate||''}</td><td>${(safeArr(DATA.projects).find(p=>p.id===r.projectId)?.name)||''}</td><td><button class="secondary" onclick="delSub('${r.id}')">å‰Šé™¤</button></td>`;
    tb.appendChild(tr);
  });
}

// --- Gantt ---
// æ—¥å¹…ã¯å›ºå®šï¼ˆã‚ºãƒ¼ãƒ å»ƒæ­¢ï¼‰
const GANTT_DAY_W = 40;

function applyGanttRange(){ renderGantt(false); }

function renderGantt(forceDefaults){
  if (ACTIVE_TAB !== 'gantt') return;
  const wrap = document.getElementById('gantt-container'); if (!wrap) return;

  const allTasks = filterTasks(safeArr(DATA.tasks));
  const projects = safeArr(DATA.projects);
  if (!allTasks.length) { wrap.innerHTML = '<div class="muted">è©²å½“ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }

  let startInput = el('gantt-start').value;
  let endInput   = el('gantt-end').value;

  // ç½®ãæ›ãˆå‰ã® computeDefaults() ã‚’ä¸‹è¨˜ã«å·®ã—æ›¿ãˆ
    function computeDefaults(){
      const today = parseYMDLocal(todayStr());  // â† ä»Šæ—¥ (ãƒ­ãƒ¼ã‚«ãƒ«) ã‚’å–å¾—
      let latestDue = null;

      // æœªå®Œã®ã‚¿ã‚¹ã‚¯æœŸé™ã®æœ€å¤§ã‚’æ‹¾ã†
      allTasks.forEach(t=>{
        const done = (String(t.status||'').toLowerCase()==='done');
        if (!done && t.dueDate){
          const d = parseYMDLocal(t.dueDate);
          if (d && (!latestDue || d > latestDue)) latestDue = d;
        }
      });

      // æœŸé™ãŒå–ã‚Œãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä½œæˆæ—¥ç­‰ï¼‰
      if (!latestDue){
        allTasks.forEach(t=>{
          const cand = parseYMDLocal(t.dueDate||t.nextOccurrence||t.startDate||t.createdAt);
          if (cand && (!latestDue || cand > latestDue)) latestDue = cand;
        });
      }

      // å·¦ç«¯ã¯å¸¸ã«ä»Šæ—¥ã€‚å³ç«¯ã¯æœ€å¤§æœŸé™+2æ—¥ ã‚‚ã—ãã¯ ä»Šæ—¥+60æ—¥ ã®é…ã„æ–¹
      const endCandidateA = latestDue ? addDays(latestDue, 2) : null;
      const endCandidateB = addDays(today, 60);
      const end = (endCandidateA && endCandidateA > endCandidateB) ? endCandidateA : endCandidateB;

      return { start: today, end };
    }


  if (!startInput || !endInput || forceDefaults===true){
    const {start, end} = computeDefaults();
    const fmt = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if (!startInput || forceDefaults===true) { el('gantt-start').value = fmt(start); startInput = el('gantt-start').value; }
    if (!endInput   || forceDefaults===true) { el('gantt-end').value   = fmt(end);   endInput   = el('gantt-end').value; }
  }

  const minD = parseYMDLocal(startInput);
  const maxD = parseYMDLocal(endInput);
  if (!minD || !maxD || (maxD<minD)){ wrap.innerHTML = '<div class="muted">è¡¨ç¤ºç¯„å›²ã®æ—¥ä»˜ãŒä¸æ­£ã§ã™</div>'; return; }

  const projMap = Object.fromEntries(projects.map(p=>[p.id,p]));
  const grouped = {};
  allTasks.forEach(t=>{ (grouped[t.projectId||'']||(grouped[t.projectId||'']=[])).push(t); });
  const projIds = Object.keys(grouped);

  const pxPerDay = GANTT_DAY_W;
  const weekCellW = pxPerDay * 7;
  const monthCellW = Math.max(90, pxPerDay*5);
  const cellW = Math.round(GANTT_SCALE==='month' ? monthCellW : (GANTT_SCALE==='week' ? weekCellW : pxPerDay));

  // ãƒ™ãƒ¼ã‚¹ã®ç¸¦ç½«
  const baseGrid = `repeating-linear-gradient(to right, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent ${cellW}px)`;
  let headBgImage = baseGrid;
  let headBgPos   = '0 0';

  let gridW, scaleHtml;

  if (GANTT_SCALE==='month'){
    const months=[]; let d=new Date(minD.getFullYear(),minD.getMonth(),1), end=new Date(maxD.getFullYear(),maxD.getMonth(),1);
    while (d<=end){ months.push(new Date(d)); d=new Date(d.getFullYear(), d.getMonth()+1, 1); }
    gridW = months.length * cellW;

    scaleHtml = `<div class="gantt-scale" style="width:${gridW}px; display:flex; background-image:${headBgImage}; background-size:auto 100%;">` +
      months.map(md=>{
        const label = md.getFullYear()+'/'+String(md.getMonth()+1).padStart(2,'0');
        return `<div style="flex:0 0 ${cellW}px; text-align:center; font-size:11px;">${label}</div>`;
      }).join('') + `</div>`;

  } else {
    // day / week ã¯ãƒ”ã‚¯ã‚»ãƒ«å¹…ã¯å¸¸ã«ã€Œæ—¥Ã—pxPerDayã€
    const totalDays = diffDays(minD, maxD) + 1;
    gridW = totalDays * pxPerDay;

    let cells='';
    if (GANTT_SCALE==='day'){
      // é€±æœ«ã‚¹ãƒˆãƒ©ã‚¤ãƒ—
      const dow = minD.getDay(); // Sun=0
      const sunOffset = ((7 - (dow % 7)) % 7) * pxPerDay;
      const satOffset = ((6 - dow + 7) % 7) * pxPerDay;
      const sunStripe = `repeating-linear-gradient(to right, rgba(220,38,38,.22) 0, rgba(220,38,38,.22) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
      const satStripe = `repeating-linear-gradient(to right, rgba(37,99,235,.18) 0, rgba(37,99,235,.18) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
      headBgImage = `${baseGrid}, ${sunStripe}, ${satStripe}`;
      headBgPos   = `0 0, ${sunOffset}px 0, ${satOffset}px 0`;

      for(let i=0;i<totalDays;i++){
        const d=addDays(minD, i);
        const label=(d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getDate().toString().padStart(2,'0');
        cells += `<div style="flex:0 0 ${pxPerDay}px; text-align:center; font-size:11px;">${label}</div>`;
      }

    } else {
      // week: æœˆæ›œã¯ã˜ã¾ã‚Šã®é€±ã§åŒºåˆ‡ã‚‹ã€‚ç¸¦ç½«ã¯é€±å¢ƒç•Œã«åˆã‚ã›ã‚‹
      const preDaysMon = ( (minD.getDay()+6) % 7 ); // Mon=0 ... Sun=6
      headBgPos = `${-preDaysMon*pxPerDay}px 0`;    // ç½«ç·šã‚’é€±ã«æ•´åˆ—

      const firstSpan = Math.min(7 - preDaysMon, totalDays);
      const rest = totalDays - firstSpan;
      const fullWeeks = Math.floor(rest / 7);
      const tail = rest % 7;

      const segs = [];
      let cursor = new Date(minD);

      // 1) å…ˆé ­ã®ç«¯æ•°
      if (firstSpan>0){
        const end = addDays(cursor, firstSpan-1);
        segs.push({days:firstSpan, label:`${String(cursor.getMonth()+1).padStart(2,'0')}/${String(cursor.getDate()).padStart(2,'0')}ã€œ${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
        cursor = addDays(cursor, firstSpan);
      }
      // 2) ãƒ•ãƒ«é€±
      for(let i=0;i<fullWeeks;i++){
        const start = new Date(cursor);
        const end = addDays(start, 6);
        segs.push({days:7, label:`W${i+1} ${String(start.getMonth()+1).padStart(2,'0')}/${String(start.getDate()).padStart(2,'0')}ã€œ${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
        cursor = addDays(cursor, 7);
      }
      // 3) æœ«å°¾ã®ç«¯æ•°
      if (tail>0){
        const start = new Date(cursor);
        const end = addDays(start, tail-1);
        segs.push({days:tail, label:`${String(start.getMonth()+1).padStart(2,'0')}/${String(start.getDate()).padStart(2,'0')}ã€œ${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
      }

      cells = segs.map(s=>`<div style="flex:0 0 ${s.days*pxPerDay}px; text-align:center; font-size:11px;">${s.label}</div>`).join('');
    }

    scaleHtml = `<div class="gantt-scale" style="width:${gridW}px; display:flex; background-image:${headBgImage}; background-position:${headBgPos}; background-size:auto 100%;">${cells}</div>`;
  }

  // ãƒ©ãƒ™ãƒ«ï¼ãƒ¬ãƒ¼ãƒ³
  const labelHtml = [];
  const laneHtml  = [];

  projIds.forEach(pid=>{
    const proj = projMap[pid];
    const color = hashColor(pid); // æ—¢å­˜
    const ownerName = nameByUserId(proj?.ownerUserId || '');
    const pDocUrl = getProjectDocUrl(pid);
    const docBadgeP = pDocUrl
      ? `<span class="doc-badge" title="Project Doc" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openProjectDocById('${pid}')">ğŸ“„Doc</span>`
      : '';
    const attNP = countAttachments('project', pid);
    const attBadgeP = attNP
      ? `<span class="doc-badge" title="æ·»ä»˜ ${attNP}ä»¶" onclick="openAttachmentManager('project','${pid}')">ğŸ“${attNP}</span>`
      : '';

    labelHtml.push(
      `<div style="height:26px; line-height:26px; padding:0 8px; font-weight:700; border-bottom:1px solid var(--border); background:#f3f4f6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ${escapeHtml(proj?.name || '(æœªå‰²å½“)')}
        ${ownerName ? `<span class="muted"> / ${escapeHtml(ownerName)}</span>` : ''}
        ${docBadgeP} ${attBadgeP}
      </div>`
    );
    laneHtml.push(`<div style="position:relative; height:26px; border-bottom:1px solid var(--border); width:${gridW}px; background:#fafafa;"></div>`);

    (grouped[pid]||[]).forEach(t=>{
      const sDate = parseYMDLocal(t.startDate||t.createdAt);
      const eDate = parseYMDLocal(t.dueDate||t.nextOccurrence||t.startDate||t.createdAt);

      let off=0, w=0;
      if (sDate && eDate){
        if (GANTT_SCALE==='month'){
          const sm=sDate.getFullYear()*12+sDate.getMonth();
          const mm=minD.getFullYear()*12+minD.getMonth();
          const em=eDate.getFullYear()*12+eDate.getMonth();
          off=Math.max(0,(sm-mm)*cellW);
          w  =Math.max(6,(em-sm+1)*cellW-6);
        } else {
          off=Math.max(0, diffDays(minD, sDate)*pxPerDay);                          // æ—¥â†’px
          w  =Math.max(6,(diffDays(sDate, eDate)+1)*pxPerDay-4);
        }
      }
      const title = escapeHtml(t.title||'');
      const bar = `<div title="${title}" style="position:absolute; left:${off}px; width:${w}px; top:4px; height:16px; border-radius:8px; background:${color.bg}; border:1px solid ${color.border};">
        <div style="position:absolute; left:0; right:0; top:-2px; font-size:11px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
      </div>`;

      // renderGantt å†…ã€å„ã‚¿ã‚¹ã‚¯ã®ãƒ©ãƒ™ãƒ«ç”Ÿæˆç®‡æ‰€ã‚’ç½®ãæ›ãˆ
      // ç½®æ›å‰ï¼šlabelHtml.push(`<div ...>${escapeHtml(proj?.name || '(æœªå‰²å½“)')} / <span class="muted">${title}</span></div>`);
      const tDocUrl = getTaskDocUrl(t.id);
      const docBadge = tDocUrl ? `<span class="doc-badge" title="Task Doc" data-tip="ã‚¿ã‚¹ã‚¯ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openTaskDocById('${t.id}')">ğŸ“„Doc</span>` : '';
      const attN = countAttachments('task', t.id);

      const attBadge = attN ? `<span class="doc-badge" title="æ·»ä»˜ ${attN}ä»¶" onclick="openAttachmentManager('task','${t.id}')">ğŸ“${attN}</span>` : '';

      labelHtml.push(
        `<div style="height:24px; line-height:24px; padding:0 8px; border-bottom:1px solid var(--border); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          <strong>${title}</strong> ${docBadge} ${attBadge}
        </div>`
      );

      // æœ¬ä½“èƒŒæ™¯ï¼ˆdayã®ã¿é€±æœ«å¸¯ï¼‰
      let bgImage = baseGrid, bgPos='0 0', bgSize='auto 100%';
      if (GANTT_SCALE==='day'){
        const dow = minD.getDay();
        const sunOffset = ((7 - (dow % 7)) % 7) * pxPerDay;
        const satOffset = ((6 - dow + 7) % 7) * pxPerDay;
        const sunStripe = `repeating-linear-gradient(to right, rgba(220,38,38,.28) 0, rgba(220,38,38,.28) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
        const satStripe = `repeating-linear-gradient(to right, rgba(37,99,235,.24) 0, rgba(37,99,235,.24) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
        bgImage = `${baseGrid}, ${sunStripe}, ${satStripe}`;
        bgPos   = `0 0, ${sunOffset}px 0, ${satOffset}px 0`;
      } else if (GANTT_SCALE==='week'){
        const preDaysMon = ( (minD.getDay()+6) % 7 );
        bgPos = `${-preDaysMon*pxPerDay}px 0`; // é€±å¢ƒç•Œã«åˆã‚ã›ã‚‹
      }

      // ä»Šæ—¥ãƒ©ã‚¤ãƒ³
      let todayBar = '';
      const today = new Date(); today.setHours(0,0,0,0);
      if (today >= minD && today <= maxD) {
        let left;
        if (GANTT_SCALE === 'month') {
          const sm = minD.getFullYear()*12+minD.getMonth();
          const tm = today.getFullYear()*12+today.getMonth();
          left = Math.max(0, (tm-sm)*cellW);
        } else {
          left = Math.max(0, diffDays(minD, today)*pxPerDay);
        }
        todayBar = `<div style="position:absolute; left:${left}px; top:0; bottom:0; width:2px; background:#ef4444; opacity:.5; pointer-events:none;"></div>`;
      }

      laneHtml.push(
        `<div style="position:relative; height:24px; border-bottom:1px solid var(--border); width:${gridW}px;
                    background-image:${bgImage}; background-position:${bgPos}; background-size:${bgSize};">
           ${todayBar}${bar}
         </div>`
      );
    });
  });

  wrap.innerHTML =
    '<div class="gantt-wrap" style="border:1px solid var(--border); border-radius:8px; overflow:hidden; width:100%; max-width:100%;">'
    + '<div class="gantt-head" style="display:flex; border-bottom:1px solid var(--border);">'
    +   '<div class="gantt-left" style="width:320px; flex:0 0 320px; font-weight:600; background:var(--card); border-right:1px solid var(--border);">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ / ã‚¿ã‚¹ã‚¯</div>'
    +   `<div class="gantt-right show-scrollbars" id="gantt-head-scroll" style="overflow:auto; flex:1 1 auto; max-width:100%;">${scaleHtml}</div>`
    + '</div>'
    + '<div class="gantt-main" style="display:flex; max-height:60vh;">'
    +   '<div class="gantt-left show-scrollbars" style="width:320px; flex:0 0 320px; border-right:1px solid var(--border); overflow:auto;">'+ labelHtml.join('') +'</div>'
    +   '<div class="gantt-right show-scrollbars" id="gantt-body-scroll" style="overflow:auto; flex:1 1 auto; max-width:100%;">'+ laneHtml.join('') +'</div>'
    + '</div>'
    + '</div>';

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼â‡„æœ¬ä½“ï¼‰â€” åŒæ–¹å‘ & ãƒ«ãƒ¼ãƒ—é˜²æ­¢
  const head = document.getElementById('gantt-head-scroll');
  const body = document.getElementById('gantt-body-scroll');
  if (head && body){
    let lock=false;
    head.addEventListener('scroll', ()=>{ if(lock) return; lock=true; body.scrollLeft = head.scrollLeft; lock=false; }, {passive:true});
    body.addEventListener('scroll', ()=>{ if(lock) return; lock=true; head.scrollLeft = body.scrollLeft; lock=false; }, {passive:true});
  }
}


// --- Ledger entry/plan (existing) ---
function addLedgerEntry(){
  const e = {
    date: val('l_date'),
    type: sel('l_type'),
    title: val('l_title'),             // â˜… è¿½åŠ 
    amount: Number(val('l_amount')||0),
    account: val('l_account'),
    counterpart: val('l_counterpart'),
    projectId: sel('l_project'),
    memoText: val('l_memo')
  };
  if (!e.date || !e.type || !e.amount){ alert('æ—¥ä»˜ãƒ»åŒºåˆ†ãƒ»é‡‘é¡ã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertLedgerEntry(e);
}
function combinedLedgerRows(){
  const singles = safeArr(DATA.ledger).map(e => ({
    kind: 'å˜ç™º',
    date: e.date || '',
    type: e.type,
    title: e.title || '',
    amount: Number(e.amount||0),
    account: e.account,
    counterpart: e.counterpart,
    projectId: e.projectId,
    memoText: e.memoText || '',
    id: e.id || ''
  }));

  // æ¬¡å›ç™ºç”Ÿæ—¥ãŒã‚ã‚‹å®šæœŸã®ã¿ä¸€è¦§ã«æ··ãœã‚‹
  const plans = safeArr(DATA.ledgerPlans).map(p => ({
    kind: 'å®šæœŸ',
    date: p.nextOccurrence || '',   // ä¸€è¦§ä¸Šã¯ã€Œæ¬¡å›ã€ã‚’æ—¥ä»˜ã¨ã—ã¦æ‰±ã†
    type: p.type,
    title: p.title || '',
    amount: Number(p.amount||0),
    account: p.account,
    counterpart: p.counterpart,
    projectId: p.projectId,
    memoText: p.memoText || '',
    rrule: p.rrule || '',
    id: p.id || ''
  }));

  return [...singles, ...plans]
    .filter(r => r.date)  // æ—¥ä»˜æœªè¨­å®šã¯é™¤å¤–
    .sort((a,b)=> String(b.date).localeCompare(String(a.date)));
}

function addLedgerPlan(){
  const p = {
    title: val('lp_title'),
    type: sel('lp_type'),
    amount: Number(val('lp_amount')||0),
    account: val('lp_account'),
    counterpart: val('lp_counterpart'),
    projectId: sel('lp_project'),
    rrule: val('lp_rrule'),
    nextOccurrence: val('lp_next'),
    memoText: val('lp_memo')
  };
  if (!p.title || !p.type || !p.amount || !p.rrule){ alert('åç§°ãƒ»åŒºåˆ†ãƒ»é‡‘é¡ãƒ»RRULEã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertLedgerPlan(p);
}
function delLedgerPlan(id){ gsr().withSuccessHandler(()=>refresh()).deleteLedgerPlan(id); }

function renderLedgerPage(){
  if (PAGE !== 'ledger') return;

  // å®šæœŸã®ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜ï¼‰â€”ãã®ã¾ã¾
  const tbp = document.querySelector('#ledgerPlanTable tbody');
  if (tbp){
    tbp.innerHTML='';
    safeArr(DATA.ledgerPlans)
      .slice()
      .sort((a,b)=> String(a.nextOccurrence||'').localeCompare(String(b.nextOccurrence||'')))
      .forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.title||'')}</td>
          <td>${escapeHtml(r.type||'')}</td>
          <td>${Number(r.amount||0).toLocaleString()}</td>
          <td>${escapeHtml(r.rrule||'')}</td>
          <td>${escapeHtml(r.nextOccurrence||'')}</td>
          <td><button class="secondary" onclick="delLedgerPlan('${r.id}')">å‰Šé™¤</button></td>`;
        tbp.appendChild(tr);
      });
  }

  // â˜… å˜ç™ºï¼‹å®šæœŸï¼ˆæ¬¡å›ï¼‰ã‚’çµ±åˆã—ãŸä¸€è¦§ï¼ˆæœ€æ–°50ä»¶ï¼‰
  const tbl = document.querySelector('#ledgerTableFull tbody');
  if (tbl){
    tbl.innerHTML='';
    combinedLedgerRows().slice(0,50).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date||''}</td>
        <td>${r.kind}</td>
        <td>${r.type||''}</td>
        <td>${escapeHtml(r.title||'')}</td>
        <td>${Number(r.amount||0).toLocaleString()}</td>
        <td>${escapeHtml(r.account||'')}</td>
        <td>${escapeHtml(r.counterpart||'')}</td>
        <td>${escapeHtml(nameByProjectId(r.projectId||''))}</td>
        <td>${escapeHtml(r.memoText||'')}</td>`;
      tbl.appendChild(tr);
    });
  }
}



// --- Misc/Utils ---
function parseISODateOnly(s){ const m=/^(\d{4})-(\d{2})-(\d{2})/.exec(String(s||'')); return m?new Date(+m[1],+m[2]-1,+m[3]):null; }
function ageDaysForTask(t){
  // æ›´æ–°æ—¥ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°ä½œæˆæ—¥ã€‚å®Œäº†ã¯0å›ºå®š
  if (String(t.status||'').toLowerCase()==='done') return 0;
  const base = parseISODateOnly(t.updatedAt) || parseISODateOnly(t.createdAt);
  if(!base) return 0;
  const today = new Date(); today.setHours(0,0,0,0);
  return Math.max(0, Math.floor((today - base) / (24*60*60*1000)));
}
function ageClass(t){
  const d = ageDaysForTask(t);
  if (d>=14) return 'age-14';
  if (d>=7)  return 'age-7';
  if (d>=3)  return 'age-3';
  return '';
}
function showToast(kind, msg, ms=2200){
  const host = document.getElementById('toast-stack'); if(!host) return alert(msg);
  const div = document.createElement('div');
  div.className = 'toast ' + (kind==='ok'?'ok':(kind==='ng'?'ng':'')); div.textContent = msg;
  host.appendChild(div);
  setTimeout(()=>{ div.style.opacity=.0; div.style.transform='translateY(6px)'; }, ms);
  setTimeout(()=>div.remove(), ms+350);
}

function val(id){
  const n = document.getElementById(id);
  return n ? n.value : '';
}

function sel(id){ const el=document.getElementById(id); return el ? (el.value||'') : ''; }
function selMulti(id){ const el=document.getElementById(id); if (!el) return []; return Array.from(el.selectedOptions).map(o=>o.value); }
function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }
function el(id){ return document.getElementById(id); }
function forceResync(){ refresh(); }
// ---- Theme Color helpers (Spreadsheetã® color åˆ—ã‚’å„ªå…ˆ) ----
function hashColor(id){
  const s = String(id||'0'); let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  const hue = Math.abs(h)%360;
  return { bg: `hsl(${hue}, 80%, 85%)`, border: `hsl(${hue}, 70%, 55%)` };
}
function hexToRgb(hex){
  if(!hex) return null;
  let h = String(hex).trim();
  if(h.startsWith('#')) h = h.slice(1);
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return null;
  const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
  return {r,g,b};
}

function transparentTheme(){ return { bg: 'transparent', border: 'rgba(0,0,0,.1)' }; }

// æ—¢å­˜ themeFromHex / themeFor ã‚’èª¿æ•´
function themeFromHex(hex, fallbackId){
  if (!hex) return hashColor(fallbackId||'0');
  if (String(hex).toLowerCase()==='#ffffff') return transparentTheme(); // ç™½ã¯é€æ˜æ‰±ã„
  const rgb = hexToRgb(hex);
  if(!rgb){ return hashColor(fallbackId||'0'); }
  // ä»¥é™ã¯æ—¢å­˜ã®ã¾ã¾ï¼ˆãƒ‘ã‚¹ãƒ†ãƒ«ç”Ÿæˆï¼‰...
  const r=rgb.r/255, g=rgb.g/255, b=rgb.b/255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=0; s=0; } else {
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      default: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  const H=Math.round(h*360);
  const S=Math.round(Math.min(0.45, s)*100);
  const L=96;
  return { bg: `hsl(${H}, ${S}%, ${L}%)`, border: `rgb(${rgb.r},${rgb.g},${rgb.b})` };
}

function themeFor(projectId, task){
  const p = projectById(projectId||'');
  const tHex = (task && task.color) ? String(task.color).trim() : '';
  const pHex = (p && p.color) ? String(p.color).trim() : '';
  // ç„¡æŒ‡å®š or #ffffff ã¯é€æ˜èƒŒæ™¯
  if(!tHex || tHex.toLowerCase()==='#ffffff'){
    if(!pHex || pHex.toLowerCase()==='#ffffff') return transparentTheme();
    return themeFromHex(pHex, projectId||'0');
  }
  return themeFromHex(tHex, projectId||'0');
}

function setVersionAndDebug(v){
  const badge = document.getElementById('app-version');
  const displayV = newerVersionPrefer(APP_VERSION, v); // å¤ã„å€¤ã§ä¸Šæ›¸ãã•ã›ãªã„
  if (badge) badge.textContent = displayV;

  const bar = document.getElementById('debug-bar');
  if (!bar) return;
  const chip = document.getElementById('sheet-chip'); if (chip) { chip.textContent=''; }
  bar.innerHTML = '';
  const btn = document.createElement('button');
  btn.className = 'secondary';
  btn.textContent = 'ãƒ‡ãƒ¼ã‚¿å†å–å¾—';
  btn.onclick = ()=>refresh();
  bar.appendChild(btn);

  const span = document.createElement('span');
  span.className = 'muted';
  const u = safeArr(DATA.users).length;
  const p = safeArr(DATA.projects).length;
  const t = safeArr(DATA.tasks).length;
  const s = safeArr(DATA.subs).length;
  span.textContent = `Users:${u} / Projects:${p} / Tasks:${t} / Subs:${s}`;
  bar.appendChild(span);


  gsr().withSuccessHandler((info)=>{
    const chip2 = document.getElementById('sheet-chip');
    if (chip2 && info && info.id) {
      chip2.textContent = `Sheet: ${info.name} (${info.id.slice(0,6)}...)`;
      chip2.onclick = ()=>window.open(info.url,'_blank'); chip2.style.cursor='pointer';
    }
  }).getSpreadsheetInfo();
     gas('getLogoDataUrl')
    .then(url => {
      setWatermark(url, 0.05, '820px');
      //setHeaderLogo(url);
    })
    .catch(() => { /* ãƒ­ã‚´ã¯ç„¡ãã¦ã‚‚å‹•ä½œã«ã¯æ”¯éšœãªã— */ });
}


function fetchSpreadsheetInfo(){
  gsr().withSuccessHandler((info)=>{
    const elx = document.getElementById('ss-info');
    if (elx) elx.value = info && info.url ? `${info.name} (${info.id}) [via:${info.via}]` : '[æœªè¨­å®š]';
  }).getSpreadsheetInfo();
}
function saveSpreadsheetId(){
  const id = (document.getElementById('ss-input')||{}).value || '';
  if (!id) { alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  gsr().withSuccessHandler(()=>{
    alert('æ¥ç¶šå…ˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
    try{ fetchSpreadsheetInfo(); }catch(_){}
    try{ refresh(); }catch(_){}
  }).setTargetSpreadsheetId(id);
}

async function runDiagnostics(){
  const log = (m)=>{ const elx=document.getElementById('dbg_log'); if(elx){ elx.textContent += m+'\n'; elx.scrollTop = elx.scrollHeight; } };
  try{
    log('start');
    const meta = await gas('getSpreadsheetInfo'); document.getElementById('dbg_sheet').textContent = JSON.stringify(meta,null,2);
    const ping = await gas('ping'); const client = {users:safeArr(DATA.users).length, projects:safeArr(DATA.projects).length, tasks:safeArr(DATA.tasks).length, subs:safeArr(DATA.subs).length};
    document.getElementById('dbg_counts').textContent = JSON.stringify({server: ping.counts, client}, null, 2);
    const all = await gas('getAllDataPlain'); document.getElementById('dbg_all').textContent = JSON.stringify({version:all.version, users:(all.users||[]).length, projects:(all.projects||[]).length, sampleUser:(all.users||[])[0]||null, sampleProject:(all.projects||[])[0]||null}, null, 2);
    const u = await gas('debugPeek','Users',5); const p = await gas('debugPeek','Projects',5);
    document.getElementById('dbg_users').textContent = JSON.stringify(u.rows, null, 2);
    document.getElementById('dbg_projects').textContent = JSON.stringify(p.rows, null, 2);
    log('done');
  }catch(e){ alert('Diagnostics error: '+(e && e.message ? e.message : e)); log('ERROR '+(e && e.message ? e.message : e)); }
}

function openHelpPopup(){ alert('ä¸Šéƒ¨ã®ã€Œä½¿ã„æ–¹ã€ã‚¿ãƒ–ã«ã€è©³ç´°ãªæ‰‹å¼•ãã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚'); }

// google.script.run helper
function gsr(){
  try {
    return google.script.run.withFailureHandler(function(e){
      alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + (e && e.message ? e.message : e));
    });
  } catch (err) {
    alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + err);
    throw err;
  }
}

window.addEventListener('error', (e)=>{
  try { alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¨ãƒ©ãƒ¼: ' + (e.message||e.error||e)); } catch(_) {}
});

document.addEventListener('DOMContentLoaded', function(){
// --- RRULE helpers ---
function rruleFromMode(mode, baseDate){
  // baseDate: 'YYYY-MM-DD' or ''
  const d = parseYMDLocal(baseDate || '');
  const dow = ['SU','MO','TU','WE','TH','FR','SA'];
  if (!mode) return '';
  switch(mode){
    case 'DAILY':
      return 'FREQ=DAILY;INTERVAL=1';
    case 'WEEKLY':
      if (d) return 'FREQ=WEEKLY;INTERVAL=1;BYDAY=' + dow[d.getDay()];
      return 'FREQ=WEEKLY;INTERVAL=1';
    case 'BIWEEKLY':
      if (d) return 'FREQ=WEEKLY;INTERVAL=2;BYDAY=' + dow[d.getDay()];
      return 'FREQ=WEEKLY;INTERVAL=2';
    case 'MONTHLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=1;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=1';
    case 'BIMONTHLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=2;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=2';
    case 'QUARTERLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=3;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=3';
    case 'YEARLY':
      if (d) return 'FREQ=YEARLY;INTERVAL=1;BYMONTH='+(d.getMonth()+1)+';BYMONTHDAY='+d.getDate();
      return 'FREQ=YEARLY;INTERVAL=1';
    default:
      return '';
  }
}

function bindRruleUI(){
  // Task quick form
  const modeT = el('t_rrule_mode'), inputT = el('t_rrule'), dueT = el('t_due'), typeT = el('t_type');
  function updateTaskRrule(){ if(!modeT) return;
    const m = modeT.value;
    if(!m){ return; }
    const base = dueT && dueT.value ? dueT.value : '';
    inputT.value = rruleFromMode(m, base);
  }
  if (modeT && inputT){
    modeT.addEventListener('change', updateTaskRrule);
    if (dueT) dueT.addEventListener('change', function(){ if(modeT.value) updateTaskRrule(); });
    if (typeT) typeT.addEventListener('change', function(){ const wrap = modeT.closest('div'); if(!wrap) return; wrap.style.opacity = (typeT.value==='recurring') ? '1' : '.6'; });
  }

  // Ledger plan form
  const modeL = el('lp_rrule_mode'), inputL = el('lp_rrule'), nextL = el('lp_next');
  function updateLedgerRrule(){ if(!modeL) return;
    const m = modeL.value;
    if(!m){ return; }
    const base = nextL && nextL.value ? nextL.value : '';
    inputL.value = rruleFromMode(m, base);
  }
  if (modeL && inputL){
    modeL.addEventListener('change', updateLedgerRrule);
    if (nextL) nextL.addEventListener('change', function(){ if(modeL.value) updateLedgerRrule(); });
  }
}

  loadFiltersFromLS();  // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’èª­ã‚€
  applyHash();          // URLæŒ‡å®šãŒã‚ã‚Œã°ä¸Šæ›¸ã
  try { applyRouteFromUrl(); } catch(_){ }
  try { bindDashboardTabs?.(); } catch(_){ }
  // æ—¢å­˜æŒ‡å®šï¼ˆLS/ãƒãƒƒã‚·ãƒ¥ï¼‰ãŒç„¡ã‘ã‚Œã°ã€Œå®Œäº†ä»¥å¤–ã€ã‚’åˆæœŸå€¤ã«
  if (!FILTERS.status && !OVERDUE) {
    FILTERS.status = 'notdone';
    const s = el('f_status'); if (s) s.value = 'notdone';
  }
  try { const m=document.getElementById('gantt-scale-mode'); if(m) m.value=GANTT_SCALE; } catch(_){ }
  try { setVersionAndDebug(APP_VERSION); fetchSpreadsheetInfo(); refresh(); bindRruleUI(); } catch(e){ alert('åˆæœŸåŒ–æ™‚ã‚¨ãƒ©ãƒ¼: ' + e); }

  // ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’åæ˜ 
  //try { QUICK_COLLAPSED = (localStorage.getItem('quick_collapsed')==='1'); applyQuickPanelState(); } catch(_){}
  try { QUICK_COLLAPSED = (localStorage.getItem('quick_collapsed')==='0'); applyQuickPanelState(); } catch(_){}
});

function setWatermark(url, opacity, size){
  const wm = document.getElementById('watermark');
  if(!wm) return;
  if (typeof opacity === 'number') wm.style.setProperty('--wm-opacity', String(opacity));
  if (size) wm.style.setProperty('--wm-size', size);
  wm.style.backgroundImage = `url('${url}')`;
}
function toCSV(rows, headers){
  const esc = (v)=>{ const s=(v==null?'':String(v)); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; };
  return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
}
function exportCSV(kind){
  let rows, headers, name;
  if (kind==='tasks'){
    rows = filterTasks(safeArr(DATA.tasks));
    headers = ['id','projectId','title','type','ownerUserId','assignees','dueDate','status','priority','memoText','createdAt','updatedAt','docId','docUrl'];
    name = 'tasks';
  } else {
    rows = safeArr(DATA.projects);
    headers = ['id','name','parentProjectId','ownerUserId','priority','budget','startDate','endDate','status','memoText','createdAt','updatedAt','docId','docUrl'];
    name = 'projects';
  }
  const csv = '\ufeff' + toCSV(rows, headers); // BOMä»˜ãï¼ˆExcelæƒ³å®šï¼‰
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${name}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}



// --- Local date helpersï¼ˆUTCã‚ºãƒ¬é˜²æ­¢ï¼‰ ---
function parseYMDLocal(s){
  if(!s) return null;
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]); // local midnight
  const d = new Date(s);
  if (isNaN(d)) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function diffDays(a, b){
  const aa = new Date(a.getFullYear(), a.getMonth(), a.getDate());
  const bb = new Date(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((bb - aa)/dayMs);
}

function setHeaderLogo(url){
  const img = document.getElementById('brandmark');
  if (img){ img.src = url; img.style.display = 'inline-block'; }
}

/* --- Quick panel collapse --- */
let QUICK_COLLAPSED = false;
function applyQuickPanelState(){
  const grid=document.getElementById('dashboard-grid');
  const panel=document.getElementById('quick-panel');
  const btn=document.getElementById('qp-toggle');
  if(!grid||!panel||!btn) return;
  grid.classList.toggle('collapsed-left', QUICK_COLLAPSED);
  panel.classList.toggle('collapsed', QUICK_COLLAPSED);
  btn.textContent = QUICK_COLLAPSED ? 'â–¶' : 'â—€';
  btn.title = QUICK_COLLAPSED ? 'å±•é–‹' : 'æŠ˜ã‚ŠãŸãŸã¿';
}
function toggleQuickPanel(){
  QUICK_COLLAPSED = !QUICK_COLLAPSED;
  try{ localStorage.setItem('quick_collapsed', QUICK_COLLAPSED ? '1':'0'); }catch(_){}
  applyQuickPanelState();
}
function parseAttachmentLines(text){
  // 1è¡Œã«1æ·»ä»˜ã€‚URLã ã‘ or "ã‚¿ã‚¤ãƒˆãƒ«,URL" ä¸¡å¯¾å¿œã€‚Drive URLã¯ fileId æŠœãå‡ºã—
  const lines = String(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return lines.map(line=>{
    let title='', url=line;
    const m = line.split(',').map(s=>s.trim());
    if(m.length>=2){ title=m[0]; url=m[1]; }
    // Drive ID æŠœãå‡ºã—
    const dm = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    const fileId = dm ? dm[1] : '';
    const type = fileId ? 'drive' : 'url';
    if(!title) title = url.replace(/^https?:\/\//,'').slice(0,80);
    return {type, title, url, fileId};
  });
}

// ç½®ãæ›ãˆ
function targetFromQuick(kind){
  
  if(kind==='project'){
    const projs = safeArr(DATA.projects);
    const name = val('p_name');
    return projs.find(p=>p.name===name) || projs[projs.length-1];

 } else if (kind==='task'){
   const tasks = safeArr(DATA.tasks);
   const title = val('t_title');
   return tasks.find(t=>t.title===title) || tasks[tasks.length-1];
 } else if(kind==='shared'){
    const list = safeArr(DATA.shareds);
    const editId = (document.getElementById('sh_editing_id')||{}).value || '';
    if (editId) {
      const hit = list.find(s => String(s.id) === String(editId));
      if (hit) return hit;
    }
    const name = (document.getElementById('sh_name')||{}).value || '';
    if (name) {
      const byName = list.find(s => s.name === name);
      if (byName) return byName;
    }
    return list[list.length - 1]; // æœ€çµ‚è¿½åŠ ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  } else {
   // å¿…è¦ãªã‚‰ minute/daily ãªã©ã‚‚ã“ã“ã«è¿½åŠ 
   return null;
  }
}

function openAttachDialog(kind){
  const tgt = targetFromQuick(kind);
  if (!tgt){
    alert(kind === 'shared'
      ? 'å…ˆã«ã€Œå…±æœ‰è³‡æ–™ã‚’è¿½åŠ ã€ã—ã¦ã‹ã‚‰æ·»ä»˜ã—ã¦ãã ã•ã„'
      : 'å…ˆã«å¯¾è±¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
    return;
  }
  const sample = 'ä¾‹)\nhttps://docs.google.com/document/d/xxxxxxxx\nè¨­è¨ˆè³‡æ–™,https://example.com/spec\n...';
  const txt = prompt(`æ·»ä»˜ã™ã‚‹URL/Driveãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ”¹è¡Œã§è¤‡æ•°å…¥åŠ›ã§ãã¾ã™ã€‚\n"${sample}"\n`, '');
  if (txt === null) return;
  const items = parseAttachmentLines(txt);
  if (!items.length) return;
  gsr().withSuccessHandler(()=>refresh()).upsertAttachments(kind, tgt.id, items);
}


function openAttachmentManager(kind, id){
  const list = safeArr(DATA.attachments).filter(a=>a.parentType===kind && String(a.parentId)===String(id));
  if(!list.length){ alert('æ·»ä»˜ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
  const lines = list.map(a=> `ãƒ»${a.title||'(ç„¡é¡Œ)'}\n   ${a.url || ('https://drive.google.com/file/d/'+a.fileId)}`).join('\n');
  const choice = prompt(`æ·»ä»˜(${list.length}ä»¶)ï¼š\n${lines}\n\næ–°è¦è¿½åŠ ã¯URLã‚’å…¥åŠ›ï¼ˆè¤‡æ•°ã¯æ”¹è¡Œï¼‰`, '');
  if(choice===null) return;
  if(choice.trim()){
    const items = parseAttachmentLines(choice);
    if(items.length) gsr().withSuccessHandler(()=>refresh()).upsertAttachments(kind, id, items);
  }
}
function renderMinutesPage(){
  if (PAGE!=='minutes') return;
  const md = document.getElementById('m_date');
  if (md && !md.value) md.value = todayStr();  // â˜… è¿½åŠ 
  const tb = document.querySelector('#minutesTable tbody'); if(!tb) return;
  tb.innerHTML='';
  safeArr(DATA.minutes).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).forEach(m=>{
    const proj = nameByProjectId(m.projectId||'');
    const idsCsv = m.taskIds || m.taskId || '';
    const taskTitles = String(idsCsv).split(',')
      .map(id => safeArr(DATA.tasks).find(t=>t.id===id)?.title)
      .filter(Boolean).join(', ');
    const link = m.docUrl ? `<button class="secondary" onclick="window.open('${m.docUrl}','_blank')">Docs</button>` : '';
    const attN = countAttachments('minute', m.id||'');
    const attB = attN? `<button class="secondary" onclick="openAttachmentManager('minute','${m.id}')">ğŸ“${attN}</button>`:'';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.date||''}</td>
      <td>${escapeHtml(m.title||'')}</td>
      <td>${escapeHtml(proj)}${taskTitles?(' / '+escapeHtml(taskTitles)) : ''}</td>
      <td>${escapeHtml(m.attendees||'')}</td>
      <td>
        ${link} ${attB}
        <button class="secondary" onclick="delMinute('${m.id}')">å‰Šé™¤</button>
    </td>`;
    tb.appendChild(tr);
  });
}


async function createMinuteDocFromForm(){
  return guardRun('createMinute', async () => {
    const taskIdsCsv = selMulti('m_tasks').join(',');
    const m = {
      date: val('m_date'),
      title: val('m_title'),
      projectId: sel('m_project'),
      taskIds: taskIdsCsv,
      taskId: taskIdsCsv.split(',')[0] || '',
      attendees: val('m_attendees')
    };
    if(!m.date || !m.title){ alert('æ—¥ä»˜ã¨ä»¶åã¯å¿…é ˆã§ã™'); return; }
    await ensureUsersLoaded();

    Busy.push();
    google.script.run
      .withSuccessHandler((res)=>{
        if(res && res.docId){
          const body = buildMinutesBody(m);
          google.script.run
            .withSuccessHandler(()=>{
              // â–¼â–¼ ã“ã“ã§è‡ªå‹•æ·»ä»˜ â–¼â–¼
              // â–¼â–¼ ã“ã“ã§è‡ªå‹•æ·»ä»˜ï¼ˆproject + è¤‡æ•° taskï¼‰â–¼â–¼
              if (res.url) {
                const niceTitle = `è­°äº‹éŒ²ï¼š${m.title}ï¼ˆ${m.date}ï¼‰`;
                const attachments = [{ type: 'url', title: niceTitle, url: res.url }];

                // è¤‡æ•°ã‚¿ã‚¹ã‚¯IDã‚’é…åˆ—åŒ–ï¼ˆç©ºè¦ç´ é™¤å»ï¼‰
                const taskIds = (m.taskIds || '')
                  .split(',')
                  .map(s => s.trim())
                  .filter(Boolean);

                // ä½•ä»¶æ·»ä»˜ã™ã‚‹ã‹ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆprojectåˆ† + taskåˆ†ï¼‰
                let pending = 0;
                const done = () => {
                  pending--;
                  if (pending <= 0) { Busy.pop(); refresh(); }
                };
                const fail = (err) => {
                  alert('æ·»ä»˜ã«å¤±æ•—: ' + err);
                  done();
                };

                // project ã¸ã®æ·»ä»˜
                if (m.projectId) {
                  pending++;
                  google.script.run
                    .withSuccessHandler(done)
                    .withFailureHandler(fail)
                    .upsertAttachments('project', m.projectId, attachments);
                }

                // å„ task ã¸ã®æ·»ä»˜ï¼ˆè¤‡æ•°ï¼‰
                taskIds.forEach(taskId => {
                  pending++;
                  google.script.run
                    .withSuccessHandler(done)
                    .withFailureHandler(fail)
                    .upsertAttachments('task', taskId, attachments);
                });

                // æ·»ä»˜å¯¾è±¡ãŒ1ä»¶ã‚‚ãªã„å ´åˆã¯å³çµ‚äº†
                if (pending === 0) {
                  Busy.pop();
                  refresh();
                }
              } else {
                Busy.pop();
                refresh();
              }
              // â–²â–² è‡ªå‹•æ·»ä»˜ã“ã“ã¾ã§ â–²â–²
            })
            .withFailureHandler(()=>Busy.pop())
            .replaceDocWithMemo(res.docId, body);
        }else{
          refresh();
          Busy.pop();
        }
      })
      .withFailureHandler(()=>Busy.pop())
      .createMinuteDoc(m);
  });
}



function renderDailyPage(){
  if (PAGE!=='daily') return;
  const dIn = document.getElementById('dr_date');
  if (dIn && !dIn.value) dIn.value = todayStr();   // â˜… ã“ã‚Œã‚’è¿½åŠ 
  const tb = document.querySelector('#dailyTable tbody'); if(!tb) return;
  tb.innerHTML='';
  safeArr(DATA.dailyReports).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).forEach(r=>{
    const user = nameByUserId(r.userId||'');
    const proj = nameByProjectId(r.projectId||'');
    const tasks = r.tasks||'';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date||''}</td><td>${escapeHtml(user||'')}</td><td>${Number(r.hours||0)}</td>
      <td>${escapeHtml(r.body||'')}</td><td>${escapeHtml(proj)}${tasks?(' / '+escapeHtml(tasks)) : ''}</td>`;
    tb.appendChild(tr);
  });
}
function addDailyReport(){
  const tasksCsv = selMulti('dr_tasks').join(',');
  const r = { date: val('dr_date'), userId: sel('dr_user'), hours: Number(val('dr_hours')||0), projectId: sel('dr_project'), body: val('dr_body'), tasks: tasksCsv };
  if(!r.date || !r.userId ){ alert('æ—¥ä»˜ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertDailyReport(r);
}

// å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«çµ±åˆ
//(function(orig){ window.renderAll = function(){ orig && orig(); renderLedgerPage(); renderMinutesPage(); renderDailyPage(); } })(window.renderAll||null);

function countProjectAttachmentsDeep(projectId){
  const pid = String(projectId||'');
  const direct = safeArr(DATA.attachments).filter(a=>a.parentType==='project' && String(a.parentId)===pid).length;
  const taskIds = safeArr(DATA.tasks).filter(t=>String(t.projectId)===pid).map(t=>String(t.id));
  const taskAtt = safeArr(DATA.attachments).filter(a=>a.parentType==='task' && taskIds.includes(String(a.parentId))).length;
  const minuteIds = safeArr(DATA.minutes).filter(m=>String(m.projectId)===pid).map(m=>String(m.id));
  const minuteAtt = safeArr(DATA.attachments).filter(a=>a.parentType==='minute' && minuteIds.includes(String(a.parentId))).length;
  return direct + taskAtt + minuteAtt;
}
async function createDailyReportDocFromForm(){
  return guardRun('createDaily', async () => {
    const tasksCsv = selMulti('dr_tasks').join(',');
    const r = { date: val('dr_date'), userId: sel('dr_user'), hours: Number(val('dr_hours')||0), projectId: sel('dr_project'), body: val('dr_body'), tasks: tasksCsv };
    if(!r.date || !r.userId){ alert('æ—¥ä»˜ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¿…é ˆã§ã™'); return; }
    await ensureUsersLoaded();

    Busy.push();
    google.script.run
      .withSuccessHandler((res)=>{
        if(res && res.docId){
          const body = buildDailyBody(r);
          google.script.run
            .withSuccessHandler(()=>refresh())
            .withFailureHandler(()=>Busy.pop())
            .replaceDocWithMemo(res.docId, body);
        }else{
          refresh();
          Busy.pop();
        }
      })
      .withFailureHandler(()=>Busy.pop())
      .createDailyReportDoc(r);
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã«ã‚‚åæ˜ 
(function(orig){
  window.renderDailyPage = function(){
    orig && orig();
    if (PAGE!=='daily') return;

    // æœˆã®åˆæœŸå€¤
    const m = el('dr_month');
    if (m && !m.value){
      const now = new Date(); m.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿
    const uf = el('dr_user_filter');
    if (uf){
      while (uf.options.length) uf.remove(0);
      uf.add(new Option('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼', ''));
      safeArr(DATA.users).forEach(u=> uf.add(new Option(u.name||u.email||u.id, u.id)));
      uf.onchange = renderDailyCalendar;
    }
    renderDailyCalendar();
  };
})(window.renderDailyPage);

function renderDailyCalendar(){
  if (PAGE!=='daily') return;
  const cont = el('daily-calendar'); if(!cont) return;

  const monthStr = el('dr_month')?.value || new Date().toISOString().slice(0,7);
  const [yy,mm] = monthStr.split('-').map(Number);
  const first = new Date(yy, mm-1, 1), last = new Date(yy, mm, 0);

  // è¡¨ç¤ºç¯„å›²ï¼ˆå‰å¾Œã®ç«¯æ•°ã‚’å«ã‚ã¦æ—¥æ›œã€œåœŸæ›œã§åŸ‹ã‚ã‚‹ï¼‰
  const start = new Date(first); start.setDate(first.getDate() - first.getDay());
  const end   = new Date(last);  end.setDate(last.getDate() + (6 - last.getDay()));

  const userFilter = el('dr_user_filter')?.value || '';
  let html = '<div class="calendar-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;">';
  for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const inMonth = (d.getMonth()===first.getMonth());
    const items = safeArr(DATA.dailyReports).filter(r=>r.date===ymd && (!userFilter || r.userId===userFilter));
    const lis = items.map(r=>{
      const u = nameByUserId(r.userId||'');
      const label = `${u}${r.docUrl?'':'ï¼ˆæœªä½œæˆï¼‰'}`;
      return r.docUrl
        ? `<div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">â€¢ <a href="${r.docUrl}" target="_blank">${escapeHtml(label)}</a></div>`
        : `<div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">â€¢ ${escapeHtml(label)}</div>`;
    }).join('');
    html += `<div class="card see-through" style="padding:6px; min-height:84px; ${inMonth?'':'opacity:.6;'}">
      <div style="font-weight:700; font-size:12px; margin-bottom:4px;">${d.getDate()}</div>
      ${lis || '<div class="muted" style="font-size:12px;">-</div>'}
    </div>`;
  }
  html += '</div>';
  cont.innerHTML = html;
}
// â”€â”€ æ·»ä»˜ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆè¡¨ã®è¡Œã®ç›´ä¸‹ã«å·®ã—è¾¼ã‚€ï¼‰ â”€â”€
function toggleAttachmentList(kind, id, anchor){
  try{
    const tr = anchor.closest('tr');
    if(!tr) return;
    const next = tr.nextElementSibling;
    if(next && next.classList.contains('att-row')){
      next.remove(); // æ—¢ã«é–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
      return;
    }
    const list = safeArr(DATA.attachments).filter(a=>a.parentType===kind && String(a.parentId)===String(id));
    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;

    const holder = document.createElement('tr');
    holder.className = 'att-row';
    const td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = list.length
      ? `<div class="inline-attachments">
           ${list.map(a=>`<div>ãƒ»<a href="${a.url || ('https://drive.google.com/file/d/'+(a.fileId||''))}" target="_blank" rel="noopener">${escapeHtml(a.title||'(ç„¡é¡Œ)')}</a></div>`).join('')}
           <div style="margin-top:6px;">
             <button class="secondary mini" onclick="openAttachmentManager('${kind}','${id}')">ï¼‹è¿½åŠ </button>
           </div>
         </div>`
      : `<div class="inline-attachments muted">æ·»ä»˜ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    holder.appendChild(td);
    tr.after(holder);
  }catch(e){ console.error(e); }
}
// â”€â”€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é–¢é€£ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒˆã‚°ãƒ«ï¼ˆè¡¨ã®è¡Œã®ç›´ä¸‹ã«å·®ã—è¾¼ã‚€ï¼‰ â”€â”€
function toggleProjectTaskList(projectId, anchor){
  try{
    const tr = anchor.closest('tr');
    if(!tr) return;

    // æ—¢ã«é–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
    const next = tr.nextElementSibling;
    if(next && next.classList.contains('proj-task-row')){
      next.remove();
      return;
    }

    const list = safeArr(DATA.tasks)
      .filter(t => String(t.projectId) === String(projectId))
      // æœªå®Œâ†’å®Œäº† ã®é †ã§ã–ã£ãã‚Šä¸¦ã¹ã‚‹
      .sort((a,b) => {
        const ad = String(a.status||'').toLowerCase()==='done' ? 1 : 0;
        const bd = String(b.status||'').toLowerCase()==='done' ? 1 : 0;
        if (ad !== bd) return ad - bd;
        return String(a.dueDate||'9999-12-31').localeCompare(String(b.dueDate||'9999-12-31'));
      });

    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;
    const holder = document.createElement('tr');
    holder.className = 'proj-task-row';
    const td = document.createElement('td');
    td.colSpan = cols;

    if(!list.length){
      td.innerHTML = `<div class="inline-attachments muted">ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      const items = list.map(t=>{
        const title = escapeHtml(t.title||'');
        const due   = t.dueDate ? ` [${t.dueDate}]` : '';
        const st    = labelStatus(t.status||'');              // ä¾‹: æœªç€æ‰‹/é€²è¡Œä¸­/ä¿ç•™ä¸­/å®Œäº†
        const ass   = String(t.assignees||'')
                        .split(',').filter(Boolean).map(nameByUserId).join(', ');
        const tDoc  = getTaskDocUrl(t.id);
        const attN  = countAttachments('task', t.id);
        const docLink = tDoc ? `<a href="${tDoc}" target="_blank" rel="noopener">ğŸ“„</a>` : '';
        const attBtn  = attN ? `<button class="secondary mini" onclick="openAttachmentManager('task','${t.id}')">ğŸ“${attN}</button>` : '';
        return `
          <div style="display:flex; gap:8px; align-items:center; padding:2px 0;">
            <span style="min-width:72px;" class="muted">${escapeHtml(st)}</span>
            <span style="flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              <strong>${title}</strong>${due}
              ${ass ? `<span class="muted"> ãƒ» ${escapeHtml(ass)}</span>` : ''}
            </span>
            <span class="toolbar" style="gap:6px;">
              ${docLink} ${attBtn}
              <button class="secondary mini" onclick="openTaskDocById('${t.id}')">Task</button>
              <button class="secondary mini" onclick="moveStatus('${t.id}','done')">å®Œäº†</button>
            </span>
          </div>`;
      }).join('');

      // æ—¢å­˜ã®æ·»ä»˜UIã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æµç”¨
      td.innerHTML = `<div class="inline-attachments">${items}</div>`;
    }

    holder.appendChild(td);
    tr.after(holder);
  }catch(e){ console.error(e); }
}
function getProjectTaskCounts(pid){
  const list = safeArr(DATA.tasks).filter(t => String(t.projectId) === String(pid));
  const done = list.filter(t => String(t.status||'').toLowerCase() === 'done').length;
  const open = list.length - done;
  return {open, done, list};
}

function projectStatusLabel(s){
  return String(s||'').toLowerCase()==='archived' ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' : 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
}

function toggleProjectTasks(projectId, anchor){
  try{
    const tr = anchor.closest('tr'); if(!tr) return;
    const next = tr.nextElementSibling;
    if(next && next.classList.contains('proj-task-row')){ next.remove(); return; }
    const {list} = getProjectTaskCounts(projectId);
    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;

    const html = list.length ? list.map(t=>{
      const st = String(t.status||'').toLowerCase();
      const pr = normPriority(t.priority||'');
      const tDoc = getTaskDocUrl(t.id);
      const attN = countAttachments('task', t.id);
      const att = attN ? ` <span class="doc-badge" title="æ·»ä»˜ ${attN}ä»¶" onclick="openAttachmentManager('task','${t.id}')">ğŸ“${attN}</span>` : '';
      const doc = tDoc ? ` <span class="doc-badge" title="Task Doc" data-tip="ã‚¿ã‚¹ã‚¯ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openTaskDocById('${t.id}')">ğŸ“„Doc</span>` : '';
      return `<div style="padding:2px 0;">
        <span class="pill" style="margin-right:6px;">${labelStatus(st)}</span>
        <span class="pill prio-badge ${pr==='é«˜'?'prio-high':pr==='ä¸­'?'prio-mid':pr==='ä½'?'prio-low':''}" style="margin-right:6px;">${escapeHtml(pr)}</span>
        <strong>${escapeHtml(t.title||'')}</strong>
        <span class="muted">ï¼ˆæœŸé™: ${t.dueDate||'-'}ï¼‰</span>${doc}${att}
      </div>`;
    }).join('') : '<div class="muted">ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

    const holder = document.createElement('tr');
    holder.className = 'proj-task-row';
    const td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = `<div class="inline-attachments">${html}</div>`;
    holder.appendChild(td);
    tr.after(holder);
  }catch(e){ console.error(e); }
}
function renderProjectsPage(){
  if (PAGE !== 'projects') return;
  const tb = document.querySelector('#projAllTable tbody'); if (!tb) return;
  tb.innerHTML='';

  // ãƒ•ã‚£ãƒ«ã‚¿åé›†
  const kw  = (document.getElementById('proj_f_keyword')?.value || '').trim().toLowerCase();
  const own = document.getElementById('proj_f_owner')?.value || '';
  const pri = document.getElementById('proj_f_priority')?.value || '';
  const stf = document.getElementById('proj_f_status')?.value || ''; // ''|'active'|'archived'

  // çµã‚Šè¾¼ã¿ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å«ã‚€ï¼ï¼‰
  let rows = safeArr(DATA.projects).slice(0,1000).filter(p=>{
    if (stf && String(p.status||'').toLowerCase() !== stf) return false;
    if (own && String(p.ownerUserId||'') !== own) return false;
    if (pri && normPriority(p.priority||'') !== pri) return false;
    if (kw){
      const hay = (p.name||'') + ' ' + (p.memoText||'');
      if (!hay.toLowerCase().includes(kw)) return false;
    }
    return true;
  });

  rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));

  for (const r of rows){
    const pDocUrl = getProjectDocUrl(r.id);
    const badge   = pDocUrl ? `<span class="doc-badge" title="Project Doc" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openProjectDocById('${r.id}')">ğŸ“„Doc</span>` : '';
    const docBtn  = pDocUrl ? `<button class="secondary" data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã¾ã™" onclick="openProjectDocById('${r.id}')">ğŸ“„PJ Doc</button>` : '';
    const attN    = countProjectAttachmentsDeep(r.id);
    const attBadge= attN ? `<span class="doc-badge" data-tip="æ·»ä»˜URLä¸€è¦§ã‚’é–‹ãã¾ã™ã€‚" title="æ·»ä»˜ ${attN}ä»¶" onclick="toggleAttachmentList('project','${r.id}', this)">ğŸ“${attN}</span>` : '';

    const theme = themeFor(r.id, null);
    const bg = ` style="background:${theme.bg}"`;

    // å„ªå…ˆåº¦ã®è‰²åˆ†ã‘ï¼ˆã‚¿ã‚¹ã‚¯ä¸€è¦§ã¨åŒæ§˜ï¼‰
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel==='é«˜' ? 'high' : prioLabel==='ä¸­' ? 'mid' : prioLabel==='ä½' ? 'low' : '';

    const {open, done} = getProjectTaskCounts(r.id);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td${bg}>${escapeHtml(r.name||'')}${badge} ${attBadge}</td>
      <td${bg}>${projectStatusLabel(r.status)}</td>
      <td${bg}>${(safeArr(DATA.projects).find(p=>p.id===r.parentProjectId)?.name)||''}</td>
      <td${bg}>${escapeHtml(nameByUserId(r.ownerUserId||''))}</td>
      <td class="cell-prio ${prc?('prio-'+prc):''}">
        <span class="pill prio-badge ${prc?('prio-'+prc):''}">${escapeHtml(prioLabel||'')}</span>
      </td>
      <td${bg}>${Number(r.budget||0).toLocaleString()}</td>
      <td${bg}>${r.startDate||''}ã€œ${r.endDate||''}</td>
      <td${bg}><b>${open}</b></td>
      <td${bg}><b>${done}</b></td>
      <td${bg}>${attN||0}</td>
      <td style="white-space:nowrap;">
        ${docBtn}
        <button class="secondary" onclick="toggleProjectTasks('${r.id}', this)">é–¢é€£ã‚¿ã‚¹ã‚¯</button>
        <button class="secondary" onclick="editProject('${r.id}')">ç·¨é›†</button>
        <button class="secondary" onclick="toggleArchiveProject('${r.id}')">${(String(r.status||'').toLowerCase()==='archived')?'å¾©æ´»':'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}
function applyProjectsFilters(){ try{ renderProjectsPage(); }catch(_){} }
function clearProjectsFilters(){
  ['proj_f_keyword','proj_f_owner','proj_f_priority','proj_f_status'].forEach(id=>{
    const e=document.getElementById(id); if(e) e.value='';
  });
  applyProjectsFilters();
}
// â˜…è¿½åŠ ï¼šUsersã‚’ç¢ºå®Ÿã«æƒãˆã¦ã‹ã‚‰ç¶šè¡Œ
function ensureUsersLoaded(timeoutMs=1500){
  return new Promise(res=>{
    if (safeArr(DATA.users).length) return res();
    gsr().withSuccessHandler(x=>{
      DATA.users = Array.isArray(x) ? x : safeArr((x||{}).users);
      res();
    }).getUsers();
    setTimeout(res, timeoutMs);  // ã‚µãƒ¼ãƒé…å»¶æ™‚ã®é€ƒã’é“
  });
}

// â˜…è¿½åŠ ï¼šUUIDã‚’ç´ é€šã—ã—ãªã„â€œå¯›å®¹â€ãªåå‰è§£æ±º
function displayUser(id){
  const s = String(id||'').trim();
  if(!s) return '';
  const u = safeArr(DATA.users).find(x => x.id===s || x.email===s || x.name===s);
  if (u) return u.name || u.email || u.id;
  if (/^\S+@\S+\.\S+$/.test(s)) return s; // emailãªã‚‰ãã®ã¾ã¾è¡¨ç¤º
  return 'ï¼ˆæœªç™»éŒ²ï¼‰';                     // UUIDç­‰ã¯ã“ã“ã«è½ã¨ã™
}
function buildMinutesBody(m){
  const projName = nameByProjectId(m.projectId||'') || '-';
  const idsCsv = m.taskIds || m.taskId || '';
  const titles = String(idsCsv)
    .split(',')
    .map(id => safeArr(DATA.tasks).find(t => t.id === id)?.title)
    .filter(Boolean)
    .join(', ');
  const attendees = (m.attendees||'')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .join(', ');

  return `# è­°äº‹éŒ²: ${m.title||''}
æ—¥ä»˜: ${m.date||''}
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projName}
å‚åŠ è€…: ${attendees || '-'}
é–¢é€£ã‚¿ã‚¹ã‚¯: ${titles || '-'}
---
`;
}



// â˜…Dailyãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
function buildDailyBody(r){
  const userName = displayUser(r.userId||'');
  const projName = nameByProjectId(r.projectId||'') || '-';
  // r.tasks ã¯ CSV ã§æ¥ã‚‹å‰æï¼ˆcreateDailyReportDocFromFormå†…ï¼‰
  const taskTitles = String(r.tasks||'').split(',').map(id=>safeArr(DATA.tasks).find(t=>t.id===id)?.title).filter(Boolean).join(', ') || '-';

  return (
`# æ—¥å ± ${r.date||''} / ${userName||'-'}

`
  );
}
async function openIcsDialog(){
  try{
    const base = await gas('getIcsBaseUrl'); // å…ˆã»ã©ã®ã‚µãƒ¼ãƒé–¢æ•°
    if(!base){ alert('ICSã®ãƒ™ãƒ¼ã‚¹URLãŒæœªè¨­å®šã§ã™ï¼ˆç®¡ç†è€…å‘ã‘: setIcsBaseUrl ã‚’ä¸€åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰'); return; }
    const who = prompt('è³¼èª­å¯¾è±¡: ç©º=ã™ã¹ã¦ / ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã§æ‹…å½“è€…åˆ¥ï¼ˆä¾‹: u_123ï¼‰', '');
    const url = base.replace(/\/exec.*/,'/exec') + '?feed=tasks' + (who?('&assignee='+encodeURIComponent(who)):'');
    prompt('ã“ã®URLã‚’Google/Outlookã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è³¼èª­ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', url);
  }catch(e){ alert('ICS URL å–å¾—ã«å¤±æ•—: '+(e && e.message ? e.message : e)); }
}
function toggleUpdatesPanel(){
  const p = document.getElementById('updates-panel');
  if(!p) return;
  const visible = getComputedStyle(p).display !== 'none';
  p.style.display = visible ? 'none' : '';
  if (!visible) {
    try { renderUpdates(); } catch(_) {}
    try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){}
  }
}
// ã‚¹ã‚¤ãƒ OFFæ™‚ã«ã€æ¨™æº–ã®4ã‚«ãƒ©ãƒ éª¨çµ„ã¿ãŒç„¡ã‘ã‚Œã°å¾©å…ƒã™ã‚‹
function ensureDefaultBoardColumns() {
  const host = document.querySelector('#view-board .kanban');
  if (!host) return;
  const need =
    !document.getElementById('col_todo') ||
    !document.getElementById('col_doing') ||
    !document.getElementById('col_blocked') ||
    !document.getElementById('col_done');

  if (need) {
    host.innerHTML = `
      <div class="col see-through" data-status="todo" ondragover="allowDrop(event)" ondrop="onDrop(event, 'todo')">
        <h3>æœªç€æ‰‹ <span class="muted" id="cnt_todo">0</span></h3>
        <div id="col_todo"></div>
      </div>
      <div class="col see-through" data-status="doing" ondragover="allowDrop(event)" ondrop="onDrop(event, 'doing')">
        <h3>é€²è¡Œä¸­ <span class="muted" id="cnt_doing">0</span></h3>
        <div id="col_doing"></div>
      </div>
      <div class="col see-through" data-status="blocked" ondragover="allowDrop(event)" ondrop="onDrop(event, 'blocked')">
        <h3>ä¿ç•™ä¸­ <span class="muted" id="cnt_blocked">0</span></h3>
        <div id="col_blocked"></div>
      </div>
      <div class="col see-through" data-status="done" ondragover="allowDrop(event)" ondrop="onDrop(event, 'done')">
        <h3>å®Œäº† <span class="muted" id="cnt_done">0</span></h3>
        <div id="col_done"></div>
      </div>`;
  }
}
// â–¼ åŒä¸€äººç‰©ã‚’ä¸€æ„ã«ã™ã‚‹ãŸã‚ã®æ­£è¦åŒ–
function userKey(any){
  const s = String(any||'').trim();
  const u = safeArr(DATA.users).find(x => x.id===s || x.email===s || x.name===s);
  return u ? String(u.id) : s; // è¦‹ã¤ã‹ã‚Œã°å†…éƒ¨IDã€ãªã‘ã‚Œã°ãã®ã¾ã¾
}
function primaryAssigneeKey(t){
  const tokens = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);
  if (tokens.length) return userKey(tokens[0]);
  if (t.ownerUserId) return userKey(t.ownerUserId); // æ‹…å½“æœªè¨­å®šãªã‚‰è²¬ä»»è€…ã§æŸã­ã‚‹
  return '__NONE__';
}
function displayNameFromKey(key){
  if (key==='__NONE__') return 'æœªå‰²å½“';
  return nameByUserId(key) || displayUser(key) || key;
}
// idå±æ€§ç”¨ã®å®‰å…¨ãªæ–‡å­—åˆ—
function safeId(s){ return 'x' + String(s).replace(/[^a-zA-Z0-9_-]+/g,'_'); }
function resetProjectForm(){
  const ids = ['p_name','p_parent_select','p_owner_select','p_priority','p_budget','p_start','p_end','p_memo','p_color'];
  ids.forEach(id=>{
    const e = el(id); if(!e) return;
    if (e.tagName === 'SELECT') e.value = '';
    else if (e.type === 'color') e.value = '#ffffff';
    else e.value = '';
  });
  const hid = el('p_editing_id'); if (hid){ hid.value=''; hid.dataset.orig=''; }
  const btn = el('btn_add_project'); if (btn){ btn.textContent='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ '; btn.title=''; }
  showToast('ok','æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
}

function resetTaskForm(){
  const ms = el('t_assignees_select'); if (ms) Array.from(ms.options).forEach(o=> o.selected=false);

  const ids = ['t_title','t_project_select','t_type','t_due','t_owner_select','t_prio','t_rrule','t_memo','t_color'];
  ids.forEach(id=>{
    const e = el(id); if(!e) return;
    if (e.id==='t_type') e.value='single';
    else if (e.tagName === 'SELECT') e.value = '';
    else if (e.type === 'color') e.value = '#ffffff';
    else e.value = '';
  });

  const hid = el('t_editing_id'); if (hid){ hid.value=''; hid.dataset.orig=''; }
  const btn = el('btn_add_task'); if (btn){ btn.textContent='ã‚¿ã‚¹ã‚¯è¿½åŠ '; btn.title=''; }
  showToast('ok','æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
}
function bindQuickNameGuards(){
  const pName = el('p_name'), pHid = el('p_editing_id'), pBtn = el('btn_add_project');
  if (pName && pHid && pBtn) {
    const upd = ()=> {
      const edit = !!pHid.value;
      const orig = pHid.dataset.orig || '';
      const now  = (pName.value||'').trim();
      pBtn.textContent = (edit && orig && now && now!==orig) ? 'âš  ä¸Šæ›¸ãæ›´æ–°' : (edit ? 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°' : 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ');
      pBtn.title = (pBtn.textContent==='âš  ä¸Šæ›¸ãæ›´æ–°') ? 'ç·¨é›†ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒãƒ¼ãƒ ã—ã¦ä¸Šæ›¸ãã—ã¾ã™' : '';
    };
    pName.addEventListener('input', upd);
  }

  const tName = el('t_title'), tHid = el('t_editing_id'), tBtn = el('btn_add_task');
  if (tName && tHid && tBtn) {
    const upd = ()=> {
      const edit = !!tHid.value;
      const orig = tHid.dataset.orig || '';
      const now  = (tName.value||'').trim();
      tBtn.textContent = (edit && orig && now && now!==orig) ? 'âš  ä¸Šæ›¸ãæ›´æ–°' : (edit ? 'ã‚¿ã‚¹ã‚¯æ›´æ–°' : 'ã‚¿ã‚¹ã‚¯è¿½åŠ ');
      tBtn.title = (tBtn.textContent==='âš  ä¸Šæ›¸ãæ›´æ–°') ? 'ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒªãƒãƒ¼ãƒ ã—ã¦ä¸Šæ›¸ãã—ã¾ã™' : '';
    };
    tName.addEventListener('input', upd);
  }
}

// DOMContentLoaded ã®æœ«å°¾ã‚ãŸã‚Šã«ä¸€è¡Œè¿½åŠ 
// æ—¢å­˜: setVersionAndDebug(APP_VERSION); fetchSpreadsheetInfo(); refresh(); bindRruleUI();
bindQuickNameGuards();
// è¿½åŠ ï¼šå…±æœ‰è³‡æ–™ CRUD + è¡¨ç¤º
function resetSharedForm(){
  el('sh_editing_id').value = '';
  el('sh_name').value = '';
  el('sh_category').value = '';
  el('sh_owner').value = '';
  el('sh_tags').value = '';
  if (el('sh_color')) el('sh_color').value = '#ffffff';
  el('sh_memo').value = '';
}

function addShared(){
  return guardRun('addShared', async () => {
    const s = {
      name: val('sh_name'),
      category: val('sh_category'),
      ownerUserId: sel('sh_owner'),
      tags: val('sh_tags'),
      color: val('sh_color'),
      memoText: val('sh_memo')
    };
    if(!s.name){ alert('åç§°ã¯å¿…é ˆã§ã™'); return; }
    Busy.wrap(
      google.script.run
        .withSuccessHandler(()=>refresh())
        .upsertShared(s)
    );
  });
}


function editShared(id){
  const s = safeArr(DATA.shareds).find(x=>x.id===id); if(!s) return;
  el('sh_editing_id').value = s.id || '';
  el('sh_name').value       = s.name || '';
  el('sh_category').value   = s.category || '';
  el('sh_owner').value      = s.ownerUserId || '';
  el('sh_tags').value       = s.tags || '';
  if (el('sh_color')) el('sh_color').value = (s.color && /^#[0-9a-fA-F]{6}$/.test(s.color)) ? s.color : '#ffffff';
  el('sh_memo').value       = s.memoText || '';
}

function toggleArchiveShared(id){
  const s = safeArr(DATA.shareds).find(x=>x.id===id); if(!s) return;
  const ns = (String(s.status||'').toLowerCase()==='archived')?'active':'archived';
  const send = Object.assign({}, s, {status: ns});
  gsr().withSuccessHandler(()=>refresh()).upsertShared(send);
}

function delShared(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  gsr().withSuccessHandler(()=>{ dropRow('shareds', id); rerenderAfter('shareds'); }).deleteShared(id);
}

// ã€Œå…±æœ‰è³‡æ–™ã€è¡¨ç¤º
function renderShareds(){
  // ãƒšãƒ¼ã‚¸å¤–ã§ã‚‚å®‰å…¨ã«ç©ºæŒ¯ã‚Šã™ã‚‹ä½œã‚Šã«
  const tb = document.querySelector('#sharedTable tbody');
  if (!tb) return;

  tb.innerHTML = '';
  const rows = safeArr(DATA.shareds).slice(0, 1000)
    .sort((a,b)=> String(a.category||'').localeCompare(String(b.category||'')) || String(a.name||'').localeCompare(String(b.name||'')));

  rows.forEach(r=>{
    const owner = nameByUserId(r.ownerUserId||'');
    const tags  = String(r.tags||'').split(',').map(s=>s.trim()).filter(Boolean).join(', ');
    const attN  = countAttachments('shared', r.id);   // parentType 'shared' ã‚’ä½¿ã†

    const attBadge = attN
      ? `<span class="doc-badge" title="æ·»ä»˜ ${attN}ä»¶" onclick="toggleAttachmentList('shared','${r.id}', this)">ğŸ“${attN}</span>`
      : '';

    // çŠ¶æ…‹ã¯ä»»æ„ã§ï¼šactive/archived ãªã©ãŒã‚ã‚Œã°è¡¨ç¤ºã€ãªã‘ã‚Œã°ç©º
    const state = r.status || '';
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>${escapeHtml(r.name||'')}</td>
      <td>${escapeHtml(r.category||'')}</td>
      <td>${escapeHtml(owner)}</td>
      <td>${escapeHtml(tags)}</td>
      <td>${attBadge}</td>
      <td>${escapeHtml(state)}</td>
      <td style="white-space:nowrap;">
        <button class="secondary" data-tip="ã“ã®é …ç›®ã‚’ç·¨é›†ã—ã¾ã™" onclick="editShared('${r.id}')">ç·¨é›†</button>
        <button class="secondary" onclick="openAttachmentManager('shared','${r.id}')">ğŸ“ç®¡ç†</button>
        <button class="secondary" onclick="delShared('${r.id}')">å‰Šé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}function toggleAttachmentList(kind, parentId, badgeEl){
  const row = badgeEl?.closest('tr');
  if(!row) return;

  // æ—¢ã«å‡ºã¦ã„ã‚Œã°ç•³ã‚€
  const next = row.nextElementSibling;
  if (next && next.classList.contains('att-row')) {
    next.remove();
    return;
  }

  // æ–°è¦ã§æŒ¿å…¥
  const list = safeArr(DATA.attachments)
    .filter(a => a.parentType === kind && String(a.parentId) === String(parentId));
  const html = renderAttachmentInline(list);

  const tr = document.createElement('tr');
  tr.className = 'att-row';
  tr.innerHTML = `<td colspan="7">
    <div class="inline-attachments">${html || '<span class="muted">æ·»ä»˜ãªã—</span>'}</div>
  </td>`;
  row.insertAdjacentElement('afterend', tr);
}

function renderAttachmentInline(list){
  if(!list.length) return '';
  const icon = (a)=>{
    if (a.type === 'drive' || a.fileId) return 'ğŸ“„';
    const u = String(a.url||'').toLowerCase();
    if (/\.(png|jpe?g|gif|webp|svg)$/.test(u)) return 'ğŸ–¼ï¸';
    if (/\.(pdf)$/.test(u)) return 'ğŸ“•';
    return 'ğŸ”—';
  };
  return list.map(a=>{
    const href = a.url || (a.fileId ? `https://drive.google.com/file/d/${a.fileId}/view` : '#');
    const title = escapeHtml(a.title || a.url || a.fileId || '(ç„¡é¡Œ)');
    return `<div style="margin:4px 0;">
      ${icon(a)} <a href="${escapeHtml(href)}" target="_blank" rel="noopener">${title}</a>
    </div>`;
  }).join('');
}

// å…±æœ‰è³‡æ–™ è¿½åŠ /æ›´æ–°
function addShared(){
  const editId = el('sh_editing_id')?.value || '';
  const payload = {
    id: editId,
    name: val('sh_name').trim(),
    category: val('sh_category').trim(),
    ownerUserId: sel('sh_owner'),
    tags: val('sh_tags').trim(),
    color: val('sh_color'),
    memoText: val('sh_memo')
  };
  if (!payload.name){ alert('åç§°ã¯å¿…é ˆã§ã™'); return; }

  // ã‚µãƒ¼ãƒã®é–¢æ•°åã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„
  gsr().withSuccessHandler(row => {
    patchRow('shareds', row);
    rerenderAfter('shareds');   // è¿½åŠ ï¼šå†æç”»ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã«å¯¾å¿œ
    resetSharedForm();
    renderShareds();
    showToast && showToast('ok','å…±æœ‰è³‡æ–™ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }).upsertShared(payload);
}

// å…±æœ‰è³‡æ–™ ç·¨é›†é–‹å§‹
function editShared(id){
  const r = safeArr(DATA.shareds).find(x=>String(x.id)===String(id));
  if(!r) return;
  el('sh_editing_id').value = r.id || '';
  el('sh_name').value       = r.name || '';
  el('sh_category').value   = r.category || '';
  el('sh_owner').value      = r.ownerUserId || '';
  el('sh_tags').value       = r.tags || '';
  if(el('sh_color')) el('sh_color').value = (r.color && /^#[0-9a-fA-F]{6}$/.test(r.color)) ? r.color : '#ffffff';
  el('sh_memo').value       = r.memoText || '';
}

// å…±æœ‰è³‡æ–™ å‰Šé™¤
function delShared(id){
  if(!confirm('å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  gsr().withSuccessHandler(()=>{
    dropRow('shareds', id);
    renderShareds();
  }).deleteShared(id);
}

// å…±æœ‰è³‡æ–™ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ãƒªã‚»ãƒƒãƒˆ
function resetSharedForm(){
  if (el('sh_editing_id')) el('sh_editing_id').value = '';
  if (el('sh_name'))       el('sh_name').value = '';
  if (el('sh_category'))   el('sh_category').value = '';
  if (el('sh_owner'))      el('sh_owner').value = '';
  if (el('sh_tags'))       el('sh_tags').value = '';
  if (el('sh_color'))      el('sh_color').value = '#ffffff';
  if (el('sh_memo'))       el('sh_memo').value = '';
}
// --- Click guard (multi-press protection) ---
const InFlight = new Set();
// ---- Click/submit é€£æ‰“ã‚¬ãƒ¼ãƒ‰ï¼ˆå…±é€šï¼‰ ----
const __GUARDS__ = new Map();
/**
 * åŒã˜ key ã®å‡¦ç†ãŒã€Œå®Ÿè¡Œä¸­ã€ã¾ãŸã¯ã€Œçµ‚äº†ç›´å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã€ã¯å¼¾ãã€‚
 * ä½¿ã„æ–¹: return guardRun('addTask', async () => { ... });
 */
async function guardRun(key, fn, cooldownMs = 800) {
  const now = Date.now();
  const g = __GUARDS__.get(key);

  // å®Ÿè¡Œä¸­ or ç›´è¿‘çµ‚äº†ã‹ã‚‰ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœªæº€ â†’ 2å›ç›®ä»¥é™ã‚’æ¨ã¦ã‚‹
  if (g && (g.running || (now - (g.endedAt || 0)) < cooldownMs)) return;

  __GUARDS__.set(key, { running: true, startedAt: now, endedAt: 0 });
  try {
    return await fn();
  } finally {
    __GUARDS__.set(key, { running: false, startedAt: g?.startedAt || now, endedAt: Date.now() });
  }
}

/**
 * ãƒœã‚¿ãƒ³ã‚‚åŒæ™‚ã«å®‰å…¨ã«ãƒ­ãƒƒã‚¯ã—ãŸã„å ´åˆã®ç³–è¡£ã€‚
 * ä¾‹: onclick="guardBtn(this, 'addTask', () => addTask())"
 */
function guardBtn(btn, key, fn, cooldownMs = 800) {
  return guardRun(key, async () => {
    const prevDisabled = btn.disabled;
    btn.disabled = true;
    btn.classList.add('disabled');  // è¦‹ãŸç›®ç”¨ï¼ˆä»»æ„ï¼‰
    try { return await fn(); }
    finally {
      btn.disabled = prevDisabled;
      btn.classList.remove('disabled');
    }
  }, cooldownMs);
}


function confirmDel(label){ return confirm(`æœ¬å½“ã«${label}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`); }

function delTask(id){ if(!confirmDel('ã‚¿ã‚¹ã‚¯')) return;
  gsr().withSuccessHandler(()=>{ dropRow('tasks', id); rerenderAfter('tasks'); }).deleteTask(id);
}
function delUser(id){ if(!confirmDel('ãƒ¦ãƒ¼ã‚¶ãƒ¼')) return;
  gsr().withSuccessHandler(()=>{ dropRow('users', id); rerenderAfter('users'); }).deleteUser(id);
}
function delMinute(id){ if(!confirmDel('è­°äº‹éŒ²')) return;
  gsr().withSuccessHandler(()=>{ dropRow('minutes', id); rerenderAfter('minutes'); }).deleteMinute(id);
}
function delSub(id){ if(!confirmDel('ã‚µãƒ–ã‚¹ã‚¯é …ç›®')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteSubscription(id);
}
function delLedgerPlan(id){ if(!confirmDel('å®šæœŸå…¥å‡ºé‡‘')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteLedgerPlan(id);
}
function delCredential(id){ if(!confirmDel('èªè¨¼æƒ…å ±')) return;
  gsr().withSuccessHandler(()=>{ dropRow('credentials', id); rerenderAfter('credentials'); }).deleteCredential(id);
}
let MEMO_BOUND = false;
function attachDefaultMemoEditors(){
  if (MEMO_BOUND) return; MEMO_BOUND = true;

  const handlerKeydown = (ev)=>{
    const ta = ev.target;
    if (!ta || !ta.classList || !ta.classList.contains('memo-edit')) return;
    if (ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)) {
      ev.preventDefault();
      saveMemoNow(ta);
    }
    if (ev.key === 'Escape') {
      // ç›´å‰ä¿å­˜å€¤ã§ãƒªã‚»ãƒƒãƒˆã—ãŸã„å ´åˆã¯ã“ã“ã«å¾©å…ƒå‡¦ç†ã‚’å…¥ã‚Œã‚‹ï¼ˆä»Šå›ã¯ä½•ã‚‚ã—ãªã„ï¼‰
    }
  };

  const handlerBlur = (ev)=>{
    const ta = ev.target;
    if (!ta || !ta.classList || !ta.classList.contains('memo-edit')) return;
    saveMemoNow(ta);
  };

  document.addEventListener('keydown', handlerKeydown, true);
  document.addEventListener('blur', handlerBlur, true);

  function saveMemoNow(ta){
    const kind = ta.dataset.kind;    // 'task' | 'project'
    const id   = ta.dataset.id;
    const text = ta.value;

    if (!kind || !id) return;

    if (kind === 'task'){
      try{
        google.script.run
          .withSuccessHandler(()=>{
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå³æ™‚åæ˜ 
            const idx = safeArr(DATA.tasks).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.tasks[idx].memoText = text;
            ta.closest('td')?.classList.add('cell-flash');
            setTimeout(()=>ta.closest('td')?.classList.remove('cell-flash'), 1200);
            showToast('ok','ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          })
          .withFailureHandler(err=>showToast('ng', (err&&err.message)?err.message:'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'))
          .saveTaskMemo(id, text);
      }catch(e){ showToast('ng','é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
      return;
    }

    if (kind === 'project'){
      const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
      if (!p) return;
      const patch = Object.assign({}, p, { memoText: text });
      try{
        google.script.run
          .withSuccessHandler(()=>{
            // å³æ™‚åæ˜ 
            const idx = safeArr(DATA.projects).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.projects[idx].memoText = text;
            ta.closest('td')?.classList.add('cell-flash');
            setTimeout(()=>ta.closest('td')?.classList.remove('cell-flash'), 1200);
            showToast('ok','ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          })
          .withFailureHandler(err=>showToast('ng', (err&&err.message)?err.message:'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'))
          .upsertProject(patch);
      }catch(e){ showToast('ng','é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
    }
  }
}
function attachDefaultMemoEditors(){
  // ç”»é¢å†…ã® .memo-edit ã‚’æ‹¾ã£ã¦ã€é‡è¤‡é…ç·šã‚’é˜²æ­¢
  document.querySelectorAll('textarea.memo-edit').forEach(ta=>{
    if(ta.dataset._bound === '1') return;
    ta.dataset._bound = '1';

    let orig = ta.value;
    let timer = null;

    const save = ()=>{
      const id   = ta.dataset.id;
      const kind = (ta.dataset.kind || '').toLowerCase();
      const val  = ta.value;

      if (!id) return;
      if (val === orig) return;

      if (kind === 'task'){
        google.script.run
          .withSuccessHandler(()=>{
            orig = val;
            showToast('ok','ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚‚å³åæ˜ 
            const idx = safeArr(DATA.tasks).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.tasks[idx].memoText = val;
          })
          .withFailureHandler(err=>{
            showToast('ng', (err && err.message) ? err.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            ta.value = orig; // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          })
          .saveTaskMemo(id, val);

      } else if (kind === 'project'){
        const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
        if (!p) return;

        const patch = Object.assign({}, p, { memoText: val });
        google.script.run
          .withSuccessHandler(row=>{
            orig = val;
            showToast('ok','ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            // å·®åˆ†é©ç”¨
            if (row && row.id) { patchRow('projects', row); }
          })
          .withFailureHandler(err=>{
            showToast('ng', (err && err.message) ? err.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            ta.value = orig; // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          })
          .upsertProject(patch);
      }
    };

    const debounced = ()=>{
      if (timer) clearTimeout(timer);
      timer = setTimeout(save, 500); // ã‚¿ã‚¤ãƒ—ä¸­ã¯ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    };

    ta.addEventListener('input', debounced); // å…¥åŠ›ä¸­ã¯é…å»¶ä¿å­˜
    ta.addEventListener('change', save);     // ãƒ•ã‚©ãƒ¼ãƒ ç¢ºå®š
    ta.addEventListener('blur', save);       // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚Œæ™‚ã«ç¢ºå®š
  });
}
// === ãƒ¡ãƒ¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ï¼šè‡ªå‹•ä¼¸é•·ï¼†è‡ªå‹•ä¿å­˜ ===
function attachDefaultMemoEditors(){
  const areas = document.querySelectorAll('textarea.memo-edit');
  areas.forEach(ta => {
    if (ta.dataset.bound === '1') return;
    ta.dataset.bound = '1';

    const kind = ta.getAttribute('data-kind');   // "task" / "project"
    const id   = ta.getAttribute('data-id') || '';

    // é«˜ã•ã‚’å†…å®¹ã«åˆã‚ã›ã¦ãƒ•ã‚£ãƒƒãƒˆ
    const fit = () => {
      ta.style.height = 'auto';
      ta.style.height = ta.scrollHeight + 'px';
    };
    fit();
    ta.addEventListener('input', fit);
    ta.addEventListener('focus', fit);

    // å…¥åŠ›ã®å°ä¼‘æ­¢ã§ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰ï¼‹ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆã§æœ€çµ‚ä¿å­˜
    let tmr = null;
    let last = ta.value;

    const commit = () => {
      const val = ta.value;
      if (val === last) return;
      last = val;

      if (kind === 'task') {
        // å³æ™‚ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ ï¼ˆä½“æ„Ÿã‚’è»½ãï¼‰
        const idx = safeArr(DATA.tasks).findIndex(x => String(x.id) === String(id));
        if (idx >= 0) DATA.tasks[idx].memoText = val;

        google.script.run
          .withSuccessHandler(() => { showToast('ok', 'ã‚¿ã‚¹ã‚¯ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); })
          .withFailureHandler((err) => { showToast('ng', (err && err.message) || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); })
          .saveTaskMemo(id, val);

      } else if (kind === 'project') {
        const p = safeArr(DATA.projects).find(x => String(x.id) === String(id)) || { id };
        const payload = Object.assign({}, p, { memoText: val });

        google.script.run
          .withSuccessHandler((row) => {
            if (row) patchRow('projects', row);
            showToast('ok', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          })
          .withFailureHandler((err) => { showToast('ng', (err && err.message) || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); })
          .upsertProject(payload);
      }
    };

    ta.addEventListener('input', () => {
      clearTimeout(tmr);
      tmr = setTimeout(commit, 600);  // 0.6ç§’ç„¡å…¥åŠ›ã§ä¿å­˜
    });
    ta.addEventListener('blur', commit);
  });
}


// ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã®é–‹é–‰ãƒ»åˆæœŸåŒ– =====
function openFlyout(kind){
  const mask = document.getElementById('flyout-mask');
  const pane = document.getElementById(kind==='project' ? 'flyout-project' : 'flyout-task');
  if (mask) { mask.style.display='block'; mask.setAttribute('aria-hidden','false'); }
  if (pane) { pane.classList.add('open'); setTimeout(()=>{ pane.querySelector('input,select,textarea')?.focus(); }, 60); }
}
function closeFlyout(kind){
  const mask = document.getElementById('flyout-mask');
  const pane = document.getElementById(kind==='project' ? 'flyout-project' : 'flyout-task');
  if (pane) pane.classList.remove('open');
  if (mask) { mask.style.display='none'; mask.setAttribute('aria-hidden','true'); }
}
document.getElementById('fab-add-project')?.addEventListener('click', ()=>openFlyout('project'));
document.getElementById('fab-add-task')?.addEventListener('click', ()=>openFlyout('task'));
document.getElementById('flyout-mask')?.addEventListener('click', ()=>{ closeFlyout('project'); closeFlyout('task'); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeFlyout('project'); closeFlyout('task'); }});

// ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚»ãƒ¬ã‚¯ãƒˆã¸ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã‚€ =====
function hydrateFlyouts(){
  const users = safeArr(DATA.users), projects = safeArr(DATA.projects).filter(p=>String(p.status||'').toLowerCase()!=='archived');
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´
  const prParent = document.getElementById('fly_p_parent');
  const prOwner  = document.getElementById('fly_p_owner');
  if (prParent){ prParent.innerHTML=''; prParent.add(new Option('ï¼ˆãªã—ï¼‰','')); projects.forEach(p=>prParent.add(new Option(p.name||p.id, p.id))); }
  if (prOwner){  prOwner.innerHTML='';  prOwner.add(new Option('ï¼ˆæœªé¸æŠï¼‰','')); users.forEach(u=>prOwner.add(new Option(u.name||u.email||u.id, u.id))); }
  // ã‚¿ã‚¹ã‚¯å´
  const tProj = document.getElementById('fly_t_project');
  const tAss  = document.getElementById('fly_t_assignees');
  if (tProj){ tProj.innerHTML=''; tProj.add(new Option('ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰','')); projects.forEach(p=>tProj.add(new Option(p.name||p.id, p.id))); }
  if (tAss){  tAss.innerHTML=''; users.forEach(u=>tAss.add(new Option(u.name||u.email||u.id, u.id))); tAss.size = Math.min(Math.max(users.length, 3), 8); }
}
// æ—¢å­˜ã® refresh/renderAll ã®å¾Œã«ã‚‚æµã—è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ãƒ•ãƒƒã‚¯
(function(orig){
  window.renderAll = function(){ orig && orig(); try{ hydrateFlyouts(); }catch(_){} };
})(window.renderAll);

// ===== é€ä¿¡ï¼šæ—¢å­˜ã® addProject / addTask ã‚’å†åˆ©ç”¨ =====
function submitFlyoutProject(){
  // ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆå€¤ã‚’ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã¸è»¢é€ã—ã¦ã‹ã‚‰ addProject()
  const map = [
    ['fly_p_name','p_name'], ['fly_p_parent','p_parent_select'], ['fly_p_owner','p_owner_select'],
    ['fly_p_prio','p_priority'], ['fly_p_color','p_color'], ['fly_p_budget','p_budget'],
    ['fly_p_start','p_start'], ['fly_p_end','p_end'], ['fly_p_memo','p_memo'],
  ];
  for(const [src,dst] of map){ const s=document.getElementById(src), d=document.getElementById(dst); if(s&&d){ d.value = s.value; } }
  // æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸ï¼ˆå¿µã®ãŸã‚ï¼‰
  try{ document.getElementById('p_editing_id').value=''; }catch(_){}
  addProject();
  closeFlyout('project');
  showToast('ok','ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
function submitFlyoutTask(){
  // ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆå€¤ â†’ ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã¸
  const copy = (src,dst)=>{ const s=document.getElementById(src), d=document.getElementById(dst); if(s&&d) d.value = s.value; };
  copy('fly_t_title','t_title');
  copy('fly_t_project','t_project_select');
  copy('fly_t_due','t_due');
  copy('fly_t_prio','t_prio');
  copy('fly_t_type','t_type');
  copy('fly_t_color','t_color');
  copy('fly_t_memo','t_memo');

  // æ‹…å½“ï¼ˆè¤‡æ•°ï¼‰ã‚’è»¢é€
  const flyAss = document.getElementById('fly_t_assignees');
  const mainAss = document.getElementById('t_assignees_select');
  if (flyAss && mainAss){
    const vals = Array.from(flyAss.selectedOptions).map(o=>o.value);
    Array.from(mainAss.options).forEach(o => o.selected = vals.includes(o.value));
  }

  // æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã§ç¢ºå®Ÿã«è¿½åŠ 
  try{ document.getElementById('t_editing_id').value=''; }catch(_){}
  addTask();
  closeFlyout('task');
  showToast('ok','ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

// ===== æ—¢å­˜UIã«è»½ã„èª¬æ˜ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰ã‚’ä»˜ä¸ =====
(function addInlineHints(){
  const hints = [
    ['nav-dashboard',"ã“ã“ãŒãƒ¡ã‚¤ãƒ³ã§ã™ã€‚é€²æ—ãƒ»ä¸€è¦§ãƒ»ã‚¬ãƒ³ãƒˆã«åˆ‡æ›¿ã§ãã¾ã™"],
    ['qp-toggle',"å·¦ã®ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ã‚’æŠ˜ã‚ŠãŸãŸã¿ï¼å±•é–‹ã—ã¾ã™"],
    ['tab-list',"ã‚¿ã‚¹ã‚¯ã‚’è¡¨å½¢å¼ã§ç¢ºèªãƒ»ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ã§ãã¾ã™"],
    ['tab-board',"ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§çŠ¶æ…‹ã‚’ç§»å‹•ã§ãã¾ã™"],
    ['tab-board',"æ‹…å½“è€…åˆ¥ã‚¹ã‚¤ãƒ ãƒ¬ãƒ¼ãƒ³ã¯ãƒã‚§ãƒƒã‚¯ã§åˆ‡æ›¿"],
    ['tab-board',"ã‚«ãƒ¼ãƒ‰ã®ğŸ“„ã§Docsã€ğŸ“ã§æ·»ä»˜ã‚’é–‹ãã¾ã™"],
    ['tab-list',"å³ä¸Šã®CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™"],
    ['f_keyword',"ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒ¡ãƒ¢ã‚’æ¨ªæ–­æ¤œç´¢"],
    ['f_project',"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§çµã‚Šè¾¼ã¿"],
    ['f_assignee',"æ‹…å½“è€…ã§çµã‚Šè¾¼ã¿"],
    ['f_from',"ã“ã®æ—¥ä»˜ä»¥é™ã®æœŸé™ã§çµã‚Šè¾¼ã¿"],
    ['f_to',"ã“ã®æ—¥ä»˜ä»¥å‰ã®æœŸé™ã§çµã‚Šè¾¼ã¿"],
    ['f_priority',"å„ªå…ˆåº¦ã§çµã‚Šè¾¼ã¿"],
    ['f_status',"çŠ¶æ…‹ï¼ˆæœªç€æ‰‹/é€²è¡Œä¸­/â€¦ï¼‰ã§çµã‚Šè¾¼ã¿"],
    ['gantt-scale-mode',"æ—¥/é€±/æœˆã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’åˆ‡æ›¿"],
  ];
  for(const [id,tip] of hints){
    const el = document.getElementById(id);
    if (el && !el.hasAttribute('data-tip')) el.setAttribute('data-tip', tip);
  }
})();


/* ========= ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ ========= */
const Flyout = (function(){
  const mask = document.getElementById('flyout-mask');
  const panel = document.getElementById('flyout');
  const btnClose = document.getElementById('flyout-close');
  const btnCancel = document.getElementById('flyout-cancel');
  const btnSubmit = document.getElementById('flyout-submit');

  function open(){
    mask.classList.add('open');
    panel.classList.add('open');
    document.body.classList.add('flyout-open');
    hydrateQuickForm(); // ã‚»ãƒ¬ã‚¯ãƒˆç­‰ã‚’æµã—è¾¼ã‚€
    // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(()=> document.getElementById('qx_t_title')?.focus(), 10);
  }
  function close(){
    mask.classList.remove('open');
    panel.classList.remove('open');
    document.body.classList.remove('flyout-open');
  }
  function toggle(){ panel.classList.contains('open') ? close() : open(); }

  // ESC/ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  mask?.addEventListener('click', close);
  btnClose?.addEventListener('click', close);
  btnCancel?.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && panel.classList.contains('open')) close(); });

  // ä½œæˆãƒœã‚¿ãƒ³ â†’ æ—¢å­˜addTask()ã‚’åˆ©ç”¨
  btnSubmit?.addEventListener('click', submitQuickTask);

  return { open, close, toggle };
})();

// FAB ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆ
(function bindFab(){
  const fab = document.getElementById('fab-main');
  if (!fab) return;
  fab.addEventListener('click', ()=> Flyout.toggle());
})();

/* ========= ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆå†…ï¼šã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¹ã‚¯ ========= */
function hydrateQuickForm(){
  // Users / Projects ã‚’æ—¢å­˜DATAã‹ã‚‰æ³¨å…¥
  const users = safeArr(DATA.users);
  const projs = safeArr(DATA.projects).filter(p => String(p.status||'').toLowerCase()!=='archived');

  const set = (sel, opts, label, value) => {
    sel.innerHTML = '';
    opts.forEach(o => sel.add(new Option(label(o), value(o))));
  };

  const pjSel = document.getElementById('qx_t_project');
  const asSel = document.getElementById('qx_t_assignees');

  if (pjSel) set(pjSel, projs, p => p.name||p.id, p => p.id);
  if (asSel) {
    asSel.innerHTML = '';
    users.forEach(u => asSel.add(new Option(u.name||u.email||u.id, u.id)));
    asSel.size = Math.min(Math.max(users.length, 3), 10);
  }

  // æœŸé™åˆæœŸå€¤=ä»Šæ—¥
  const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const today = `${y}-${m}-${dd}`;
  const due = document.getElementById('qx_t_due'); if (due && !due.value) due.value = today;
}

function submitQuickTask(){
  const title = (document.getElementById('qx_t_title')||{}).value?.trim();
  if(!title){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); document.getElementById('qx_t_title')?.focus(); return; }

  // æ—¢å­˜ addTask() ã¨åŒã˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å†™ã—ã¦ã‹ã‚‰ addTask å‘¼ã³å‡ºã—
  const to = (id, v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
  to('t_title', title);
  to('t_project_select', (document.getElementById('qx_t_project')||{}).value||'');
  to('t_due', (document.getElementById('qx_t_due')||{}).value||'');
  to('t_prio', (document.getElementById('qx_t_prio')||{}).value||'');
  to('t_memo', (document.getElementById('qx_t_memo')||{}).value||'');
  // æ‹…å½“ï¼ˆè¤‡æ•°ï¼‰ã‚’ç§»ã™
  const qxAss = Array.from((document.getElementById('qx_t_assignees')||{}).selectedOptions||[]).map(o=>o.value);
  const ms = document.getElementById('t_assignees_select');
  if (ms) Array.from(ms.options).forEach(o => o.selected = qxAss.includes(o.value));

  // ç¨®åˆ¥/è‰²ãªã©ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ©ç”¨
  to('t_type','single');
  // å®Ÿè¡Œ
  addTask();
  showToast('ok','ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ');
  Flyout.close();
}

// Enterã§ä½œæˆ
document.getElementById('flyout')?.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey)) return; // ä¿®é£¾ã¯ç„¡è¦–
  if(e.key==='Enter'){ e.preventDefault(); submitQuickTask(); }
});

// ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ =====
function hydrateFlyoutSelects(){
  // æ—¢å­˜DATAã‹ã‚‰é¸æŠè‚¢ã‚’æµç”¨
  const users = safeArr(DATA.users);
  const projects = safeArr(DATA.projects).filter(p => String(p.status||'').toLowerCase()!=='archived');

  const fill = (el, opts, getLabel, getVal) => {
    if (!el) return;
    while (el.options.length) el.remove(0);
    opts.forEach(o => el.add(new Option(getLabel(o), getVal(o))));
  };

  // taskç”¨
  fill(document.getElementById('ft_project'), projects, p => p.name||p.id, p => p.id);
  fill(document.getElementById('ft_owner'), users, u => u.name||u.email||u.id, u => u.id);
  const ass = document.getElementById('ft_assignees');
  if (ass){
    while (ass.options.length) ass.remove(0);
    users.forEach(u => ass.add(new Option(u.name||u.email||u.id, u.id)));
    ass.size = Math.min(Math.max(users.length, 3), 10);
  }
  // projectç”¨
  fill(document.getElementById('fp_parent'), projects, p => p.name||p.id, p => p.id);
  fill(document.getElementById('fp_owner'), users, u => u.name||u.email||u.id, u => u.id);
}

function openFlyout(kind){
  hydrateFlyoutSelects();
  document.body.classList.add('flyout-open');
  document.getElementById('flyout-mask')?.classList.add('open');
  const pane = document.getElementById(kind==='task' ? 'flyout-task' : 'flyout-project');
  pane?.classList.add('open');
  pane?.setAttribute('aria-hidden','false');
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆæœŸåŒ–
  (kind==='task' ? document.getElementById('ft_title') : document.getElementById('fp_name'))?.focus();
}
function closeFlyout(){
  document.body.classList.remove('flyout-open');
  document.getElementById('flyout-mask')?.classList.remove('open');
  ['flyout-task','flyout-project'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
  });
}
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeFlyout(); });

// ===== é€ä¿¡ï¼ˆGASã«ç›´æ¥ä¿å­˜ï¼‰ =====
function submitFlyoutTask(){
  const ownerId = sel('ft_owner');
  const assigneesArr = Array.from((document.getElementById('ft_assignees')||{selectedOptions:[]}).selectedOptions).map(o=>o.value);
  if (ownerId && !assigneesArr.includes(ownerId)) assigneesArr.push(ownerId);

  const t = {
    projectId: sel('ft_project'),
    parentTaskId: '',
    type: sel('ft_type') || 'single',
    title: val('ft_title').trim(),
    ownerUserId: ownerId,
    assignees: assigneesArr.join(','),
    dueDate: val('ft_due'),
    status: 'todo',
    priority: val('ft_prio'),
    color: (val('ft_color')||'') === '#ffffff' ? '' : val('ft_color'),
    memoText: val('ft_memo'),
    estimateHours: '',
    actualHours: '',
    rrule: '',
    nextOccurrence: ''
  };
  if(!t.title){ alert('ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(row => {
    patchRow('tasks', row); rerenderAfter('tasks'); closeFlyout();
  }).upsertTask(t);
}

function submitFlyoutProject(){
  const p = {
    name: val('fp_name').trim(),
    parentProjectId: sel('fp_parent'),
    ownerUserId: sel('fp_owner'),
    priority: val('fp_priority'),
    color: (val('fp_color')||'') === '#ffffff' ? '' : val('fp_color'),
    budget: val('fp_budget'),
    startDate: val('fp_start'),
    endDate: val('fp_end'),
    memoText: val('fp_memo'),
    status: 'active',
    fiscalYear: new Date().getFullYear()
  };
  if(!p.name){ alert('åç§°ã¯å¿…é ˆã§ã™'); return; }
  gsr().withSuccessHandler(row => {
    patchRow('projects', row); rerenderAfter('projects'); closeFlyout();
  }).upsertProject(p);
}
// ======== Center Modal API ========
function openModal(title, html, onOpen){
  const mask = document.getElementById('modal-mask');
  const tt   = document.getElementById('modal-title');
  const ct   = document.getElementById('modal-content');
  if(!mask || !tt || !ct) return alert('Modal host not found');
  tt.textContent = title || '';
  ct.innerHTML = html || '';
  mask.style.display = 'flex';
  document.body.dataset.modalOpen = '1';
  try{
    if (typeof onOpen === 'function') {
      const modalRoot = document.getElementById('modal') || mask;
      onOpen(modalRoot);
    }
  }catch(e){
    console.error(e);
  }
}
function closeModal(){
  const mask = document.getElementById('modal-mask');
  if(mask) mask.style.display = 'none';
  document.body.dataset.modalOpen = '';
}
// å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', (e)=>{
  const mask = document.getElementById('modal-mask');
  const dlg  = document.getElementById('modal');
  if(!mask || !dlg) return;
  if(mask.style.display !== 'flex') return;
  if(e.target === mask){ closeModal(); }
});
// ESCã§é–‰ã˜ã‚‹
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && document.body.dataset.modalOpen === '1'){ closeModal(); }
});

// æ—¢å­˜ã®ã€Œå³ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã€ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸å·®ã—æ›¿ãˆï¼ˆäº’æ›ãƒ•ãƒƒã‚¯ï¼‰
function openFlyoutCompat(title, html){ openModal(title, html); }
async function fetchDocsMarkdown(name){
  const normalized = String(name || '').trim().toUpperCase();
  const fileName = normalized === 'BEGINNER' ? 'BEGINNER.md'
    : (normalized === 'USER_GUIDE' || normalized === 'USERGUIDE' || normalized === 'USER-GUIDE') ? 'USER_GUIDE.md'
    : normalized === 'SPEC' ? 'SPEC.md'
    : '';
  if (!fileName) throw new Error('Invalid or missing name');

  // Prefer static docs to avoid server cwd/path differences.
  try{
    const url = '/docs/' + encodeURIComponent(fileName);
    const resp = await fetch(url, { method:'GET' });
    if (resp.ok) {
      // Docs may be Shift_JIS; pick the decode with fewer replacement chars.
      try{
        const buf = await resp.arrayBuffer();
        const countReplacement = (s)=>{
          try { return (String(s||'').match(/\uFFFD|ï¿½/g) || []).length; } catch(_){ return 0; }
        };
        const tryDecode = (enc)=>{
          try { return new TextDecoder(enc).decode(buf); } catch(_){ return null; }
        };
        const utf8 = tryDecode('utf-8');
        const sjis = tryDecode('shift_jis');
        const utf8Score = utf8 == null ? 1e9 : countReplacement(utf8);
        const sjisScore = sjis == null ? 1e9 : countReplacement(sjis);
        if (sjis != null && sjisScore <= utf8Score) return sjis;
        if (utf8 != null) return utf8;
        return await resp.text();
      }catch(_){
        return await resp.text();
      }
    }
  }catch(_){ }

  // Backward-compatible fallback.
  const apiUrl = '/api/docs?name=' + encodeURIComponent(normalized);
  const resp = await fetch(apiUrl, { method:'GET' });
  const raw = await resp.text().catch(()=> '');
  let data = null;
  try { data = raw ? JSON.parse(raw) : null; } catch { data = null; }
  if (!resp.ok || !data || data.ok !== true) {
    const msg = (data && data.error) ? data.error : (raw || ('HTTP '+resp.status));
    throw new Error(msg);
  }
  return String(data.markdown || '');
}

function mdToHtml(md){
  try{
    if (window.marked && typeof window.marked.parse === 'function') {
      return window.marked.parse(String(md||''), { gfm:true, breaks:true });
    }
  }catch(_){ }
  return '<pre>' + escapeHtml(String(md||'')) + '</pre>';
}

function renderMermaidIn(container){
  try{
    if (!window.mermaid) return;
    try { window.mermaid.initialize({ startOnLoad:false }); } catch(_){ }

    // Convert fenced ```mermaid blocks (marked emits code.language-mermaid)
    const codes = container.querySelectorAll('pre > code.language-mermaid, pre > code.mermaid');
    codes.forEach(code => {
      const pre = code.parentElement;
      if (!pre) return;
      const div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = code.textContent || '';
      pre.replaceWith(div);
    });

    // Render
    const nodes = container.querySelectorAll('.mermaid');
    if (nodes && nodes.length) {
      window.mermaid.run({ nodes });
    }
  }catch(e){
    console.error(e);
  }
}

async function loadUsageDocsInto(modalRoot, name){
  const host = modalRoot.querySelector('#usage-docs-host');
  if (!host) return;
  host.innerHTML = '<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    const md = await fetchDocsMarkdown(name);
    host.innerHTML = '<div class="md-docs">' + mdToHtml(md) + '</div>';
    renderMermaidIn(host);
    // ensure top scroll
    try { host.scrollTop = 0; } catch(_){ }
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    host.innerHTML = '<div class="muted">è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(msg) + '</div>';
  }
}

function openUsageGuide(initial){
  const first = (String(initial||'').toUpperCase()==='USER_GUIDE') ? 'USER_GUIDE' : 'BEGINNER';
  const body = `
    <div class="md-docs-nav">
      <button id="btn-usage-beginner" class="secondary">åˆä½¿ç”¨è€…å‘ã‘ï¼ˆBEGINNERï¼‰</button>
      <button id="btn-usage-user" class="secondary">ä½¿ç”¨è€…å‘ã‘ï¼ˆUSER_GUIDEï¼‰</button>
      <button id="btn-usage-spec" class="secondary">ä»•æ§˜æ›¸ï¼ˆSPECï¼‰</button>
    </div>
    <div id="usage-docs-host" style="max-height:65vh; overflow:auto;"></div>
  `;
  openModal('ä½¿ã„æ–¹', body, (modalRoot)=>{
    const b0 = modalRoot.querySelector('#btn-usage-beginner');
    const b1 = modalRoot.querySelector('#btn-usage-user');
    const b2 = modalRoot.querySelector('#btn-usage-spec');
    function setActive(name){
      if (b0) b0.classList.toggle('active', name==='BEGINNER');
      if (b1) b1.classList.toggle('active', name==='USER_GUIDE');
      if (b2) b2.classList.toggle('active', name==='SPEC');
    }
    if (b0) b0.addEventListener('click', ()=>{ setActive('BEGINNER'); loadUsageDocsInto(modalRoot, 'BEGINNER'); });
    if (b1) b1.addEventListener('click', ()=>{ setActive('USER_GUIDE'); loadUsageDocsInto(modalRoot, 'USER_GUIDE'); });
    if (b2) b2.addEventListener('click', ()=>{ setActive('SPEC'); loadUsageDocsInto(modalRoot, 'SPEC'); });
    setActive(first);
    loadUsageDocsInto(modalRoot, first);
  });
}
// ç¾åœ¨ã®ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ ã®å…¥åŠ›æ¬„ã‚’ãã®ã¾ã¾ä½¿ã„ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã€Œè¤‡è£½ã€ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚
// ä¿å­˜æ™‚ã¯æ—¢å­˜ã® addProject / addTask ã‚’ãã®ã¾ã¾å‘¼ã¶ã€‚
function openProjectFormModal(){
  

  const html = `
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h3 class="modal-title" style="margin:0;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </h3>
      <ul>
        <li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ã«è¿½åŠ ã—ã¾ã™ã€‚</li>
        <li>â€»æ·»ä»˜URLã¯é …ç›®ä½œæˆå¾Œä¸€è¦§ã‚‚ã—ãã¯ç·¨é›†ãƒœã‚¿ãƒ³ã‚ˆã‚Šè¿½åŠ å¯èƒ½ã§ã™</li>
        <li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯ã«Goodleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™</li>
      </ul>
      <button class="secondary" onclick="openUsageGuide()">ä½¿ã„æ–¹</button>
    </div>

    <div class="row">
      <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå(å¿…é ˆ)</label><input id="mp_name" value="${escapeHtml(val('p_name'))}"/></div>
      <div><label data-tip="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã»ã‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸‹ä½ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å ´åˆå…¥åŠ›ã—ã¾ã™" >è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(ä»»æ„)</label>${document.getElementById('p_parent_select').outerHTML.replace('p_parent_select','mp_parent_select')}</div>
    </div>
    <div class="row">
      <div><label>ä¸»æ‹…å½“è€…ï¼ˆUsersï¼‰(å¿…é ˆ)</label>${document.getElementById('p_owner_select').outerHTML.replace('p_owner_select','mp_owner_select')}</div>
      <div><label>å„ªå…ˆåº¦(å¿…é ˆ)</label>${document.getElementById('p_priority').outerHTML.replace('p_priority','mp_priority')}</div>
    </div>
    <div class="row">
      <div><label>ã‚«ãƒ©ãƒ¼(ä»»æ„)</label><input id="mp_color" data-tip="ã‚¿ã‚¹ã‚¯ã«è‰²ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä¸€è¦§ä¸­ã§ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚" type="color" value="${escapeHtml(val('p_color'))||'#ffffff'}"/></div>
      <div><label>äºˆç®—ï¼ˆå††ï¼‰(ä»»æ„)</label><input id="mp_budget" type="number" value="${escapeHtml(val('p_budget'))}"/></div>
    </div>
    <div class="row">
      <div><label>é–‹å§‹æ—¥(ä»»æ„)</label><input id="mp_start" type="date" value="${escapeHtml(val('p_start'))}"/></div>
      <div><label>çµ‚äº†æ—¥(ä»»æ„)</label><input id="mp_end" type="date" value="${escapeHtml(val('p_end'))}"/></div>
    </div>
    <div><label>ãƒ¡ãƒ¢(ä»»æ„)</label><textarea id="mp_memo">${escapeHtml(val('p_memo'))}</textarea></div>

    <div class="toolbar" style="justify-content:flex-end; gap:8px;">
      
      <button data-tip="ã“ã®å†…å®¹ã§ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã—ã¾ã™" onclick="(function(){
        // ãƒ¢ãƒ¼ãƒ€ãƒ«â†’å®Ÿä½“ãƒ•ã‚©ãƒ¼ãƒ ã¸å€¤ã‚’æˆ»ã™
        el('p_name').value = val('mp_name');
        el('p_parent_select').value = sel('mp_parent_select');
        el('p_owner_select').value = sel('mp_owner_select');
        el('p_priority').value = val('mp_priority');
        el('p_color').value = val('mp_color');
        el('p_budget').value = val('mp_budget');
        el('p_start').value = val('mp_start');
        el('p_end').value = val('mp_end');
        el('p_memo').value = val('mp_memo');
        closeModal();
        addProject();
      })()">ä¿å­˜ã—ã¦è¿½åŠ </button>
    </div>
  `;
  openModal('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ', html);
}

function openTaskFormModal(){
  // ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
  

  // æ‹…å½“è€…ã®è¤‡æ•°é¸æŠã¯ç°¡æ˜“å…¥åŠ›ã«å¯„ã›ã‚‹ï¼ˆä¿å­˜æ™‚ã«æ—¢å­˜UIã¸åæ˜ ï¼‰
  const assigneeSel = document.getElementById('t_assignees_select');
  const assigneeHtml = assigneeSel ? assigneeSel.outerHTML.replace('t_assignees_select','mt_assignees_select') : '';

  const html = `
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h3 class="modal-title" style="margin:0;">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
      <ul>
        <li>ã‚¿ã‚¹ã‚¯ã‚’æ–°è¦ã«è¿½åŠ ã—ã¾ã™ã€‚</li>
        <li>â€»æ·»ä»˜URLã¯é …ç›®ä½œæˆå¾Œä¸€è¦§ã‚‚ã—ãã¯ç·¨é›†ãƒœã‚¿ãƒ³ã‚ˆã‚Šè¿½åŠ å¯èƒ½ã§ã™</li>
        <li>â€»ã‚¿ã‚¹ã‚¯æ¯ã«Goodleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™</li>
      </ul>
      <button class="secondary" onclick="openUsageGuide()">ä½¿ã„æ–¹</button>
    </div>

    <div class="row">
      <div><label>ã‚¿ã‚¹ã‚¯å(å¿…é ˆ)</label><input data-tip="ã“ã®ã‚¿ã‚¹ã‚¯ã®è­˜åˆ¥åã§ã™ã€‚"  id="mt_title" value="${escapeHtml(val('t_title'))}"/></div>
      <div><label data-tip="ã“ã®ã‚¿ã‚¹ã‚¯ãŒæ‰€å±ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚è¦ªã¨ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆã€å…ˆã«ä½œæˆã—ã¦ãã ã•ã„ã€‚">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(å¿…é ˆ)</label>${document.getElementById('t_project_select').outerHTML.replace('t_project_select','mt_project_select')}</div>
    </div>
    <div class="row">
      <div><label>ç¨®åˆ¥(ä»»æ„)</label>${document.getElementById('t_type').outerHTML.replace('t_type','mt_type')}</div>
      <div><label>æœŸé™(ä»»æ„)</label><input id="mt_due" type="date" value="${escapeHtml(val('t_due'))}"/></div>
    </div>
    <div class="row">
      <div><label>ä¸»æ‹…å½“è€…ï¼ˆUsersï¼‰(å¿…é ˆ)</label>${document.getElementById('t_owner_select').outerHTML.replace('t_owner_select','mt_owner_select')}</div>
      <div><label data-tip="ã“ã®ã‚¿ã‚¹ã‚¯ã«å®Ÿéš›ã«é–¢ã‚ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã™ã¹ã¦é¸æŠã—ã¾ã™ã€‚ctrl+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°äººæŒ‡å®šå¯èƒ½ã§ã™ã€‚ä¸»è²¬ä»»è€…ã¯è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ã€‚">æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰(ä»»æ„)</label>${assigneeHtml}</div>
    </div>
    <div class="row">
      <div><label>å„ªå…ˆåº¦(å¿…é ˆ)</label>${document.getElementById('t_prio').outerHTML.replace('t_prio','mt_prio')}</div>
      <div><label>ã‚«ãƒ©ãƒ¼(ä»»æ„)</label><input id="mt_color" data-tip="ã‚¿ã‚¹ã‚¯ã«è‰²ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä¸€è¦§ä¸­ã§ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚" type="color" value="${escapeHtml(val('t_color'))||'#ffffff'}"/></div>
    </div>
    <div><label>ãƒ¡ãƒ¢(ä»»æ„)</label><textarea id="mt_memo">${escapeHtml(val('t_memo'))}</textarea></div>

    <div class="toolbar" style="justify-content:flex-end; gap:8px;">
      
      <button data-tip="ã“ã®å†…å®¹ã§ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã—ã¾ã™" onclick="(function(){
        el('t_title').value = val('mt_title');
        el('t_project_select').value = sel('mt_project_select');
        el('t_type').value = sel('mt_type');
        el('t_due').value = val('mt_due');
        el('t_owner_select').value = sel('mt_owner_select');
        // æ‹…å½“è€… è¤‡æ•°
        const src = document.getElementById('mt_assignees_select');
        const dst = document.getElementById('t_assignees_select');
        if(src && dst){
          Array.from(dst.options).forEach(o => o.selected = false);
          Array.from(src.selectedOptions).forEach(o => {
            const hit = Array.from(dst.options).find(x => x.value === o.value);
            if(hit) hit.selected = true;
          });
        }
        el('t_prio').value = sel('mt_prio');
        el('t_color').value = val('mt_color');
        el('t_memo').value = val('mt_memo');
        closeModal();
        addTask();
      })()">ä¿å­˜ã—ã¦è¿½åŠ </button>
    </div>
  `;
  openModal('ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ', html);
}
// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ±ç”¨ãƒ˜ãƒ«ãƒ‘ =====
function openModal(title, bodyHtml, onMount){
  const mask = document.getElementById('modal-mask');
  const modal = document.getElementById('modal');
  if(!mask || !modal){ alert('ãƒ¢ãƒ¼ãƒ€ãƒ«DOMãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  modal.innerHTML = `
    <header>
      <strong>${escapeHtml(title||'')}</strong>
      <button class="close" onclick="closeModal()">âœ•</button>
    </header>
    <div class="content">${bodyHtml||''}</div>
  `;
  mask.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  try{ onMount && onMount(modal); }catch(_){}
}
function closeModal(){
  const mask = document.getElementById('modal-mask');
  if(mask) mask.style.display = 'none';
  document.body.style.overflow = '';
}
// ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰ =====
function showProjectModal(id){
  const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
  if(!p){ alert('å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  const projOpts = (safeArr(DATA.projects).map(q =>
    `<option value="${escapeHtml(q.id)}" ${String(q.id)===String(p.parentProjectId)?'selected':''}>${escapeHtml(q.name||q.id)}</option>`
  ).join(''));
  const userOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${String(u.id)===String(p.ownerUserId)?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const prio = (v)=> (String(v).trim()==='é«˜'?'é«˜':String(v).trim()==='ä¸­'?'ä¸­':String(v).trim()==='ä½'?'ä½':'');
  const body = `
    <div class="row">
      <div><label>åç§°</label><input id="pm_name" value="${escapeHtml(p.name||'')}"/></div>
      <div><label>è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="pm_parent"><option value="">ï¼ˆãªã—ï¼‰</option>${projOpts}</select></div>
    </div>
    <div class="row">
      <div><label>è²¬ä»»è€…</label><select id="pm_owner"><option value="">ï¼ˆæœªé¸æŠï¼‰</option>${userOpts}</select></div>
      <div><label>å„ªå…ˆåº¦</label>
        <select id="pm_prio">
          <option value="">-</option>
          <option ${prio(p.priority)==='é«˜'?'selected':''}>é«˜</option>
          <option ${prio(p.priority)==='ä¸­'?'selected':''}>ä¸­</option>
          <option ${prio(p.priority)==='ä½'?'selected':''}>ä½</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label>ã‚«ãƒ©ãƒ¼</label><input id="pm_color" type="color" value="${/^#[0-9a-fA-F]{6}$/.test(p.color||'')?escapeHtml(p.color):'#ffffff'}"/></div>
      <div><label>äºˆç®—ï¼ˆå††ï¼‰</label><input id="pm_budget" type="number" value="${escapeHtml(String(p.budget||''))}"/></div>
    </div>
    <div class="row">
      <div><label>é–‹å§‹æ—¥</label><input id="pm_start" type="date" value="${escapeHtml(p.startDate||'')}"/></div>
      <div><label>çµ‚äº†æ—¥</label><input id="pm_end" type="date" value="${escapeHtml(p.endDate||'')}"/></div>
    </div>
    <div class="row">
      <div>
        <label>ãƒ¡ãƒ¢</label>
        <textarea id="pm_memo" style="min-height:120px;">${escapeHtml(p.memoText||'')}</textarea>
      </div>
      <div>
        <label>æ·»ä»˜</label>
        <div class="toolbar">
          <button class="secondary" onclick="openAttachDialogFor('project','${escapeHtml(p.id)}')">ğŸ“æ·»ä»˜ã‚’è¿½åŠ </button>
          <button class="secondary" onclick="openAttachmentManager('project','${escapeHtml(p.id)}')">æ·»ä»˜ä¸€è¦§</button>
        </div>
        <div class="muted"></div>
      </div>
    </div>
    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button class="secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveProjectFromModal('${escapeHtml(p.id)}')">æ›´æ–°</button>
    </div>
  `;

  openModal('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç·¨é›†', body);
}

function saveProjectFromModal(id){
  const payload = {
    id,
    name: val('pm_name').trim(),
    parentProjectId: sel('pm_parent'),
    ownerUserId: sel('pm_owner'),
    priority: val('pm_prio'),
    color: val('pm_color'),
    budget: val('pm_budget'),
    startDate: val('pm_start'),
    endDate: val('pm_end'),
    memoText: val('pm_memo'),
    status: 'active'
  };
  gsr().withSuccessHandler(row=>{
    patchRow('projects', row);
    rerenderAfter('projects');
    closeModal();
    showToast('ok','æ›´æ–°ã—ã¾ã—ãŸ');
  }).upsertProject(payload);
}


// ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¿ã‚¹ã‚¯ï¼‰ =====
function showTaskModal(id){
  const t = safeArr(DATA.tasks).find(x=>String(x.id)===String(id));
  if(!t){ alert('å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  const projOpts = (safeArr(DATA.projects).filter(p=>String(p.status||'').toLowerCase()!=='archived').map(p =>
    `<option value="${escapeHtml(p.id)}" ${String(p.id)===String(t.projectId)?'selected':''}>${escapeHtml(p.name||p.id)}</option>`
  ).join(''));
  const userOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${String(u.id)===String(t.ownerUserId)?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const assSet = new Set(String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean));
  const assOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${assSet.has(String(u.id))?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const prio = (v)=> (String(v).trim()==='é«˜'?'é«˜':String(v).trim()==='ä¸­'?'ä¸­':String(v).trim()==='ä½'?'ä½':'');
  const body = `
    <div class="row">
      <div><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input id="tm_title" value="${escapeHtml(t.title||'')}"/></div>
      <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="tm_project"><option value="">ï¼ˆæœªé¸æŠï¼‰</option>${projOpts}</select></div>
    </div>
    <div class="row">
      <div><label>ç¨®åˆ¥</label>
        <select id="tm_type">
          <option value="single" ${String(t.type||'single')==='single'?'selected':''}>å˜ç™º</option>
          <option value="recurring" ${String(t.type)==='recurring'?'selected':''}>å®šæœŸ</option>
        </select>
      </div>
      <div><label>æœŸé™</label><input id="tm_due" type="date" value="${escapeHtml(t.dueDate||'')}"/></div>
    </div>
    <div class="row">
      <div><label>è²¬ä»»è€…</label><select id="tm_owner"><option value="">ï¼ˆæœªé¸æŠï¼‰</option>${userOpts}</select></div>
      <div>
        <label>æ‹…å½“è€…ï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <select id="tm_assignees" multiple size="6" style="min-height:110px;">${assOpts}</select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>å„ªå…ˆåº¦</label>
        <select id="tm_prio">
          <option value="">-</option>
          <option ${prio(t.priority)==='é«˜'?'selected':''}>é«˜</option>
          <option ${prio(t.priority)==='ä¸­'?'selected':''}>ä¸­</option>
          <option ${prio(t.priority)==='ä½'?'selected':''}>ä½</option>
        </select>
      </div>
      <div>
        <label>ã‚«ãƒ©ãƒ¼</label>
        <input id="tm_color" type="color" value="${/^#[0-9a-fA-F]{6}$/.test(t.color||'')?escapeHtml(t.color):'#ffffff'}"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>ã‚¿ã‚¹ã‚¯ãƒ¡ãƒ¢</label>
        <textarea id="tm_memo" style="min-height:120px;">${escapeHtml(t.memoText||'')}</textarea>
      </div>
      <div>
        <label>æ·»ä»˜</label>
        <div class="toolbar">
          <button class="secondary" onclick="openAttachDialogFor('task','${escapeHtml(t.id)}')">ğŸ“æ·»ä»˜ã‚’è¿½åŠ </button>
          <button class="secondary" onclick="openAttachmentManager('task','${escapeHtml(t.id)}')">æ·»ä»˜ä¸€è¦§</button>
        </div>
        <div class="muted"></div>
      </div>
    </div>
    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button class="secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveTaskFromModal('${escapeHtml(t.id)}')">æ›´æ–°</button>
    </div>
  `;
  openModal('ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†', body);
}

function saveTaskFromModal(id){
  const ass = Array.from(document.querySelectorAll('#tm_assignees option:checked')).map(o=>o.value);
  const payload = {
    id,
    projectId: sel('tm_project'),
    parentTaskId: '',
    type: sel('tm_type')||'single',
    title: val('tm_title').trim(),
    ownerUserId: sel('tm_owner'),
    assignees: ass.join(','),
    dueDate: val('tm_due'),
    status: (safeArr(DATA.tasks).find(x=>String(x.id)===String(id))?.status)||'todo',
    priority: val('tm_prio'),
    color: val('tm_color'),
    memoText: val('tm_memo')
  };
  gsr().withSuccessHandler(row=>{
    patchRow('tasks', row);
    rerenderAfter('tasks');
    closeModal();
    showToast('ok','æ›´æ–°ã—ã¾ã—ãŸ');
  }).upsertTask(payload);
}
// ç½®æ›å¾Œï¼šä¸€è¦§ã®ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function editProject(id){ showProjectModal(id); }
function editTask(id){ showTaskModal(id); }
function openAppUsageGuide() {
  // Vercel/staticç‰ˆã¯ã€docs/*.md ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆMermaidå¯¾å¿œï¼‰
  try { openUsageGuide('BEGINNER'); } catch(_){ }
  }
(() => {
  const OFFSET_X = 12;   // ãƒã‚¦ã‚¹ã‹ã‚‰å³ã¸
  const OFFSET_Y = 12;   // ãƒã‚¦ã‚¹ã‹ã‚‰â€œä¸Šã¸â€ (ä¸Šã«å‡ºã™ã®ã§ä½¿ç”¨æ™‚ã¯å¼•ãç®—)
  let bubble = null;
  let moveHandler = null;

  function createBubble(text){
    const el = document.createElement('div');
    el.className = 'tooltip-bubble';
    el.textContent = text || '';
    document.body.appendChild(el);
    return el;
  }

  function positionBubble(e){
    if(!bubble) return;
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    // ã¾ãš â€œå³ä¸Šâ€ ã«å‡ºã™ï¼ˆï¼ã‚«ãƒ¼ã‚½ãƒ«ã‚ˆã‚Šä¸Šãƒ»å³ï¼‰
    let left = e.clientX + OFFSET_X;
    let top  = e.clientY - (bubble.offsetHeight + OFFSET_Y);

    // ç”»é¢ä¸Šç«¯ã«é£Ÿã„è¾¼ã‚€ãªã‚‰â€œä¸‹å´â€ã«å‡ºã™
    if (top < 8) {
      top = e.clientY + OFFSET_Y;
      bubble.classList.add('below');
    } else {
      bubble.classList.remove('below');
    }

    // å³ç«¯ã«é£Ÿã„è¾¼ã‚€ãªã‚‰å·¦å´ã«ãƒ•ãƒªãƒƒãƒ—
    const width = bubble.offsetWidth;
    if (left + width > vw - 8) {
      left = e.clientX - width - OFFSET_X;
      bubble.classList.add('left');
    } else {
      bubble.classList.remove('left');
    }

    // å·¦ç«¯ã®æœ€çµ‚ä¿è­·
    if (left < 8) left = 8;
    // ä¸‹ç«¯ã®æœ€çµ‚ä¿è­·
    if (top + bubble.offsetHeight > vh - 8) top = vh - bubble.offsetHeight - 8;

    bubble.style.left = left + 'px';
    bubble.style.top  = top + 'px';
  }

  function onEnter(e){
    const target = closestSafe(e.target,'[data-tip]');
    if(!target) return;
    const text = target.getAttribute('data-tip');
    if(!text) return;

    bubble = createBubble(text);
    moveHandler = (ev) => positionBubble(ev);
    // ã™ã1å›åº§æ¨™ã‚’åæ˜ 
    positionBubble(e);

    target.addEventListener('pointermove', moveHandler);
    target.addEventListener('pointerleave', onLeave, { once: true });
    target.addEventListener('pointerdown',  onLeave, { once: true });
  }

  function onLeave(e){
    const target = e.currentTarget || e.target;
    if (moveHandler) target.removeEventListener('pointermove', moveHandler);
    moveHandler = null;
    if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble);
    bubble = null;
  }

  // ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ data-tip å…¨ä½“ã«é©ç”¨
  document.addEventListener('pointerenter', onEnter, true);
})();

// ã©ã‚“ãª target ãŒæ¥ã¦ã‚‚å®‰å…¨ã« closest ã‚’ä½¿ã†ãƒ˜ãƒ«ãƒ‘ãƒ¼
function closestSafe(target, selector){
  if (!target) return null;
  // target ãŒè¦ç´ ã§ãªã‘ã‚Œã°è¦ªã®è¦ç´ ã‚’èµ·ç‚¹ã«ã™ã‚‹ï¼ˆText ãƒãƒ¼ãƒ‰ãªã©ã®å¯¾ç­–ï¼‰
  let el = (target.nodeType === 1) ? target : target.parentElement;
  if (!el) return null;
  return el.closest ? el.closest(selector) : null; // å¿µã®ãŸã‚å¤ã„ç’°å¢ƒã‚‚è€ƒæ…®
}

</script>



<!-- ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ  ===== -->
<div id="flyout-mask" class="flyout-mask" tabindex="-1" aria-hidden="true"></div>

<aside id="flyout-project" class="flyout" role="dialog" aria-modal="true" aria-labelledby="fly-prj-title">
  <header>
    <h3 id="fly-prj-title" style="margin:0;font-size:16px;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </h3>
    <button class="secondary" onclick="closeFlyout('project')" aria-label="é–‰ã˜ã‚‹">âœ–</button>
  </header>
  <div class="content">
    <div class="row">
      <div>
        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå <span class="pill">å¿…é ˆ</span></label>
        <input id="fly_p_name" placeholder="ä¾‹: 2025ä¸ŠæœŸ æ–°è£½å“A"/>
        <div class="hint">åç§°ã¯å¾Œã‹ã‚‰å¤‰æ›´ã§ãã¾ã™</div>
      </div>
      <div>
        <label>è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä»»æ„ï¼‰</label>
        <select id="fly_p_parent"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>è²¬ä»»è€…</label>
        <select id="fly_p_owner"></select>
      </div>
      <div>
        <label>å„ªå…ˆåº¦</label>
        <select id="fly_p_prio"><option value="">-</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>ã‚«ãƒ©ãƒ¼</label><input id="fly_p_color" type="color" value="#ffffff"/></div>
      <div><label>äºˆç®—ï¼ˆå††ï¼‰</label><input id="fly_p_budget" type="number" min="0"/></div>
    </div>
    <div class="row">
      <div><label>é–‹å§‹æ—¥</label><input id="fly_p_start" type="date"/></div>
      <div><label>çµ‚äº†æ—¥</label><input id="fly_p_end" type="date"/></div>
    </div>
    <label>ãƒ¡ãƒ¢</label>
    <textarea id="fly_p_memo" placeholder="ç›®çš„ã‚„èƒŒæ™¯ãªã©"></textarea>
  </div>
  <div class="actions">
    <button class="secondary" onclick="closeFlyout('project')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button onclick="submitFlyoutProject()">ä½œæˆ</button>
  </div>
</aside>

<!-- ===== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚¿ã‚¹ã‚¯è¿½åŠ  ===== -->
<aside id="flyout-task" class="flyout" role="dialog" aria-modal="true" aria-labelledby="fly-task-title">
  <header>
    <h3 id="fly-task-title" style="margin:0;font-size:16px;">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
    <button class="secondary" onclick="closeFlyout('task')" aria-label="é–‰ã˜ã‚‹">âœ–</button>
  </header>
  <div class="content">
    <div class="row">
      <div>
        <label>ã‚¿ã‚¹ã‚¯å <span class="pill">å¿…é ˆ</span></label>
        <input id="fly_t_title" placeholder="ä¾‹: å–èª¬ãƒ‰ãƒ©ãƒ•ãƒˆ"/>
      </div>
      <div>
        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
        <select id="fly_t_project"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>æ‹…å½“è€…ï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <select id="fly_t_assignees" multiple size="4"></select>
        <div class="hint">è²¬ä»»è€…ã¯è‡ªå‹•ã§æ‹…å½“ã«å«ã‚ã¾ã™</div>
      </div>
      <div>
        <label>æœŸé™</label>
        <input id="fly_t_due" type="date"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>å„ªå…ˆåº¦</label>
        <select id="fly_t_prio"><option value="">-</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
      </div>
      <div>
        <label>ç¨®åˆ¥</label>
        <select id="fly_t_type"><option value="single">å˜ç™º</option><option value="recurring">å®šæœŸ</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>ã‚«ãƒ©ãƒ¼</label><input id="fly_t_color" type="color" value="#ffffff"/></div>
      <div></div>
    </div>
    <label>ãƒ¡ãƒ¢</label>
    <textarea id="fly_t_memo" placeholder="è©³ç´°ã‚„æ³¨æ„ç‚¹"></textarea>
  </div>
  <div class="actions">
    <button class="secondary" onclick="closeFlyout('task')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button onclick="submitFlyoutTask()">ä½œæˆ</button>
  </div>
</aside>
<!-- â–¼ ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆFABï¼‰ -->
<div id="fab-stack" aria-live="polite">
  <button id="fab-main" class="fab-btn tooltip-host"
          data-tip="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ã‚¿ã‚¹ã‚¯ã®ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œã‚’é–‹ãã¾ã™\nEscã§é–‰ã˜ã‚‹ãƒ»å³ä¸ŠÃ—ã§ã‚‚é–‰ã˜ã¾ã™"
          data-tip-pos="left">
    ï¼‹ ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ
  </button>
  <!-- äºˆå‚™ï¼šå°†æ¥ã®æ‹¡å¼µç”¨ã«å°ãƒœã‚¿ãƒ³ã‚’ä¸¦ã¹ãŸã„å ´åˆ
  <button class="fab-btn secondary tooltip-host"
          data-tip="ä»Šæ—¥ã®é…å»¶ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ" data-tip-pos="left"
          onclick="quickOverdue()">âš¡ é…å»¶ãƒ•ã‚£ãƒ«ã‚¿</button>
  -->
</div>

<!-- â–¼ ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå³ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ -->
<div id="flyout-mask" class="flyout-mask" tabindex="-1" aria-hidden="true"></div>
<aside id="flyout" class="flyout" role="dialog" aria-modal="true" aria-labelledby="flyout-title">
  <header>
    <strong id="flyout-title">ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ</strong>
    <div style="display:flex; gap:6px; align-items:center;">
      <span class="muted tooltip-host" data-tip="ãƒ’ãƒ³ãƒˆ:\nEnterã§å®Ÿè¡Œï¼Escã§é–‰ã˜ã‚‹" data-tip-pos="bottom">ï¼Ÿ</span>
      <button id="flyout-close" class="secondary mini" aria-label="ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã‚’é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </header>
  <div class="content">
    <!-- åˆæœŸå†…å®¹ï¼ˆå¿…è¦ãªã‚‰è‡ªç”±ã«å·®ã—æ›¿ãˆï¼‰ -->
    <div class="row">
      <div class="card see-through">
        <h2 style="padding:0 0 8px 0;">ã‚¿ã‚¹ã‚¯ã‚’ã™ã°ã‚„ãä½œæˆ</h2>
        <div class="body">
          <div class="row">
            <div><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input id="qx_t_title" placeholder="ä¾‹: ä»•æ§˜ãƒ¬ãƒ“ãƒ¥ãƒ¼"/></div>
            <div><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label><select id="qx_t_project"></select></div>
          </div>
          <div class="row">
            <div><label>æœŸé™</label><input id="qx_t_due" type="date"/></div>
            <div><label>å„ªå…ˆåº¦</label>
              <select id="qx_t_prio">
                <option value="">-</option><option>é«˜</option><option>ä¸­</option><option>ä½</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>æ‹…å½“ï¼ˆè¤‡æ•°å¯ï¼‰</label><select id="qx_t_assignees" multiple size="3"></select></div>
            <div><label>ãƒ¡ãƒ¢</label><textarea id="qx_t_memo" placeholder="è¦ç‚¹ã ã‘ã§OK"></textarea></div>
          </div>
        </div>
      </div>
      <div class="card see-through">
        <h2 style="padding:0 0 8px 0;">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h2>
        <div class="body">
          <div class="toolbar">
            <button class="secondary tooltip-host" data-tip="ä»Šæ—¥ä»¥å‰ãŒæœŸé™ã§æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º">âš¡ é…å»¶ã ã‘</button>
            <button class="secondary tooltip-host" data-tip="ã‚«ãƒ³ãƒãƒ³ã«åˆ‡æ›¿" onclick="gotoDashboardTab('board')">ğŸ“‹ ã‚«ãƒ³ãƒãƒ³</button>
            <button class="secondary tooltip-host" data-tip="ã‚¬ãƒ³ãƒˆã«åˆ‡æ›¿" onclick="gotoDashboardTab('gantt')">ğŸ“ˆ ã‚¬ãƒ³ãƒˆ</button>
          </div>
          <p class="hint">ãƒ’ãƒ³ãƒˆ: Enterã§ã€Œã‚¿ã‚¹ã‚¯ä½œæˆã€ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
        </div>
      </div>
    </div>
  </div>
  <div class="actions">
    <button class="secondary" id="flyout-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«(Esc)</button>
    <button id="flyout-submit">ã‚¿ã‚¹ã‚¯ä½œæˆ</button>
  </div>
</aside>

<!-- ===== å³ä¸‹ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ ===== -->
<div id="fab-stack" aria-live="polite" >
  <button class="fab-btn" id="btn_add_project" onclick="openProjectFormModal()" data-tip="æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å³å´ã®ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆã‹ã‚‰ç´ æ—©ãä½œæˆã—ã¾ã™">
    â• ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ 
  </button>
  <button class="fab-btn" id="btn_add_task" onclick="openTaskFormModal()" data-tip="é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã™">
    âœ… ã‚¿ã‚¹ã‚¯è¿½åŠ 
  </button>
</div>
<div id="flyout-mask" class="flyout-mask" onclick="closeFlyout()"></div>

<!-- â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² -->
<!-- Center Modal -->
<div id="modal-mask" aria-hidden="true">
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header>
      <strong id="modal-title">ã‚¿ã‚¤ãƒˆãƒ«</strong>
      <button class="close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal()">âœ•</button>
    </header>
    <div class="content" id="modal-content"></div>
  </div>
</div>

</body>

</html>
