# 出勤状況・勤務時間・休憩の仕様まとめ

## 対象
- 画面: 出勤状況（`page-attendance`）
- データ: `attendance`（ステータス・打刻・休憩・メモ・プロジェクト/タスク）と `attendance_worklogs`（週次集計で使用）

## 出勤ステータス
内部値と表示名は以下です。
- `not-clocked`: 未打刻
- `working`: 出勤中
- `break`: 休憩中
- `out`: 外出中
- `done`: 退勤済

勤務場所（location）は以下を使用します。
- `office`: オフィス
- `remote`: テレワーク
- `out`: 外出

操作ボタンの挙動（概要）
- 出勤: オフィス/テレワーク/外出で出勤を開始（または勤務中の切替）
- 休憩/外出: `toggleBreak` / `toggleOut` で開始/終了を切替
- 退勤: 退勤済に変更（退勤取消も同一ボタン）

## 勤務時間の計算
1. 勤務区間は `clock_in`〜`clock_out` を基準に計算  
   - `clock_out` が空の場合は「現在時刻」を終了時刻として計算
   - `clock_in` が無い場合は 0 分
2. `breaks` に格納された休憩区間（`start`/`end`）を勤務区間から除外
   - 休憩区間が 12:00-13:00 に重なる部分は「固定休憩」と二重控除しないように除外
3. 固定休憩時間を差し引き
   - ユーザーごとの `fixedBreakMinutes` を控除（未設定は 90 分）

最終的な勤務時間は以下で計算されます。
- `勤務時間 = (勤務区間合計 - 休憩区間合計) - 固定休憩(ユーザー設定)`

## 休憩の扱い
- 休憩は `breaks` 配列で管理されます（`start`/`end`）
- 休憩中・外出中の時間はプロジェクト/タスク投下時間としては扱いません（UI上のTipsより）

## 夜間勤務時間
夜間時間は以下の時間帯を合算して算出します。
- 0:00〜5:00
- 22:00〜24:00

## 月次集計（概算）
- 所定労働日は「祝日ICS」「会社休日ICS」および土日を除外して判定
- 所定労働時間（分）: `scheduledWorkMinutes * 所定労働日数`
  - `scheduledWorkMinutes` はユーザー設定（未設定は 450分）
- 残業/不足は所定労働時間との差分で算出

## ユーザーごとの勤務形態
以下を Users タブで設定できます（保存はユーザーレコードに格納）。
- `workType`: `standard` / `hourly` / `contractor` / `custom`
- `scheduledWorkMinutes`: 所定勤務時間（分、デフォルト 450）
- `fixedBreakMinutes`: 固定休憩時間（分、デフォルト 90）

## 表示対象ユーザー
以下のフラグで出勤状況の表示可否を制御します（未指定は表示）。
- `attendance_visible`
- `attendanceVisible`
- `showAttendance`

## 自動更新
- 出勤状況画面（`attendance`）のダッシュボード表示中のみ自動更新
- 更新間隔はUIの設定で変更可能
