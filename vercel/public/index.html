<!DOCTYPE html> 
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<base target="_top">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest" crossorigin="use-credentials">
<meta name="theme-color" content="#0ea5e9">
<title>PJバインダー</title>
<!-- Markdown + Mermaid (usage docs) -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
<style>
    /* ページ全体の横スクロールは殺して、横スクロールは各エリアで */
  html, body { overflow-x: hidden; }

  /* 念のため：ガントの外側では広がらないように */
  #gantt-container { overflow: hidden; }

  /* 横スクロールが見えるように（既存のクラスを活用） */
  .gantt-right.show-scrollbars,
  .gantt-head.show-scrollbars { max-width: 100%; overflow: auto; }
  /* 色ドット（一覧/プロジェクト表/カンバンで使用） */
  .color-swatch{
    display:inline-block; width:10px; height:10px; border-radius:50%;
    margin-right:6px; vertical-align:middle; box-shadow:0 0 0 1px rgba(0,0,0,.06) inset;
  }

  :root{
    --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --ink:#111827;
    --muted:#6b7280; --accent:#0ea5e9; --pill:#eef2ff; --pill-ink:#3730a3;
    --shadow: 0 1px 2px rgba(0,0,0,.05);

    /* Weekly schedule sheet-like colors */
    --weekly-name-bg: #dbeafe; /* light blue */
    --weekly-week-bg: #fef3c7; /* light yellow */
    --weekly-week-stripe: rgba(0,0,0,.05);

    /* Sticky UI offsets (fallbacks; JS will refine) */
    --header-h: 56px;
    --toolbar-h: 0px;
    --filters-h: 46px;
  }
  select { background-color: #fff; }
  html, body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; margin:0; background:var(--bg); color:var(--ink); }
  header {
      padding: 6px 6px;
      background: #0f172a;
      color: #fff;
      display: flex;
      gap: 8px 12px;
      align-items: center;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 30;
      width: 100%;
  }
  header > * { min-width: 0; }
  header h1{ display:flex; align-items:center; gap:8px; white-space:nowrap; }
  #tenant-label{
    display:inline-flex; align-items:center; gap:6px;
    padding:2px 8px; border-radius:999px; border:1px solid #334155;
    background:#1f2937; color:#e2e8f0; font-size:12px; font-weight:600;
  }
  .checkline{ display:flex; align-items:center; gap:6px; font-size:13px; }
  .checkline input[type="checkbox"]{ width:auto; }
  .toolbar{ flex-wrap: wrap; }
  nav { flex-wrap: wrap; }
  :root{
    /* 行の基本高さと上下パディング（お好みで調整） */
    --row-h: 44px;
    --cell-py: 6px;
  }

  /* 行高を揃える */
  #taskTable tbody tr,
  #projTable tbody tr{
    height: var(--row-h);
  }

  /* 上下パディングを揃える */
  #taskTable td, #taskTable th,
  #projTable td, #projTable th{
    padding-top: var(--cell-py);
    padding-bottom: var(--cell-py);
  }

  /* メモセル（行高固定・オーバーフローは中で処理） */
  td.cell-memo{
    position: relative;
    height: var(--row-h);
  }

  /* memo default editors */
  .memo-edit{
    display:block;
    box-sizing: border-box;
    width:100%;
    /* セルの上下パディングとボーダーを引いた高さに固定 */
    height: calc(var(--row-h) - var(--cell-py)*2 + 8px);
    min-height: 0;         /* “伸びる”余地をなくす */
    max-height: none;
    line-height: 1.35;
    font: inherit;
    padding:1px 6px;
    border:1px solid #d1d5db;
    border-radius:4px;
    resize: none;          /* ユーザー操作で伸ばさせない */
    overflow: auto;        /* 文字が増えたら中でスクロール */
    background: inherit;
  }


  header h1 { font-size:16px; margin:0; font-weight:700; }
  nav { display:flex; gap:8px; margin-left:auto; }
  nav button { background:#1f2937; border:1px solid #334155; }
  nav button.active { background:#0ea5e9; border-color:#0ea5e9; }
  .menu-bar{ background:#0f172a; border-bottom:1px solid #1f2937; padding:6px 6px; z-index:28; }
  .menu-bar nav{ display:flex; gap:8px; flex-wrap:wrap; margin-left:0; }
  .menu-bar.fixed.top{ position: sticky; top: var(--header-h); }
  .menu-bar.fixed.bottom{ position: fixed; bottom:0; left:0; right:0; }
  body.menu-bottom.menu-fixed{ padding-bottom: var(--menu-h, 0px); }
  .container { padding:16px; }
  .page { display:none; }
  .page.active { display:block; }
  .grid { display:grid; grid-template-columns: 360px 1fr; gap:16px; transition: grid-template-columns .2s ease; }
  .grid.collapsed-left { grid-template-columns: 44px 1fr; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow); position:relative; }
  .card h2 { font-size:14px; margin:0; padding:12px 12px 0; color:#111827; display:flex; align-items:center; justify-content:space-between; }
  .card .body { padding:12px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
  label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
  input, select, textarea { width:100%; border:1px solid #d1d5db; border-radius:8px; padding:8px; font-size:14px; background:#fff; }
  textarea { min-height: 120px; }
  button { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#111827; color:#fff; cursor:pointer; }
  button.secondary { background:#fff; color:#111827; }
  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { padding:8px; border-bottom:1px solid #f3f4f6; text-align:left; }
  th { color:#6b7280; font-weight:600; }

  /* Weekly table (gantt-like) */
  /* Make weekly page use full width (single column) */
  #page-weekly .weekly-grid { grid-template-columns: 1fr; }
  #page-weekly #weekly-users { padding: 0; }
  #page-weekly{ --wk-user-col: 170px; --wk-proj-col: 260px; }
  #page-weekly .wk-scopebar{ flex-wrap: nowrap !important; overflow-x: auto; gap: 8px; }
  #page-weekly .wk-scopebar > *{ flex: 0 0 auto; }
  #page-weekly .wk-scopebar select{ padding: 6px 8px; font-size: 13px; }
  #page-weekly .wk-scopebar input[type="date"]{ padding: 6px 8px; font-size: 13px; }
  #page-weekly .wk-scopebar button{ padding: 6px 10px; }
  #page-weekly h2{ color: var(--primary); }
  #page-weekly .wk-row-common td{ background: #f8fafc; }
  #page-weekly .wk-proj-common .wk-proj-name{ font-weight: 700; color: #1f2937; }
  #page-weekly .wk-proj.prio-high{ box-shadow: inset 4px 0 #ef4444; }
  #page-weekly .wk-proj.prio-mid { box-shadow: inset 4px 0 #f59e0b; }
  #page-weekly .wk-proj.prio-low { box-shadow: inset 4px 0 #10b981; }
  .wk-prio-badge{ display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border-radius:999px; border:1px solid rgba(17,24,39,.12); font-size:11px; color:#111827; background:#e5e7eb; }
  .wk-prio-badge.prio-high{ background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.35); color:#991b1b; }
  .wk-prio-badge.prio-mid { background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35); color:#92400e; }
  .wk-prio-badge.prio-low { background:rgba(16,185,129,.15); border-color:rgba(16,185,129,.35); color:#065f46; }
  #page-weekly .wk-scope-label{ display:flex; gap:6px; align-items:center; user-select:none; font-size:12px; color: var(--muted); }

  #weeklyTable { border-collapse: separate; border-spacing: 0; }
  #weeklyTable th, #weeklyTable td {
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    background: var(--card);
  }
  #weeklyTable th { position: sticky; top: 0; z-index: 4; }
  #weeklyTable .wk-sticky-1 { position: sticky; left: 0; z-index: 5; }
  #weeklyTable .wk-sticky-2 { position: sticky; left: var(--wk-user-col); z-index: 5; }
  #weeklyTable .wk-sticky-1 { background: var(--weekly-name-bg); }
  #weeklyTable .wk-sticky-2 { background: var(--card); }
  #weeklyTable .wk-sub { font-size: 12px; color: var(--muted); }
  #weeklyTable .wk-rowhead { min-width: var(--wk-user-col); width: var(--wk-user-col); max-width: var(--wk-user-col); }
  #weeklyTable .wk-proj { min-width: var(--wk-proj-col); }
  #weeklyTable .wk-week { min-width: 360px; }
  #weeklyTable .wk-user-name{ display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #weeklyTable .wk-proj-name{ font-size: 15px; font-weight: 700; }
  #weeklyTable .wk-proj-memo{ margin-top:6px; font-size:12px; color: #111827; white-space: pre-wrap; }
  #weeklyTable .wk-weekly-memo{
    color: #111827;
    font-family: "BIZ UDPGothic","BIZ UDGothic","Yu Gothic","Meiryo",sans-serif;
    height: auto;
    min-height: 56px;
    max-height: none;
    resize: vertical;
  }
  /* Week header: yellow hatched like spreadsheet */
  #weeklyTable thead th.wk-week{
    background:
      linear-gradient(var(--weekly-week-bg), var(--weekly-week-bg)),
      repeating-linear-gradient(135deg,
        var(--weekly-week-stripe) 0,
        var(--weekly-week-stripe) 2px,
        rgba(255,255,255,0) 2px,
        rgba(255,255,255,0) 7px
      );
  }
  /* Keep top-left sticky header readable */
  #weeklyTable thead th.wk-sticky-1{ background: var(--weekly-name-bg); }
  .pill { padding:2px 8px; font-size:12px; border-radius:999px; background:var(--pill); color:var(--pill-ink); }
  .muted { color:var(--muted); }
  .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .list { max-height: 600px; overflow:auto; }
  .tabs {
    display:flex;
    gap:8px;
    border-bottom:1px solid var(--border);
    margin-bottom:8px;
    position: sticky;
    top: calc(var(--header-h) + var(--toolbar-h));
    z-index: 58;
    background: var(--bg);
  }
  .tab { padding:8px 12px; border-radius:10px 10px 0 0; background:#e5e7eb; cursor:pointer; }
  .tab.active { background:var(--card); border:1px solid var(--border); border-bottom:1px solid var(--card); }
  .fac-gantt { border:1px solid var(--border); border-radius:10px; overflow:hidden; }
  .fac-gantt-head{ display:grid; grid-template-columns: 64px repeat(7,1fr); background:#f8fafc; border-bottom:1px solid var(--border); }
  .fac-gantt-head .cell{ padding:6px 8px; font-size:12px; color:var(--muted); border-right:1px solid var(--border); }
  .fac-gantt-body{ display:grid; grid-template-columns: 64px repeat(7,1fr); }
  .fac-gantt-timecol{ border-right:1px solid var(--border); background:#fff; }
  .fac-gantt-timecol .time{ height:48px; padding:2px 6px; font-size:11px; color:var(--muted); border-bottom:1px solid #f3f4f6; }
  .fac-day-col{ position:relative; height:768px; border-right:1px solid var(--border); background:
      repeating-linear-gradient(to bottom, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 48px); }
  .fac-day-col.today{ background:
      linear-gradient(rgba(14,165,233,.08), rgba(14,165,233,.08)),
      repeating-linear-gradient(to bottom, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 48px); }
  .fac-event{ position:absolute; left:4px; right:4px; border-radius:8px; padding:6px; color:#fff; font-size:11px; line-height:1.3; overflow:hidden; box-shadow: var(--shadow); box-sizing:border-box; }
  .fac-event .meta{ font-size:10px; opacity:.9; }
  #page-facility .facility-grid.single{ grid-template-columns: 1fr; }
  #page-facility .facility-panel{ display:none; }
  #page-facility .facility-panel.active{ display:block; }
  #page-facility .facility-tabs{ margin-bottom:10px; }
  #facility-gantt{ overflow-x:auto; width:100%; }
  #page-facility .facility-resv-grid{ display:grid; grid-template-columns: minmax(360px, 420px) minmax(0, 1fr); gap:16px; align-items:start; }
  #page-facility .facility-resv-grid > div{ min-width:0; }
  #page-facility .fac-gantt{ width:100%; }
  #page-facility .fac-gantt-head,
  #page-facility .fac-gantt-body{ min-width:100%; }
  @media (max-width: 1200px){
    #page-facility .facility-resv-grid{ grid-template-columns: 1fr; }
  }

  /* ===== Usage docs (Markdown) ===== */
  .md-docs-nav{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 10px 0; }
  .md-docs-nav button{ padding:6px 10px; border-radius: 8px; }
  .md-docs-nav button.active{ background: var(--accent); color: #fff; border-color: transparent; }
  .md-docs{ line-height: 1.75; }
  .md-docs h1, .md-docs h2, .md-docs h3{ margin: 0.8em 0 0.35em; }
  .md-docs pre{ overflow:auto; padding:10px; background: rgba(0,0,0,.04); border-radius: 10px; }
  .md-docs code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .md-docs table{ border-collapse: collapse; width:100%; }
  .md-docs th, .md-docs td{ border:1px solid var(--border); padding:6px 8px; }
  .kanban { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; min-height: 380px; }
  .col { background:#f9fafb; border:1px solid var(--border); border-radius:12px; padding:8px; min-height:320px; }
  .col h3 { font-size:13px; margin:0 0 8px 0; display:flex; justify-content:space-between; align-items:center; }
  .cardlet { background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px; margin:6px 0; box-shadow: var(--shadow); cursor:grab; font-size:12px; line-height:1.35; }
  .dropping { outline:2px dashed var(--accent); outline-offset:-4px; }
  .filters { display:grid; grid-template-columns: repeat(7, minmax(140px, 1fr)); gap:8px; margin-bottom:8px; }
  .filters.sticky { position: sticky; top: 56px; z-index: 25; border:1px solid var(--border); border-radius:10px; padding:8px; }
  .help { line-height:1.8; }
  @media (max-width: 1200px) {
    .grid { grid-template-columns: 1fr; }
    .row, .row-3 { grid-template-columns: 1fr; }
    .filters { grid-template-columns: 1fr 1fr; }
    .kanban { grid-template-columns: 1fr; }
  }
  .card--glass{
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(4px);
  }
  /* compact density */
  body { font-size: 14px; }
  .card { padding: 12px; border-radius: 10px; }
  .toolbar { gap: 8px; }
  button, .tab { padding: 6px 10px; border-radius: 8px; }
  input, select, textarea { padding: 6px 8px; }
  .filters > * { margin-right: 6px; }
  .cardlet { padding: 8px; }
  .pill { padding: 2px 6px; font-size: 12px; }

  /* 期限列（タスク一覧）を中央寄せ */
  #taskTable th:nth-child(1),
  #taskTable td.cell-due { text-align: center; }

  /* プロジェクト一覧の期間列は幅を抑えてメモ列を広く */
  #projTable th:nth-child(8),
  #projTable td:nth-child(8){
    width: 120px;
    max-width: 120px;
    white-space: nowrap;
  }

  /* gantt visibility guard */
  #view-gantt[style*="display:none"] { pointer-events:none; height:0; overflow:hidden; }



  /* Docsバッジ */
  .doc-badge{ margin-left:4px; cursor:pointer; opacity:.9; display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:12px; line-height:1.2; white-space:nowrap; }
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:20; display:none; align-items:center; justify-content:center; }
  .modal-panel{ background:var(--card); border-radius:12px; padding:16px; max-width:760px; width:calc(100% - 32px); box-shadow:0 10px 40px rgba(0,0,0,.25); max-height:80vh; overflow:auto; }
  .modal-panel h3{ margin-top:0; margin-bottom:8px; }
  .modal-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
  #updates-modal .modal-panel{ max-width:860px; }
  #updates-body{ font-family:'Segoe UI', sans-serif; font-size:13px; line-height:1.25; }
  #updates-modal .md-docs{ line-height:1.25; }
  #updates-modal .md-docs ul{ margin:4px 0 6px 18px; }
  #updates-modal .md-docs li{ margin:2px 0; }
  #updates-modal details{ margin:4px 0; }
  #updates-modal summary{ cursor:pointer; }
  #updates-modal details:not([open]) > *:not(summary){ display:none; }
  .att-modal-row{ display:grid; grid-template-columns: 1fr 1.2fr auto; gap:6px; align-items:center; margin-bottom:6px; }
  .att-modal-row input{ width:100%; }
  .att-modal-row button{ white-space:nowrap; }
  .doc-badge:hover{ opacity:1; transform: translateY(-1px); }

  /* ツールボタンの詰め */
  .toolbar .mini{ padding:4px 8px; font-size:12px; border-radius:6px; }
  /* ヘッダーロゴ */
  #brandmark{
    height:22px; margin-left:8px; object-fit:contain;
    opacity:.85; filter: invert(1) brightness(1.4) grayscale(1);
  }

  /* 左サイド（クイック追加）折りたたみ */
  #quick-panel { position: sticky; top: 64px; align-self:start; overflow:hidden; }
  #quick-panel.collapsed { width: 44px; padding: 8px 4px; }
  #quick-panel.collapsed h2 { writing-mode: vertical-rl; transform: rotate(180deg); margin:0; padding: 8px 0; font-size:12px; }
  #quick-panel.collapsed .body { display:none; }
  #qp-toggle { position:absolute; top:8px; right:8px; }
  /* Quick panel is kept for form bindings but hidden from the dashboard UI. */
  #page-dashboard #quick-panel{ display:none; }
  #page-dashboard #dashboard-grid{ grid-template-columns: 1fr; }
  #page-dashboard #dashboard-grid.collapsed-left{ grid-template-columns: 1fr; }

  /* ガントのスクロールバー（復活＋見やすく） */
  .show-scrollbars{ scrollbar-gutter: auto; }
  .show-scrollbars::-webkit-scrollbar{ height:10px; width:10px; }
  .show-scrollbars::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:6px; }
  .show-scrollbars::-webkit-scrollbar-track{ background: #f1f5f9; }

  /* 目的箇所の透明化（透かしを見せる） */
  .see-through{ background: rgba(255,255,255,.7) !important; backdrop-filter: blur(1px); }
  /* ▼NEW: 優先度の網掛け（一覧セル＋バッジ） */
  .cell-prio { text-align:center; }
  .cell-prio.prio-high { background: rgba(239,68,68,.12); }   /* 赤: 高 */
  .cell-prio.prio-mid  { background: rgba(234,179,8,.16); }   /* 黄: 中 */
  .cell-prio.prio-low  { background: rgba(34,197,94,.12); }   /* 緑: 低 */

  .prio-badge { border:1px solid transparent; }
  .prio-badge.prio-high { background: rgba(239,68,68,.18); color:#991b1b; border-color: rgba(239,68,68,.35); }
  .prio-badge.prio-mid  { background: rgba(234,179,8,.20); color:#854d0e; border-color: rgba(234,179,8,.35); }
  .prio-badge.prio-low  { background: rgba(34,197,94,.18); color:#065f46; border-color: rgba(34,197,94,.35); }
  /* ▼NEW: Grid 子の最小幅を 0 にして親幅を超えない */
  .grid > * { min-width: 0; }

  /* ▼NEW: ガントはカードの中だけで横スクロール */
  #gantt-container, .gantt-wrap, .gantt-head, .gantt-main, .gantt-right { max-width: 100%; }
  .gantt-right { overflow: auto; min-width: 0; }
  /* 添付のインライン行 */
  .att-row td { background: #fff; }
  .inline-attachments{ padding:8px 12px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; }
  .inline-attachments.slide{ overflow:hidden; max-height:0; transition:max-height .2s ease; }
  .inline-attachments.slide.open{ max-height:800px; }
  /* 日報一覧をグリッド横断で表示 */
  #page-daily #daily-list-card { grid-column: 1 / -1; }
  /* 検索ツールバーも固定（フィルタの直下に重ならない位置） */
  .toolbar.sticky-head {
    position: sticky;
    top: 102px;           /* header(約56px)+filters(約46px)の下に配置 */
    z-index: 24;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
  }
  /* inline edit controls */
  .inline-ctl { display:inline-flex; gap:6px; margin-left:6px; vertical-align:middle; }
  .inline-ctl button{ padding:2px 6px; font-size:12px; border-radius:6px; }
  .inline-ctl .ok { background:#10b981; border-color:#10b981; }
  .inline-ctl .ng { background:#ef4444; border-color:#ef4444; }
  .cell-flash { animation: flashBg 1.2s ease-out 1; }
  @keyframes flashBg { 0%{ background:#fef08a; } 100%{ background:transparent; } }

  /* toast */
  #toast-stack{ position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
  .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow: var(--shadow); max-width: 360px; }
  .toast.ok{ background:#065f46; }
  .toast.ng{ background:#7f1d1d; }
  /* aging colors */
  .age-3  { box-shadow: inset 0 0 0 2px rgba(234,179,8,.35); }   /* 3日超 黄色 */
  .age-7  { box-shadow: inset 0 0 0 2px rgba(249,115,22,.5); }   /* 7日超 橙 */
  .age-14 { box-shadow: inset 0 0 0 2px rgba(239,68,68,.6); }    /* 14日超 赤 */

  /* === Attendance UI (look recreation) === */
  /* ダッシュボード表示時はカードリストを全幅にする */
  #page-attendance.att-layout-dashboard .grid{ grid-template-columns: 1fr; }
  #att-cards{ display:flex; flex-direction:column; gap:4px; }
  .att-card{ padding: 6px 10px; border-radius: 10px; box-shadow: 0 1px 3px rgba(17, 24, 39, 0.04); }
  .att-card .body{ padding: 0; }
  .att-avatar{ width:22px; height:22px; border-radius:50%; background:#cbd5e1; flex: 0 0 auto; }
  .att-name{ font-weight:800; font-size:20px; line-height:1.05; }
  .att-role{ color:#6b7280; font-size:12px; line-height:1.05; margin-left:8px; }
  .att-status-pill{ margin-left:auto; padding:2px 6px; border-radius:999px; font-weight:800; font-size:11px; border:1px solid rgba(17,24,39,.08); background: rgba(255,255,255,.7); white-space:nowrap; }

  .att-line{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; background: rgba(255,255,255,.6); border-radius: 10px; padding: 6px; }
  .att-line + .att-line{ margin-top:4px; }
  .att-k{ color:#374151; font-size:12px; font-weight:700; white-space:nowrap; }
  .att-v{ color:#111827; font-size:12px; white-space:nowrap; }
  .att-person{ display:flex; align-items:baseline; gap:0; margin-right:6px; }
  .att-ctl{ padding:4px 8px; font-size:13px; border-radius:8px; width:auto; min-width: 120px; }
  .att-ctl.small{ min-width: 0; width: auto; }
  .att-ctl.wide{ min-width: 240px; max-width: 420px; }
  .att-actions{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .att-card button{ padding:6px 10px; border-radius:8px; }
  .att-muted{ color: var(--muted); font-size:12px; }
  .att-status-pill.tone-green{ background:#dcfce7; color:#166534; border-color: rgba(22,101,52,.25); }
  .att-status-pill.tone-yellow{ background:#fef3c7; color:#92400e; border-color: rgba(146,64,14,.25); }
  .att-status-pill.tone-red{ background:#fee2e2; color:#991b1b; border-color: rgba(153,27,27,.25); }
  .att-status-pill.tone-gray{ background:#e5e7eb; color:#374151; border-color: rgba(55,65,81,.20); }

  .att-card.card-state-working-office{ border-left: 6px solid #16a34a; background: #d1fae5; }
  .att-card.card-state-working-remote{ border-left: 6px solid #075985; background: #e0f2fe; }
  .att-card.card-state-event{ border-left: 6px solid #f59e0b; background: #fef3c7; }
  .att-card.card-state-done{ border-left: 6px solid #9ca3af; background: #e5e7eb; }
  .att-card.card-state-not-clocked{ border-left: 6px solid #ef4444; background: #fee2e2; }

  .att-card.card-state-working-office .row,
  .att-card.card-state-working-remote .row,
  .att-card.card-state-event .row,
  .att-card.card-state-done .row,
  .att-card.card-state-not-clocked .row{ background: rgba(255,255,255,.6); border-radius: 10px; padding: 6px; margin-bottom: 4px; }
  .att-card.is-busy { opacity: .6; pointer-events: none; }
  .wk-scopebar.sticky-wk{
    position: sticky;
    top: calc(var(--header-h) + 8px);
    z-index: 6;
    background: var(--bg);
    padding-top: 6px;
    padding-bottom: 6px;
    border-radius: 10px;
  }

  @media (max-width: 768px) {
    #page-attendance .grid { grid-template-columns: 1fr !important; }
    #page-attendance .att-actions {
      position: sticky;
      bottom: 0;
      background: var(--card);
      padding-top: 6px;
      padding-bottom: 6px;
      border-top: 1px solid var(--border);
      z-index: 6;
    }
  }

  /* 透かしより前面に出す対象を追加（header だけでなく toolbar も） */
  header, #global-toolbar, .container { position: relative; z-index: 1; }

  /* 画面上部に固定するツールバー */
  #global-toolbar.toolbar--global{
    position: sticky;
    top: var(--header-h);
    z-index: 29;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 6px 12px;
    display: flex;
    gap: 8px;
    align-items: center;
    box-shadow: var(--shadow);
  }


  /* スクロール固定UIのオフセット調整（ヘッダー＋ツールバー分を考慮） */
  .filters.sticky { top: calc(var(--header-h) + var(--toolbar-h)); }
  .toolbar.sticky-head { top: calc(var(--header-h) + var(--toolbar-h) + var(--filters-h)); }
  /* 透かしロゴ */
  #watermark{
    position: fixed;
    inset: 0;
    pointer-events: none;
    background-repeat: no-repeat;
    background-position: center 45%;
    background-size: var(--wm-size, 820px);
    opacity: var(--wm-opacity, 0.03);
    filter: grayscale(1);
    mix-blend-mode: normal;
    z-index: 999; /* 透かしを最前面に表示 */
  }
  /* 追加 */
  #view-board .kanban.is-swim{
    display:block;
    grid-template-columns: 1fr; /* 元の repeat(4,1fr) を無効化 */
    gap: 0;
  }
  #view-board .kanban.is-swim .lane-wrap{
    margin-bottom:12px;
  }
  /* ====== 重なり解消パッチ（最後に追記） ====== */


  /* ヘッダーは通常の sticky に（固定化の打ち消し） */
  header{
    position: sticky !important;
    top: 0;
    z-index: 60;          /* 透かしより前面に */
  }

  /* コンテンツは通常フローに戻す（固定化の打ち消し） */
  .container{
    position: relative !important;
    z-index: 1;
    /* 余白は既存の .container { padding:16px; } を活かすので追加不要 */
  }

  /* 左のクイックパネルのsticky位置もヘッダー高に合わせてずらす */
  #quick-panel{
    top: calc(var(--header-h) + 8px) !important;  /* 例：56px + 8px = 64px と同等 */
  }

  /* 念のため：スクロール時の固定UIの基準（アンカー/内部リンク用） */
  html{
    scroll-padding-top: calc(var(--header-h) + 8px);
  }
  /* bottom-right busy indicator */
  .busy{
    position: fixed; right:14px; bottom:14px;
    background:#111827; color:#fff;
    padding:8px 10px; border-radius:10px;
    box-shadow: var(--shadow); z-index: 1200;
    font-size: 13px;
  }
  .busy::before{ content:'? '; }
  /* select のプレイスホルダー表示用（値が空のとき） */
  select.is-placeholder { color: var(--muted); }
  /* === メモ全文表示のための自動高さパッチ === */

  /* 行：固定 height をやめ、min-height ベースに */
  #taskTable tbody tr,
  #projTable tbody tr{
    height: auto !important;
    min-height: var(--row-h);
  }

  /* メモセルも固定高さを解除 */
  td.cell-memo{
    height: auto !important;
    vertical-align: top;
  }

  /* メモのテキストエリアは内容に合わせて伸縮 */
  .memo-edit{
    display: block;
    width: 100%;
    box-sizing: border-box;

    /* 高さは自動、スクロールバーは基本出さない（scrollHeightで伸ばす） */
    height: max-content;
    min-height: 28px;        /* 1行ぶんの最低値だけ与える */
    max-height: none;
    overflow: hidden;        /* 中でスクロールさせず伸ばす */
    resize: none;            /* ユーザーの手動リサイズは無効 */

    /* 既存の見た目はそのまま維持 */
    line-height: 1.35;
    font: inherit;
    padding: 1px 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: inherit;
  }
/* ===== ツールチップ（data-tip属性で有効） ===== */
.tooltip-bubble{
  position: fixed;            /* ← viewport基準でマウス追随 */
  z-index: 20000;
  max-width: 280px;
  font-size: 12px;
  line-height: 1.5;
  background: #111827;
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  white-space: normal;
  pointer-events: none;
}

.tooltip-bubble::after{
  content:"";
  position:absolute;
  left: 12px;                 /* 矢印の基準位置（右寄せ時に切替） */
  bottom: -6px;               /* 通常は“上向き”の吹き出しにするので下辺に矢印 */
  border: 6px solid transparent;
  border-top-color: #111827;  /* 上向き矢印（バブルは上、矢印は下に出す） */
}

/* 画面右端で左寄せにフリップしたときの矢印 */
.tooltip-bubble.left::after{
  left: auto;
  right: 12px;
}

/* 画面上端で“下側に出す”ときの矢印 */
.tooltip-bubble.below::after{
  bottom: auto;
  top: -6px;
  border-top-color: transparent;
  border-bottom-color: #111827;
}


/* ===== 右下フローティングFAB ===== */
#fab-stack{
  position: fixed; right:16px; bottom:16px; z-index:1100;
  display:flex; flex-direction:column; gap:10px;
}
.fab-btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:12px 14px; border-radius:999px; border:1px solid #e5e7eb;
  background:#0ea5e9; color:#fff; font-weight:600; cursor:pointer;
  box-shadow: 0 6px 16px rgba(14,165,233,.35);
}
.fab-btn:active{ transform: translateY(1px); }

/* ===== フライアウト（右からスライド） ===== */
.flyout-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1099; display:none;
}
.flyout{
  position:fixed; top:0; right:-420px; width:420px; max-width:92vw; height:100%;
  background:var(--card); border-left:1px solid var(--border); box-shadow: -6px 0 20px rgba(0,0,0,.12);
  z-index:1101; display:flex; flex-direction:column; transition:right .24s ease;
}
.flyout.open{ right:0; }
.flyout header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px; background:#f8fafc; border-bottom:1px solid var(--border);
}
.flyout .content{ padding:12px; overflow:auto; }
.flyout .actions{ margin-top:auto; display:flex; gap:8px; justify-content:flex-end; padding:12px; border-top:1px solid var(--border); }
.flyout .hint{ font-size:12px; color:var(--muted); margin-top:4px; }
/* ▼ 追加：ツールチップの方位バリエーションと幅指定 */
.tooltip-bubble.bottom{ transform: translate(-50%, 6px); }
.tooltip-bubble.bottom::after{
  bottom:auto; top:-6px; border-top-color:transparent; border-bottom-color:#111827;
}
.tooltip-bubble.left{ left:auto; right:100%; transform: translate(-8px, -6px); }
.tooltip-bubble.left::after{
  left:auto; right:-6px; bottom:10px; border-top-color:transparent; border-left-color:#111827;
}
.tooltip-bubble.wide{ max-width: 420px; }
/* ツールチップの改行に対応（\nを<br>に変換するので余白を少し） */
.tooltip-bubble p{ margin:0; }
.tooltip-bubble p + p{ margin-top:6px; }

/* ▼ 追加：フライアウトの暗幕ON/OFF */
.flyout-mask.open{ display:block; }
body.flyout-open{ overflow:hidden; } /* 背景スクロール抑止 */
/* ======== Center Modal ======== */
#modal-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.28);
  display:none; align-items:center; justify-content:center; z-index:1300;
}
#modal{
  width:min(720px, 94vw); max-height:86vh; overflow:auto;
  background:#fff; border:1px solid var(--border); border-radius:14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.2);
}
#modal header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid var(--border); background:#f8fafc;
}
#modal .content{ padding:12px; }
#modal .close{
  border:none; background:transparent; color:#111827; font-size:18px; cursor:pointer;
}
/* リンク風の小ボタン */
button.link {
  background: transparent;
  border: none;
  padding: 4px 8px;
  cursor: pointer;
  text-decoration: underline;
  font: inherit;
}
button.link:hover { opacity: .8; }

</style>

</head>
<body>
  <div id="watermark"></div>
<header>
  <h1>
    <span id="tenant-label" style="display:none;"></span>
    PJバインダー
    <span id="app-version" class="muted" style="font-weight:500; margin-left:8px;"></span>
    <img id="brandmark" alt="" />
  </h1>

  <div class="toolbar" id="debug-bar" style="display:none"></div>
  <div class="muted" id="sheet-chip" style="display:none"></div>
  <div class="muted" id="debug-snapshot" style="display:none"></div>
  <div class="toolbar">
    <button class="secondary" onclick="refresh()">最新化</button>
    <button class="secondary" id="nav-help"    onclick="openUsageGuide('BEGINNER')">使い方</button>
    <button class="secondary" id="nav-updates" onclick="openUpdatesModal()">アップデート情報</button>
  </div>
</header>
<div id="menu-bar-top">
  <div id="menu-bar" class="menu-bar fixed top">
    <nav>
      <button class="active" id="nav-dashboard" onclick="goto('dashboard')" data-tip="タスク/プロジェクトの一覧・カンバン・ガント">ダッシュボード</button>
      <button id="nav-minutes" onclick="goto('minutes')" data-tip="議事録の作成とDocs連携">議事録</button>
      <button id="nav-daily"   onclick="goto('daily')" data-tip="日報の記録">日報</button>
      <button id="nav-weekly"  onclick="goto('weekly')" data-tip="週次の振り返り入力">週次</button>
      <button id="nav-attendance" onclick="goto('attendance')" data-tip="出退勤・休憩・外出の管理">出勤状況</button>
      <button id="nav-shared"  onclick="goto('shared')" data-tip="共有資料の登録と閲覧">共有資料</button>
      <button id="nav-users"   onclick="goto('users')" data-tip="ユーザー情報/所属の管理">ユーザー</button>
      <button id="nav-vault"   onclick="goto('vault')" data-tip="パスワード金庫の管理">パスワード金庫</button>
      <button id="nav-subs"    onclick="goto('subs')" data-tip="サブスクの登録と一覧">サブスク</button>
      <button id="nav-budget"  onclick="goto('budget')" data-tip="予算サマリと集計">予算</button>
      <button id="nav-ledger"  onclick="goto('ledger')" data-tip="入出金の登録・一覧">入出金</button>
      <button id="nav-projects" onclick="goto('projects')" data-tip="プロジェクト一覧と編集">プロジェクト</button>
      <button id="nav-facility" onclick="goto('facility')" data-tip="設備予約の登録とガント">設備予約</button>
      <button id="nav-workflow" onclick="goto('workflow')" data-tip="申請/承認の管理">決済申請</button>
      <button id="nav-settings" onclick="goto('settings')" data-tip="画面表示や操作の設定">設定</button>
      <button id="nav-debug"   onclick="goto('debug')" data-tip="診断・再同期">デバッグ</button>
    </nav>
  </div>
</div>

  <div id="toast-stack"></div>
  <!-- budget/subs/ledger/debug pages -->
    <section class="page" id="page-budget">
    <div class="grid">
      <div class="card">
        <h2>予算サマリ</h2>
        <div class="body" id="budget-summary"></div>
      </div>
      <div class="card">
        <h2>主担当者別 予算集計</h2>
        <div class="body">
          <table id="budget-by-owner"><thead><tr><th>主担当者</th><th>プロジェクト数</th><th>予算合計</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>
  <div id="busy-indicator" class="busy" aria-live="polite" style="display:none">⏳️Loading...</div>


  <section class="page" id="page-subs">
    <div class="grid">
      <div class="card">
        <h2>サブスク登録</h2>
        <div class="body">
          <input type="hidden" id="s_editing_id"/>
          <div class="row">
            <div><label>サービス名</label><input id="s_service"/></div>
            <div><label>ベンダー</label><input id="s_vendor"/></div>
          </div>
          <div class="row">
            <div><label>金額</label><input id="s_amount" type="number" min="0"/></div>
            <div><label>税込み？</label><select id="s_taxIncl"><option value="true">税込</option><option value="false">税抜</option></select></div>
          </div>
          <div class="row">
            <div><label>税率</label><input id="s_taxCode" placeholder="例: 10%"/></div>
            <div><label>勘定科目</label><input id="s_account" placeholder="例: サブスク費用"/></div>
          </div>
          <div class="row">
            <div><label>サイクル</label><select id="s_cycle"><option value="monthly">毎月</option><option value="quarterly">四半期</option><option value="yearly">毎年</option></select></div>
            <div><label>次回課金日</label><input id="s_nextBill" type="date"/></div>
          </div>
          <div class="row">
            <div><label>プロジェクト</label><select id="s_project"></select></div>
            <div><label>自動仕訳</label><select id="s_autoJournal"><option value="false">しない</option><option value="true">する</option></select></div>
          </div>
          <div class="row"><div><label>メモ</label><input id="s_memo"/></div></div>
          <div class="toolbar" style="margin-top:8px;"><button class="primary" onclick="addSubscription()">登録</button></div>
        </div>
      </div>
      <div class="card">
        <h2>サブスク一覧</h2>
        <div class="body">
          <table id="subsTable"><thead><tr><th>サービス</th><th>ベンダー</th><th>金額</th><th>サイクル</th><th>次回課金日</th><th>プロジェクト</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="page-projects">
    <div class="card">
      <h2>プロジェクト一覧（アクティブ＋完了）</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <input id="proj_f_keyword" placeholder="キーワード（名称/メモ）"/>
          <select id="proj_f_owner"></select>
          <select id="proj_f_priority">
            <option value="">全優先度</option>
            <option>高</option><option>中</option><option>低</option>
          </select>
          <select id="proj_f_status">
            <option value="">全ステータス</option>
            <option value="active">アクティブ</option>
            <option value="archived">完了</option>
          </select>
          <button class="secondary" onclick="clearProjectsFilters()">クリア</button>
          <button onclick="applyProjectsFilters()">フィルタ適用</button>
        </div>

        <div class="body list" style="padding:0;">
          <table id="projAllTable">
            <thead>
              <tr>
                <th>名称</th><th>ステータス</th><th>親</th><th>主担当者</th>
                <th>優先度</th><th>予算</th><th>期間</th>
                <th>未完了</th><th>完了</th><th>添付</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px;">「関連タスク」ボタンで、その場でタスク一覧をトグル表示できます。</div>
      </div>
    </div>
  </section>

  <section class="page" id="page-ledger">
    
    <div class="grid">
      <div class="card">
        <h2>入出金登録</h2>
        <div class="row">
          <div><label>名称</label><input id="l_title" placeholder="例: 7月 広告費"/></div>
          <div></div>
        </div>
        <div class="body">
          <div class="row">
            <div><label>日付</label><input id="l_date" type="date"/></div>
            <div><label>区分</label><select id="l_type"><option>income</option><option>expense</option></select></div>
          </div>
          <div class="row">
            <div><label>金額</label><input id="l_amount" type="number" min="0"/></div>
            <div><label>勘定科目</label><input id="l_account" placeholder="例: 広告費"/></div>
          </div>
          <div class="row">
            <div><label>相手先</label><input id="l_counterpart" placeholder="例: 〇〇株式会社"/></div>
            <div><label>プロジェクト</label><select id="l_project"></select></div>
          </div>
          <div class="row">
            <div><label>メモ</label><input id="l_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addLedgerEntry()">登録</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>定期入出金（RRULE）</h2>
        <div class="body">
          <div class="row">
            <div><label>名称</label><input id="lp_title" placeholder="例: 家賃/広告費月次 など"/></div>
            <div><label>区分</label><select id="lp_type"><option>income</option><option>expense</option></select></div>
          </div>
          <div class="row">
            <div><label>金額</label><input id="lp_amount" type="number" min="0"/></div>
            <div><label>勘定科目</label><input id="lp_account" placeholder="例: 地代家賃"/></div>
          </div>
          <div class="row">
            <div><label>相手先</label><input id="lp_counterpart"/></div>
            <div><label>プロジェクト</label><select id="lp_project"></select></div>
          </div>
          
  <div class="row">
    <div>
      <label>RRULE</label>
      <div style="display:flex; gap:6px; align-items:center;">
        <select id="lp_rrule_mode">
          <option value="">（選択）</option>
          <option value="DAILY">毎日</option>
          <option value="WEEKLY">毎週</option>
          <option value="BIWEEKLY">隔週</option>
          <option value="MONTHLY">毎月</option>
          <option value="BIMONTHLY">隔月</option>
          <option value="QUARTERLY">四半期</option>
          <option value="YEARLY">毎年</option>
        </select>
        <input id="lp_rrule" placeholder="FREQ=MONTHLY;INTERVAL=1;BYMONTHDAY=25" style="flex:1;"/>
      </div>
      <div class="muted" style="font-size:11px; margin-top:4px;">ドロップダウンで自動入力／手動編集も可</div>
    </div>
    <div><label>次回発生日（初期）</label><input id="lp_next" type="date"/></div>
  </div>

          <div class="row">
            <div><label>メモ</label><input id="lp_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addLedgerPlan()">定期登録</button>
          </div>

          <hr/>
          <table id="ledgerPlanTable">
            <thead><tr><th>名称</th><th>区分</th><th>金額</th><th>RRULE</th><th>次回</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>入出金一覧（最新50件）</h2>
        <div class="body list" style="padding:0;">
          <table id="ledgerTableFull">
            <thead>
              <tr>
                <th>日付</th><th>種別</th><th>区分</th><th>名称</th><th>金額</th>
                <th>科目</th><th>相手先</th><th>プロジェクト</th><th>メモ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="page" id="page-facility">
    <div class="tabs facility-tabs" id="facility-tabs">
      <div class="tab active" data-tab="reservations" onclick="setFacilityTab('reservations')">予約</div>
      <div class="tab" data-tab="assets" onclick="setFacilityTab('assets')">設備一覧</div>
    </div>
    <div class="grid facility-grid" id="facility-grid">
      <div class="card facility-panel" data-facility-tab="assets">
        <h2>設備一覧</h2>
        <div class="body">
          <input type="hidden" id="fa_editing_id"/>
          <div class="row">
            <div><label>設備名</label><input id="fa_name" placeholder="例: 会議室A"/></div>
            <div><label>色</label><input id="fa_color" type="color" value="#60a5fa"/></div>
          </div>
          <div class="row">
            <div><label>表示順</label><input id="fa_sort" type="number" placeholder="例: 10"/></div>
            <div><label>有効</label>
              <select id="fa_active">
                <option value="true">有効</option>
                <option value="false">無効</option>
              </select>
            </div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addFacilityAsset()">登録</button>
            <button class="secondary" onclick="resetFacilityAssetForm()">クリア</button>
          </div>
          <div class="body list" style="padding:0; margin-top:10px;">
            <table id="facilityAssetTable">
              <thead><tr><th>色</th><th>設備名</th><th>表示順</th><th>有効</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card facility-panel active" data-facility-tab="reservations">
        <h2>設備予約</h2>
        <div class="body facility-resv-grid">
          <div>
          <input type="hidden" id="fac_editing_id"/>
          <div class="row">
            <div><label>設備名</label><select id="fac_facility"></select></div>
            <div><label>予約名</label><input id="fac_title" placeholder="例: 定例MTG"/></div>
          </div>
          <div class="row">
            <div><label>予約者</label><select id="fac_user"></select></div>
            <div></div>
          </div>
          <div class="row">
            <div><label>開始日</label><input id="fac_start_date" type="date"/></div>
            <div><label>終了日</label><input id="fac_end_date" type="date"/></div>
          </div>
          <div class="row">
            <div><label>開始時刻</label><input id="fac_start_time" type="time" step="900"/></div>
            <div><label>終了時刻</label><input id="fac_end_time" type="time" step="900"/></div>
          </div>
          <div class="row">
            <div><label>場所</label><input id="fac_location" placeholder="例: 本社事務所"/></div>
            <div><label>プロジェクト</label><select id="fac_project"></select></div>
          </div>
          <div class="row">
            <div><label>メモ</label><input id="fac_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addFacilityReservation()">登録</button>
            <button class="secondary" onclick="resetFacilityForm()">クリア</button>
          </div>
          </div>
          <div>
            <div class="card" style="margin:0 0 12px 0;">
              <div class="body">
                <div class="toolbar" style="gap:8px; margin-bottom:8px;">
                  <button class="secondary" onclick="shiftFacilityWeek(-7)">←前週</button>
                  <input id="fac_week_start" type="date"/>
                  <button class="secondary" onclick="shiftFacilityWeek(7)">次週→</button>
                  <button class="secondary" onclick="setFacilityWeekToday()">今週</button>
                  <button onclick="renderFacilityGantt()">更新</button>
                </div>
                <div id="facility-gantt"></div>
              </div>
            </div>
            <div class="card" style="margin:0;">
              <h2>今日の予約一覧</h2>
              <div class="body">
                <table id="facilityTable">
                  <thead>
                    <tr>
                      <th>期間</th><th>設備</th><th>場所</th><th>予約名</th><th>予約者</th><th>プロジェクト</th><th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <section class="page" id="page-workflow">
    <div class="grid">
      <div class="card">
        <h2>決済申請申請</h2>
        <div class="body">
          <input type="hidden" id="wf_editing_id"/>
          <div class="row">
            <div><label>件名</label><input id="wf_title" placeholder="例: 1月 サーバー費"/></div>
            <div><label>申請者</label><select id="wf_requester"></select></div>
          </div>
          <div class="row">
            <div><label>金額</label><input id="wf_amount" type="number" min="0"/></div>
            <div><label>支払期日</label><input id="wf_due" type="date"/></div>
          </div>
          <div class="row">
            <div><label>相手先</label><input id="wf_vendor" placeholder="例: 〇〇株式会社"/></div>
            <div><label>勘定科目</label><input id="wf_account" placeholder="例: 広告費"/></div>
          </div>
          <div class="row">
            <div><label>プロジェクト</label><select id="wf_project"></select></div>
            <div><label>ステータス</label>
              <select id="wf_status">
                <option value="draft">下書き</option>
                <option value="pending">申請中</option>
                <option value="approved">承認</option>
                <option value="rejected">却下</option>
                <option value="paid">支払済</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>承認ルート（順番）</label>
              <select id="wf_approvers" multiple size="4"></select>
            </div>
            <div><label>メモ</label><input id="wf_memo"/></div>
            <div></div>
          </div>
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="addWorkflowRequest()">登録</button>
            <button class="secondary" onclick="resetWorkflowForm()">クリア</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>申請一覧（承認履歴）</h2>
        <div class="body">
          <table id="workflowTable">
            <thead>
              <tr>
                <th>件名</th><th>金額</th><th>申請者</th><th>承認ルート</th><th>支払期日</th><th>ステータス</th><th>履歴</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="page-settings" class="page">
    <div class="card">
      <h2>設定</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>表示密度</label>
            <select id="set_density">
              <option value="standard">標準</option>
              <option value="compact">コンパクト</option>
              <option value="relaxed">ゆったり</option>
            </select>
          </div>
          <div>
            <label>ダッシュボード既定ビュー</label>
            <select id="set_dashboard_view">
              <option value="list">一覧</option>
              <option value="board">カンバン</option>
              <option value="gantt">ガント</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>ガント既定スケール</label>
            <select id="set_gantt_scale">
              <option value="day">日単位</option>
              <option value="week">週単位</option>
              <option value="month">月単位</option>
            </select>
          </div>
          <div>
            <label>メニューバー位置</label>
            <select id="set_menu_position">
              <option value="top">上部</option>
              <option value="bottom">下部</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label class="checkline"><input type="checkbox" id="set_menu_fixed">メニューバーを固定表示</label></div>
          <div></div>
        </div>
        <div class="row">
          <div><label class="checkline"><input type="checkbox" id="set_show_watermark">透かしロゴを表示</label></div>
          <div><label class="checkline"><input type="checkbox" id="set_show_tooltips">ツールチップを表示</label></div>
        </div>
        <div class="row">
          <div>
            <label>透かしロゴの透明度</label>
            <input id="set_watermark_opacity" type="number" min="0" max="0.2" step="0.01" placeholder="例: 0.03"/>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div><label class="checkline"><input type="checkbox" id="set_show_fab">右下の追加ボタンを表示</label></div>
          <div></div>
        </div>
        <div class="toolbar" style="justify-content:flex-end; margin-top:8px;">
          <button onclick="saveAppSettings()">保存</button>
          <button class="secondary" onclick="resetAppSettings()">初期化</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>テナント設定（Supabase）</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>キー</label>
            <input id="ts_key" placeholder="例: DAILY_TEMPLATE_ID"/>
          </div>
          <div>
            <label>値</label>
            <input id="ts_value" placeholder="例: 1u_..."/>
          </div>
        </div>
        <div class="toolbar" style="justify-content:flex-end; margin-top:8px;">
          <input type="hidden" id="ts_editing_key"/>
          <button onclick="saveTenantSetting()">保存</button>
          <button class="secondary" onclick="resetTenantSettingForm()">クリア</button>
          <button class="secondary" onclick="loadTenantSettings()">再読み込み</button>
        </div>
        <div class="body list" style="padding:0; margin-top:8px;">
          <table id="tenantSettingsTable">
            <thead><tr><th>キー</th><th>値</th><th>更新日</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="page-debug" class="page">
    <div class="card">
      <h2>診断（Diagnostics）</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap;">
          <button onclick="runDiagnostics()">情報収集</button>
          <button class="secondary" onclick="forceResync()">強制再同期（Users/Projects）</button>
          <button class="secondary" onclick="refresh()">データ再取得</button>
          <button class="secondary" onclick="renderAll()">再レンダリング</button>
        </div>
        <div class="row">
          <div><label>接続先シート</label><pre id="dbg_sheet"></pre></div>
          <div><label>カウント（サーバ/クライアント）</label><pre id="dbg_counts"></pre></div>
        </div>
        <div class="row">
          <div><label>Users（先頭5行）</label><pre id="dbg_users" style="max-height:220px; overflow:auto;"></pre></div>
          <div><label>Projects（先頭5行）</label><pre id="dbg_projects" style="max-height:220px; overflow:auto;"></pre></div>
        </div>
        <div><label>getAllDataプレビュー</label><pre id="dbg_all" style="max-height:300px; overflow:auto;"></pre></div>
        <div><label>ログ</label><pre id="dbg_log" style="white-space:pre-wrap; background:#111827; color:#e5e7eb; padding:8px; border-radius:8px; max-height:240px; overflow:auto;"></pre></div>
      </div>
    </div>
  </section>
  <!-- 最近の更新（最大10件） -->
  <div class="card see-through" id="updates-panel" style="display:none;">
    <details>
      <summary style="cursor:pointer; font-weight:600;">最近の更新</summary>
      <div class="body" id="updates-feed" style="margin-top:8px;"></div>
    </details>
  </div>
  

  <!-- DASHBOARD -->
  <section class="page active" id="page-dashboard">
    <div class="grid" id="dashboard-grid">
      <!-- 左サイド：クイック追加（折りたたみ対応） -->
      <div class="card" id="quick-panel" data-disabled="1">
        <h2>
          クイック追加
          <button id="qp-toggle" class="secondary mini" onclick="toggleQuickPanel()" title="折りたたみ/展開">?</button>
          <button class="secondary mini" onclick="openUsageGuide('BEGINNER')" title="使い方">？</button>
        </h2>
        <div class="body">
          <!-- Projects -->
          <div class="row">
            <button class="secondary" onclick="openUsageGuide()">使い方</button>
            <div>
              <label>プロジェクト名</label>
              <input type="hidden" id="p_editing_id"/>
              <input id="p_name" placeholder="例: 2025上期 新製品A"/>
            </div>
            <div>
              <label>親プロジェクト（任意）</label>
              <select id="p_parent_select"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>主担当者（Users）</label>
              <select id="p_owner_select"></select>
            </div>
            <div>
              <label>プロジェクト優先度</label>
              <select id="p_priority"><option value="">-</option><option>高</option><option>中</option><option>低</option></select>
            </div>
            <div class="row">
              <div>
                <label>カラー</label>
                <input id="p_color" type="color" value="#ffffff"/>
              </div>
              <div><label>予算（円）</label><input id="p_budget" type="number"/></div>
              <div></div>
            </div>

          </div>
          <div class="row">
            <div><label>開始日</label><input id="p_start" type="date"/></div>
            <div><label>終了日</label><input id="p_end" type="date"/></div>
          </div>
          <div class="row">
            <div>
              <label>プロジェクトメモ（テキスト）</label>
              <textarea id="p_memo"></textarea>
            </div>
            <div>
              <label>Googleドキュメント連携</label>
              <div class="toolbar">
                <button class="secondary" onclick="openUsageGuide()">使い方</button>
                <button onclick="openProjectDoc()">Docsを開く</button>
                <button class="secondary" onclick="openAttachDialog('project')">📎添付</button>
              </div>
              <div class="muted" id="p_doc_status">未作成</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="secondary" id="btn_reset_project" onclick="resetProjectForm()">新規モードへ切替</button>
            <button id="btn_add_project" onclick="addProject()">プロジェクト追加</button>
          </div>


          <hr/>
          <!-- Tasks -->
          <div class="row">
            <button class="secondary" onclick="openUsageGuide()">使い方</button>
            <div>
              <label>タスク名</label>
              <input type="hidden" id="t_editing_id"/>
              <input id="t_title" placeholder="例: 取説ドラフト"/>
            </div>
            <div>
              <label>プロジェクト</label>
              <select id="t_project_select"></select>
            </div>
          </div>
          <div class="row">
            <div><label>種別</label>
              <select id="t_type">
                <option value="single">単発</option>
                <option value="recurring">定期</option>
              </select>
            </div>
            <div><label>期限</label><input id="t_due" type="date"/></div>
          </div>
          <div class="row">
            <div>
              <label>主担当者（Users）</label>
              <select id="t_owner_select"></select>
            </div>
            <div>
              <label>担当者（複数選択可）</label>
              <select id="t_assignees_select" multiple="" size="3"></select>
            </div>
          </div>
          
<div class="row">
  <div>
    <label>優先度</label>
    <select id="t_prio">
      <option value="">-</option>
      <option>高</option><option>中</option><option>低</option>
    </select>
  </div>
  <div>
    <label>RRULE（定期の場合）</label>
    <div style="display:flex; gap:6px; align-items:center;">
      <select id="t_rrule_mode">
        <option value="">（選択）</option>
        <option value="DAILY">毎日</option>
        <option value="WEEKLY">毎週</option>
        <option value="BIWEEKLY">隔週</option>
        <option value="MONTHLY">毎月</option>
        <option value="BIMONTHLY">隔月</option>
        <option value="QUARTERLY">四半期</option>
        <option value="YEARLY">毎年</option>
      </select>
    </div>
  </div>
</div>

          <div class="row">
            <div>
              <label>カラー</label>
              <input id="t_color" type="color" value="#ffffff"/>
            </div>
            <div></div>
          </div>
          <div class="row">
            <div>
              <label>タスクメモ（テキスト）</label>
              <textarea id="t_memo"></textarea>
            </div>
            <div>
              <label>Googleドキュメント連携</label>
              <div class="toolbar">

                <button onclick="openTaskDoc()">Docsを開く</button>
                <button class="secondary" onclick="openAttachDialog('task')">📎添付</button>
              </div>
              <div class="muted" id="t_doc_status">未作成</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="secondary" id="btn_reset_task" onclick="resetTaskForm()">新規モードへ切替</button>
            <button id="btn_add_task" onclick="addTask()">タスク追加</button>
          </div>

        </div>
      </div>

      <div class="card card--glass" id="main-work-card">
        <div class="body">
          <div class="tabs">
            <div class="tab active" id="tab-list"  onclick="switchTab('list')">タスク一覧</div>
            <div class="tab"          id="tab-board" onclick="switchTab('board')">カンバン</div>
            <div class="tab"          id="tab-gantt" onclick="switchTab('gantt')">ガント</div>
          </div>

          <div class="filters sticky see-through">
            <input id="f_keyword" placeholder="キーワード（タイトル/メモ等）" aria-label="キーワード検索"/>
            <select id="f_project" aria-label="プロジェクト絞り込み"></select>
            <select id="f_assignee" aria-label="担当者絞り込み"></select>
            <select id="f_department" aria-label="部署絞り込み"></select>
            <div><label class="muted">期限(From)</label><input id="f_from" type="date" aria-label="期限From"/></div>
            <div><label class="muted">期限(To)</label><input id="f_to" type="date" aria-label="期限To"/></div>
            <div>
              <label class="muted">優先度</label>
              <select id="f_priority" aria-label="優先度絞り込み">
                <option value="">全優先度</option>
                <option>高</option><option>中</option><option>低</option>
              </select>
            </div>
          </div>
          <div class="toolbar sticky-head" style="justify-content:flex-end; margin-bottom:8px;">
            <div class="toolbar" style="justify-content:flex-end; margin-bottom:8px;">
              <select id="f_status">
                <option value="">全ステータス</option>
                <option value="todo">未着手</option>
                <option value="doing">進行中</option>
                <option value="blocked">保留中</option>
                <option value="done">完了</option>
                <option value="notdone">完了以外</option>
              </select>
              <button class="secondary" onclick="clearFilters()">クリア</button>
              <button onclick="applyFilters()">フィルタ適用</button>
              <button class="secondary" onclick="quickOverdue()">遅延</button>
              <button class="secondary mini" onclick="exportCSV('tasks')">CSV(Tasks)</button>
              <button class="secondary mini" onclick="exportCSV('projects')">CSV(Projects)</button>
            </div>
          </div>
          <!-- 一覧 -->
          <div id="view-list">
            <div class="body list see-through" style="padding:0;">
              <table id="taskTable">
                <thead>
                  <tr>
                    <th>期限</th><th>タイトル</th><th>担当</th><th>優先度</th><th>状態</th><th>メモ</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- カンバン -->
          <div id="view-board" style="display:none;">
            <div class="toolbar" style="margin-bottom:8px;">
              <label><input type="checkbox" id="opt_swimlane" onchange="renderKanban()"> 担当者別スイムレーン</label>
            </div>
            <div class="kanban">
              <div class="col see-through" data-status="todo" ondragover="allowDrop(event)" ondrop="onDrop(event, 'todo')">
                <h3>未着手 <span class="muted" id="cnt_todo">0</span></h3>
                <div id="col_todo"></div>
              </div>
              <div class="col see-through" data-status="doing" ondragover="allowDrop(event)" ondrop="onDrop(event, 'doing')">
                <h3>進行中 <span class="muted" id="cnt_doing">0</span></h3>
                <div id="col_doing"></div>
              </div>
              <div class="col see-through" data-status="blocked" ondragover="allowDrop(event)" ondrop="onDrop(event, 'blocked')">
                <h3>保留中 <span class="muted" id="cnt_blocked">0</span></h3>
                <div id="col_blocked"></div>
              </div>
              <div class="col see-through" data-status="done" ondragover="allowDrop(event)" ondrop="onDrop(event, 'done')">
                <h3>完了 <span class="muted" id="cnt_done">0</span></h3>
                <div id="col_done"></div>
              </div>
            </div>
          </div>

          <!-- ガント -->
          <div id="view-gantt" style="display:none;">
            <div class="toolbar" style="margin:6px 0;">
              <label class="muted" style="margin-right:6px;">スケール</label>
              <select id="gantt-scale-mode" onchange="setGanttScale(this.value)" style="margin-right:8px;">
                <option value="day">日単位</option>
                <option value="week">週単位</option>
                <option value="month">月単位</option>
              </select>
              <label class="muted" style="margin:0 6px 0 12px;">表示範囲</label>
              <input id="gantt-start" type="date"/> <span class="muted">?</span> <input id="gantt-end" type="date"/>
              <button class="secondary" onclick="applyGanttRange()">適用</button>
            </div>
            <div id="gantt-container"></div>
          </div>

          <hr/>
          <h2>プロジェクト一覧</h2>
          <div class="body list see-through" style="padding:0;">
            <table id="projTable">
              <thead><tr>
                <th>名称</th><th>親</th><th>主担当者</th><th>優先度</th>
                <th>タスク(未/完)</th>  <!-- ← 追加 -->
                <th>メモ</th>
                <th>予算</th><th>期間</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>サブスク一覧</h2>
        <div class="body list">
          <table id="subTable">
            <thead><tr><th>次回請求日</th><th>サービス</th><th>金額</th><th>サイクル</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>入出金（最新20件）</h2>
        <div class="body list">
          <table id="ledTable">
            <thead><tr><th>日付</th><th>種別</th><th>区分</th><th>名称</th><th>金額</th><th>科目</th><th>相手先</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <!-- USERS -->
  <section class="page" id="page-users">
    <div class="card">
      <h2>ユーザー追加</h2>
      <div class="body">
        <div class="row">
          <div><label>氏名</label><input id="u_name"/></div>
          <div><label>メール</label><input id="u_email"/></div>
        </div>
        <div class="row">
          <div><label>ロール</label>
            <select id="u_role"><option>一般</option><option>主担当者</option><option>管理者</option></select>
          </div>
          <div><label>所属</label><input id="u_dept"/></div>
        </div>
        <div class="row-3">
          <div><label>勤務形態</label>
            <select id="u_work_type">
              <option value="standard">所定勤務（7時間30分）</option>
              <option value="hourly">時給制</option>
              <option value="contractor">委託</option>
              <option value="custom">カスタム</option>
            </select>
          </div>
          <div><label>所定勤務時間（分）</label><input id="u_work_minutes" type="number" min="0" placeholder="例: 450" value="450"/></div>
          <div><label>固定休憩（分）</label><input id="u_break_minutes" type="number" min="0" placeholder="例: 90" value="90"/></div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button onclick="addUser()">ユーザー追加</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ユーザー一覧</h2>
      <div class="body list">
        <table id="userTable">
          <thead><tr><th>氏名</th><th>メール</th><th>ロール</th><th>所属</th><th>勤務形態</th><th>所定(分)</th><th>休憩(分)</th><th>出勤状況に表示</th><th>freee従業員番号</th><th>個人カレンダー(ICS)</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- VAULT (Credentials) -->
  <section class="page" id="page-vault">
    <div class="card">
      <h2>認証情報（金庫）? パスワードは<b>ブラウザ側で暗号化</b>して保存</h2>
      <div class="body">
        <div class="muted" style="margin-bottom:8px;">
          パスワードの平文保存は危険です。本機能は <b>クライアント側AES-GCM暗号</b>で暗号化した文字列のみを保存します。<br/>
          復号に使う<b>パスフレーズはサーバに保存しません</b>。社内で共有する場合は、パスフレーズの管理にご注意ください。
        </div>
        <div class="row">
          <div><label>サービス名</label><input id="c_service"/></div>
          <div><label>URL</label><input id="c_url" placeholder="https://..."/></div>
        </div>
        <div class="row">
          <div><label>ログインID</label><input id="c_login"/></div>
          <div><label>パスワード</label><input id="c_password" type="password"/></div>
        </div>
        <div class="row">
          <div><label>登録者（Users）</label><select id="c_owner"></select></div>
          <div><label>備考</label><input id="c_note"/></div>
        </div>
        <div class="row">
          <div><label>暗号化パスフレーズ</label><input id="c_passphrase" placeholder="保存時・復号時に使用" type="password"/></div>
          <div></div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button onclick="addCredential()">保存（暗号化）</button>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>認証情報一覧</h2>
      <div class="body list">
        <table id="credTable">
          <thead><tr><th>サービス</th><th>URL</th><th>ログインID</th><th>パスワード</th><th>登録者</th><th>備考</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section class="page help" id="page-help">
    <div class="card">
    </div>
  </section>
  <section class="page" id="page-shared">
    <div class="grid">
      <div class="card">
        <h2>共有資料を登録</h2>
        <div class="body">
          <div class="row">
            <div><label>名称</label><input id="sh_name" placeholder="例: 社内規程"/></div>
            <div><label>カテゴリ</label><input id="sh_category" placeholder="例: 規程/テンプレ/資料"/></div>
          </div>
          <div class="row">
            <div><label>オーナー（Users）</label><select id="sh_owner"></select></div>
            <div><label>タグ（カンマ区切り）</label><input id="sh_tags" placeholder="例: 規程,労務"/></div>
          </div>
          <div class="row">
            <div><label>カラー</label><input id="sh_color" type="color" value="#ffffff"/></div>
            <div></div>
          </div>
          <div class="row">
            <div><label>メモ</label><textarea id="sh_memo"></textarea></div>
            <div>
              <label>添付URL</label>
              <div class="toolbar">
                <button class="secondary" onclick="openAttachDialog('shared')">📎添付</button>
              </div>
              <div class="muted">Drive/URL を登録（Docs自動作成はありません）</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <input type="hidden" id="sh_editing_id"/>
            <button class="secondary" onclick="resetSharedForm()">新規モードへ切替</button>
            <button onclick="addShared()">共有資料追加</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>共有資料一覧</h2>
        <div class="body list" style="padding:0;">
          <table id="sharedTable">
            <thead>
              <tr>
                <th>名称</th><th>カテゴリ</th><th>オーナー</th><th>タグ</th><th>添付</th><th>状態</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px;">📎アイコンで添付のインライン一覧をトグル表示できます。</div>
      </div>
    </div>
  </section>

  <section class="page" id="page-minutes">
    <div class="grid">
      <div class="card">
        <h2>議事録を登録</h2>
        <div class="body">
          <div class="row">
            <div><label>日付</label><input id="m_date" type="date"/></div>
            <div><label>件名</label><input id="m_title" placeholder="会議名など"/></div>
          </div>
          <div class="row">
            <div><label>プロジェクト</label><select id="m_project" data-tip="プロジェクトを指定すると、自動でプロジェクトの添付URLに追加されます"></select></div>
            <div><label>関連タスク（複数選択可）</label>
              <select id="m_tasks" multiple size="5" style="min-height:110px;"></select>
            </div>

          </div>
          <div class="row">
            <div><label>参加者（カンマ区切り可）</label><input id="m_attendees" placeholder="山田, 田中"/></div>
            <div></div>
          </div>
          <div class="toolbar">
            <button class="secondary" onclick="createMinuteDocFromForm()">登録(Docs自動作成)</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>議事録一覧</h2>
        <div class="body list">
          <table id="minutesTable">
            <thead><tr><th>日付</th><th>件名</th><th>プロジェクト/タスク</th><th>参加者</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
</section>

<section class="page" id="page-daily">
  <div class="grid">
    <div class="card">
      <h2>日報を登録</h2>
      <div class="body">
        <div class="row">
          <div><label>日付</label><input id="dr_date" type="date"/></div>
          <div><label>ユーザー</label><select id="dr_user"></select></div>
        </div>
        
        <div class="toolbar">
          <button onclick="createDailyReportDocFromForm()">登録</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>日報カレンダー</h2>
      <div class="body">
        <div class="toolbar" style="margin-bottom:8px;">
          <input type="month" id="dr_month"/>
          <select id="dr_user_filter"></select>
          <button class="secondary" onclick="renderDailyCalendar()">更新</button>
        </div>
        <div id="daily-calendar"></div>
      </div>
    </div>

    <div class="card" id="daily-list-card">
      <h2>日報一覧</h2>
      
      <div class="body list">
        <table id="dailyTable">
          <thead><tr><th>日付</th><th>ユーザー</th><th>工数</th><th>内容</th><th>プロジェクト/タスク</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<section class="page" id="page-weekly">
  <div class="grid weekly-grid">
    <div class="card">
      <h2>週次進捗</h2>
      <div class="body">
        <div class="toolbar" style="flex-direction:column; align-items:stretch; gap:6px;">
          <div class="toolbar wk-scopebar sticky-wk">
            <button class="secondary" onclick="shiftWeekly(-7)">←前週</button>
            <input id="wk_start"  style="width:120px;" type="date" />
            <button class="secondary" onclick="shiftWeekly(7)">次週→</button>
            <button class="secondary" onclick="setWeeklyToday()">今週</button>
            <button onclick="loadWeekly()">更新</button>

            <span style="width:12px;"></span>
            <label class="wk-scope-label">
              <span>所属</span>
              <select id="wk_filter_dept" style="max-width:180px;"></select>
            </label>
            <label class="wk-scope-label">
              <span>ユーザー</span>
              <select id="wk_filter_user" style="max-width:220px;"></select>
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>メンバー×プロジェクト×週（前週 / 今週 / 次週）</h2>
      <div class="body" id="weekly-users" style="overflow:auto;"></div>
    </div>
  </div>
</section>

<section class="page" id="page-attendance">
  <div class="tabs" style="margin-bottom:8px;">
    <div class="tab active" id="att-view-tab-dashboard" onclick="setAttendanceView('dashboard')">ダッシュボード</div>
    <div class="tab" id="att-view-tab-summary" onclick="setAttendanceView('summary')">サマリ（月/週）</div>
  </div>
  <div class="grid">
    <div class="card" data-att-view="dashboard">
      <h2>出勤状況（今日） <span class="muted" id="att-today-label"></span></h2>
      <div class="body">
        <div id="att-auto-warning" class="muted" style="display:none;color:#b45309;background:#fef3c7;border:1px solid #f59e0b;padding:6px 8px;border-radius:8px;margin-bottom:8px;">
          自動更新が一時停止しました（画面が非表示/他タブなど）。
        </div>
        <div class="toolbar" style="justify-content:space-between;">
          <div class="toolbar">
            <button class="secondary" id="att_refresh_btn" onclick="refreshAttendance()">更新</button>
            <label class="muted" style="display:flex; gap:6px; align-items:center; user-select:none;">
              <input type="checkbox" id="att_auto_refresh" /> 自動更新
            </label>
            <select id="att_auto_interval" class="secondary" style="max-width:140px;">
              <option value="10">10s</option>
              <option value="60">60s</option>
              <option value="120" selected>120s</option>
              <option value="300">300s</option>
            </select>
            <span class="muted" id="att-status"></span>
          </div>
          <div class="muted" style="font-size:12px;">打刻はサーバ時刻で記録</div>
        </div>
        <div id="att-cards" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="card" data-att-view="dashboard">
      <h2>出勤状況設定（休日/個人ICS）</h2>
      <div class="body">
        <div class="row">
          <div><label>祝日ICS URL</label><input id="att_holiday_url" placeholder="https://...ics"/></div>
          <div><label>会社休日ICS URL（任意）</label><input id="att_company_holiday_url" placeholder="https://...ics"/></div>
        </div>
        <div class="toolbar" style="margin-top:8px; justify-content:flex-end;">
          <button onclick="saveAttendanceSettings()">保存</button>
        </div>
        <hr/>
        <div class="muted" style="margin-top:6px;">個人ICS / freee従業員番号 / 出勤状況への表示 は「ユーザー」タブで設定します。</div>
        <div class="muted" style="margin-top:6px;">Tips: 休憩中（「休憩」状態）の時間はプロジェクト/タスクの投下時間として追跡しません。</div>
      </div>
    </div>

    <div class="card" data-att-view="summary">
      <h2>月次CSV / 閲覧（freee集計）</h2>
      <div class="body">
        <div class="toolbar" style="gap:8px; flex-wrap:wrap;">
          <input type="month" id="att_month"/>
          <button onclick="loadAttendanceMonth()">月次読み込み</button>
          <button class="secondary" onclick="exportFreeeAttendanceCsv()">freee集計CSVダウンロード</button>
        </div>
        <div class="muted" id="att-month-summary" style="margin-top:6px;"></div>
        <div class="body list" style="padding:0; margin-top:8px;">
          <table id="att-month-table">
            <thead><tr><th>日付</th><th>ユーザー</th><th>状態</th><th>出勤</th><th>退勤</th><th>勤務(概算)</th><th>プロジェクト/タスク</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" data-att-view="summary">
      <h2>週次サマリ</h2>
      <div class="body">
        <div class="muted" id="att-week-summary" style="margin-top:6px;"></div>
        <div class="body list" style="padding:0; margin-top:8px;">
          <table id="att-week-table">
            <thead><tr><th>週(開始)</th><th>週(終了)</th><th>ユーザー</th><th>勤務日数</th><th>勤務(概算)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

</div>

<script>
// --- RPC runner (no legacy script dependency) ---
async function rpcRequest(name, args){
  const tenantId = String(window.PJBINDER_TENANT_ID || localStorage.getItem('tenant_id') || '').trim();
  const payload = { name: String(name), args };
  if (tenantId) payload.tenantId = tenantId;
  const resp = await fetch('/api/rpc', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const raw = await resp.text().catch(() => '');
  let data = null;
  try { data = raw ? JSON.parse(raw) : null; } catch { data = { ok: false, error: raw || 'RPC error' }; }
  if (!resp.ok || !data || data.ok !== true) {
    throw new Error((data && data.error) ? data.error : `RPC failed: ${resp.status}`);
  }
  return data.result;
}

function initTenantFromUrl(){
  try{
    const params = new URLSearchParams(window.location.search || '');
    const urlTenant = String(params.get('tenant') || params.get('tenantId') || params.get('t') || '').trim();
    if (urlTenant) {
      localStorage.setItem('tenant_id', urlTenant);
      window.PJBINDER_TENANT_ID = urlTenant;
      return;
    }
    const stored = String(localStorage.getItem('tenant_id') || '').trim();
    if (stored) window.PJBINDER_TENANT_ID = stored;
  } catch(_){}
}

function setTenantLabel(value){
  const el = document.getElementById('tenant-label');
  if (!el) return;
  const text = String(value || '').trim();
  el.textContent = text;
  el.style.display = text ? 'inline-flex' : 'none';
}

function shortTenantId(value){
  const text = String(value || '').trim();
  if (!text) return '';
  return text.length > 12 ? `${text.slice(0, 8)}...` : text;
}

async function loadTenantLabel(){
  try{
    const info = await rpc('getTenantInfo');
    if (info && info.name) {
      setTenantLabel(info.name);
      return;
    }
    if (info && info.id) {
      setTenantLabel(shortTenantId(info.id));
      return;
    }
  }catch(_){}
  const fallback = String(window.PJBINDER_TENANT_ID || localStorage.getItem('tenant_id') || '').trim();
  if (fallback) setTenantLabel(shortTenantId(fallback));
}

function createRpcRunner(){
  let onSuccess = null;
  let onFailure = null;

  const runner = new Proxy({}, {
    get(_target, prop){
      if (prop === 'withSuccessHandler') {
        return function(fn){ onSuccess = fn; return runner; };
      }
      if (prop === 'withFailureHandler') {
        return function(fn){ onFailure = fn; return runner; };
      }

      return async function(...args){
        const success = onSuccess;
        const failure = onFailure;
        onSuccess = null;
        onFailure = null;
        try{
          const result = await rpcRequest(prop, args);
          if (typeof success === 'function') success(result);
        }catch(e){
          if (typeof failure === 'function') failure(e);
          else throw e;
        }
      };
    }
  });

  return runner;
}

const rpcRun = createRpcRunner();
function rpc(name, ...args){ return rpcRequest(name, args); }

// === ローカルストア差分適用（超軽量） ===
function patchRow(tableKey, row){
  const k = tableKey;             // 'tasks' / 'projects' / 'users' など
  const arr = safeArr(DATA[k]).slice();
  const i = arr.findIndex(x => String(x.id) === String(row.id));
  if (i >= 0) arr[i] = Object.assign({}, arr[i], row);
  else arr.unshift(row);
  DATA[k] = arr;
}
function dropRow(tableKey, id){
  DATA[tableKey] = safeArr(DATA[tableKey]).filter(x => String(x.id) !== String(id));
}

// 最小限だけ再描画（重い refresh は禁止）
function rerenderAfter(tableKey){
  switch (tableKey){
    case 'tasks':
      renderTasksTable();
      if (ACTIVE_TAB === 'board') renderKanban();
      if (ACTIVE_TAB === 'gantt') renderGantt();
      renderProjects();           // プロジェクト表の「未/完了数」も更新
      break;
    case 'projects':
      hydrateSelects();
      renderProjects();
      renderTasksTable();         // タスクに表示するプロジェクト名が変わる可能性
      break;
    case 'users':
      hydrateSelects();
      renderUsers();
      break;
    case 'subs':
      renderSubs(); renderBudget();
      break;
    case 'ledger':
      renderLedger(); renderBudget();
      break;
    case 'ledgerPlans':
      // 計画→実績に反映されるのは朝ジョブなので即描画は軽めでOK
      break;
    case 'credentials':
      renderCreds();
      break;
  }
}

let APP_VERSION = null;

    window.addEventListener('load', () => {
    rpcRun
      .withSuccessHandler(v => {
        APP_VERSION = v;
        setAppVersionBadge(APP_VERSION);
      })
      .withFailureHandler(err => {
        console.error(err);
        // Fallback: keep badge blank; update.md parser will fill if available.
      })
      //.getVersion();
    try { loadVersionFromUpdateMd(); } catch(_){}
  });

// --- semver helper（サーバが古いverでも上書きしない） ---
function parseSemver(v){
  if(!v) return null;
  const s=String(v).trim().replace(/^v/i,'');
  const [a,b,c] = s.split('.').map(x=>parseInt(x,10)||0);
  return {a,b,c,raw:String(v)};
}
function newerVersionPrefer(clientV, serverV){
  const c=parseSemver(clientV), s=parseSemver(serverV);
  if(!s) return c?.raw || clientV;
  if(!c) return s.raw;
  if(s.a>c.a) return s.raw;
  if(s.a<c.a) return c.raw;
  if(s.b>c.b) return s.raw;
  if(s.b<c.b) return c.raw;
  if(s.c>c.c) return s.raw;
  return c.raw;
}

// --- Navigation ---
function updateRouteParams(next, { replace=false } = {}){
  try{
    const url = new URL(window.location.href);
    Object.entries(next||{}).forEach(([k,v])=>{
      if (v === null || v === undefined || v === '') url.searchParams.delete(k);
      else url.searchParams.set(String(k), String(v));
    });
    const qs = url.searchParams.toString();
    const nextUrl = url.pathname + (qs ? ('?'+qs) : '') + url.hash;
    if (replace) history.replaceState({}, '', nextUrl);
    else history.pushState({}, '', nextUrl);
  }catch(_){ }
}

function readRouteParams(){
  const p = new URLSearchParams(location.search || '');
  const page = String(p.get('page') || '').trim();
  const view = String(p.get('view') || '').trim();
  const tab = String(p.get('tab') || '').trim();
  return { page, view, tab };
}

function applyRouteFromUrl(){
  const { page, view, tab } = readRouteParams();

  // IMPORTANT:
  // `tab` is the dashboard's task tab (list/board/gantt).
  // If we apply it while opening attendance, switchTab() may redirect to dashboard.
  // Therefore we:
  // 1) decide the target page first
  // 2) navigate to page
  // 3) apply tab only when the target page is dashboard

  const targetPage = page || PAGE || 'dashboard';
  if (targetPage === 'attendance') {
    ATT_VIEW = (view === 'summary') ? 'summary' : 'dashboard';
  }

  if (page) {
    goto(page, { skipRoute:true });
  }

  const effectivePage = page || PAGE;
  if (effectivePage === 'dashboard') {
    if (tab) {
      try { switchTab(tab); } catch(_){ }
      // Legacy: query param `tab` may coexist with hash tab and cause state to be re-applied.
      // After consuming it once, remove it from the query to keep a single source of truth.
      try { updateRouteParams({ tab: null }, { replace:true }); } catch(_){ }
    }
  }

  if (PAGE === 'attendance') {
    applyAttendanceViewUi();
    if (ATT_VIEW === 'summary') {
      try { loadAttendanceMonth?.(); } catch(_){ }
    }
  }
}

window.addEventListener('popstate', ()=>{ try{ applyRouteFromUrl(); }catch(_){ } });

function syncStickyOffsets(){
  try{
    const root = document.documentElement;
    const header = document.querySelector('header');
    const globalToolbar = document.getElementById('global-toolbar');
    const menuBar = document.getElementById('menu-bar');
    const filters = document.querySelector('#page-dashboard .filters.sticky, #page-dashboard .filters');

    const headerH = header ? Math.round(header.getBoundingClientRect().height) : 56;
    const baseToolbarH = (globalToolbar && globalToolbar.offsetParent !== null)
      ? Math.round(globalToolbar.getBoundingClientRect().height)
      : 0;
    const menuFixedTop = !!(menuBar && menuBar.classList.contains('fixed') && menuBar.classList.contains('top'));
    const menuFixedBottom = !!(menuBar && menuBar.classList.contains('fixed') && menuBar.classList.contains('bottom'));
    const menuTopH = menuFixedTop ? Math.round(menuBar.getBoundingClientRect().height) : 0;
    const menuBottomH = menuFixedBottom ? Math.round(menuBar.getBoundingClientRect().height) : 0;
    const toolbarH = baseToolbarH + menuTopH;
    const filtersH = (filters && filters.offsetParent !== null)
      ? Math.round(filters.getBoundingClientRect().height)
      : 46;

    root.style.setProperty('--header-h', headerH + 'px');
    root.style.setProperty('--toolbar-h', toolbarH + 'px');
    root.style.setProperty('--filters-h', filtersH + 'px');
    root.style.setProperty('--menu-h', menuBottomH + 'px');
  }catch(_){ }
}

function goto(page, opts) {
  opts = opts || {};
  // 正規化（shareds→shared）
  const aliases = { shareds:'shared' };
  page = aliases[page] || page;

  // Attendance auto-refresh must stop when leaving attendance.
  try {
    if (PAGE === 'attendance' && page !== 'attendance') {
      pauseAttendanceAutoRefresh({ reason:'navigate' });
    }
  } catch(_){ }

  // URL: query param deep-link
  if (!opts.skipRoute) {
    if (page === 'attendance') {
      // `tab` is for dashboard task tabs (list/board/gantt). Do not include it for attendance.
      updateRouteParams({ page:'attendance', view: (ATT_VIEW||'dashboard'), tab: null }, { replace:false });

      // Clear hash as well: it may contain #tab=list from dashboard bookmarks.
      try{
        if (location.hash) {
          const url = new URL(location.href);
          url.hash = '';
          const qs = url.searchParams.toString();
          history.replaceState({}, '', url.pathname + (qs ? ('?'+qs) : ''));
        }
      }catch(_){ }
    } else {
      // Keep dashboard task tab state in hash only (avoid query/hash double sources of truth).
      updateRouteParams({ page, view: null, tab: null }, { replace:false });
    }
  }

  const pages = ['dashboard','minutes','daily','weekly','attendance','users','vault','budget','subs','ledger','projects','facility','workflow','settings','debug','shared'];
  pages.forEach(p => {
    const pageEl = document.getElementById('page-'+p);
    if (pageEl) pageEl.classList.toggle('active', p===page);
    const navEl = document.getElementById('nav-'+p);
    if (navEl) navEl.classList.toggle('active', p===page);
  });
  const showDebug = (page === 'debug');
  ['debug-bar','debug-snapshot','sheet-chip'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = showDebug ? '' : 'none';
  });
  PAGE = page;
  try { renderAll(); } catch (e) {}
  try { setTimeout(syncStickyOffsets, 0); } catch(_){ }
  if (page === 'settings') {
    try { ensureTenantSettings(); } catch(_){ }
  }
  if (page === 'attendance') {
    applyAttendanceViewUi();
    try { loadAttendanceSettings?.(); } catch (e) {}
    if (ATT_VIEW === 'dashboard') {
      try { refreshAttendance?.(); } catch (e) {}
      try { if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh?.(); } catch(_){ }
    } else {
      try { loadAttendanceMonth?.(); } catch (e) {}
    }
  }
}

// Navigate to dashboard and select a task tab (list/board/gantt).
// Used by shortcuts that may be clicked while on another page.
function gotoDashboardTab(tab){
  const t = (tab==='board' || tab==='gantt') ? tab : 'list';
  try{ goto('dashboard'); }catch(_){ }
  setTimeout(()=>{ try{ switchTab(t); }catch(_){ } }, 0);
}

// --- Data & Filters ---
let DATA = {users:[], projects:[], tasks:[], subs:[], ledger:[], ledgerPlans:[], credentials:[], attachments:[], minutes:[], dailyReports:[], shareds:[], facilityAssets:[], facilityReservations:[], workflowRequests:[], workflowApprovals:[], paymentRequests:[]};
let FILTERS = { keyword:'', project:'', assignee:'', department:'', from:'', to:'', priority:'', status:'' };
let PAGE = 'dashboard';
let ACTIVE_TAB = 'list';
let GANTT_SCALE = (localStorage.getItem('gantt_scale')||'day');
// 添付件数
function isValidAttachment(a){
  const url = String(a?.url || '').trim();
  const fileId = String(a?.fileId || '').trim();
  return !!(url || fileId);
}
function listAttachments(kind, id){
  return safeArr(DATA.attachments).filter(a =>
    String(a.parentType||a.parent_type||a.type||'')===String(kind) &&
    String(a.parentId||a.parent_id||'')===String(id)
  ).filter(isValidAttachment);
}
function attachmentHref(a){
  const url = String(a?.url || '').trim();
  if (url) return url;
  const fileId = String(a?.fileId || '').trim();
  return fileId ? `https://drive.google.com/file/d/${fileId}/view` : '';
}
function countAttachments(kind, id){
  return listAttachments(kind, id).length;
}
const FILTERS_KEY = 'pm_filters_v2';
let OVERDUE = false; // 遅延クイックフィルタ
const SETTINGS_KEY = 'pjbinder_settings_v1';
const DEFAULT_SETTINGS = {
  density: 'standard',
  dashboardView: 'list',
  ganttScale: 'day',
  menuPosition: 'top',
  menuFixed: true,
  showWatermark: true,
  watermarkOpacity: 0.03,
  showTooltips: true,
  showFab: true,
};
let APP_SETTINGS = { ...DEFAULT_SETTINGS };
let TOOLTIPS_ENABLED = true;
const dayMs = 24*60*60*1000; // グローバル日ミリ秒（ガント/日付計算で使用）
let TENANT_SETTINGS = [];

function loadAppSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (!raw) return;
    const data = JSON.parse(raw) || {};
    APP_SETTINGS = { ...DEFAULT_SETTINGS, ...data };
  }catch(_){}
}

function persistAppSettings(){
  try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(APP_SETTINGS)); }catch(_){}
}

function syncSettingsForm(){
  const density = document.getElementById('set_density');
  const dashboardView = document.getElementById('set_dashboard_view');
  const ganttScale = document.getElementById('set_gantt_scale');
  const menuPosition = document.getElementById('set_menu_position');
  const menuFixed = document.getElementById('set_menu_fixed');
  const wm = document.getElementById('set_show_watermark');
  const wmOpacity = document.getElementById('set_watermark_opacity');
  const tips = document.getElementById('set_show_tooltips');
  const fab = document.getElementById('set_show_fab');
  if (density) density.value = APP_SETTINGS.density || 'standard';
  if (dashboardView) dashboardView.value = APP_SETTINGS.dashboardView || 'list';
  if (ganttScale) ganttScale.value = APP_SETTINGS.ganttScale || 'day';
  if (menuPosition) menuPosition.value = APP_SETTINGS.menuPosition || 'top';
  if (menuFixed) menuFixed.checked = !!APP_SETTINGS.menuFixed;
  if (wm) wm.checked = !!APP_SETTINGS.showWatermark;
  if (wmOpacity) wmOpacity.value = String(APP_SETTINGS.watermarkOpacity ?? 0.03);
  if (tips) tips.checked = !!APP_SETTINGS.showTooltips;
  if (fab) fab.checked = !!APP_SETTINGS.showFab;
}

function applyDensity(value){
  const root = document.documentElement;
  if (!root) return;
  const d = String(value || 'standard');
  if (d === 'compact') {
    root.style.setProperty('--row-h', '38px');
    root.style.setProperty('--cell-py', '4px');
    document.body.style.fontSize = '13px';
    return;
  }
  if (d === 'relaxed') {
    root.style.setProperty('--row-h', '52px');
    root.style.setProperty('--cell-py', '8px');
    document.body.style.fontSize = '15px';
    return;
  }
  root.style.setProperty('--row-h', '44px');
  root.style.setProperty('--cell-py', '6px');
  document.body.style.fontSize = '14px';
}

function placeMenuBar(position){
  const bar = document.getElementById('menu-bar');
  if (!bar) return;
  const pos = (position === 'bottom') ? 'bottom' : 'top';
  const topHost = document.getElementById('menu-bar-top');
  const bottomHost = document.getElementById('menu-bar-bottom');
  const host = (pos === 'bottom') ? bottomHost : topHost;
  if (host && bar.parentElement !== host) host.appendChild(bar);
  document.body.classList.toggle('menu-bottom', pos === 'bottom');
  document.body.classList.toggle('menu-top', pos === 'top');
}

function applyMenuBarSettings(){
  const bar = document.getElementById('menu-bar');
  if (!bar) return;
  const position = APP_SETTINGS.menuPosition === 'bottom' ? 'bottom' : 'top';
  const fixed = !!APP_SETTINGS.menuFixed;
  placeMenuBar(position);
  bar.classList.toggle('fixed', fixed);
  bar.classList.toggle('top', position === 'top');
  bar.classList.toggle('bottom', position === 'bottom');
  document.body.classList.toggle('menu-fixed', fixed);
  try { syncStickyOffsets(); } catch(_){}
}

function applyAppSettings(opts){
  const options = opts || {};
  applyDensity(APP_SETTINGS.density);

  const wm = document.getElementById('watermark');
  if (wm) {
    wm.style.display = APP_SETTINGS.showWatermark ? '' : 'none';
    const opacity = Number(APP_SETTINGS.watermarkOpacity);
    if (Number.isFinite(opacity) && opacity >= 0) {
      wm.style.setProperty('--wm-opacity', String(Math.min(opacity, 0.2)));
    }
  }

  TOOLTIPS_ENABLED = !!APP_SETTINGS.showTooltips;
  if (!TOOLTIPS_ENABLED) {
    document.querySelectorAll('.tooltip-bubble').forEach(el => el.remove());
  }

  const fab = document.getElementById('fab-stack');
  if (fab) fab.style.display = APP_SETTINGS.showFab ? '' : 'none';

  applyMenuBarSettings();

  const nextScale = APP_SETTINGS.ganttScale || 'day';
  if (nextScale !== GANTT_SCALE) {
    GANTT_SCALE = nextScale;
    try { localStorage.setItem('gantt_scale', GANTT_SCALE); } catch(_){}
    if (PAGE === 'dashboard' && ACTIVE_TAB === 'gantt') {
      try { renderGantt?.(true); } catch(_){}
    }
  }
  const scaleSel = document.getElementById('gantt-scale-mode');
  if (scaleSel && String(scaleSel.value || '') !== String(GANTT_SCALE)) {
    scaleSel.value = GANTT_SCALE;
  }

  if (PAGE === 'dashboard') {
    const params = readRouteParams();
    const hasRouteTab = !!params.tab || !!location.hash;
    if (!options.respectRoute || !hasRouteTab) {
      try { switchTab(APP_SETTINGS.dashboardView || 'list'); } catch(_){}
    }
  }
}

function readSettingsForm(){
  const density = (document.getElementById('set_density') || {}).value;
  const dashboardView = (document.getElementById('set_dashboard_view') || {}).value;
  const ganttScale = (document.getElementById('set_gantt_scale') || {}).value;
  const menuPosition = (document.getElementById('set_menu_position') || {}).value;
  const menuFixed = (document.getElementById('set_menu_fixed') || {}).checked;
  const watermarkOpacityRaw = (document.getElementById('set_watermark_opacity') || {}).value;
  const watermarkOpacityNum = Number(watermarkOpacityRaw);
  const watermarkOpacity = Number.isFinite(watermarkOpacityNum) ? Math.max(0, Math.min(0.2, watermarkOpacityNum)) : 0.03;
  const showWatermark = (document.getElementById('set_show_watermark') || {}).checked;
  const showTooltips = (document.getElementById('set_show_tooltips') || {}).checked;
  const showFab = (document.getElementById('set_show_fab') || {}).checked;
  return {
    density: density || 'standard',
    dashboardView: dashboardView || 'list',
    ganttScale: ganttScale || 'day',
    menuPosition: menuPosition || 'top',
    menuFixed: !!menuFixed,
    watermarkOpacity,
    showWatermark: !!showWatermark,
    showTooltips: !!showTooltips,
    showFab: !!showFab,
  };
}

function saveAppSettings(){
  APP_SETTINGS = { ...DEFAULT_SETTINGS, ...readSettingsForm() };
  persistAppSettings();
  applyAppSettings({ respectRoute: false });
  try { showToast('ok', '設定を保存しました'); } catch(_){}
}

function resetAppSettings(){
  APP_SETTINGS = { ...DEFAULT_SETTINGS };
  persistAppSettings();
  syncSettingsForm();
  applyAppSettings({ respectRoute: false });
  try { showToast('ok', '設定を初期化しました'); } catch(_){}
}

async function loadTenantSettings(){
  try{
    const rows = await rpc('getSettingsEntries');
    TENANT_SETTINGS = Array.isArray(rows) ? rows : [];
    renderTenantSettings();
  }catch(e){
    try { showToast('ng', '設定の取得に失敗しました'); } catch(_){}
  }
}

async function ensureTenantSettings(){
  try{
    await rpc('ensureTenantSettings');
  }catch(e){
    try { showToast('ng', '設定テンプレートの作成に失敗しました'); } catch(_){}
  }
  await loadTenantSettings();
}

function renderTenantSettings(){
  const tbody = document.querySelector('#tenantSettingsTable tbody');
  if (!tbody) return;
  const rows = safeArr(TENANT_SETTINGS).slice().sort((a,b)=>{
    const ak = String(a?.key || '');
    const bk = String(b?.key || '');
    return ak.localeCompare(bk);
  });
  if (!rows.length){
    tbody.innerHTML = '<tr><td colspan="4" class="muted">データなし</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(r=>{
    const key = escapeHtml(r?.key || '');
    const rawValue = String(r?.value || '');
    const maskedValue = rawValue.length <= 8 ? rawValue : `${rawValue.slice(0, 8)}***`;
    const value = escapeHtml(maskedValue);
    const updated = escapeHtml(r?.updatedAt || '');
    const editKey = escapeJsSq(r?.key || '');
    const editValue = escapeJsSq(r?.value || '');
    return `<tr>
      <td>${key}</td>
      <td>${value}</td>
      <td>${updated}</td>
      <td><button class="secondary mini" onclick="editTenantSetting('${editKey}','${editValue}')">編集</button></td>
    </tr>`;
  }).join('');
}

function editTenantSetting(key, value){
  const keyEl = document.getElementById('ts_key');
  const valueEl = document.getElementById('ts_value');
  const editing = document.getElementById('ts_editing_key');
  if (keyEl) keyEl.value = String(key || '');
  if (valueEl) valueEl.value = String(value || '');
  if (editing) editing.value = String(key || '');
}

function resetTenantSettingForm(){
  const keyEl = document.getElementById('ts_key');
  const valueEl = document.getElementById('ts_value');
  const editing = document.getElementById('ts_editing_key');
  if (keyEl) keyEl.value = '';
  if (valueEl) valueEl.value = '';
  if (editing) editing.value = '';
}

async function saveTenantSetting(){
  const key = String(val('ts_key') || '').trim();
  const value = String(val('ts_value') || '');
  if (!key) { alert('キーを入力してください'); return; }
  try{
    await rpc('setSettingEntry', key, value);
    await loadTenantSettings();
    resetTenantSettingForm();
    try { showToast('ok', '設定を保存しました'); } catch(_){}
  }catch(e){
    alert('設定の保存に失敗しました: ' + (e && e.message ? e.message : e));
  }
}

function saveFiltersToLS(){
  const payload = { ...FILTERS, overdue: OVERDUE ? 1 : 0 };
  try{ localStorage.setItem(FILTERS_KEY, JSON.stringify(payload)); }catch(_){}
}
function loadFiltersFromLS(){
  try{
    const raw = localStorage.getItem(FILTERS_KEY);
    if(!raw) return;
    const f = JSON.parse(raw)||{};
    OVERDUE = String(f.overdue||'0')==='1';
    FILTERS = {
      keyword: f.keyword||'',
      project: f.project||'',
      assignee: f.assignee||'',
      department: f.department||'',
      from: f.from||'',
      to: f.to||'',
      priority: f.priority||'',
      status: f.status||''
    };
    // UIへ反映（セレクトは hydrateSelects でも再設定されます）
    const map = {keyword:'f_keyword', project:'f_project', assignee:'f_assignee', department:'f_department', from:'f_from', to:'f_to', priority:'f_priority', status:'f_status'};
    Object.keys(map).forEach(k=>{ const e=el(map[k]); if(e) e.value=FILTERS[k]||''; });
  }catch(_){}
}

function setGanttScale(v){ GANTT_SCALE = (v==='month'?'month':(v==='week'?'week':'day')); localStorage.setItem('gantt_scale', GANTT_SCALE); renderGantt(); }

// display labels (status/priority)
const STATUS_LABELS = { todo:'未着手', doing:'進行中', blocked:'保留中', done:'完了' };
const PRIORITY_IN = { 'High':'高', 'Middle':'中', 'Medium':'中', 'Low':'低', '高':'高', '中':'中', '低':'低' };
function normPriority(p){ return PRIORITY_IN[String(p||'').trim()] || String(p||''); }
function labelStatus(code){ return STATUS_LABELS[String(code||'').toLowerCase()] || String(code||''); }

function emptyData(){ return {users:[], projects:[], tasks:[], subs:[], ledger:[], credentials:[], facilityAssets:[], facilityReservations:[], workflowRequests:[], workflowApprovals:[], paymentRequests:[]}; }
function safeArr(a){ return Array.isArray(a) ? a : []; }

// --- Busy indicator ---
const Busy = {
  _n: 0,
  show(){ const el = document.getElementById('busy-indicator'); if (el) el.style.display = ''; },
  hide(){ const el = document.getElementById('busy-indicator'); if (el) el.style.display = 'none'; },
  push(){ this._n++; this.show(); },
  pop(){ this._n = Math.max(0, this._n-1); if (this._n===0) this.hide(); },
  async wrap(p){ this.push(); try{ return await p; } finally{ this.pop(); } }
};

// ★ 既存 refresh を置き換え（中身はそのまま、前後に Busy を追加）
function refresh() {
  Busy.push();
  rpcRun
    .withSuccessHandler((raw)=>{
      const d0 = (raw && typeof raw==='object') ? raw : {};
      const d = Object.fromEntries(Object.entries(d0).map(([k,v])=>[String(k).toLowerCase(), v]));
      const pick = (...keys)=> { for (const k of keys){ const v = d[String(k).toLowerCase()]; if (Array.isArray(v)) return v; } return []; };
      const workflowRequests = pick('workflowRequests','workflow_requests','workflowrequests');
      const workflowApprovals = pick('workflowApprovals','workflow_approvals','workflowapprovals');
      const paymentRequests = pick('paymentRequests','payment_requests','paymentrequests');
      const workflowFallback = (!workflowRequests.length && paymentRequests.length)
        ? paymentRequests.map(r=>({
          id: r.id,
          title: r.title,
          requesterId: r.userId,
          amount: r.amount,
          dueDate: r.dueDate,
          vendor: r.vendor,
          account: r.account,
          projectId: r.projectId,
          status: r.status,
          memoText: r.memoText,
          approverIds: '',
          currentStep: 0,
          requestDate: r.requestDate,
          createdAt: r.createdAt,
          updatedAt: r.updatedAt,
        }))
        : workflowRequests;

      DATA = {
        users:        pick('users'),
        projects:     pick('projects'),
        tasks:        pick('tasks'),
        subs:         pick('subs','subscriptions'),
        ledger:       pick('ledger','ledgers'),
        ledgerPlans:  pick('ledgerplans'),
        credentials:  pick('credentials'),
        attachments:  pick('attachments'),
        minutes:      pick('minutes'),
        dailyReports: pick('dailyreports','daily_reports','daily'),
        attendanceWorklogs: [], // lazy load on weekly view
        shareds:      safeArr(d.shareds ?? d.Shareds ?? d.shared),
        facilityAssets:       pick('facilityAssets','facility_assets','facilityassets'),
        facilityReservations: pick('facilityReservations','facility_reservations','facilityreservations'),
        workflowRequests:     workflowFallback,
        workflowApprovals:    workflowApprovals,
        paymentRequests:      paymentRequests,
      };
      ATT_WORKLOGS_LOADED = false;
      hydrateSelects();
      renderAll();
      Busy.pop();
    })
    .withFailureHandler(err => {
      console.error(err);
      showToast && showToast('ng','データ取得エラー');
      Busy.pop();
    })
    .getAllData();
}


// --- Helpers for names/lookup ---
function nameByUserId(id){ const u = safeArr(DATA.users).find(x=>x.id===id); return u ? (u.name || u.email || u.id) : id; }
function projectById(id){ return safeArr(DATA.projects).find(x=>x.id===id); }
function nameByProjectId(id){ const p = projectById(id); return p ? (p.name || p.id) : id; }

function getProjectDocUrl(pid){
  const p = projectById(pid); if (!p) return '';
  const url = p.docUrl || (p.docID||p.docId ? 'https://docs.google.com/document/d/'+(p.docID||p.docId) : '');
  return url || '';
}
function getTaskDocUrl(tid){
  const t = safeArr(DATA.tasks).find(x=>x.id===tid); if (!t) return '';
  const url = t.docUrl || (t.docID||t.docId ? 'https://docs.google.com/document/d/'+(t.docID||t.docId) : '');
  return url || '';
}
function openProjectDocById(pid){
  const url = getProjectDocUrl(pid);
  if (url) window.open(url,'_blank'); else alert('このプロジェクトのDocsは未作成です');
}
function openTaskDocById(tid){
  const url = getTaskDocUrl(tid);
  if (url) window.open(url,'_blank'); else alert('このタスクのDocsは未作成です');
}
// 検索フィルター用のプレイスホルダー表示テキスト
const SELECT_PLACEHOLDERS = {
  f_project:   'プロジェクト',
  f_assignee:  'ユーザー',
  proj_f_owner:'ユーザー'     // プロジェクト一覧ページのフィルタにも適用
};
// --- Selects ---
function hydrateSelects(){
  const users     = safeArr(DATA.users);
  const projects  = safeArr(DATA.projects);
  const activePjs = projects.filter(p => String(p.status||'').toLowerCase() !== 'archived');
  const facilities = safeArr(DATA.facilityAssets).filter(f => String(f.active||'true') !== 'false');
  const departments = Array.from(new Set(users.map(u=>String(u.department||'').trim()).filter(Boolean)));

  // 汎用: セレクトへ流し込み（空=プレイスホルダー文言を表示）
  const set = (id, items, {empty=true, label=x=>x.name||x.title||x.id||'', value=x=>x.id}={})=>{
    const el = document.getElementById(id); if(!el) return;
    while(el.options.length) el.remove(0);

    if (empty) {
      const ph = SELECT_PLACEHOLDERS[id] || '（未選択）';
      // 空値の option を先頭に（選択可能のまま：空=フィルタ無効の意味）
      const o = new Option(ph, '');
      el.add(o);
    }

    items.forEach(it => el.add(new Option(label(it), value(it))));

    // 見た目の薄字切替（値が空なら is-placeholder）
    const applyPH = ()=>{
      if (!el) return;
      el.classList.toggle('is-placeholder', !el.value);
    };
    el.addEventListener('change', applyPH, { once:false });
    // 初期状態（LS復元等で値が入る前に一旦判定）
    applyPH();
  };

  // --- プロジェクト選択（フォーム系は非アーカイブのみ） ---
  ['p_parent_select','t_project_select','s_project','l_project','lp_project','m_project','dr_project','fac_project','wf_project']
    .forEach(id => set(id, activePjs, {empty:true, label:p=>p.name||p.id, value:p=>p.id}));

  // 検索フィルタは全件（過去参照のため）
  set('f_project', projects, {empty:true, label:p=>p.name||p.id, value:p=>p.id});

  // --- ユーザー系 ---
  ['p_owner_select','t_owner_select','f_assignee','dr_user','sh_owner','c_owner','fac_user','wf_requester']
    .forEach(id => set(id, users, {empty:true, label:u=>u.name||u.email||u.id, value:u=>u.id}));

  // --- 設備 ---
  (function setFacilities(){
    const items = facilities.slice().sort((a,b)=>{
      const ao = Number(a.sortOrder||0);
      const bo = Number(b.sortOrder||0);
      if (ao !== bo) return ao - bo;
      return String(a.name||'').localeCompare(String(b.name||''),'ja');
    });
    set('fac_facility', items, {empty:true, label:f=>f.name||f.id, value:f=>f.id});
  })();

  // 決済申請承認者（順番）
  const wfMulti = document.getElementById('wf_approvers');
  if (wfMulti){
    while(wfMulti.options.length) wfMulti.remove(0);
    users.forEach(u => wfMulti.add(new Option(u.name||u.email||u.id, u.id)));
    wfMulti.size = Math.min(Math.max(users.length, 3), 8);
  }
  // 部署フィルタ
  (function setDeptFilter(){
    const el = document.getElementById('f_department');
    if (!el) return;
    while(el.options.length) el.remove(0);
    el.add(new Option('全所属',''));
    departments.forEach(d => el.add(new Option(d, d)));
    // 復元
    el.value = FILTERS.department || '';
    if (el.value !== (FILTERS.department||'')) el.value = '';
  })();

  // タスク担当（複数選択）
  const multi = document.getElementById('t_assignees_select');
  if (multi){
    while(multi.options.length) multi.remove(0);
    users.forEach(u => multi.add(new Option(u.name||u.email||u.id, u.id)));
    multi.size = Math.min(Math.max(users.length, 3), 10);
  }

  // --- Minutes/日報の「関連タスク」：未完＋アクティブPJのみ ---
  const openTasks = safeArr(DATA.tasks).filter(t=>{
    const notDone  = String(t.status||'').toLowerCase() !== 'done';
    const pj       = projects.find(p=>String(p.id)===String(t.projectId));
    const pjActive = !pj || String(pj.status||'').toLowerCase() !== 'archived';
    return notDone && pjActive;
  });
  const setMulti = (id, items, min=5, max=12)=>{
    const el = document.getElementById(id); if(!el) return;
    while(el.options.length) el.remove(0);
    items.forEach(t => el.add(new Option(t.title || t.id, t.id)));
    el.size = Math.min(Math.max(items.length, min), max);
  };
  setMulti('m_tasks', openTasks, 5, 12);
  setMulti('dr_tasks', openTasks, 6, 12);

  // --- フィルタの値をUIに復元 ---
  const map = { project:'f_project', assignee:'f_assignee', department:'f_department', priority:'f_priority', status:'f_status' };
  Object.keys(map).forEach(k => { const e = document.getElementById(map[k]); if(e) e.value = FILTERS[k] || ''; });
  ['f_keyword','f_from','f_to'].forEach(id => { const e = document.getElementById(id); if(e) e.value = (FILTERS[id.replace('f_','')] || ''); });

  // （任意）デバッグ表示
  const snap = document.getElementById('debug-snapshot');
  if (snap){
    const uShow = users.slice(0,2).map(u=>u.name||u.email||u.id).join(', ') || '-';
    const pShow = projects.slice(0,2).map(p=>p.name||p.id).join(', ') || '-';
    snap.textContent = `[Client] Users:${users.length} / Projects:${projects.length} | ${uShow} | ${pShow}`;
  }
}


// 追加: DnDでIDを安全に取り出す（text/plain と text 両対応）
function _dragId_(ev){
  if (!ev || !ev.dataTransfer) return '';
  return ev.dataTransfer.getData('text/plain') || ev.dataTransfer.getData('text') || '';
}

// 置換: allowDrop を少し強化
function allowDrop(ev){
  if (ev && ev.preventDefault) ev.preventDefault();
  if (ev && ev.dataTransfer) ev.dataTransfer.dropEffect = 'move';
}
function onDrop(ev, status){
  try{
    if (ev && ev.preventDefault) ev.preventDefault();
    const id = _dragId_(ev); 
    if(!id) return;

    // 今がスイムレーンか？どのレーンに落ちたか？
    const isSwim = !!document.getElementById('opt_swimlane')?.checked;
    const laneEl = ev.target && ev.target.closest ? ev.target.closest('[data-lane-key]') : null;
    const laneKey = laneEl ? laneEl.getAttribute('data-lane-key') : '';

    // スイムONかつ laneKey が取れたら：ステータス＋担当者(assignees)も更新
    if (isSwim && laneKey){
      const t = safeArr(DATA.tasks).find(x=>x.id===id);
      if(!t){ moveStatus(id, status); return; }

      let ass = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);

      if (laneKey === '__NONE__'){
        // 未割当レーンに落とした → 担当者クリア
        ass = [];
      } else {
        // 先頭をそのレーンのユーザーに（重複は排除）
        ass = [laneKey, ...ass.filter(a => a !== laneKey)];
      }

      const patch = Object.assign({}, t, {
        status,
        assignees: ass.join(',')
      });

      rpcRun
        .withSuccessHandler(()=>{ refresh(); })
        .withFailureHandler(err => {
          console.error(err);
          // ステータスだけでも反映しておく
          moveStatus(id, status);
        })
        .upsertTask(patch);
      return;
    }

    // スイムOFF（従来通り：ステータスだけ）
    moveStatus(id, status);
  }catch(e){ console.error(e); }
}


// --- Updates (max 10) ---
function renderUpdates(){
  const elx = document.getElementById('updates-feed'); if (!elx) return;
  const items = [];
  safeArr(DATA.projects).forEach(p=>items.push({type:'プロジェクト', title:p.name||p.id, when:p.updatedAt||p.createdAt||''}));
  safeArr(DATA.tasks).forEach(t=>items.push({type:'タスク', title:t.title||t.id, when:t.updatedAt||t.createdAt||''}));
  items.sort((a,b)=>String(b.when||'').localeCompare(String(a.when||'')));
  elx.innerHTML = items.slice(0,10).map(it=>`<div class="row" style="justify-content:space-between;">
      <div>${it.type}：<b>${escapeHtml(it.title)}</b></div><div class="muted">${it.when||''}</div></div>`).join('')
    || '<div class="muted">更新はまだありません</div>';
}

// textarea を内容に合わせて自動で伸縮
function autosizeTA(ta){
  if (!ta) return;
  ta.style.height = 'auto';               // 一旦リセット
  ta.style.height = ta.scrollHeight + 'px';
}

// 一覧・プロジェクト表にある .memo-edit を全部対象にする
function attachDefaultMemoEditors(){
  const list = document.querySelectorAll('textarea.memo-edit');
  list.forEach(ta => {
    // 初期高さ
    requestAnimationFrame(() => autosizeTA(ta));
    // 入力のたびに伸縮
    ta.removeEventListener?.(_autosizeHandlerName, ta._autosizeHandler); // 多重バインド回避
    ta._autosizeHandler = () => autosizeTA(ta);
    ta.addEventListener('input', ta._autosizeHandler);
  });
}
// イベント名の衝突回避用
const _autosizeHandlerName = 'input';


// --- Rendering (tasks/kanban/projects/subs/ledger) ---
function renderAll() {
  renderBudget();
  renderUpdates();
  renderTasksTable();
  renderKanban();
  renderProjects();
  renderShareds?.();      // ← 未定義でも落ちない
  renderSubs();
  renderSubsPage();
  renderLedger();
  renderUsers();
  renderCreds();
  renderProjectsPage?.();
  renderAttendancePage?.();
  if (ACTIVE_TAB === 'gantt') renderGantt();

  // ここを追加（タブ側で早期returnする安全なレンダラ）
  renderLedgerPage();
  renderMinutesPage();
  renderDailyPage();
  renderWeeklyPage();
  renderFacilityPage();
  renderWorkflowPage();

  // メモの自動伸縮
  attachDefaultMemoEditors();
}

// =============================
// Weekly progress
// =============================
let WEEKLY = {
  centerWeekStart: '',
  weeks: [],
  rowsByKey: {},
};

let WEEKLY_FILTER = {
  department: '', // '' | '__unset__' | deptName
  userId: '',
};
let WEEKLY_FILTER_READY = false;
const WEEKLY_FILTER_KEY = 'weekly_filters_v1';
function loadWeeklyFilterFromLS(){
  try{
    const raw = localStorage.getItem(WEEKLY_FILTER_KEY);
    if (!raw) return;
    const f = JSON.parse(raw) || {};
    WEEKLY_FILTER.department = String(f.department||'');
    WEEKLY_FILTER.userId = String(f.userId||'');
  }catch(_){}
}
function saveWeeklyFilterToLS(){
  const payload = {
    department: String(WEEKLY_FILTER.department||''),
    userId: String(WEEKLY_FILTER.userId||''),
  };
  try{ localStorage.setItem(WEEKLY_FILTER_KEY, JSON.stringify(payload)); }catch(_){}
}

function setAppVersionBadge(v){
  const badge = document.getElementById('app-version');
  const displayV = newerVersionPrefer(APP_VERSION, v);
  if (badge) badge.textContent = displayV || '';
}
async function loadVersionFromUpdateMd(){
  try{
    const resp = await fetch('/update.md', { cache: 'no-store' });
    if (!resp.ok) return;
    const text = await resp.text();
    let v = '';
    const m1 = text.match(/\(v[^)]+\)/i);
    if (m1) v = m1[0].replace(/[()]/g, '');
    if (!v) {
      const m2 = text.match(/\bv\d+(?:\.\d+)+(?:[a-z]\b)?/i);
      if (m2) v = m2[0];
    }
    if (!v) return;
    APP_VERSION = newerVersionPrefer(APP_VERSION, v);
    setAppVersionBadge(APP_VERSION);
  }catch(_){}
}

function weeklyUserDept(u){
  return String((u && u.department) ? u.department : '').trim();
}

function setSelectOptions(sel, options, selectedValue){
  if (!sel) return;
  const cur = String(selectedValue ?? sel.value ?? '');
  const html = options.map(o=>`<option value="${escapeHtml(String(o.value))}">${escapeHtml(String(o.label))}</option>`).join('');
  sel.innerHTML = html;
  sel.value = cur;
  if (sel.value !== cur) {
    // selection no longer valid
    sel.value = '';
  }
}

function weeklyDeptMatches(u, dept){
  const d = weeklyUserDept(u);
  const want = String(dept||'');
  if (!want) return true;
  if (want === '__unset__') return !d;
  return d === want;
}

function weeklyApplyFilters(users){
  let out = users;
  const dept = String(WEEKLY_FILTER.department||'');
  const uid = String(WEEKLY_FILTER.userId||'');
  if (dept) out = out.filter(u=>weeklyDeptMatches(u, dept));
  if (uid) out = out.filter(u=>String(u.id||'') === uid);
  return out;
}

function ensureWeeklyFilterControls(baseUsers){
  const deptSel = el('wk_filter_dept');
  const userSel = el('wk_filter_user');
  if (!deptSel || !userSel) return;
  if (!Array.isArray(baseUsers) || baseUsers.length === 0) return;
  if (!WEEKLY_FILTER_READY) {
    loadWeeklyFilterFromLS();
    WEEKLY_FILTER_READY = true;
  }

  // Bind handlers once.
  if (!deptSel.dataset.bound) {
    deptSel.addEventListener('change', ()=>{
      WEEKLY_FILTER.department = String(deptSel.value||'');
      // If the current selected user doesn't belong to the dept anymore, reset.
      if (WEEKLY_FILTER.userId) {
        const ok = baseUsers.some(u => String(u.id||'') === String(WEEKLY_FILTER.userId||'') && weeklyDeptMatches(u, WEEKLY_FILTER.department));
        if (!ok) {
          WEEKLY_FILTER.userId = '';
          try { userSel.value = ''; } catch(_){ }
        }
      }
      saveWeeklyFilterToLS();
      renderWeeklyPage();
    });
    deptSel.dataset.bound = '1';
  }
  if (!userSel.dataset.bound) {
    userSel.addEventListener('change', ()=>{
      WEEKLY_FILTER.userId = String(userSel.value||'');
      saveWeeklyFilterToLS();
      renderWeeklyPage();
    });
    userSel.dataset.bound = '1';
  }

  // Dept options from base users.
  const depts = Array.from(new Set(baseUsers.map(u=>weeklyUserDept(u)).filter(Boolean)))
    .sort((a,b)=>String(a).localeCompare(String(b), 'ja'));
  const hasUnset = baseUsers.some(u=>!weeklyUserDept(u));
  const deptOptions = [{ value:'', label:'全所属' }]
    .concat(hasUnset ? [{ value:'__unset__', label:'（所属未設定）' }] : [])
    .concat(depts.map(d=>({ value:d, label:d })));
  setSelectOptions(deptSel, deptOptions, WEEKLY_FILTER.department);
  WEEKLY_FILTER.department = String(deptSel.value||'');

  // User options depend on dept selection.
  const deptFiltered = baseUsers.filter(u=>weeklyDeptMatches(u, WEEKLY_FILTER.department));
  const userOptions = [{ value:'', label:'全ユーザー' }].concat(
    deptFiltered.map(u=>{
      const name = String(u.name||u.email||u.id||'');
      const emp = String(u.employeeNumber||'').trim();
      const label = emp ? `${name} (${emp})` : name;
      return { value: String(u.id||''), label };
    })
  );
  setSelectOptions(userSel, userOptions, WEEKLY_FILTER.userId);
  WEEKLY_FILTER.userId = String(userSel.value||'');
}

function fmtYMDLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function weekStartMonday(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const delta = (x.getDay() + 6) % 7; // Mon=0 ... Sun=6
  x.setDate(x.getDate() - delta);
  return x;
}

function ensureWeeklyStartInput(){
  const inp = el('wk_start');
  if (!inp) return;
  if (inp.value) return;
  inp.value = fmtYMDLocal(weekStartMonday(new Date()));
}

function setWeeklyToday(){
  const inp = el('wk_start');
  if (!inp) return;
  inp.value = fmtYMDLocal(weekStartMonday(new Date()));
  loadWeekly();
}

async function ensureAttendanceWorklogsLoaded(){
  if (ATT_WORKLOGS_LOADED && Array.isArray(DATA.attendanceWorklogs) && DATA.attendanceWorklogs.length) return;
  try{
    const rows = await rpc('getAttendanceWorklogs');
    if (Array.isArray(rows)) DATA.attendanceWorklogs = rows;
    ATT_WORKLOGS_LOADED = true;
  }catch(e){
    console.error('attendance_worklogs load failed', e);
  }
}

function normalizeWeeklyStartInput(){
  const inp = el('wk_start');
  if (!inp) return '';
  const raw = String(inp.value||'').trim();
  const d = parseYMDLocal(raw) || weekStartMonday(new Date());
  const mon = weekStartMonday(d);
  const ws = fmtYMDLocal(mon);
  if (raw !== ws) inp.value = ws;
  return ws;
}

function weeklyWeeksFromCenter(centerWs){
  const d0 = parseYMDLocal(String(centerWs||'')) || weekStartMonday(new Date());
  const mon = weekStartMonday(d0);
  const cur = fmtYMDLocal(mon);
  const prev = fmtYMDLocal(addDays(mon, -7));
  const next = fmtYMDLocal(addDays(mon, 7));
  return [prev, cur, next];
}

function weeklyUserProjectKey(uid, projectId){
  return String(uid||'') + '|' + String(projectId||'');
}

function weeklyComputeHoursMapsForWeek(weekStartYmd){
  // Uses DATA.attendanceWorklogs (attendance_worklogs) intervals.
  // Returns hours for the given week + total hours.
  const weekMap = {};
  const totalMap = {};
  const ws = String(weekStartYmd||'').trim();
  const weekStart = parseYMDLocal(ws);
  const weekEndExcl = weekStart ? addDays(weekStart, 7) : null;
  const now = new Date();

  const add = (map, key, hours)=>{
    if (!key) return;
    map[key] = (map[key] || 0) + (Number(hours) || 0);
  };

  const pick = (obj, ...keys)=>{
    for (const k of keys) {
      if (obj && obj[k] != null) return obj[k];
    }
    return undefined;
  };

  const toDate = (v)=>{
    if (!v) return null;
    const tryParse = (s)=>{
      const d = new Date(s);
      return Number.isFinite(d.getTime()) ? d : null;
    };
    const raw = String(v);
    let d = tryParse(raw);
    if (d) return d;
    // Normalize common timestamp variants: "YYYY-MM-DD HH:mm:ss.sss+00" => "YYYY-MM-DDTHH:mm:ss.sss+00:00"
    const t1 = raw.replace(' ', 'T');
    d = tryParse(t1);
    if (d) return d;
    const t2 = t1.replace(/\+(\d\d)$/, '+$1:00');
    d = tryParse(t2);
    return d;
  };

  const overlapMs = (a0, a1, b0, b1)=>{
    const s = Math.max(a0.getTime(), b0.getTime());
    const e = Math.min(a1.getTime(), b1.getTime());
    return Math.max(0, e - s);
  };

  safeArr(DATA.attendanceWorklogs).forEach(w=>{
    const uid = String(pick(w,'user_id','userId','userid')||'').trim();
    if (!uid) return;
    let pid = String(pick(w,'project_id','projectId','projectid')||'').trim();
    // プロジェクト未指定でタスクだけ指定されている場合、タスクのプロジェクトに寄せて集計する
    if (!pid) {
      const tid = String(pick(w,'task_id','taskId','taskid')||'').trim();
      if (tid) {
        const taskProj = safeArr(DATA.tasks).find(t => String(t.id||'') === tid)?.projectId;
        if (taskProj) pid = String(taskProj);
      }
    }
    const parsedValue = (()=>{
      if (!w || typeof w.value !== 'string') return null;
      try{ return JSON.parse(w.value); }catch(_){ return null; }
    })();
    const startRaw = pick(w,'start_at','startAt','start','clock_in','clockIn','clockin','startTime') || (parsedValue && (parsedValue.start_at || parsedValue.clock_in || parsedValue.start));
    const endRaw   = pick(w,'end_at','endAt','end','clock_out','clockOut','clockout','endTime')   || (parsedValue && (parsedValue.end_at || parsedValue.clock_out || parsedValue.end));
    const startAt = toDate(startRaw);
    if (!startAt) return;
    const endAt = toDate(endRaw) || now;
    if (endAt.getTime() <= startAt.getTime()) return;

    const key = weeklyUserProjectKey(uid, pid);
    const totalH = (endAt.getTime() - startAt.getTime()) / 3600000;
    add(totalMap, key, totalH);

    if (weekStart && weekEndExcl) {
      const wkMs = overlapMs(startAt, endAt, weekStart, weekEndExcl);
      if (wkMs > 0) add(weekMap, key, wkMs / 3600000);
    }
  });

  return { weekMap, totalMap };
}

function fmtHours(h){
  const x = Number(h||0);
  if (!Number.isFinite(x) || x === 0) return '0h';
  const rounded = Math.round(x * 10) / 10;
  const s = (Number.isInteger(rounded) ? String(rounded) : String(rounded));
  return `${s}h`;
}

function weeklyRangeLabel(ws){
  try{
    const d0 = parseYMDLocal(String(ws||'')) || weekStartMonday(new Date());
    const d6 = addDays(d0, 6);
    return `${fmtYMDLocal(d0)}?${fmtYMDLocal(d6)}`;
  }catch(_){
    return String(ws||'');
  }
}

function shiftWeekly(days){
  const inp = el('wk_start');
  if (!inp) return;
  const base = parseYMDLocal(inp.value) || weekStartMonday(new Date());
  inp.value = fmtYMDLocal(addDays(base, Number(days)||0));
  loadWeekly();
}

function weeklyKey(ws, uid, projectId){
  return String(ws||'') + '|' + String(uid||'') + '|' + String(projectId||'');
}

function weeklyRow(ws, uid, projectId){
  const k = weeklyKey(ws, uid, projectId);
  return (WEEKLY.rowsByKey && WEEKLY.rowsByKey[k]) ? WEEKLY.rowsByKey[k] : null;
}

function normalizeWeeklyRowIds(row, knownUsers, knownProjects){
  let uid = String(row && row.userId ? row.userId : '').trim();
  let pid = String(row && row.projectId ? row.projectId : '').trim();
  if (!uid) return { uid, pid };
  const hasUser = knownUsers && knownUsers.has(uid);
  if (!hasUser) {
    const pjIdx = uid.indexOf('_pj_');
    if (pjIdx > 0) {
      const candidateUid = uid.slice(0, pjIdx);
      const candidatePid = uid.slice(pjIdx + 4);
      if (candidateUid && knownUsers && knownUsers.has(candidateUid)) {
        uid = candidateUid;
        if ((!pid || (knownProjects && !knownProjects.has(pid))) && candidatePid) {
          if (knownProjects && knownProjects.has(candidatePid)) {
            pid = candidatePid;
          } else if (knownProjects && knownProjects.has('pj_' + candidatePid)) {
            pid = 'pj_' + candidatePid;
          }
        }
      }
    }
    if (knownUsers && !knownUsers.has(uid)) {
      for (const known of knownUsers) {
        if (!known) continue;
        if (uid.startsWith(known + '_')) {
          const rest = uid.slice(known.length + 1);
          uid = known;
          if ((!pid || (knownProjects && !knownProjects.has(pid))) && rest) {
            if (knownProjects && knownProjects.has(rest)) pid = rest;
          }
          break;
        }
      }
    }
  }
  return { uid, pid };
}

function normalizeWeeklySaveIds(uid, pid){
  let outUid = String(uid||'').trim();
  let outPid = String(pid||'').trim();
  const m = outUid.match(/^(.*)_pj_(.+)$/);
  if (m) {
    outUid = m[1];
    if (outPid && !outPid.startsWith('pj_')) {
      outPid = 'pj_' + m[2] + '_' + outPid;
    }
  }
  return { uid: outUid, pid: outPid };
}

function weeklyDomPart(s){
  // Keep ids stable and safe for querySelector/getElementById.
  return String(s ?? '').replace(/[^a-zA-Z0-9_-]/g, '_');
}

async function loadWeekly(){
  return guardRun('weekly_load', async ()=>{
    ensureWeeklyStartInput();
    const center = normalizeWeeklyStartInput();
    if(!center){ alert('週開始日を指定してください'); return; }
    await ensureAttendanceWorklogsLoaded();

    const weeks = weeklyWeeksFromCenter(center);

    Busy.push();
    try{
    const results = await Promise.all(weeks.map(ws => rpc('getWeeklyReports', ws)));
      const rowsByKey = {};
      const knownUsers = new Set(safeArr(DATA.users).map(u=>String(u.id||'').trim()).filter(Boolean));
      const knownProjects = new Set(safeArr(DATA.projects).map(p=>String(p.id||'').trim()).filter(Boolean));
      weeks.forEach((ws, i)=>{
        const rows = Array.isArray(results[i]) ? results[i] : [];
        rows.forEach(r=>{
          const normalized = normalizeWeeklyRowIds(r, knownUsers, knownProjects);
          const uid = String(normalized.uid||'').trim();
          const pid = String(normalized.pid||'').trim();
          if(!uid) return;
          rowsByKey[weeklyKey(ws, uid, pid)] = Object.assign({}, r, { weekStart: ws, userId: uid, projectId: pid });
        });
      });
      WEEKLY.centerWeekStart = center;
      WEEKLY.weeks = weeks;
      WEEKLY.rowsByKey = rowsByKey;
    }catch(e){
      console.error(e);
      try{ showToast?.('ng', '週次の読み込みに失敗しました'); }catch(_){ }
      // Avoid blank UI / infinite load loop: keep weeks state even on failure.
      WEEKLY.centerWeekStart = center;
      WEEKLY.weeks = weeks;
      WEEKLY.rowsByKey = WEEKLY.rowsByKey || {};
    }finally{
      Busy.pop();
    }
    renderWeeklyPage();
  });
}

async function saveWeeklyForUserWeek(userId, weekStart){
  // Backward compat signature kept; prefer saveWeeklyForUserProjectWeek.
  const uid = String(userId||'').trim();
  const ws = String(weekStart||'').trim();
  return saveWeeklyForUserProjectWeek(uid, '', ws);
}

async function saveWeeklyForUserProjectWeek(userId, projectId, weekStart){
  const uid = String(userId||'').trim();
  const pid = String(projectId||'').trim();
  const ws = String(weekStart||'').trim();
  return guardRun('weekly_save_' + uid + '_' + pid + '_' + ws, async ()=>{
    ensureWeeklyStartInput();
    normalizeWeeklyStartInput();
    if(!ws){ alert('週開始日が不正です'); return; }
    if(!uid){ alert('userId が不正です'); return; }

    const rawUid = uid;
    const rawPid = pid;
    const idp = weeklyDomPart(rawUid) + '_' + weeklyDomPart(rawPid) + '_' + weeklyDomPart(ws);
    const issuesEl = el('wk_issues_'+idp);
    const doneEl = el('wk_done_'+idp);
    const issues = issuesEl ? String(issuesEl.value||'') : '';
    const done = doneEl ? String(doneEl.value||'') : '';
    const normalized = normalizeWeeklySaveIds(rawUid, rawPid);
    const saveUid = normalized.uid;
    const savePid = normalized.pid;

    Busy.push();
    try{
      const saved = await rpc('upsertWeeklyReport', { weekStart: ws, userId: saveUid, projectId: savePid, issues, done });
      if (!WEEKLY.rowsByKey) WEEKLY.rowsByKey = {};
      if (rawUid !== saveUid || rawPid !== savePid) {
        delete WEEKLY.rowsByKey[weeklyKey(ws, rawUid, rawPid)];
      }
      WEEKLY.rowsByKey[weeklyKey(ws, saveUid, savePid)] = Object.assign({}, saved, { weekStart: ws, userId: saveUid, projectId: savePid });
    }finally{
      Busy.pop();
    }
  });
}

function renderWeeklyPage(){
  if (PAGE !== 'weekly') return;
  ensureWeeklyStartInput();
  const center = normalizeWeeklyStartInput();
  const weeks = weeklyWeeksFromCenter(center);
  const range = el('weekly-range');
  if (range) {
    range.textContent = `表示: ${weeklyRangeLabel(weeks[0])} / ${weeklyRangeLabel(weeks[1])} / ${weeklyRangeLabel(weeks[2])}`;
  }

  const cont = el('weekly-users');
  if (!cont) return;

  // 初回だけ自動ロード（center基準・3週分）
  const needLoad = (
    WEEKLY.centerWeekStart !== center ||
    !Array.isArray(WEEKLY.weeks) ||
    WEEKLY.weeks.length !== 3 ||
    WEEKLY.weeks.some((w,i)=>String(w||'') !== String(weeks[i]||''))
  );
  if (center && needLoad) {
    // Render skeleton immediately; refresh in background.
    cont.innerHTML = '<div class="muted">読み込み中...</div>';
    try{ loadWeekly(); }catch(_){ }
  }

  // Use the same member selection/order as attendance.
  const baseUsers = safeArr(DATA.users)
    .filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u))
    .slice()
    .sort((a,b)=>{
      const anum = String(a.employeeNumber||'').replace(/\D/g,'');
      const bnum = String(b.employeeNumber||'').replace(/\D/g,'');
      const ai = anum ? parseInt(anum,10) : Number.POSITIVE_INFINITY;
      const bi = bnum ? parseInt(bnum,10) : Number.POSITIVE_INFINITY;
      if (ai !== bi) return ai - bi;
      const an = String(a.name||a.email||a.id||'');
      const bn = String(b.name||b.email||b.id||'');
      return an.localeCompare(bn, 'ja');
    });

  ensureWeeklyFilterControls(baseUsers);
  const users = weeklyApplyFilters(baseUsers);

  const headWeeks = Array.isArray(WEEKLY.weeks) && WEEKLY.weeks.length === 3 ? WEEKLY.weeks : weeks;
  const { weekMap: wkHoursMap, totalMap: totalHoursMap } = weeklyComputeHoursMapsForWeek(headWeeks[1]);
  const thead = `
    <thead>
      <tr>
        <th class="wk-rowhead wk-sticky-1">ユーザー</th>
        <th class="wk-proj wk-sticky-2">プロジェクト</th>
        <th class="wk-week">前週 <span class="wk-sub">${escapeHtml(weeklyRangeLabel(headWeeks[0]))}</span></th>
        <th class="wk-week">今週 <span class="wk-sub">${escapeHtml(weeklyRangeLabel(headWeeks[1]))}</span></th>
        <th class="wk-week">次週 <span class="wk-sub">${escapeHtml(weeklyRangeLabel(headWeeks[2]))}</span></th>
      </tr>
    </thead>
  `;

  const activeProjects = safeArr(DATA.projects).filter(p=>String(p.status||'active').toLowerCase() !== 'archived');
  const projNameById = (pid)=>{
    if (!pid) return '（共通・その他）';
    const p = activeProjects.find(x=>String(x.id)===String(pid));
    return p ? (p.name || p.id) : String(pid);
  };
  const projById = (pid)=> activeProjects.find(x=>String(x.id)===String(pid)) || null;
  const projPriorityLabel = (pid)=> normPriority((projById(pid)?.priority)||'');
  const projPriorityClass = (pid)=>{
    const pr = projPriorityLabel(pid);
    return pr==='高' ? 'prio-high' : pr==='中' ? 'prio-mid' : pr==='低' ? 'prio-low' : '';
  };
  const projHasDoc = (pid)=> {
    const p = projById(pid);
    return !!(p && (p.docUrl || p.docID || p.docId));
  };

  const tasksAll = safeArr(DATA.tasks);
  const taskMemberIds = (t)=>{
    const out = new Set();
    const addList = (raw)=>{
      String(raw||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(v=>out.add(v));
    };
    addList(t.assignees);
    addList(t.members);
    addList(t.memberIds);
    addList(t.memberUserIds);
    const owner = String(t.ownerUserId || t.owner || '').trim();
    if (owner) out.add(owner);
    return Array.from(out);
  };

  const rows = [];
  users.forEach(u=>{
    const uid = String(u.id||'').trim();
    const uname = escapeHtml(u.name||u.email||u.id||'(unknown)');

    const openTasksForUser = tasksAll
      .filter(t => {
        const raw = String(t.status||'');
        const st = raw.toLowerCase();
        return st !== 'done' && raw !== '完了';
      })
      .filter(t => taskMemberIds(t).includes(uid));
    const projectIdsSet = new Set();
    const markProject = (pidRaw)=>{
      const pidTrim = String(pidRaw||'').trim();
      if (pidTrim) projectIdsSet.add(pidTrim);
    };
    openTasksForUser.forEach(t=>markProject(t.projectId));
    activeProjects.forEach(p=>{
      const owner = String(p.ownerUserId || p.owner || '').trim();
      const memberList = String(p.members || p.assignees || p.memberIds || '').split(',').map(s=>s.trim()).filter(Boolean);
      if (owner === uid || memberList.includes(uid)) markProject(p.id);
    });
    const collectFromMap = (map)=>{
      Object.keys(map||{}).forEach(k=>{
        const [kUid, kPid=''] = String(k||'').split('|');
        if (String(kUid) === uid) markProject(kPid);
      });
    };
    collectFromMap(wkHoursMap);
    collectFromMap(totalHoursMap);
    Object.keys(WEEKLY.rowsByKey||{}).forEach(k=>{
      const parts = String(k||'').split('|');
      if (parts.length < 3) return;
      const kUid = parts[1];
      const kPid = parts[2];
      if (String(kUid) === uid) markProject(kPid);
    });
    const priorityRank = (pid)=>{
      const pr = projPriorityLabel(pid);
      return pr === '高' ? 0 : pr === '中' ? 1 : pr === '低' ? 2 : 3;
    };
    const orderedProjectIds = [''].concat(
      Array.from(projectIdsSet).sort((a,b)=>{
        const ra = priorityRank(a);
        const rb = priorityRank(b);
        if (ra !== rb) return ra - rb;
        return projNameById(a).localeCompare(projNameById(b), 'ja');
      })
    );

    orderedProjectIds.forEach((pid, idx)=>{
      const openTasks = pid
        ? openTasksForUser.filter(t=>String(t.projectId||'')===String(pid))
        : openTasksForUser.filter(t=>!String(t.projectId||'').trim());

      const taskLines = (openTasks.length ? openTasks : [])
        .slice()
        .sort((a,b)=>String(a.dueDate||'9999-12-31').localeCompare(String(b.dueDate||'9999-12-31')))
        .slice(0, 30)
        .map(t=>{
          const due = t.dueDate ? ` [${escapeHtml(t.dueDate)}]` : '';
          const hasDoc = !!(t.docUrl || t.docID || t.docId);
          const docBtn = `<button class="secondary mini" style="margin-left:6px;" ${hasDoc?'':'disabled'} onclick="openTaskDocById('${escapeJsSq(String(t.id||''))}')">Doc</button>`;
          return `<div style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">&bull; ${escapeHtml(t.title||'')}${due} ${docBtn}</div>`;
        }).join('') || '<div class="muted" style="font-size:12px;">未完了タスクなし</div>';

      const userCell = `
        <div class="wk-user-name" style="font-weight:700;">${uname}</div>
        <div class="muted" style="font-size:12px; margin-top:2px;">未完了: ${openTasksForUser.length}</div>
      `;

      const projMemo = pid ? String((projById(pid)?.memoText)||'') : '';
      const projMemoHtml = projMemo ? `<div class="wk-proj-memo">${escapeHtml(projMemo)}</div>` : '';
      const projCell = `
        <div class="wk-proj-name">
          ${escapeHtml(projNameById(pid))}
          ${pid ? `<button class="secondary mini" style="margin-left:6px;" ${projHasDoc(pid)?'':'disabled'} onclick="openProjectDocById('${escapeJsSq(pid)}')">Doc</button>` : ''}
          ${projPriorityLabel(pid) ? `<span class="wk-prio-badge ${projPriorityClass(pid)}" style="margin-left:4px;">優先度: ${escapeHtml(projPriorityLabel(pid))}</span>` : ''}
        </div>
        <div class="muted" style="font-size:12px; margin-top:2px;">今週: ${escapeHtml(fmtHours(wkHoursMap[weeklyUserProjectKey(uid, pid)]||0))} / 累計: ${escapeHtml(fmtHours(totalHoursMap[weeklyUserProjectKey(uid, pid)]||0))}</div>
        ${projMemoHtml}
        <div style="margin-top:6px; max-height:120px; overflow:auto;">${taskLines}</div>
      `;

      const cell = (ws)=>{
        const r = weeklyRow(ws, uid, pid) || {};
        const issues = escapeHtml(String(r.issues||''));
        const done = escapeHtml(String(r.done||''));
        const idp = weeklyDomPart(uid) + '_' + weeklyDomPart(pid) + '_' + weeklyDomPart(ws);
        return `
          <div>
            <label>課題</label>
            <textarea id="wk_issues_${idp}" class="memo-edit wk-weekly-memo" rows="3" data-uid="${escapeHtml(uid)}" data-pid="${escapeHtml(pid)}" data-ws="${escapeHtml(ws)}">${issues}</textarea>
            <label style="margin-top:0px;">実施</label>
            <textarea id="wk_done_${idp}" class="memo-edit wk-weekly-memo" rows="3" data-uid="${escapeHtml(uid)}" data-pid="${escapeHtml(pid)}" data-ws="${escapeHtml(ws)}">${done}</textarea>
          </div>
        `;
      };

      rows.push(`
        <tr class="${pid ? '' : 'wk-row-common'}">
          <td class="wk-rowhead wk-sticky-1" style="vertical-align:top;">${userCell}</td>
          <td class="wk-proj wk-sticky-2 ${pid ? projPriorityClass(pid) : ''} ${pid ? '' : 'wk-proj-common'}" style="vertical-align:top;">${projCell}</td>
          <td class="wk-week" style="vertical-align:top;">${cell(headWeeks[0])}</td>
          <td class="wk-week" style="vertical-align:top;">${cell(headWeeks[1])}</td>
          <td class="wk-week" style="vertical-align:top;">${cell(headWeeks[2])}</td>
        </tr>
      `);
    });
  });

  const tbody = rows.join('');

  const table = `
    <div class="body list" style="padding:0;">
      <table id="weeklyTable" style="width:100%;">
        ${thead}
        <tbody>${tbody}</tbody>
      </table>
    </div>
  `;

  cont.innerHTML = (users.length ? table : '<div class="muted">ユーザーがありません</div>');
  try{
    cont.querySelectorAll('textarea.memo-edit').forEach(ta=>{
      const grow=()=>{
        ta.style.height='auto';
        ta.style.height = Math.max(80, ta.scrollHeight) + 'px';
      };
      ta.addEventListener('input', grow);
      grow();
    });
  }catch(_){}
  try{
    cont.querySelectorAll('textarea.wk-weekly-memo').forEach(ta=>{
      if (ta.dataset.bound==='1') return;
      ta.dataset.bound='1';
      ta.addEventListener('blur', ()=>{
        let uid = String(ta.dataset.uid||'');
        let pid = String(ta.dataset.pid||'');
        let ws = String(ta.dataset.ws||'');
        if (!uid || !ws) {
          const id = ta.id || '';
          const m = id.match(/^wk_(issues|done)_(.+)$/);
          if (!m) return;
          const parts = m[2].split('_');
          if (parts.length < 3) return;
          ws = parts.pop();
          pid = parts.pop();
          uid = parts.join('_');
        }
        if (!uid || !ws) return;
        saveWeeklyForUserProjectWeek(uid, pid, ws);
      });
    });
  }catch(_){}
  attachDefaultMemoEditors();
}

// 追加：今日を "YYYY-MM-DD" で返す
function todayStr(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// =============================
// Attendance (Vercel)
// =============================
const ATT = {
  dayRows: [],
  monthRows: [],
  settings: { holidayUrl: '', companyHolidayUrl: '' },
  holidayDates: new Set(),
  companyHolidayDates: new Set(),
  nextEventsByUser: {},
  next2EventsByUser: {},
  currentEventsByUser: {},
};

const _attSaveHintTimers = new Map(); // userId -> timeoutId

function setAttendanceSaveHint(userId, text, ok){
  try{
    const uid = String(userId||'');
    const el = document.querySelector(`#att-cards [data-att-savehint][data-att-uid="${CSS.escape(uid)}"]`);
    if(!el) return;
    el.textContent = String(text||'');
    el.style.color = ok===false ? 'var(--danger)' : '';
    const prev = _attSaveHintTimers.get(uid);
    if(prev) clearTimeout(prev);
    if (text) {
      const tid = setTimeout(()=>{
        try{
          const el2 = document.querySelector(`#att-cards [data-att-savehint][data-att-uid="${CSS.escape(uid)}"]`);
          if(el2) el2.textContent = '';
        }catch(_){ }
      }, ok===false ? 4000 : 1500);
      _attSaveHintTimers.set(uid, tid);
    }
  }catch(_){ }
}

function setAttendanceCardBusy(userId, busy){
  try{
    const uid = String(userId||'');
    const card = document.querySelector(`.att-card[data-att-card-uid="${CSS.escape(uid)}"]`);
    if(!card) return;
    card.classList.toggle('is-busy', !!busy);
    card.querySelectorAll('button,select,input,textarea').forEach(el => { el.disabled = !!busy; });
  }catch(_){ }
}

function setAttendanceRefreshBusy(busy){
  try{
    const b = document.getElementById('att_refresh_btn');
    if (b) b.disabled = !!busy;
  }catch(_){ }
}

let _attWorklogsRefreshTimer = null;
function scheduleAttendanceWorklogsRefresh(){
  try{
    if (_attWorklogsRefreshTimer) clearTimeout(_attWorklogsRefreshTimer);
    _attWorklogsRefreshTimer = setTimeout(async ()=>{
      try{
        const rows = await rpc('getAttendanceWorklogs');
        if (Array.isArray(rows)) DATA.attendanceWorklogs = rows;
      }catch(_){ }
    }, 400);
  }catch(_){ }
}

let ATT_VIEW = 'dashboard'; // 'dashboard' | 'summary'

// Default ON (can be turned off by the user)
let ATT_AUTO_REFRESH_ENABLED = true;
let ATT_AUTO_REFRESH_INTERVAL_MS = 120000; // default 120s
let ATT_AUTO_REFRESH_TIMER = null;
let ATT_WORKLOGS_LOADED = false;

const ATT_LS_AUTO_REFRESH_ENABLED = 'att_auto_refresh_enabled_v1';
const ATT_LS_AUTO_REFRESH_INTERVAL_SEC = 'att_auto_refresh_interval_sec_v1';

function persistAttendanceAutoRefreshSettings(){
  try{
    localStorage.setItem(ATT_LS_AUTO_REFRESH_ENABLED, ATT_AUTO_REFRESH_ENABLED ? '1' : '0');
    localStorage.setItem(ATT_LS_AUTO_REFRESH_INTERVAL_SEC, String(Math.round((ATT_AUTO_REFRESH_INTERVAL_MS||120000)/1000)));
  }catch(_){ }
}

function loadAttendanceAutoRefreshSettingsFromLS(){
  try{
    const e = localStorage.getItem(ATT_LS_AUTO_REFRESH_ENABLED);
    if (e === '0' || e === '1') ATT_AUTO_REFRESH_ENABLED = (e === '1');
    const secRaw = localStorage.getItem(ATT_LS_AUTO_REFRESH_INTERVAL_SEC);
    const sec = secRaw ? Number(secRaw) : NaN;
    if (Number.isFinite(sec) && sec > 0) ATT_AUTO_REFRESH_INTERVAL_MS = sec * 1000;
  }catch(_){ }
}

function isAttendanceAutoRefreshEligible(){
  return (PAGE === 'attendance' && ATT_VIEW === 'dashboard');
}

function setAttendanceAutoRefreshUi(enabled){
  const cb = document.getElementById('att_auto_refresh');
  if (cb) cb.checked = !!enabled;
}

function readAttendanceAutoRefreshIntervalFromUi(){
  const sel = document.getElementById('att_auto_interval');
  const v = sel ? Number(sel.value) : NaN;
  if (!Number.isFinite(v) || v <= 0) return;
  ATT_AUTO_REFRESH_INTERVAL_MS = v * 1000;
  persistAttendanceAutoRefreshSettings();
}

function applyAttendanceAutoRefreshIntervalToUi(){
  const sel = document.getElementById('att_auto_interval');
  if (!sel) return;
  const sec = Math.round((ATT_AUTO_REFRESH_INTERVAL_MS||120000) / 1000);
  sel.value = String(sec);
}

function startAttendanceAutoRefresh(){
  ATT_AUTO_REFRESH_ENABLED = true;
  readAttendanceAutoRefreshIntervalFromUi();
  setAttendanceAutoRefreshUi(true);
  persistAttendanceAutoRefreshSettings();

  if (ATT_AUTO_REFRESH_TIMER) {
    clearInterval(ATT_AUTO_REFRESH_TIMER);
    ATT_AUTO_REFRESH_TIMER = null;
  }

  // If not eligible, keep enabled/UI but do not start a timer.
  if (!isAttendanceAutoRefreshEligible()) return;

  // Immediate refresh on start (best-effort)
  try { refreshAttendance?.(); } catch(_){ }

  ATT_AUTO_REFRESH_TIMER = setInterval(async ()=>{
    try {
      if (!ATT_AUTO_REFRESH_ENABLED) {
        stopAttendanceAutoRefresh({ uncheck:false, reason:'disabled' });
        return;
      }
      if (!isAttendanceAutoRefreshEligible()) {
        pauseAttendanceAutoRefresh({ reason:'not-eligible' });
        return;
      }
      await refreshAttendance?.();
    } catch(_){ }
  }, ATT_AUTO_REFRESH_INTERVAL_MS);
}

function pauseAttendanceAutoRefresh({ reason='' } = {}){
  if (ATT_AUTO_REFRESH_TIMER) {
    clearInterval(ATT_AUTO_REFRESH_TIMER);
    ATT_AUTO_REFRESH_TIMER = null;
  }
  // Show warning when paused due to ineligible state
  if (reason && reason !== 'disabled') {
    const warn = document.getElementById('att-auto-warning');
    if (warn) {
      warn.style.display = '';
      warn.textContent = '自動更新が一時停止しました（画面が非表示/他タブなど）。';
    }
  }
}

function stopAttendanceAutoRefresh({ uncheck=false, reason='' } = {}){
  ATT_AUTO_REFRESH_ENABLED = false;
  pauseAttendanceAutoRefresh({ reason });
  if (uncheck) setAttendanceAutoRefreshUi(false);
  persistAttendanceAutoRefreshSettings();
}

function applyAttendanceViewUi(){
  const d = document.getElementById('att-view-tab-dashboard');
  const s = document.getElementById('att-view-tab-summary');
  if (d) d.classList.toggle('active', ATT_VIEW === 'dashboard');
  if (s) s.classList.toggle('active', ATT_VIEW === 'summary');
  const page = document.getElementById('page-attendance');
  if (page) {
    page.classList.toggle('att-layout-dashboard', ATT_VIEW === 'dashboard');
    page.classList.toggle('att-layout-summary', ATT_VIEW === 'summary');
  }
  document.querySelectorAll('#page-attendance [data-att-view]').forEach(el=>{
    const v = el.getAttribute('data-att-view');
    el.style.display = (v === ATT_VIEW) ? '' : 'none';
  });
  const warn = document.getElementById('att-auto-warning');
  if (warn) warn.style.display = 'none';
}

function setAttendanceView(view, opts){
  opts = opts || {};
  ATT_VIEW = (String(view) === 'summary') ? 'summary' : 'dashboard';
  applyAttendanceViewUi();

  // If user leaves dashboard view, stop auto-refresh.
  if (ATT_VIEW !== 'dashboard') {
    try { pauseAttendanceAutoRefresh({ reason:'view-change' }); } catch(_){ }
  }
  if (!opts.skipRoute) {
    updateRouteParams({ page:'attendance', view: ATT_VIEW, tab: null }, { replace:false });
  }
  if (PAGE === 'attendance') {
    if (ATT_VIEW === 'dashboard') {
      try { refreshAttendance?.(); } catch(_){ }
      try { if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh?.(); } catch(_){ }
    } else {
      try { loadAttendanceMonth?.(); } catch(_){ }
    }
  }
}

const fixedBreakMinutes = 90;
const defaultScheduledWorkMinutes = 450;

function normalizeWorkType(raw){
  const t = String(raw||'').trim().toLowerCase();
  if (['standard','hourly','contractor','custom'].includes(t)) return t;
  return 'standard';
}
function workTypeDefaults(type){
  const t = normalizeWorkType(type);
  if (t === 'hourly' || t === 'contractor') return { workMinutes: 0, breakMinutes: 0 };
  if (t === 'custom') return { workMinutes: defaultScheduledWorkMinutes, breakMinutes: fixedBreakMinutes };
  return { workMinutes: defaultScheduledWorkMinutes, breakMinutes: fixedBreakMinutes };
}
function parseMinutesInput(value, fallback){
  const n = Number(value);
  return Number.isFinite(n) && n >= 0 ? Math.round(n) : fallback;
}
function getUserWorkSettingsByUser(u){
  const type = normalizeWorkType(u && (u.workType || u.work_type || u.employmentType));
  const defaults = workTypeDefaults(type);
  const workMinutes = parseMinutesInput(
    u && (u.scheduledWorkMinutes ?? u.workDailyMinutes ?? u.work_minutes ?? u.workMinutes),
    defaults.workMinutes
  );
  const breakMinutes = parseMinutesInput(
    u && (u.fixedBreakMinutes ?? u.breakMinutes ?? u.fixed_break_minutes),
    defaults.breakMinutes
  );
  return { type, workMinutes, breakMinutes };
}
function getUserWorkSettings(userId){
  const u = safeArr(DATA.users).find(x=>String(x.id||'')===String(userId||''));
  return getUserWorkSettingsByUser(u);
}
const defaultHolidayIcs = 'https://www.google.com/calendar/ical/ja.japanese%23holiday%40group.v.calendar.google.com/public/basic.ics';

function parseTaxRate(input){
  const raw = String(input || '').trim();
  if (!raw) return 0;
  const n = parseFloat(raw.replace('%',''));
  if (!Number.isFinite(n)) return 0;
  return n > 1 ? (n / 100) : n;
}

function attStatusLabel(s){
  return ({'not-clocked':'未打刻', working:'出勤中', break:'休憩中', out:'外出中', done:'退勤済'})[String(s||'not-clocked')] || String(s||'');
}
function attLocLabel(l){
  return ({office:'オフィス', remote:'テレワーク', out:'外出'})[String(l||'office')] || String(l||'');
}
function attFormatTime(iso){
  if(!iso) return '--:--';
  try{ return new Date(iso).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',hour12:false}); }catch(_){ return '--:--'; }
}
function attFormatMDHM(iso){
  if(!iso) return '--/-- --:--';
  try{ return new Date(iso).toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }catch(_){ return '--/-- --:--'; }
}
function minutesBetweenIso(startIso, endIso){
  if(!startIso) return 0;
  const end = endIso ? new Date(endIso) : new Date();
  const start = new Date(startIso);
  const ms = end.getTime() - start.getTime();
  return Math.max(0, Math.round(ms / 60000));
}
function minutesToLabel(mins){
  const h = Math.floor(mins/60);
  const m = mins%60;
  return `${h}時間${m}分`;
}

function normalizeUrl(url){ return String(url||'').trim().startsWith('http') ? String(url||'').trim() : `https://${String(url||'').trim()}`; }
function buildIcsProxyUrl(targetUrl){ return `/api/ics?url=${encodeURIComponent(targetUrl)}`; }
function canonicalizeIcsUrl(raw){
  const normalized = normalizeUrl(String(raw||'').trim());
  try{
    const u = new URL(normalized);
    if (u.pathname.includes('/calendar/embed')){
      const src = u.searchParams.get('src');
      if(src){ return `https://calendar.google.com/calendar/ical/${encodeURIComponent(src)}/public/basic.ics`; }
    }
  }catch(_){ }
  return normalized;
}

function parseIcsDate(raw){
  if(!raw) return undefined;
  if (/^\d{8}$/.test(raw)){
    return new Date(`${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}T00:00:00`);
  }
  const m = String(raw).match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
  if (m){
    const [,y,mo,d,hh,mm,ss,z] = m;
    if(z){ return new Date(Date.UTC(Number(y), Number(mo)-1, Number(d), Number(hh), Number(mm), Number(ss))); }
    return new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}`);
  }
  const parsed = Date.parse(raw);
  if (isNaN(parsed)) return undefined;
  return new Date(parsed);
}

function pickNextAndCurrentEventFromIcs(text){
  const now = new Date();
  const blocks = String(text||'').split('BEGIN:VEVENT').slice(1);
  let next = null;
  let next2 = null;
  let current = null;
  blocks.forEach(block=>{
    const lines = String(block||'').split(/\r?\n/);
    const findLine = key => lines.find(l=>String(l||'').startsWith(key));
    const dtStartLine = findLine('DTSTART');
    if(!dtStartLine) return;
    const rawStart = String(dtStartLine).split(':').slice(1).join(':');
    const startDate = parseIcsDate(rawStart);
    if(!startDate || isNaN(startDate.getTime())) return;
    const dtEndLine = findLine('DTEND');
    const rawEnd = dtEndLine ? String(dtEndLine).split(':').slice(1).join(':') : '';
    const endDate = rawEnd ? parseIcsDate(rawEnd) : undefined;
    const summaryLine = findLine('SUMMARY');
    const summary = summaryLine ? String(summaryLine).split(':').slice(1).join(':') : undefined;
    const locationLine = findLine('LOCATION');
    const location = locationLine ? String(locationLine).split(':').slice(1).join(':') : undefined;
    const startIso = startDate.toISOString();
    const endIso = (endDate && !isNaN(endDate.getTime())) ? endDate.toISOString() : undefined;

    if (startDate <= now && (!endDate || endDate >= now)){
      const candidate = { start:startIso, end:endIso, summary, location };
      if(!current || new Date(candidate.start) < new Date(current.start)) current = candidate;
      return;
    }
    if (startDate > now){
      const candidate = { start:startIso, end:endIso, summary, location };
      if(!next || new Date(candidate.start) < new Date(next.start)) {
        next2 = next;
        next = candidate;
      } else if(!next2 || new Date(candidate.start) < new Date(next2.start)) {
        next2 = candidate;
      }
    }
  });
  return { next, next2, current };
}

const _icsCache = new Map(); // url -> {text, ts}
async function fetchIcsText(url){
  const raw = String(url||'').trim();
  if(!raw) throw new Error('Empty calendar URL');
  const target = canonicalizeIcsUrl(raw);
  const cached = _icsCache.get(target);
  const TTL = 5*60*1000;
  if(cached && (Date.now()-cached.ts) < TTL) return cached.text;

  const candidates = [ buildIcsProxyUrl(target), target ];
  let lastErr = null;
  for (let i=0;i<candidates.length;i++){
    const endpoint = candidates[i];
    try{
      const controller = new AbortController();
      const tid = setTimeout(()=>controller.abort(), 10000);
      const res = await fetch(endpoint, { signal: controller.signal });
      clearTimeout(tid);
      if(!res.ok) throw new Error(`ICS fetch failed: ${res.status}`);
      const text = await res.text();
      if(!String(text||'').trim()) throw new Error('ICS empty response');
      _icsCache.set(target, {text, ts: Date.now()});
      return text;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('ICS fetch failed');
}

function parseHolidayDatesFromIcs(text){
  const toLocalDateKey = d => {
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  const addDateRange = (start, endExclusive) => {
    const out=[];
    const cursor = new Date(start);
    cursor.setHours(0,0,0,0);
    const end = new Date(endExclusive);
    end.setHours(0,0,0,0);
    while(cursor < end){ out.push(toLocalDateKey(cursor)); cursor.setDate(cursor.getDate()+1); }
    return out;
  };

  const result = new Set();
  const blocks = String(text||'').split('BEGIN:VEVENT').slice(1);
  for (const block of blocks){
    const lines = String(block||'').split(/\r?\n/);
    const findLine = prefix => lines.find(l=>String(l||'').startsWith(prefix));
    const dtStartLine = findLine('DTSTART');
    if(!dtStartLine) continue;
    const startRaw = String(dtStartLine).split(':').slice(1).join(':');
    const startDate = parseIcsDate(startRaw);
    if(!startDate || isNaN(startDate.getTime())) continue;
    const dtEndLine = findLine('DTEND');
    const endRaw = dtEndLine ? String(dtEndLine).split(':').slice(1).join(':') : '';
    const endDate = endRaw ? parseIcsDate(endRaw) : undefined;
    const isAllDayStart = /^\d{8}$/.test(startRaw);
    const isAllDayEnd = /^\d{8}$/.test(endRaw);
    if(isAllDayStart && endDate && isAllDayEnd){
      for (const k of addDateRange(startDate, endDate)) result.add(k);
      continue;
    }
    result.add(toLocalDateKey(startDate));
  }
  return result;
}

const _holidayCache = new Map(); // url -> {dates:Set, ts}
async function loadHolidaySet(url){
  const raw = String(url||'').trim();
  if(!raw) return new Set();
  const target = canonicalizeIcsUrl(raw);
  const cached = _holidayCache.get(target);
  const TTL = 24*60*60*1000;
  if(cached && (Date.now()-cached.ts) < TTL) return cached.dates;
  const text = await fetchIcsText(target);
  const dates = parseHolidayDatesFromIcs(text);
  _holidayCache.set(target, {dates, ts: Date.now()});
  return dates;
}

async function refreshAttendance(){
  try{
    setAttendanceRefreshBusy(true);
    document.getElementById('att-status').textContent = '更新中...';
    const d = todayStr();
    const rows = await rpc('getAttendanceDay', d);
    ATT.dayRows = Array.isArray(rows) ? rows : [];
    document.getElementById('att-status').textContent = `取得: ${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}`;
    renderAttendancePage();
    // calendar events are best-effort and only when attendance page is open
    if (PAGE === 'attendance' && ATT_VIEW === 'dashboard') {
      await refreshAttendanceCalendars();
      renderAttendancePage();
    }
  }catch(e){
    console.error(e);
    document.getElementById('att-status').textContent = '取得エラー';
    toast('出勤状況の取得に失敗: '+(e && e.message ? e.message : e), false);
  }finally{
    setAttendanceRefreshBusy(false);
  }
}

async function loadAttendanceSettings(){
  try{
    const s = await rpc('getAttendanceSettings');
    ATT.settings = s || { holidayUrl:'', companyHolidayUrl:'' };
    if (!ATT.settings.holidayUrl) ATT.settings.holidayUrl = defaultHolidayIcs;
    const hu = document.getElementById('att_holiday_url');
    const cu = document.getElementById('att_company_holiday_url');
    if(hu) hu.value = ATT.settings.holidayUrl || '';
    if(cu) cu.value = ATT.settings.companyHolidayUrl || '';
  }catch(e){
    console.error(e);
    toast('出勤状況設定の取得に失敗: '+(e && e.message ? e.message : e), false);
  }
}

async function saveAttendanceSettings(){
  const hu = (document.getElementById('att_holiday_url')||{}).value || '';
  const cu = (document.getElementById('att_company_holiday_url')||{}).value || '';
  try{
    await rpc('setAttendanceSettings', { holidayUrl: String(hu||'').trim(), companyHolidayUrl: String(cu||'').trim() });
    await loadAttendanceSettings();
    toast('出勤状況設定を保存しました', true);
  }catch(e){
    console.error(e);
    toast('出勤状況設定の保存に失敗: '+(e && e.message ? e.message : e), false);
  }
}

function attFindRowForUser(userId){
  return (Array.isArray(ATT.dayRows)?ATT.dayRows:[]).find(r => String(r.user_id||r.user||'') === String(userId));
}

async function patchAttendance(userId, action){
  const date = todayStr();
  setAttendanceCardBusy(userId, true);
  try{
    setAttendanceSaveHint(userId, '保存中...', true);
    const saved = await rpc('patchAttendance', userId, date, action);
    // merge into ATT.dayRows
    const arr = Array.isArray(ATT.dayRows) ? ATT.dayRows.slice() : [];
    const idx = arr.findIndex(r => String(r.user_id||r.user||'') === String(userId));
    if (idx >= 0) arr[idx] = saved;
    else arr.push(saved);
    ATT.dayRows = arr;
    renderAttendancePage();
    setAttendanceSaveHint(userId, '保存しました', true);

    try{
      const werr = saved && typeof saved==='object' ? (saved._worklogSyncError || saved.worklogSyncError) : null;
      if (werr) {
        setAttendanceSaveHint(userId, '工数ログ保存失敗', false);
        toast('attendance_worklogs 保存に失敗: '+String(werr), false);
      }
    }catch(_){ }

    // Keep in-memory worklogs in sync to avoid stale open segments
    // continuing to accumulate in weekly totals/UI.
    scheduleAttendanceWorklogsRefresh();
  }catch(e){
    console.error(e);
    toast('出勤状況更新に失敗: '+(e && e.message ? e.message : e), false);
    setAttendanceSaveHint(userId, '保存失敗', false);
  }
  finally{
    setAttendanceCardBusy(userId, false);
  }
}

function isUnsetUser(u){
  const name = String((u && (u.name||u.email||u.id))||'').trim();
  return !name;
}

function isAttendanceVisibleUser(u){
  // Default: visible. Allow explicit false to hide.
  if (!u || typeof u !== 'object') return true;
  if (Object.prototype.hasOwnProperty.call(u, 'attendance_visible')) {
    const v = u.attendance_visible;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  if (Object.prototype.hasOwnProperty.call(u, 'attendanceVisible')) {
    const v = u.attendanceVisible;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  // Backward/alternate field name safety.
  if (Object.prototype.hasOwnProperty.call(u, 'showAttendance')) {
    const v = u.showAttendance;
    if (typeof v === 'boolean') return v;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (!s) return true;
      if (['false','0','no','off'].includes(s)) return false;
      if (['true','1','yes','on'].includes(s)) return true;
      return true;
    }
    return v !== false;
  }
  return true;
}

function renderAttendanceUserSettings(){
  // Attendance tab no longer shows per-user settings.
  return;
}

function renderAttendancePage(){
  if (PAGE !== 'attendance') return;
  if (ATT_VIEW !== 'dashboard') return;
  const label = document.getElementById('att-today-label');
  if(label) label.textContent = todayStr();

  const wrap = document.getElementById('att-cards');
  if(!wrap) return;
  wrap.innerHTML = '';

  const users = safeArr(DATA.users)
    .filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u))
    .slice()
    .sort((a,b)=>{
      const anum = String(a.employeeNumber||'').replace(/\D/g,'');
      const bnum = String(b.employeeNumber||'').replace(/\D/g,'');
      const ai = anum ? parseInt(anum,10) : Number.POSITIVE_INFINITY;
      const bi = bnum ? parseInt(bnum,10) : Number.POSITIVE_INFINITY;
      if (ai !== bi) return ai - bi;
      const an = String(a.name||a.email||a.id||'');
      const bn = String(b.name||b.email||b.id||'');
      return an.localeCompare(bn, 'ja');
    });
  users.forEach(u=>{
    const uid = u.id;
    const row = attFindRowForUser(uid) || { user_id: uid, status:'not-clocked', location:'office', breaks:[], clock_in:'', clock_out:'', notes:'', project_id:'', task_id:'' };
    const status = String(row.status||'not-clocked');
    const location = String(row.location||'office');
    const clockIn = row.clock_in || '';
    const clockOut = row.clock_out || '';
    const worked = computeWorkedMinutes(row, uid);
    const grossMinutes = row.clock_in ? minutesBetweenIso(row.clock_in, row.clock_out) : 0;
    const workSettings = getUserWorkSettings(uid);
    const breakMinutes = row.clock_in ? (computeBreakMinutes(row) + (workSettings.breakMinutes || 0)) : 0;
    const workedLabel = row.clock_in
      ? `本日${minutesToLabel(grossMinutes)}(うち休憩${minutesToLabel(breakMinutes)})`
      : '';

    const currentEvent = (ATT.currentEventsByUser && ATT.currentEventsByUser[uid]) || null;
    const nextEvent = (ATT.nextEventsByUser && ATT.nextEventsByUser[uid]) || null;
    const next2Event = (ATT.next2EventsByUser && ATT.next2EventsByUser[uid]) || null;

    const avatarHue = (function(){
      // deterministic hue from id
      const s = String(uid||'');
      let h = 0;
      for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) % 360;
      return h;
    })();
    const tone = (function(){
      if(status==='working') return 'green';
      if(status==='break' || status==='out') return 'yellow';
      if(status==='done') return 'gray';
      return 'red';
    })();
    const stateClass = (function(){
      if(status==='done') return 'card-state-done';
      if(status==='not-clocked') return 'card-state-not-clocked';
      if(status==='out' || status==='break') return 'card-state-event';
      if(status==='working' && location==='remote') return 'card-state-working-remote';
      if(status==='working' && location==='office') return 'card-state-working-office';
      return 'card-state-not-clocked';
    })();

    const card = document.createElement('div');
    card.className = `card att-card ${stateClass}`;
    card.setAttribute('data-att-card-uid', uid);
    const projId = String(row.project_id||'');
    const taskId = String(row.task_id||'');

    // プロジェクト選択: 担当プロジェクトを優先的に並べる
    const userProjectSet = new Set(
      safeArr(DATA.tasks)
        .filter(t => String(t.assignees||'').split(',').map(s=>s.trim()).includes(uid))
        .map(t => String(t.projectId||'').trim())
        .filter(Boolean)
    );
    const projectList = safeArr(DATA.projects)
      .filter(p=>String(p.status||'active')!=='archived')
      .slice()
      .sort((a,b)=>{
        const afav = userProjectSet.has(String(a.id||''));
        const bfav = userProjectSet.has(String(b.id||''));
        if (afav !== bfav) return afav ? -1 : 1;
        return String(a.name||a.id||'').localeCompare(String(b.name||b.id||''),'ja');
      });
    const projOptions = ['<option value="">（未指定）</option>']
      .concat(projectList
        .map(p=>`<option value="${escapeHtml(p.id)}" ${String(p.id)===projId?'selected':''}>${escapeHtml(p.name||p.id)}</option>`));

    const tasks = safeArr(DATA.tasks);
    const taskFiltered = (projId ? tasks.filter(t=>String(t.projectId||'')===projId) : tasks)
      // Exclude completed tasks from selection.
      // If the currently selected task is already completed, keep it visible (disabled)
      // so the UI doesn't lose the current value.
      .filter(t=>{
        const tid = String(t.id||'');
        const st = String(t.status||'').toLowerCase();
        if (tid && tid === taskId) return true;
        return st !== 'done';
      });

    const taskOptions = ['<option value="">（未指定）</option>']
      .concat(taskFiltered.map(t=>{
        const tid = String(t.id||'');
        const st = String(t.status||'').toLowerCase();
        const isSelected = (tid === taskId);
        const isDoneSelected = isSelected && st === 'done';
        const title = String(t.title||t.id||'');
        const label = isDoneSelected ? `${title}（完了）` : title;
        return `<option value="${escapeHtml(t.id)}" ${isSelected?'selected':''} ${isDoneSelected?'disabled':''}>${escapeHtml(label)}</option>`;
      }));

    const projName = projId ? (safeArr(DATA.projects).find(p=>String(p.id)===projId)?.name || projId) : '';
    const taskName = taskId ? (tasks.find(t=>String(t.id)===taskId)?.title || taskId) : '';

    const curLabel = currentEvent ? `${currentEvent.summary||'(予定)'} ${attFormatMDHM(currentEvent.start)}` : '-';
    const nextLabel = nextEvent ? `${nextEvent.summary||'(予定)'} ${attFormatMDHM(nextEvent.start)}` : '-';
    const next2Label = next2Event ? `${next2Event.summary||'(予定)'} ${attFormatMDHM(next2Event.start)}` : '-';
    const roleLabel = String(u.role||'').trim();

    const breakBtnLabel = status==='break' ? '休憩戻り' : '休憩';
    const outBtnLabel = status==='out' ? '外出戻り' : '外出';
    // Allow re-pressing clock-in buttons to switch location while working.
    // Keep disabled during break/out to avoid surprising state changes.
    const canClockIn = (status==='not-clocked' || status==='done' || status==='working');
    const clockOutBtnLabel = status==='done' ? '退勤取消' : '退勤';

    const clockOfficeLabel = (status==='working') ? '切替(オフィス)' : '出勤(オフィス)';
    const clockRemoteLabel = (status==='working') ? '切替(テレワーク)' : '出勤(テレワーク)';
    const clockOutLocLabel = (status==='working') ? '切替(外出)' : '出勤(外出)';

    card.innerHTML = `
      <div class="body">
        <div class="att-line">
          <div class="att-avatar" style="background: hsl(${avatarHue} 70% 45%);"></div>
          <div class="att-person">
            <span class="att-name">${escapeHtml(u.name||u.email||u.id)}</span>
            <span class="att-role">${escapeHtml(roleLabel)}</span>
          </div>
          <span class="att-k">勤務場所</span><span class="att-v">${escapeHtml(attLocLabel(location))}</span>
          <span class="att-k">出勤</span><span class="att-v">${escapeHtml(attFormatTime(clockIn))}</span>
          <span class="att-k">退勤</span><span class="att-v">${escapeHtml(attFormatTime(clockOut))}</span>
          <span class="att-k">勤務時間</span><span class="att-v">${escapeHtml(workedLabel)}</span>
          <span class="att-status-pill tone-${tone}">${escapeHtml(attStatusLabel(status))}</span>
        </div>

        <div class="att-line">
          <span class="att-k">プロジェクト:</span>
          <select class="att-ctl wide" data-att-uid="${escapeHtml(uid)}" data-att-field="project">${projOptions.join('')}</select>
          <span class="att-k">タスク:</span>
          <select class="att-ctl wide" data-att-uid="${escapeHtml(uid)}" data-att-field="task">${taskOptions.join('')}</select>
          <span class="att-k">操作</span>
          <div class="att-actions">
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInOffice" ${canClockIn?'':'disabled'}>${escapeHtml(clockOfficeLabel)}</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInRemote" ${canClockIn?'':'disabled'}>${escapeHtml(clockRemoteLabel)}</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="clockInOut" ${canClockIn?'':'disabled'}>${escapeHtml(clockOutLocLabel)}</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="toggleBreak">${escapeHtml(breakBtnLabel)}</button>
            <button class="secondary" data-att-uid="${escapeHtml(uid)}" data-att-action="toggleOut">${escapeHtml(outBtnLabel)}</button>
            <button data-att-uid="${escapeHtml(uid)}" data-att-action="clockOut">${escapeHtml(clockOutBtnLabel)}</button>
          </div>
        </div>

        <div class="att-line">
          <span class="att-k">現在の予定:</span>
          <span class="att-muted">${escapeHtml(curLabel)}</span>
          <span class="att-k">次の予定:</span>
          <span class="att-muted">${escapeHtml(nextLabel)}</span>
          <span class="att-k">次の次の予定:</span>
          <span class="att-muted">${escapeHtml(next2Label)}</span>
          <span class="att-muted" data-att-savehint="1" data-att-uid="${escapeHtml(uid)}"></span>
          <span class="att-k">メモ:</span>
          <input class="att-ctl" data-att-uid="${escapeHtml(uid)}" data-att-field="notes" value="${escapeHtml(row.notes||'')}" placeholder=""/>
        </div>
      </div>
    `;

    // Wire events
    card.querySelectorAll('button[data-att-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const action = btn.getAttribute('data-att-action');
        if(action==='clockInOffice'){
          patchAttendance(uid, { type:'clockIn', location:'office' });
        }else if(action==='clockInRemote'){
          patchAttendance(uid, { type:'clockIn', location:'remote' });
        }else if(action==='clockInOut'){
          patchAttendance(uid, { type:'clockIn', location:'out' });
        }else if(action==='clockOut'){
          patchAttendance(uid, { type:'clockOut' });
        }else if(action==='toggleBreak'){
          patchAttendance(uid, { type:'toggleBreak' });
        }else if(action==='toggleOut'){
          patchAttendance(uid, { type:'toggleOut' });
        }
      });
    });
    const projSel = card.querySelector('select[data-att-field="project"]');
    const taskSel = card.querySelector('select[data-att-field="task"]');
    if(projSel){
      projSel.addEventListener('change', ()=>{
        // when project changes, clear task selection
        const pid = projSel.value || '';
        if(taskSel) taskSel.value = '';
        patchAttendance(uid, { type:'setProjectTask', projectId: pid, taskId: '' });
        // re-render to filter task options
        setTimeout(()=>{ renderAttendancePage(); }, 0);
      });
    }
    if(taskSel){
      taskSel.addEventListener('change', ()=>{
        const pid = projSel ? (projSel.value||'') : '';
        const tid = taskSel.value || '';
        patchAttendance(uid, { type:'setProjectTask', projectId: pid, taskId: tid });
      });
    }
    const notesInp = card.querySelector('input[data-att-field="notes"]');
    if(notesInp){
      let t=null;
      notesInp.addEventListener('input', ()=>{
        if(t) clearTimeout(t);
        t = setTimeout(()=>{ patchAttendance(uid, { type:'setNotes', notes: notesInp.value }); }, 600);
      });
    }

    wrap.appendChild(card);
  });

  // init month picker default
  const mi = document.getElementById('att_month');
  if(mi && !mi.value){ mi.value = todayStr().slice(0,7); }
}

async function refreshAttendanceCalendars(){
  const users = safeArr(DATA.users).filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u));
  const nextMap = {};
  const next2Map = {};
  const currentMap = {};
  await Promise.all(users.map(async u=>{
    const url = String(u.calendarUrl||'').trim();
    if(!url){ nextMap[u.id]=null; next2Map[u.id]=null; currentMap[u.id]=null; return; }
    try{
      const text = await fetchIcsText(url);
      const r = pickNextAndCurrentEventFromIcs(text);
      nextMap[u.id] = r.next;
      next2Map[u.id] = r.next2;
      currentMap[u.id] = r.current;
    }catch(_){ nextMap[u.id]=null; next2Map[u.id]=null; currentMap[u.id]=null; }
  }));
  ATT.nextEventsByUser = nextMap;
  ATT.next2EventsByUser = next2Map;
  ATT.currentEventsByUser = currentMap;
}

async function loadAttendanceMonth(){
  const mi = document.getElementById('att_month');
  const month = mi && mi.value ? mi.value : todayStr().slice(0,7);
  try{
    const rows = await rpc('getAttendanceMonth', month);
    ATT.monthRows = Array.isArray(rows) ? rows : [];
    renderAttendanceMonthTable(month);
    renderAttendanceWeekTable(month);
    toast('月次データを読み込みました', true);
  }catch(e){
    console.error(e);
    toast('月次データの取得に失敗: '+(e && e.message ? e.message : e), false);
  }
}

function renderAttendanceMonthTable(month){
  const tb = document.querySelector('#att-month-table tbody');
  if(!tb) return;
  tb.innerHTML='';
  const rows = safeArr(ATT.monthRows).slice().sort((a,b)=>{
    const da = String(a.work_date||'');
    const db = String(b.work_date||'');
    if(da!==db) return da.localeCompare(db);
    return String(a.user_id||'').localeCompare(String(b.user_id||''));
  });
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const uid = String(r.user_id||r.user||'');
    const uname = nameByUserId(uid);
    const worked = (r.clock_in && r.clock_out) ? computeWorkedMinutes(r, uid) : 0;
    const projName = r.project_id ? (safeArr(DATA.projects).find(p=>String(p.id)===String(r.project_id))?.name || r.project_id) : '';
    const taskName = r.task_id ? (safeArr(DATA.tasks).find(t=>String(t.id)===String(r.task_id))?.title || r.task_id) : '';
    const pt = projName && taskName ? `${projName} / ${taskName}` : (projName || taskName || '');
    tr.innerHTML = `
      <td>${escapeHtml(r.work_date||'')}</td>
      <td>${escapeHtml(uname||uid)}</td>
      <td>${escapeHtml(attStatusLabel(r.status||''))}</td>
      <td>${escapeHtml(attFormatTime(r.clock_in))}</td>
      <td>${escapeHtml(attFormatTime(r.clock_out))}</td>
      <td>${escapeHtml(worked?minutesToLabel(worked):'')}</td>
      <td>${escapeHtml(pt)}</td>
    `;
    tb.appendChild(tr);
  });
  const summary = document.getElementById('att-month-summary');
  if(summary){
    summary.textContent = `${month} / 記録 ${rows.length}件`;
  }
}

function mondayStart(dateKey){
  const d = new Date(`${dateKey}T00:00:00`);
  const dow = d.getDay(); // 0 Sun
  const diff = (dow + 6) % 7; // Mon=0
  d.setDate(d.getDate() - diff);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function addDaysKey(dateKey, add){
  const d = new Date(`${dateKey}T00:00:00`);
  d.setDate(d.getDate() + Number(add||0));
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function renderAttendanceWeekTable(month){
  const tb = document.querySelector('#att-week-table tbody');
  if(!tb) return;
  tb.innerHTML = '';

  const rows = safeArr(ATT.monthRows).slice();
  const groups = new Map(); // key -> {weekStart, weekEnd, userId, days, minutes}
  rows.forEach(r=>{
    const dateKey = String(r.work_date||'');
    if(!dateKey || dateKey.slice(0,7)!==String(month||'')) return;
    const uid = String(r.user_id||r.user||'');
    if(!uid) return;
    const worked = (r.clock_in && r.clock_out) ? computeWorkedMinutes(r, uid) : 0;
    if(worked<=0) return;
    const ws = mondayStart(dateKey);
    const we = addDaysKey(ws, 6);
    const key = `${ws}|${uid}`;
    const prev = groups.get(key) || { weekStart: ws, weekEnd: we, userId: uid, days: 0, minutes: 0 };
    prev.days += 1;
    prev.minutes += worked;
    groups.set(key, prev);
  });

  const list = Array.from(groups.values()).sort((a,b)=>{
    if(a.weekStart!==b.weekStart) return String(a.weekStart).localeCompare(String(b.weekStart));
    return nameByUserId(a.userId).localeCompare(nameByUserId(b.userId));
  });

  list.forEach(g=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(g.weekStart)}</td>
      <td>${escapeHtml(g.weekEnd)}</td>
      <td>${escapeHtml(nameByUserId(g.userId) || g.userId)}</td>
      <td>${escapeHtml(String(g.days))}</td>
      <td>${escapeHtml(minutesToLabel(Math.round(g.minutes)))}</td>
    `;
    tb.appendChild(tr);
  });

  const summary = document.getElementById('att-week-summary');
  if(summary){
    summary.textContent = `${month} / 週次 ${list.length}件`;
  }
}

function overlapMinutes(aStart, aEnd, bStart, bEnd){
  const start = Math.max(aStart.getTime(), bStart.getTime());
  const end = Math.min(aEnd.getTime(), bEnd.getTime());
  if(end <= start) return 0;
  return (end-start)/60000;
}
function subtractInterval(interval, cut){
  const s=interval[0], e=interval[1];
  const cs=cut[0], ce=cut[1];
  if(ce<=s || cs>=e) return [interval];
  const out=[];
  const leftEnd = new Date(Math.min(cs.getTime(), e.getTime()));
  if(leftEnd > s) out.push([s, leftEnd]);
  const rightStart = new Date(Math.max(ce.getTime(), s.getTime()));
  if(e > rightStart) out.push([rightStart, e]);
  return out;
}
function computeWorkIntervals(att){
  if(!att.clock_in) return [];
  const start = new Date(att.clock_in);
  const end = new Date(att.clock_out || new Date().toISOString());
  if(!(end > start)) return [];
  let intervals=[[start,end]];
  const br = Array.isArray(att.breaks) ? att.breaks : [];
  for (const b of br){
    if(!b || !b.start) continue;
    const bStart = new Date(b.start);
    const bEnd = new Date(b.end || new Date().toISOString());
    if(!(bEnd > bStart)) continue;

    // 12:00-13:00 は固定休憩として別途控除しているため、そこに重なる部分は二重控除しない
    const lunchStart = new Date(bStart);
    lunchStart.setHours(12,0,0,0);
    const lunchEnd = new Date(bStart);
    lunchEnd.setHours(13,0,0,0);

    // breakSegments: 昼休みを除外した休憩区間（0?2区間）
    const segments = subtractInterval([bStart, bEnd], [lunchStart, lunchEnd]);
    for (const seg of segments){
      const segStart = seg[0], segEnd = seg[1];
      if (!(segEnd > segStart)) continue;
      intervals = intervals.flatMap(iv => subtractInterval(iv, [segStart, segEnd]));
      if(intervals.length===0) break;
    }
    if(intervals.length===0) break;
  }
  return intervals.filter(iv=>iv[1]>iv[0]);
}
function computeBreakMinutes(att){
  if(!att) return 0;
  const br = Array.isArray(att.breaks) ? att.breaks : [];
  let total = 0;
  for (const b of br){
    if(!b || !b.start) continue;
    const bStart = new Date(b.start);
    const bEnd = new Date(b.end || new Date().toISOString());
    if(!(bEnd > bStart)) continue;

    const lunchStart = new Date(bStart);
    lunchStart.setHours(12,0,0,0);
    const lunchEnd = new Date(bStart);
    lunchEnd.setHours(13,0,0,0);

    const segments = subtractInterval([bStart, bEnd], [lunchStart, lunchEnd]);
    for (const seg of segments){
      const segStart = seg[0], segEnd = seg[1];
      if (!(segEnd > segStart)) continue;
      total += (segEnd.getTime() - segStart.getTime()) / 60000;
    }
  }
  return Math.max(0, Math.round(total));
}
function computeWorkedMinutes(att, userId){
  if(!att || !att.clock_in) return 0;
  const intervals = computeWorkIntervals(att);
  const total = intervals.reduce((sum, iv)=> sum + ((iv[1]-iv[0]) / 60000), 0);
  const work = getUserWorkSettings(userId);
  const breakMin = (work && Number.isFinite(work.breakMinutes)) ? work.breakMinutes : fixedBreakMinutes;
  return Math.max(0, Math.round(total - breakMin));
}
function computeNightMinutes(att){
  const intervals = computeWorkIntervals(att);
  let total=0;
  for (const iv of intervals){
    const start=iv[0], end=iv[1];
    const cursor = new Date(start);
    cursor.setHours(0,0,0,0);
    while(cursor < end){
      const dayStart = new Date(cursor);
      const nextDayStart = new Date(dayStart); nextDayStart.setDate(nextDayStart.getDate()+1);
      const night1Start = new Date(dayStart); night1Start.setHours(0,0,0,0);
      const night1End = new Date(dayStart); night1End.setHours(5,0,0,0);
      const night2Start = new Date(dayStart); night2Start.setHours(22,0,0,0);
      const night2End = new Date(nextDayStart);
      total += overlapMinutes(start, end, night1Start, night1End);
      total += overlapMinutes(start, end, night2Start, night2End);
      cursor.setDate(cursor.getDate()+1);
      cursor.setHours(0,0,0,0);
    }
  }
  return Math.round(total);
}

function isScheduledWorkday(dateKey, holidaySet, companyHolidaySet){
  const date = new Date(`${dateKey}T00:00:00`);
  const dow = date.getDay();
  if(dow===0 || dow===6) return false;
  if(holidaySet && holidaySet.has(dateKey)) return false;
  if(companyHolidaySet && companyHolidaySet.has(dateKey)) return false;
  return true;
}

async function exportFreeeAttendanceCsv(){
  const mi = document.getElementById('att_month');
  const month = mi && mi.value ? mi.value : todayStr().slice(0,7);

  // Ensure month data loaded
  if(!Array.isArray(ATT.monthRows) || !ATT.monthRows.length || String(ATT.monthRows[0].work_date||'').slice(0,7)!==month){
    await loadAttendanceMonth();
  }

  try{
    // Settings & holiday feeds
    if(!ATT.settings || !ATT.settings.holidayUrl){ await loadAttendanceSettings(); }
    const holidayUrl = (ATT.settings && ATT.settings.holidayUrl) ? ATT.settings.holidayUrl : defaultHolidayIcs;
    const companyHolidayUrl = (ATT.settings && ATT.settings.companyHolidayUrl) ? ATT.settings.companyHolidayUrl : '';
    const [holidaySet, companySet] = await Promise.all([
      loadHolidaySet(holidayUrl),
      companyHolidayUrl ? loadHolidaySet(companyHolidayUrl) : Promise.resolve(new Set()),
    ]);
    ATT.holidayDates = holidaySet;
    ATT.companyHolidayDates = companySet;

    const freeeHeaders = [
      '従業員番号','氏名','所定労働時間（分）','法定内残業時間（分）','時間外労働時間（分）','所定休日労働時間（分）','深夜労働時間（分）','法定休日労働時間（分）','総労働時間（分）','総労働日数','所定労働出勤日数','所定休日出勤日数','法定休日出勤日数','遅刻時間（分）','早退時間（分）','欠勤日数','遅刻日数','早退日数','有休取得日数','集計開始日','集計終了日','みなし外の法定内残業時間（分）','みなし外の時間外労働時間（分）','不足時間（分）'
    ];
    const csvEscape = (value) => {
      const raw = (value===null||value===undefined) ? '' : String(value);
      if(raw.includes('"') || raw.includes(',') || raw.includes('\n') || raw.includes('\r')) return '"'+raw.replaceAll('"','""')+'"';
      return raw;
    };

    const monthStart = new Date(`${month}-01T00:00:00`);
    const monthEnd = new Date(monthStart);
    monthEnd.setMonth(monthEnd.getMonth()+1);
    monthEnd.setDate(0);
    monthEnd.setHours(0,0,0,0);

    const toDateKey = (d) => {
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };
    const formatYmdSlash = (dateKey) => {
      const parts = dateKey.split('-').map(v=>Number(v));
      return `${parts[0]}/${parts[1]}/${parts[2]}`;
    };

    let scheduledWorkdayCount = 0;
    for(let d=new Date(monthStart); d<=monthEnd; d.setDate(d.getDate()+1)){
      if(isScheduledWorkday(toDateKey(d), holidaySet, companySet)) scheduledWorkdayCount += 1;
    }

    const users = safeArr(DATA.users).filter(u=>!isUnsetUser(u) && isAttendanceVisibleUser(u));
    // Group attendance by user
    const byUser = {};
    safeArr(ATT.monthRows).forEach(r=>{
      const uid = String(r.user_id||r.user||'');
      if(!uid) return;
      if(!byUser[uid]) byUser[uid] = [];
      byUser[uid].push(r);
    });

    const lines = users.map(u=>{
      const uid = String(u.id);
      const items = (byUser[uid]||[]).slice().sort((a,b)=>String(a.work_date||'').localeCompare(String(b.work_date||'')));
      const workedByDay = new Map();
      items.forEach(att=>{
        const dateKey = String(att.work_date||'');
        if(!dateKey) return;
        const workedMinutes = (att.clock_in && att.clock_out) ? computeWorkedMinutes(att, uid) : 0;
        const nightMinutes = computeNightMinutes(att);
        const prev = workedByDay.get(dateKey);
        if(!prev) workedByDay.set(dateKey, { workedMinutes, nightMinutes });
        else workedByDay.set(dateKey, { workedMinutes: prev.workedMinutes + workedMinutes, nightMinutes: prev.nightMinutes + nightMinutes });
      });

      let totalWorkMinutes=0;
      let totalNightMinutes=0;
      let totalWorkDays=0;
      let scheduledWorkAttendanceDays=0;
      let prescribedHolidayAttendanceDays=0;
      let legalHolidayAttendanceDays=0;

      for (const [dateKey, day] of workedByDay.entries()){
        if(day.workedMinutes <= 0) continue;
        totalWorkMinutes += day.workedMinutes;
        totalNightMinutes += day.nightMinutes;
        totalWorkDays += 1;
        const date = new Date(`${dateKey}T00:00:00`);
        const dow = date.getDay();
        const scheduled = isScheduledWorkday(dateKey, holidaySet, companySet);
        if(scheduled) scheduledWorkAttendanceDays += 1;
        else if(dow===0) legalHolidayAttendanceDays += 1;
        else prescribedHolidayAttendanceDays += 1;
      }

      const work = getUserWorkSettingsByUser(u);
      const scheduledDaily = Number(work.workMinutes || 0);
      const scheduledWorkMinutes = scheduledDaily * scheduledWorkdayCount;
      const overtimeMinutes = scheduledDaily > 0 ? Math.max(0, totalWorkMinutes - scheduledWorkMinutes) : 0;
      const shortageMinutes = scheduledDaily > 0 ? Math.max(0, scheduledWorkMinutes - totalWorkMinutes) : 0;

      const startKey = toDateKey(monthStart);
      const endKey = toDateKey(monthEnd);

      const row = [
        u.employeeNumber || '',
        (u.name||u.email||u.id),
        scheduledWorkMinutes,
        '',
        overtimeMinutes,
        '',
        totalNightMinutes,
        '',
        totalWorkMinutes,
        totalWorkDays,
        scheduledWorkAttendanceDays,
        prescribedHolidayAttendanceDays,
        legalHolidayAttendanceDays,
        '', '', '', '', '', '',
        formatYmdSlash(startKey),
        formatYmdSlash(endKey),
        '', '',
        shortageMinutes,
      ];
      return row.map(v=>csvEscape(v)).join(',');
    });

    const csv = [freeeHeaders.map(h=>csvEscape(h)).join(','), ...lines].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `freee-attendance-${month}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    console.error(e);
    toast('freee CSV出力に失敗: '+(e && e.message ? e.message : e), false);
  }
}

// Attendance init hooks (load settings, poll only on attendance page)
window.addEventListener('load', ()=>{
  try{
    // Dashboard task tabs (list/board/gantt) - ensure click handlers are bound.
    try { bindDashboardTabs?.(); } catch(_){ }

    try { syncStickyOffsets(); } catch(_){ }
    try { window.addEventListener('resize', ()=>{ try { syncStickyOffsets(); } catch(_){ } }); } catch(_){ }

    const mi = document.getElementById('att_month');
    if(mi && !mi.value) mi.value = todayStr().slice(0,7);
    loadAttendanceSettings();

    // Auto-refresh UI (default ON)
    try {
      loadAttendanceAutoRefreshSettingsFromLS();
      applyAttendanceAutoRefreshIntervalToUi();

      // reflect current state
      setAttendanceAutoRefreshUi(ATT_AUTO_REFRESH_ENABLED);

      const cb = document.getElementById('att_auto_refresh');
      const sel = document.getElementById('att_auto_interval');

      if (sel) sel.addEventListener('change', ()=>{
        readAttendanceAutoRefreshIntervalFromUi();
        if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh();
      });

      if (cb) cb.addEventListener('change', ()=>{
        if (cb.checked) {
          startAttendanceAutoRefresh();
        } else {
          stopAttendanceAutoRefresh({ uncheck:false, reason:'unchecked' });
        }
        persistAttendanceAutoRefreshSettings();
      });

      document.addEventListener('visibilitychange', ()=>{
        if (document.hidden) {
          pauseAttendanceAutoRefresh({ reason:'hidden' });
        } else {
          try { if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh?.(); } catch(_){ }
        }
      });
      window.addEventListener('beforeunload', ()=>{
        stopAttendanceAutoRefresh({ uncheck:false, reason:'unload' });
      });

      // best-effort start (will no-op unless eligible)
      try { if (ATT_AUTO_REFRESH_ENABLED) startAttendanceAutoRefresh?.(); } catch(_){ }
    } catch(_){ }
  }catch(_){ }
});


function bindDashboardTabs(){
  const defs = [
    ['tab-list','list'],
    ['tab-board','board'],
    ['tab-gantt','gantt'],
  ];
  defs.forEach(([id, tab])=>{
    const el = document.getElementById(id);
    if (!el) return;
    // Avoid duplicate binding in case of multiple init paths.
    if (el.dataset && el.dataset.boundSwitchTab === '1') return;
    if (el.dataset) el.dataset.boundSwitchTab = '1';
    el.addEventListener('click', (e)=>{
      try { e.preventDefault?.(); } catch(_){ }
      try { switchTab(tab); } catch(_){ }
    });
  });
}

// タブ切替（list/board/gantt）
function switchTab(tab) {
  // 旧版の挙動に寄せて、
  // 1) 表示切替
  // 2) 必要な再描画（list/board/gantt）
  // 3) 状態保存（hash / query）
  // を確実に実行する。

  tab = (tab === 'board' || tab === 'gantt') ? tab : 'list';
  ACTIVE_TAB = tab;

  // もしダッシュボード以外から呼ばれたら、見えるページへ移動してから切替
  // （ショートカット/URL反映などの導線で「切替したのに見えない」を防ぐ）
  try {
    if (typeof PAGE === 'string' && PAGE !== 'dashboard') {
      try { gotoDashboardTab?.(tab); } catch(_){ }
      // gotoDashboardTab 内で再度 switchTab されるのでここで終了
      return;
    }
  } catch(_){ }

  const tl = document.getElementById('tab-list');
  const tb = document.getElementById('tab-board');
  const tg = document.getElementById('tab-gantt');
  if (tl) tl.classList.toggle('active', tab==='list');
  if (tb) tb.classList.toggle('active', tab==='board');
  if (tg) tg.classList.toggle('active', tab==='gantt');

  const vl = document.getElementById('view-list');
  const vb = document.getElementById('view-board');
  const vg = document.getElementById('view-gantt');
  if (vl) vl.style.display = (tab==='list')  ? '' : 'none';
  if (vb) vb.style.display = (tab==='board') ? '' : 'none';
  if (vg) vg.style.display = (tab==='gantt') ? '' : 'none';

  try {
    // list: 一覧を確実に更新
    if (tab === 'list') {
      try { renderTasksTable?.(); } catch(_){ }
    }

    // board: カンバンを確実に更新
    // 旧版同様、タブ切替時に必ず再描画して整合を取る
    try { renderKanban?.(); } catch(_){ }

    // gantt: 選択時に必ず今日始まりデフォルトへ
    if (tab === 'gantt') {
      try { renderGantt?.(true); } catch(_){ }
    }
  } catch(_){ }

  if (tab !== 'gantt'){
    const gc = document.getElementById('gantt-container');
    if (gc) gc.innerHTML = '';
  }

  try { updateHashFromState(); } catch(_){ }
}

function setHashSilently(hashText){
  try{
    const url = new URL(location.href);
    const h = String(hashText || '').replace(/^#/, '');
    url.hash = h ? ('#' + h) : '';
    history.replaceState(history.state || {}, '', url.pathname + url.search + url.hash);
  }catch(_){ }
}

function updateHashFromState(){
  const qs = new URLSearchParams();
  qs.set('tab', ACTIVE_TAB);
  Object.entries(FILTERS).forEach(([k,v])=>{ if(v) qs.set(k, v); });
  if (OVERDUE) qs.set('overdue','1');
  // Avoid hashchange recursion / history spam; still updates URL for copy/bookmark.
  setHashSilently(qs.toString());
}

function applyHash(){
  // Hash state is used for dashboard task filters/tabs.
  // Never apply it on other pages (e.g., attendance) to avoid unintended redirects.
  try { if (PAGE !== 'dashboard') return; } catch(_){ }
  const raw = location.hash.replace(/^#/,''); if(!raw) return;
  const p = new URLSearchParams(raw);
  const tab = p.get('tab'); if(tab) switchTab(tab);

  ['keyword','project','assignee','department','from','to','priority','status'].forEach(k=>{
    const v = p.get(k)||''; if(v){ FILTERS[k]=v; const id='f_'+(k==='keyword'?'keyword':k); const e=el(id); if(e) e.value=v; }
  });
  OVERDUE = p.get('overdue')==='1';
}

window.addEventListener('hashchange', ()=>{
  try{ if (PAGE !== 'dashboard') return; }catch(_){ return; }
  applyHash();
  renderTasksTable();
  renderKanban();
  renderProjects();
  if (ACTIVE_TAB==='gantt') renderGantt();
});

// filters
function applyFilters() {
  FILTERS = {
    keyword: document.getElementById('f_keyword').value.trim(),
    project: document.getElementById('f_project').value,
    assignee: document.getElementById('f_assignee').value,
    department: document.getElementById('f_department').value,
    from: document.getElementById('f_from').value,
    to: document.getElementById('f_to').value,
    priority: document.getElementById('f_priority').value,
    status: document.getElementById('f_status').value
  };
  renderTasksTable();
  renderKanban();
  renderProjects();
  if (ACTIVE_TAB==='gantt') renderGantt();
  saveFiltersToLS();
  updateHashFromState();
}
function quickOverdue(){
  OVERDUE = true;
  ['f_from','f_to','f_status'].forEach(id=>{ const e=el(id); if(e) e.value=''; });
  saveFiltersToLS();
  updateHashFromState();
  renderTasksTable(); renderKanban(); renderProjects(); if (ACTIVE_TAB==='gantt') renderGantt();
}
function clearFilters() {
  ['f_keyword','f_project','f_assignee','f_department','f_from','f_to','f_priority','f_status'].forEach(id=>{ const elx=document.getElementById(id); if (elx) elx.value=''; });
  OVERDUE = false;
  applyFilters();
  saveFiltersToLS();
  updateHashFromState();
}
function filterTasks(list) {
  let rows = list.slice();
  const f = FILTERS;
  const userDeptById = new Map(safeArr(DATA.users).map(u => [String(u.id||''), String(u.department||'').trim()]));
  if (f.keyword) {
    const k = f.keyword.toLowerCase();
    rows = rows.filter(x => String(x.title||'').toLowerCase().includes(k) || String(x.memoText||'').toLowerCase().includes(k));
  }
  if (f.project)  rows = rows.filter(x => String(x.projectId||'') === String(f.project));
  if (f.assignee) rows = rows.filter(x => String(x.assignees||'').split(',').map(s=>s.trim()).includes(f.assignee));
  if (f.department) {
    const want = String(f.department||'');
    rows = rows.filter(x => {
      const assignees = String(x.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);
      if (!assignees.length) return false;
      return assignees.some(a => (userDeptById.get(a)||'') === want);
    });
  }
  if (f.from)     rows = rows.filter(x => x.dueDate && x.dueDate >= f.from);
  if (f.to)       rows = rows.filter(x => x.dueDate && x.dueDate <= f.to);
  if (f.status === 'notdone') {
    rows = rows.filter(x => String(x.status||'').toLowerCase() !== 'done');
  } else if (f.status) {
    rows = rows.filter(x => (x.status||'todo') === f.status);
  }
  if (f.priority) rows = rows.filter(x => normPriority(x.priority||'') === f.priority);

  // 遅延(OVERDUE)モード：期限が今日より前、かつ未完了
  if (OVERDUE) {
    const today = new Date(); today.setHours(0,0,0,0);
    const y = today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    const tstr = `${y}-${m}-${d}`;
    rows = rows.filter(x => x.dueDate && x.dueDate < tstr && String(x.status||'').toLowerCase()!=='done');
  }
  return rows;
}

// --- Budget (復活させた関数) ---
function renderBudget(){
  if (PAGE !== 'budget') return;
  const rows = safeArr(DATA.projects);
  const subs = safeArr(DATA.subs);
  const active = rows.filter(p => String(p.status||'').toLowerCase() !== 'archived');
  const sum = xs => xs.reduce((a,b)=> a + (Number(b.budget||0)||0), 0);
  const total = sum(rows);
  const totalActive = sum(active);
  // Subscriptions
  const subsMonthly = subs.reduce((a,s)=>{
    const cyc=String(s.cycle||'monthly');
    const amt=Number(s.amount||0)||0;
    if(cyc==='yearly') return a + amt/12;
    if(cyc==='quarterly') return a + amt/3;
    return a + amt;
  }, 0);
  const subsYearly  = subs.reduce((a,s)=>{
    const cyc=String(s.cycle||'monthly');
    const amt=Number(s.amount||0)||0;
    if(cyc==='yearly') return a + amt;
    if(cyc==='quarterly') return a + amt*4;
    return a + amt*12;
  }, 0);
  const elx = document.getElementById('budget-summary'); if (elx) {
    elx.innerHTML = `<div class="row"><div>総予算合計</div><div><b>${total.toLocaleString()}</b> 円</div></div>
      <div class="row"><div>アクティブ予算合計</div><div><b>${totalActive.toLocaleString()}</b> 円</div></div>
      <hr style="margin:8px 0; border:none; border-top:1px solid var(--border);"/>
      <div class="row"><div>サブスク合計（月次）</div><div><b>${Math.round(subsMonthly).toLocaleString()}</b> 円/月</div></div>
      <div class="row"><div>サブスク合計（年次）</div><div><b>${Math.round(subsYearly).toLocaleString()}</b> 円/年</div></div>
      <div class="muted" style="margin-top:6px;">※ cycle（monthly/quarterly/yearly）から換算</div>`;
  }
  const tb = document.querySelector('#budget-by-owner tbody'); if (tb) {
    tb.innerHTML = '';
    const byOwner = {};
    active.forEach(p => {
      const k = p.ownerUserId || '';
      if (!byOwner[k]) byOwner[k] = { count:0, budget:0 };
      byOwner[k].count += 1; byOwner[k].budget += Number(p.budget||0)||0;
    });
    Object.keys(byOwner).sort((a,b)=> (byOwner[b].budget - byOwner[a].budget)).forEach(uid => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(nameByUserId(uid))}</td><td>${byOwner[uid].count}</td><td>${byOwner[uid].budget.toLocaleString()}</td>`;
      tb.appendChild(tr);
    });
  }
}

// tasks table (with Docs buttons)
function renderTasksTable() {
  const tb = document.querySelector('#taskTable tbody'); if (!tb) return;
  tb.innerHTML='';
  let rows = filterTasks(safeArr(DATA.tasks));
  rows = rows.sort((a,b)=>String(a.dueDate||'9999-12-31').localeCompare(String(b.dueDate||'9999-12-31'))).slice(0,500);

  for (const r of rows) {
    const assignees = orderedAssigneeIds(r.ownerUserId || '', r.assignees || '')
      .map(s => nameByUserId(s) || displayUser(s) || s)
      .filter(Boolean)
      .join(', ');
    const tDocUrl = getTaskDocUrl(r.id);
    const pDocUrl = getProjectDocUrl(r.projectId||'');
    const docsBtns = [
      tDocUrl ? `<button class="secondary" data-tip="タスクのドキュメントを開きます" onclick="openTaskDocById('${r.id}')">📜タスクDoc</button>` : '',
      pDocUrl ? `<button class="secondary" data-tip="プロジェクト共通のドキュメントを開きます" onclick="openProjectDocById('${r.projectId||''}')">📄PJ Doc</button>` : ''
    ].filter(Boolean).join(' ');

    const tr = document.createElement('tr');
    tr.dataset.id = r.id;

    const docBadges = [
      tDocUrl ? `<span class="doc-badge" title="Task Doc" data-tip="タスクのドキュメントを開きます" onclick="openTaskDocById('${r.id}')">📜タスクDoc</span>` : '',
      pDocUrl ? `<span class="doc-badge" title="Project Doc" data-tip="プロジェクトのドキュメントを開きます" onclick="openProjectDocById('${r.projectId||''}')">📄PJDoc</span>` : ''
    ].join('');

    // ★ ここで先にテーマ色を計算する
    const theme = themeFor(r.projectId||'', r);
    const prioLabel = normPriority(r.priority||'');
    const prc = prioLabel==='高' ? 'high'
               : prioLabel==='中' ? 'mid'
               : prioLabel==='低' ? 'low' : '';
    const attN = countAttachments('task', r.id);
    const attBadge = attN
  ? `<span class="doc-badge" data-tip="添付一覧を表示します。" title="添付 ${attN}件" onclick="toggleAttachmentList('task','${r.id}', this)">??${attN}添付を表示</span>`
  : '';

    const bg = ` style="background:${theme.bg}"`;
    tr.innerHTML = `
      <td class="cell-due" data-field="dueDate"${bg}>${r.dueDate||''}</td>
      <td${bg}>
        <span class="cell-title" data-field="title">${escapeHtml(r.title||'')}</span>
        ${docBadges} ${attBadge}
        <div class="muted" style="font-size:12px;">${escapeHtml(nameByProjectId(r.projectId||''))}</div>
      </td>
      <td${bg}>${escapeHtml(assignees||'')}</td>
      <td class="cell-prio ${prc?('prio-'+prc):''}" data-field="priority">
        <span class="pill prio-badge ${prc?('prio-'+prc):''}">${escapeHtml(prioLabel)}</span>
      </td>
      <td${bg}>${escapeHtml(labelStatus(r.status||''))}</td>
      <td class="cell-memo"${bg}>
        <textarea class="memo-edit" data-kind="task" data-id="${r.id}" placeholder="メモ...">${escapeHtml(r.memoText||'')}</textarea>
      </td>

      <td style="white-space:nowrap;">
        <button class="secondary" data-tip="この項目を編集します" onclick="editTask('${r.id}')">編集</button>
        <button class="secondary" onclick="moveStatus('${r.id}','doing')">→進行中</button>
        <button class="secondary" onclick="moveStatus('${r.id}','done')">✔完了</button>
        <button class="secondary" data-tip="添付を追加・削除します。" onclick="openAttachmentModal('task','${r.id}','${escapeJsSq(r.title||r.id)}')">📎添付を追加</button>
        <button class="secondary" onclick="delTask('${r.id}')">削除</button>
      </td>
    `;

    tb.appendChild(tr);
  }
  attachTaskInlineEditHandlers();
}
let INLINE_BOUND = false;
function attachTaskInlineEditHandlers(){
  if (INLINE_BOUND) return; INLINE_BOUND = true;
  const tb = document.querySelector('#taskTable tbody'); if(!tb) return;

  // 既存: タイトル/期限/優先度は "クリック" で編集
  tb.addEventListener('click', (e)=>{
    const cell = closestSafe(e.target, '.cell-title, .cell-due, .cell-prio');
    if(!cell || cell.dataset.editing==='1') return;
    const tr = cell.closest('tr'); const id = tr?.dataset.id; if(!id) return;
    const field = cell.dataset.field;
    const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;

    cell.dataset.editing='1';
    const oldHTML = cell.innerHTML;

    let input;
    if(field==='title'){
      input = document.createElement('input');
      input.type='text'; input.value=t.title||''; input.style.width='100%';
    }else if(field==='dueDate'){
      input = document.createElement('input');
      input.type='date'; input.value=t.dueDate||'';
    }else if(field==='priority'){
      input = document.createElement('select');
      ['','高','中','低'].forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v||'-';
        if(normPriority(t.priority||'')===v) o.selected=true; input.appendChild(o);
      });
    }
    const ctl = document.createElement('span');
    ctl.className = 'inline-ctl';
    const ok = document.createElement('button'); ok.className='ok'; ok.textContent='??';
    const ng = document.createElement('button'); ng.className='ng'; ng.textContent='??';
    const wrap = document.createElement('span');
    wrap.appendChild(input); wrap.appendChild(ctl);
    ctl.appendChild(ok); ctl.appendChild(ng);
    cell.innerHTML=''; cell.appendChild(wrap); input.focus();

    const cancel=()=>{ cell.innerHTML = oldHTML; cell.dataset.editing=''; };
    const commit=()=>{
      const patch={};
      if(field==='title')    patch.title = input.value.trim();
      if(field==='dueDate')  patch.dueDate = input.value;
      if(field==='priority') patch.priority = input.value;
      const send = Object.assign({}, t, patch);

      try{
        rpcRun
          .withSuccessHandler(()=>{
            showToast('ok','保存しました');
            cell.classList.add('cell-flash'); setTimeout(()=>cell.classList.remove('cell-flash'),1200);
            refresh();
          })
          .withFailureHandler(err=>{ showToast('ng', (err && err.message) ? err.message : '保存に失敗しました'); cancel(); })
          .upsertTask(send);
      }catch(e){
        showToast('ng','通信エラー'); cancel();
      }
      cell.dataset.editing='';
    };

    input.addEventListener('keydown', ev=>{ if(ev.key==='Escape'){ ev.preventDefault(); cancel(); } if(ev.key==='Enter'){ ev.preventDefault(); commit(); } });
    ok.addEventListener('click', commit);
    ng.addEventListener('click', cancel);
    input.addEventListener('blur', ()=> setTimeout(()=>{ if(cell.dataset.editing==='1') cancel(); }, 10));
  });

  // ★ 追加: メモは "ダブルクリック" で編集（textarea）
  tb.addEventListener('dblclick', (e)=>{
    const cell = closestSafe(e.target, '.cell-memo');
    if(!cell || cell.dataset.editing==='1') return;
    const tr = cell.closest('tr'); const id = tr?.dataset.id; if(!id) return;
    const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;

    cell.dataset.editing='1';
    const oldHTML = cell.innerHTML;

    const ta = document.createElement('textarea');
    ta.value = t.memoText || '';
    ta.style.width = '100%';
    ta.style.minHeight = '88px';

    const ctl = document.createElement('span');
    ctl.className = 'inline-ctl';
    const ok = document.createElement('button'); ok.className='ok'; ok.textContent='??';
    const ng = document.createElement('button'); ng.className='ng'; ng.textContent='??';

    const wrap = document.createElement('div');
    wrap.appendChild(ta);
    wrap.appendChild(ctl);
    ctl.appendChild(ok); ctl.appendChild(ng);
    cell.innerHTML = '';
    cell.appendChild(wrap);
    ta.focus();

    const cancel = ()=>{ cell.innerHTML = oldHTML; cell.dataset.editing=''; };
    const commit  = ()=>{
      const newMemo = ta.value;
      try{
        rpcRun
          .withSuccessHandler(()=>{
            showToast('ok','メモを保存しました');
            // 軽量反映（即時見た目更新）
            const idx = safeArr(DATA.tasks).findIndex(x=>x.id===id);
            if (idx>=0) DATA.tasks[idx].memoText = newMemo;
            cell.innerHTML = escapeHtml(String(newMemo).replace(/\n/g,' '));
            cell.title = newMemo || '';
            cell.classList.add('cell-flash'); setTimeout(()=>cell.classList.remove('cell-flash'),1200);
            cell.dataset.editing='';
          })
          .withFailureHandler(err=>{ showToast('ng', (err && err.message) ? err.message : '保存に失敗しました'); cancel(); })
          .saveTaskMemo(id, newMemo);  // ← 既存のメモ保存APIを使用
      }catch(e){
        showToast('ng','通信エラー'); cancel();
      }
    };

    // キー操作: Esc=キャンセル / Ctrl+Enter=保存
    ta.addEventListener('keydown', ev=>{
      if(ev.key==='Escape'){ ev.preventDefault(); cancel(); }
      if(ev.key==='Enter' && (ev.ctrlKey || ev.metaKey)){ ev.preventDefault(); commit(); }
    });
    ok.addEventListener('click', commit);
    ng.addEventListener('click', cancel);
    // textarea は誤操作防止のため blur では保存せず、キャンセル寄りに
    ta.addEventListener('blur', ()=> setTimeout(()=>{ if(cell.dataset.editing==='1') cancel(); }, 10));
  });
}
let PROJ_INLINE_BOUND = false;
function attachProjectInlineEditHandlers(){
  if (PROJ_INLINE_BOUND) return; PROJ_INLINE_BOUND = true;
  const tb = document.querySelector('#projTable tbody'); if(!tb) return;
  tb.addEventListener('click', (e)=>{
    const cell = closestSafe(e.target, '.cell-prio');
    if(!cell || cell.dataset.editing==='1') return;
    const tr = cell.closest('tr'); const id = tr?.dataset.id; if(!id) return;
    const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id)); if(!p) return;

    cell.dataset.editing='1';
    const oldHTML = cell.innerHTML;

    const input = document.createElement('select');
    ['','高','中','低'].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v||'-';
      if(normPriority(p.priority||'')===v) o.selected=true;
      input.appendChild(o);
    });
    const ctl = document.createElement('span');
    ctl.className = 'inline-ctl';
    const ok = document.createElement('button'); ok.className='ok'; ok.textContent='?';
    const ng = document.createElement('button'); ng.className='ng'; ng.textContent='?';
    const wrap = document.createElement('span');
    wrap.appendChild(input); wrap.appendChild(ctl);
    ctl.appendChild(ok); ctl.appendChild(ng);
    cell.innerHTML=''; cell.appendChild(wrap); input.focus();

    const cancel=()=>{ cell.innerHTML = oldHTML; cell.dataset.editing=''; };
    const commit=()=>{
      const patch = Object.assign({}, p, { priority: input.value });
      try{
        rpcRun
          .withSuccessHandler(()=>{
            showToast('ok','保存しました');
            cell.classList.add('cell-flash'); setTimeout(()=>cell.classList.remove('cell-flash'),1200);
            refresh();
          })
          .withFailureHandler(err=>{ showToast('ng', (err && err.message) ? err.message : '保存に失敗しました'); cancel(); })
          .upsertProject(patch);
      }catch(e){
        showToast('ng','通信エラー'); cancel();
      }
      cell.dataset.editing='';
    };
    ok.addEventListener('click', commit);
    ng.addEventListener('click', cancel);
    input.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); commit(); } if(ev.key==='Escape'){ ev.preventDefault(); cancel(); } });
  });
}

// 追加: 通常（スイムOFF）時は内側の #col_xxx 自体にも drop/dragover を付与
function _wireInnerDrops_(){
  const map = { col_todo:'todo', col_doing:'doing', col_blocked:'blocked', col_done:'done' };
  Object.entries(map).forEach(([id, st])=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('dragover', e => allowDrop(e));
    el.addEventListener('drop', e => onDrop(e, st));
  });
}
// Kanban (通常/スイムレーン 両対応)
function renderKanban() {
  if (ACTIVE_TAB !== 'board') return;

  const host = document.querySelector('#view-board .kanban');
  if (!host) return;

  const useSwim = !!document.getElementById('opt_swimlane')?.checked;
  const rows = filterTasks(safeArr(DATA.tasks));
  const cols = ['todo', 'doing', 'blocked', 'done'];

  // ---- helpers (この関数内だけで使用) ----
  const safeId = s => String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_') || 'none';
  const primaryAssigneeKey = t => {
    const arr = String(t.assignees || '').split(',').map(s => s.trim()).filter(Boolean);
    return arr[0] || '__NONE__';
  };
  const displayNameFromKey = k => (k === '__NONE__' ? '未割当' : (nameByUserId(k) || k));
  const assigneesLabel = r => String(r.assignees || '').split(',')
                          .map(s => s.trim()).filter(Boolean).map(nameByUserId).join(', ');

  function buildCard(r, rightLabelHtml) {
    const theme = themeFor(r.projectId || '', r);
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel === '高' ? 'high' : prioLabel === '中' ? 'mid' : prioLabel === '低' ? 'low' : '';
    const aging = ageClass(r);

    const tDocUrl = getTaskDocUrl(r.id);
    const pDocUrl = getProjectDocUrl(r.projectId || '');
    const docsBtns = [
      tDocUrl ? `<button class="secondary" onclick="openTaskDocById('${r.id}')">Task Docs</button>` : '',
      pDocUrl ? `<button class="secondary" onclick="openProjectDocById('${r.projectId || ''}')">Proj Docs</button>` : ''
    ].filter(Boolean).join(' ');

    const attN = countAttachments('task', r.id);
    const attBadge = attN
      ? `<span class="doc-badge" title="添付 ${attN}件" onclick="openAttachmentManager('task','${r.id}')">??${attN}</span>`
      : '';

    const card = document.createElement('div');
    card.className = 'cardlet ' + aging;
    card.style.background = theme.bg;
    card.style.borderColor = theme.border;
    card.setAttribute('draggable','true');
    card.addEventListener('dragstart', ev => {
      if (ev && ev.dataTransfer) {
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData('text/plain', r.id);
        ev.dataTransfer.setData('text', r.id); // ★フォールバック
      }
    });
    

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:6px;align-items:center;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="color-swatch" style="background:${theme.border}"></span>
          <strong style="font-size:12px;">${escapeHtml(r.title || '')}</strong>
        </div>
        <span class="pill prio-badge ${prc ? ('prio-' + prc) : ''}"
              style="font-size:11px;padding:1px 6px;">${escapeHtml(prioLabel)}</span>
      </div>
      <div class="muted" style="margin-top:2px;font-size:11px;display:flex;justify-content:space-between;">
        <span>${r.dueDate || ''}</span>
        <span>${rightLabelHtml}</span>
      </div>
      ${attBadge ? `<div style="margin-top:2px;font-size:11px;">${attBadge}</div>` : ''}
      ${docsBtns ? `<div class="toolbar" style="margin-top:4px;">${docsBtns}</div>` : ''}
      <div style="margin-top:4px;display:flex;gap:4px;justify-content:flex-end;">
        <button class="secondary mini" onclick="moveStatus('${r.id}','todo')">未着手</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','doing')">進行中</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','blocked')">保留中</button>
        <button class="secondary mini" onclick="moveStatus('${r.id}','done')">完了</button>
      </div>`;
    return card;
  }

  // ==== 通常モード（スイムレーン OFF）====
  if (!useSwim) {
    host.classList.remove('is-swim');

    const colMap = {
      todo:    document.getElementById('col_todo'),
      doing:   document.getElementById('col_doing'),
      blocked: document.getElementById('col_blocked'),
      done:    document.getElementById('col_done'),
    };
    const cntMap = {
      todo:    document.getElementById('cnt_todo'),
      doing:   document.getElementById('cnt_doing'),
      blocked: document.getElementById('cnt_blocked'),
      done:    document.getElementById('cnt_done'),
    };

    // 骨組みが存在しなければ何もしない（安全策）
    for (const c of cols) {
      if (!colMap[c] || !cntMap[c]) return;
      colMap[c].innerHTML = '';
      cntMap[c].textContent = '0';
    }

    rows.forEach(r => {
      const st = (r.status || 'todo').toLowerCase();
      const col = colMap[st] || colMap.todo;
      const right = assigneesLabel(r); // 右側は担当者名表示
      col.appendChild(buildCard(r, escapeHtml(right)));
    });

    // カウント更新
    for (const c of cols) {
      const cntEl = cntMap[c];
      const colEl = colMap[c];
      if (cntEl && colEl) cntEl.textContent = String(colEl.children.length);
    }
    _wireInnerDrops_();
    return;
  }

  // ==== スイムレーンモード（担当者ごとに4列 × レーン）====
  host.classList.add('is-swim');
  host.innerHTML = '';

  // レーン作成（主担当＝assignees の先頭。いなければ __NONE__）
  const lanesMap = new Map();
  rows.forEach(t => {
    const key = primaryAssigneeKey(t);
    if (!lanesMap.has(key)) lanesMap.set(key, { key, name: displayNameFromKey(key), tasks: [] });
    lanesMap.get(key).tasks.push(t);
  });

  // レーンごとに描画
  Array.from(lanesMap.values())
    .sort((a, b) => a.name.localeCompare(b.name, 'ja'))
    .forEach(lane => {
      const wrap = document.createElement('div');
      wrap.className = 'lane-wrap see-through';
      wrap.style.cssText = 'border:1px solid var(--border); border-radius:12px; padding:8px; background:#f9fafb;';
      wrap.setAttribute('data-lane-key', lane.key);

      // 4カラムの骨組み
      wrap.innerHTML = `
        <h3 style="margin:0 0 6px 0;">?? ${escapeHtml(lane.name)}</h3>
        <div class="kanban" style="grid-template-columns:repeat(4,1fr); gap:8px;">
          ${cols.map(c => {
            const sid = `lane_${safeId(lane.key)}_${c}`;
            return `
              <div class="col" data-status="${c}" data-lane-key="${lane.key}"
                   ondragover="allowDrop(event)" ondrop="onDrop(event, '${c}')">
                <h3>${labelStatus(c)} <span class="muted">0</span></h3>
                <div id="${sid}"></div>
              </div>`;
          }).join('')}
        </div>`;
      host.appendChild(wrap);

      // カード挿入
      cols.forEach(c => {
        const slot = wrap.querySelector(`#lane_${safeId(lane.key)}_${c}`);
        if (!slot) return;

        lane.tasks
          .filter(t => String(t.status || 'todo').toLowerCase() === c)
          .forEach(r => {
            // 右側はプロジェクト名（スイム時は担当は見出しで分かるため）
            const right = nameByProjectId(r.projectId || '') || '';
            slot.appendChild(buildCard(r, escapeHtml(right)));
          });

        // カウント更新
        const cntSpan = slot.parentElement.querySelector('h3 .muted');
        if (cntSpan) cntSpan.textContent = String(slot.children.length);
      });
    });
}


// Projects table
function renderProjects() {
  const tb = document.querySelector('#projTable tbody'); if (!tb) return;

  tb.innerHTML = '';
  let rows = safeArr(DATA.projects)
    .filter(p => String(p.status||'').toLowerCase() !== 'archived');

  const f = (typeof FILTERS === 'object' && FILTERS) ? FILTERS : {};
  const kw = String(f.keyword||'').trim().toLowerCase();
  const pidFilter = String(f.project||'').trim();
  const assignee = String(f.assignee||'').trim();
  const dept = String(f.department||'').trim();
  const userDeptById = new Map(safeArr(DATA.users).map(u => [String(u.id||''), String(u.department||'').trim()]));
  const projectMemberIds = (p)=> String(p.members || p.assignees || p.memberIds || '')
    .split(',').map(s=>s.trim()).filter(Boolean);
  const projectMatchesKeyword = (p)=>{
    const ownerName = nameByUserId(p.ownerUserId||'') || '';
    const memberNames = projectMemberIds(p).map(id=>nameByUserId(id) || displayUser(id) || id).join(' ');
    const hay = (p.name||'') + ' ' + (p.memoText||'') + ' ' + ownerName + ' ' + memberNames;
    return hay.toLowerCase().includes(kw);
  };

  if (pidFilter) rows = rows.filter(p=>String(p.id||'') === pidFilter);
  if (kw) rows = rows.filter(projectMatchesKeyword);
  if (assignee) {
    rows = rows.filter(p=>{
      if (String(p.ownerUserId||'') === assignee) return true;
      const members = projectMemberIds(p);
      if (members.includes(assignee)) return true;
      return safeArr(DATA.tasks).some(t=>{
        if (String(t.projectId||'') !== String(p.id||'')) return false;
        const ids = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);
        return ids.includes(assignee);
      });
    });
  }
  if (dept) {
    rows = rows.filter(p=>{
      const ownerId = String(p.ownerUserId||'');
      if (userDeptById.get(ownerId) === dept) return true;
      const members = projectMemberIds(p);
      if (members.some(id=>userDeptById.get(id) === dept)) return true;
      return safeArr(DATA.tasks).some(t=>{
        if (String(t.projectId||'') !== String(p.id||'')) return false;
        const ids = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);
        return ids.some(id=>userDeptById.get(id) === dept);
      });
    });
  }

  rows = rows.slice(0,500);

  for (const r of rows) {
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel === '高' ? 'high'
            : prioLabel === '中' ? 'mid'
            : prioLabel === '低' ? 'low' : '';

    // Docs の URL（未定義対策）
    const pDocUrl = getProjectDocUrl(r.id);

    const attBtn = `<button class="secondary" data-tip="添付を追加・削除します。" onclick="openAttachmentModal('project','${escapeJsSq(r.id)}','${escapeJsSq(r.name||r.id)}')">📎添付を追加</button>`;
    const badge  = pDocUrl ? '<span class="doc-badge" title="Project Doc" data-tip="プロジェクトのドキュメントを開きます。" onclick="openProjectDocById(\''+r.id+'\')">📄PJDoc</span>' : '';

    const tr = document.createElement('tr');

    const attN = countProjectAttachmentsDeep(r.id);
    const attBadge = attN
      ? `<span class="doc-badge" data-tip="添付URL一覧を表示します。" title="添付 ${attN}件" onclick="toggleAttachmentList('project','${escapeJsSq(r.id)}', this)">??${attN}添付を表示</span>`
      : '';

    // 親プロジェクト名（オプショナルチェイニングなし）
    var parent = safeArr(DATA.projects).find(function(p){ return String(p.id) === String(r.parentProjectId); });
    var parentName = parent ? (parent.name || '') : '';

    // タスク数
    const projTasks    = safeArr(DATA.tasks).filter(t => String(t.projectId) === String(r.id));
    const doneCount    = projTasks.filter(t => String(t.status||'').toLowerCase() === 'done').length;
    const notDoneCount = projTasks.length - doneCount;

    const theme = themeFor(r.id, null);
    const bg = ' style="background:'+theme.bg+'"';

    // 「一覧」ボタン（入れ子テンプレート回避）
    const listBtn = projTasks.length
      ? '<button class="secondary mini" style="margin-left:6px;" data-tip="タスク一覧/状況を表示します" onclick="toggleProjectTaskList(\''+r.id+'\', this)">一覧</button>'
      : '';

    const hardBtn = (String(PAGE||'') === 'projects')
      ? ' <button class="secondary" data-tip="このプロジェクトと関連タスク/添付URLを完全削除します（元に戻せません）。" onclick="deleteProjectHard(\''+r.id+'\')">完全削除</button>'
      : '';

    tr.dataset.id = r.id;
    tr.innerHTML =
      '<td'+bg+'>'+escapeHtml(r.name||'')+badge+' '+attBadge+'</td>'+
      '<td'+bg+'>'+escapeHtml(parentName)+'</td>'+
      '<td'+bg+'>'+escapeHtml(nameByUserId(r.ownerUserId||''))+'</td>'+
      '<td class="cell-prio '+(prc?('prio-'+prc):'')+'" data-field="priority">'+
        '<span class="pill prio-badge '+(prc?('prio-'+prc):'')+'">'+
          escapeHtml(prioLabel || '')+
        '</span>'+
      '</td>'+
      '<td'+bg+'>'+notDoneCount+' / '+doneCount+' '+listBtn+'</td>'+
      '<td class="cell-memo"'+bg+'>'+
        '<textarea class="memo-edit" data-kind="project" data-id="'+r.id+'" placeholder="メモ...">'+escapeHtml(r.memoText||'')+'</textarea>'+
      '</td>'+
      '<td'+bg+'>'+(r.budget||'')+'</td>'+
      '<td'+bg+'>'+(r.startDate||'')+'-'+(r.endDate||'')+'</td>'+
      '<td>'+
        attBtn+
        ' <button class="secondary" data-tip="このプロジェクトについて編集します。" onclick="editProject(\''+r.id+'\')">編集</button>'+
        hardBtn+
        ' <button class="secondary" data-tip="このプロジェクトを完了扱いとして、過去ログに移します。完了扱いにしたプロジェクトは上部メニューから「プロジェクト」タブで閲覧・復活できます。" onclick="toggleArchiveProject(\''+r.id+'\')">'+
          ((String(r.status||'').toLowerCase()==='archived')?'復活':'完了')+
        '</button>'+
      '</td>';

    tb.appendChild(tr);
  }
  attachProjectInlineEditHandlers();
}



let ATT_MODAL = { kind:'', id:'', label:'', items:[], deleted:new Set() };
function openAttachmentModal(kind, id, label){
  const list = safeArr(DATA.attachments)
    .filter(a=>String(a.parentType||a.parent_type||a.type||'')===String(kind) && String(a.parentId||a.parent_id||'')===String(id))
    .map(a=>{
      const url = a.url || (a.fileId ? ('https://drive.google.com/file/d/'+a.fileId) : '');
      return { ...a, url };
    });
  ATT_MODAL = { kind, id, label: label||id, items: list, deleted: new Set() };
  el('att-modal-title').textContent = `添付管理: ${label||id}`;
  renderAttachmentModalList();
  const bg = el('att-modal'); if(bg){ bg.style.display='flex'; }
}
function renderAttachmentModalList(){
  const wrap = el('att-modal-list'); if(!wrap) return;
  const rows = (ATT_MODAL.items||[]).map((a,idx)=>{
    const id = a.id ? String(a.id) : '';
    return `
      <div class="att-modal-row att-row" data-idx="${idx}" data-id="${escapeHtml(id)}">
        <input value="${escapeHtml(a.title||'')}" placeholder="名称" />
        <input value="${escapeHtml(a.url||'')}" placeholder="URL (https://...)" />
        <button class="secondary" onclick="removeAttachmentRow(${idx})">削除</button>
      </div>
    `;
  }).join('') || '<div class="muted">まだ添付がありません</div>';
  wrap.innerHTML = rows;
}
function addAttachmentRow(){
  const title = (document.getElementById('att-new-title')||{}).value || '';
  const url = (document.getElementById('att-new-url')||{}).value || '';
  if(!url.trim()){ alert('URLを入力してください'); return; }
  ATT_MODAL.items.push({ title:title.trim(), url:url.trim(), type:'url' });
  if(el('att-new-title')) el('att-new-title').value='';
  if(el('att-new-url')) el('att-new-url').value='';
  renderAttachmentModalList();
}
function removeAttachmentRow(idx){
  const it = (ATT_MODAL.items||[])[idx];
  if(it && it.id) ATT_MODAL.deleted.add(String(it.id));
  ATT_MODAL.items.splice(idx,1);
  renderAttachmentModalList();
}
async function saveAttachmentModal(){
  const rows = Array.from(document.querySelectorAll('#att-modal-list .att-row'));
  const items = rows.map(div=>{
    const inputs = div.querySelectorAll('input');
    const title = inputs[0]?.value || '';
    const url = inputs[1]?.value || '';
    const parsed = parseAttachmentLines(`${title},${url}`)[0] || { title, url, type:'url', fileId:'' };
    return { id: div.getAttribute('data-id') || undefined, ...parsed };
  }).filter(it=> (it.title||it.url));
  const delIds = Array.from(ATT_MODAL.deleted||[]);
  Busy.push();
  try{
    if(items.length) await rpc('upsertAttachments', ATT_MODAL.kind, ATT_MODAL.id, items);
    for(const did of delIds){ await rpc('deleteAttachment', did); }
    await refresh();
    closeAttachmentModal();
  }catch(e){
    alert('添付の保存に失敗: '+(e && e.message ? e.message : e));
  }finally{
    Busy.pop();
  }
}
function closeAttachmentModal(){
  const bg = el('att-modal'); if(bg){ bg.style.display='none'; }
  ATT_MODAL = { kind:'', id:'', label:'', items:[], deleted:new Set() };
}
function openAttachDialogFor(kind, id){
  let label = id;
  if (kind === 'project') {
    label = (safeArr(DATA.projects).find(p=>String(p.id)===String(id))?.name) || id;
  } else if (kind === 'task') {
    label = (safeArr(DATA.tasks).find(t=>String(t.id)===String(id))?.title) || id;
  } else if (kind === 'shared') {
    label = (safeArr(DATA.shareds).find(s=>String(s.id)===String(id))?.name) || id;
  }
  openAttachmentModal(kind, id, label);
}


// Subs / Ledger list
function renderSubs() {
  const tb = document.querySelector('#subTable tbody'); if (!tb) return;
  tb.innerHTML='';
  const rows = safeArr(DATA.subs).slice().sort((a,b)=>String(a.nextBillDate).localeCompare(String(b.nextBillDate)));
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.nextBillDate||''}</td>
      <td>${escapeHtml(r.serviceName||'')}</td>
      <td>${r.amount||''}</td>
      <td>${r.cycle||''}</td>
      <td><button class="secondary" onclick="delSub('${r.id}')">削除</button></td>`;
    tb.appendChild(tr);
  }
}
function renderLedger() {
  const tb = document.querySelector('#ledTable tbody'); if (!tb) return;
  tb.innerHTML = '';
  const rows = combinedLedgerRows().slice(0, 20);
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.kind}</td>
      <td>${r.type||''}</td>
      <td>${escapeHtml(r.title || '')}</td>
      <td>${(Number(r.amount||0)).toLocaleString()}</td>
      <td>${escapeHtml(r.account||'')}</td>
      <td>${escapeHtml(r.counterpart||'')}</td>`;
    tb.appendChild(tr);
  }
}


// --- Users ---
function addUser() {
  const workType = normalizeWorkType(val('u_work_type'));
  const defaults = workTypeDefaults(workType);
  const u = {
    name: val('u_name'),
    email: val('u_email'),
    role: val('u_role'),
    department: val('u_dept'),
    workType: workType,
    scheduledWorkMinutes: parseMinutesInput(val('u_work_minutes'), defaults.workMinutes),
    fixedBreakMinutes: parseMinutesInput(val('u_break_minutes'), defaults.breakMinutes),
  };
  if(!u.name || !u.email){ alert('氏名とメールは必須です'); return; }
  gsr().withSuccessHandler(row => { patchRow('users', row); rerenderAfter('users'); }).upsertUser(u);
}
function renderUsers() {
  const tb = document.querySelector('#userTable tbody'); if (!tb) return;
  tb.innerHTML='';
  safeArr(DATA.users).forEach(u=>{
    const work = getUserWorkSettingsByUser(u);
    const tr = document.createElement('tr');
    const checked = isAttendanceVisibleUser(u) ? 'checked' : '';
    tr.innerHTML = `
      <td>${escapeHtml(u.name||'')}</td>
      <td>${escapeHtml(u.email||'')}</td>
      <td>${escapeHtml(u.role||'')}</td>
      <td>${escapeHtml(u.department||'')}</td>
      <td>
        <select data-uid="${escapeHtml(u.id)}" data-field="workType">
          <option value="standard" ${work.type==='standard'?'selected':''}>所定勤務</option>
          <option value="hourly" ${work.type==='hourly'?'selected':''}>時給制</option>
          <option value="contractor" ${work.type==='contractor'?'selected':''}>委託</option>
          <option value="custom" ${work.type==='custom'?'selected':''}>カスタム</option>
        </select>
      </td>
      <td><input type="number" min="0" data-uid="${escapeHtml(u.id)}" data-field="scheduledWorkMinutes" value="${escapeHtml(String(work.workMinutes))}"/></td>
      <td><input type="number" min="0" data-uid="${escapeHtml(u.id)}" data-field="fixedBreakMinutes" value="${escapeHtml(String(work.breakMinutes))}"/></td>
      <td style="text-align:center;"><input type="checkbox" data-uid="${escapeHtml(u.id)}" data-field="attendanceVisible" ${checked}/></td>
      <td><input data-uid="${escapeHtml(u.id)}" data-field="employeeNumber" value="${escapeHtml(u.employeeNumber||'')}" placeholder="12345"/></td>
      <td><input data-uid="${escapeHtml(u.id)}" data-field="calendarUrl" value="${escapeHtml(u.calendarUrl||'')}" placeholder="https://calendar.google.com/.../basic.ics"/></td>
      <td><button class="secondary" onclick="delUser('${u.id}')">削除</button></td>
    `;
    tb.appendChild(tr);
  });

  // Save user settings on change.
  tb.querySelectorAll('input[data-uid], select[data-uid]').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const uid = inp.getAttribute('data-uid');
      const field = inp.getAttribute('data-field');
      if(!uid || !field) return;

      let value = null;
      if (inp.type === 'checkbox') value = !!inp.checked;
      else if (inp.type === 'number') value = parseMinutesInput(inp.value, 0);
      else value = inp.value;

      const patch = { id: uid };
      patch[field] = value;
      gsr().withSuccessHandler(row=>{ patchRow('users', row); rerenderAfter('users'); toast('ユーザー設定を保存しました', true); })
          .withFailureHandler(e=>{ toast('ユーザー設定保存に失敗: '+(e && e.message ? e.message : e), false); })
          .upsertUser(patch);
    }, { once:false });
  });
  bindUserWorkTypeDefaults();
}
let USER_WORK_BOUND = false;
function bindUserWorkTypeDefaults(){
  if (USER_WORK_BOUND) return;
  const sel = el('u_work_type');
  const wm = el('u_work_minutes');
  const bm = el('u_break_minutes');
  if (!sel || !wm || !bm) return;
  sel.addEventListener('change', ()=>{
    const type = normalizeWorkType(sel.value);
    if (type === 'custom') return;
    const defs = workTypeDefaults(type);
    wm.value = String(defs.workMinutes);
    bm.value = String(defs.breakMinutes);
  });
  USER_WORK_BOUND = true;
}
function delUser(id) { gsr().withSuccessHandler(()=>{ dropRow('users', id); rerenderAfter('users'); }).deleteUser(id); }
function delMinute(id) { gsr().withSuccessHandler(()=>{ dropRow('minutes', id); rerenderAfter('minutes'); }).deleteMinute(id); }

function deleteProjectHard(id){
  const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
  const name = p ? (p.name||p.id) : String(id);
  const ok = confirm(`➕️ プロジェクト「${name}」を完全削除します。\n関連タスク/添付URLも削除され、元に戻せません。\n\n本当に削除しますか？`);
  if(!ok) return;

  gsr()
    .withSuccessHandler((r)=>{
      // Drop project
      dropRow('projects', String(id));

      // Drop related tasks (client-side)
      const removedTaskIds = new Set(
        safeArr(DATA.tasks).filter(t=>String(t.projectId)===String(id)).map(t=>String(t.id))
      );
      DATA.tasks = safeArr(DATA.tasks).filter(t=>String(t.projectId)!==String(id));

      // Drop attachments for project and those tasks
      DATA.attachments = safeArr(DATA.attachments).filter(a=>{
        const pt = String(a.parentType||'');
        const pid = String(a.parentId||'');
        if (pt==='project' && pid===String(id)) return false;
        if (pt==='task' && removedTaskIds.has(pid)) return false;
        return true;
      });

      rerenderAfter('projects');
      toast('プロジェクトを完全削除しました', true);
    })
    .withFailureHandler((e)=>{
      toast('完全削除に失敗: '+(e && e.message ? e.message : e), false);
    })
    .deleteProjectHard(String(id));
}

// --- Vault (AES-GCM) ---
async function deriveKey(passphrase, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'PBKDF2', salt:salt, iterations:100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}
function b64e(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64d(str){ return Uint8Array.from(atob(str), c=>c.charCodeAt(0)); }
async function encryptText(passphrase, plaintext){
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase, salt);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv:iv}, key, enc.encode(plaintext));
  return JSON.stringify({v:1, alg:'AES-GCM', salt:b64e(salt), iv:b64e(iv), ct:b64e(ct)});
}
async function decryptText(passphrase, blob){
  const o = JSON.parse(blob);
  const salt = b64d(o.salt);
  const iv = b64d(o.iv);
  const key = await deriveKey(passphrase, salt);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv:iv}, key, b64d(o.ct));
  return new TextDecoder().decode(pt);
}
function renderCreds() {
  const tb = document.querySelector('#credTable tbody'); if (!tb) return;
  tb.innerHTML='';
  safeArr(DATA.credentials).forEach(c=>{
    const owner = nameByUserId((c && c.ownerUserId) || '');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.serviceName||'')}</td>
      <td><a href="${escapeHtml(c.url||'')}" target="_blank">${escapeHtml(c.url||'')}</a></td>
      <td>${escapeHtml(c.loginId||'')}</td>
      <td><button class="secondary" onclick="revealPassword('${c.id}')">復号</button></td>
      <td>${escapeHtml(owner||'')}</td>
      <td>${escapeHtml(c.note||'')}</td>
      <td><button class="secondary" onclick="delCredential('${c.id}')">削除</button></td>`;
    tb.appendChild(tr);
  });
}
async function addCredential() {
  const pass = val('c_passphrase');
  if (!pass) { alert('暗号化パスフレーズを入力してください'); return; }
  const cipher = await encryptText(pass, val('c_password')||'');
  const c = {
    serviceName: val('c_service'),
    url: val('c_url'),
    loginId: val('c_login'),
    passwordCipher: cipher,
    ownerUserId: sel('c_owner'),
    note: val('c_note')
  };

  // ★ row に id が無い場合は差分適用せず refresh() にフォールバック
  gsr()
    .withSuccessHandler(row => {
      if (row && row.id) {
        patchRow('credentials', row);
        rerenderAfter('credentials');
      } else {
        refresh();
      }
    })
    .upsertCredential(c);
}

async function revealPassword(id) {
  const pass = prompt('復号用パスフレーズを入力'); if (pass===null) return;
  const c = safeArr(DATA.credentials).find(x=>x.id===id);
  if (!c) return;
  try {
    const pwd = await decryptText(pass, c.passwordCipher);
    alert('パスワード: ' + pwd);
  } catch(e) {
    alert('復号に失敗しました。パスフレーズが違う可能性があります。');
  }
}
function delCredential(id) { gsr().withSuccessHandler(()=>{ dropRow('credentials', id); rerenderAfter('credentials'); }).deleteCredential(id); }

// --- Project/Task CRUD & Docs ---
function addProject() {
  const editId   = el('p_editing_id')?.value || '';
  const origName = el('p_editing_id')?.dataset?.orig || '';
  const nameNow  = val('p_name').trim();

  // ★名称を変えたまま更新しようとしている → 上書き確認
  if (editId && origName && nameNow && nameNow !== origName) {
    const ok = confirm(
      `? 既存プロジェクト「${origName}」(ID:${editId}) を「${nameNow}」にリネームして上書き保存します。\n` +
      `本当に上書きしますか？\n\n新規追加にしたい場合は、キャンセルして「新規モードへ切替」を押してください。`
    );
    if (!ok) return; // 中断
  }

  let pc = val('p_color');
  if (!editId && pc === '#ffffff') pc = ''; // 新規＆白→無指定扱い

  const p = {
    id: editId,
    name: nameNow,
    parentProjectId: sel('p_parent_select'),
    ownerUserId: sel('p_owner_select'),
    priority: val('p_priority'),
    color: pc,
    budget: val('p_budget'),
    startDate: val('p_start'),
    endDate: val('p_end'),
    memoText: val('p_memo'),
    status: 'active',
    fiscalYear: new Date().getFullYear()
  };
  resetProjectForm();
  
  gsr().withSuccessHandler(row => { patchRow('projects', row); rerenderAfter('projects'); }).upsertProject(p);
  
}


function addTask() {
  const editId    = el('t_editing_id')?.value || '';
  const origTitle = el('t_editing_id')?.dataset?.orig || '';
  const titleNow  = val('t_title').trim();

  // ★タイトルを変えたまま更新しようとしている → 上書き確認
  if (editId && origTitle && titleNow && titleNow !== origTitle) {
    const ok = confirm(
      `? 既存タスク「${origTitle}」(ID:${editId}) を「${titleNow}」にリネームして上書き保存します。\n` +
      `本当に上書きしますか？\n\n新規追加にしたい場合は、キャンセルして「新規モードへ切替」を押してください。`
    );
    if (!ok) return; // 中断
  }

  const assigneesArr = orderedAssigneeIds(sel('t_owner_select'), selMulti('t_assignees_select'));

  let tc = val('t_color');
  if (!editId && tc === '#ffffff') tc = ''; // 新規＆白→無指定扱い

  const t = {
    id: editId,
    projectId: sel('t_project_select'),
    parentTaskId: '',
    type: val('t_type'),
    title: titleNow,
    ownerUserId: sel('t_owner_select'),
    assignees: assigneesArr.join(','),
    dueDate: val('t_due'),
    status: 'todo',
    priority: val('t_prio'),
    color: tc,
    memoText: val('t_memo'),
    estimateHours: '',
    actualHours: '',
    rrule: (el('t_rrule')?.value) || '',
    nextOccurrence: ''
  };

  gsr().withSuccessHandler(row => { patchRow('tasks', row); rerenderAfter('tasks'); }).upsertTask(t);
}
function editTask(id){
  const t = safeArr(DATA.tasks).find(x=>x.id===id); if(!t) return;
  el('t_title').value = t.title||'';
  el('t_project_select').value = t.projectId||'';
  el('t_type').value = t.type||'single';
  el('t_due').value = t.dueDate||'';
  el('t_owner_select').value = t.ownerUserId||'';

  const ms = el('t_assignees_select');
  if (ms) { Array.from(ms.options).forEach(o=>o.selected = String(t.assignees||'').split(',').includes(o.value)); }

  el('t_prio').value = normPriority(t.priority||'')||'';

  // ← ここを修正（存在チェック）
  const rr = el('t_rrule'); if (rr) rr.value = t.rrule||'';

  if(el('t_color')) el('t_color').value = (t.color && /^#[0-9a-fA-F]{6}$/.test(t.color)) ? t.color : '#ffffff';
  el('t_memo').value = t.memoText||'';
  if (el('t_editing_id')) el('t_editing_id').value = t.id||'';
  el('t_editing_id').dataset.orig = t.title || '';
  const btn = el('btn_add_task'); if(btn) btn.textContent='タスク更新';
}


function editTaskMemo(id) {
  const t = safeArr(DATA.tasks).find(x=>x.id===id); if (!t) return;
  const newMemo = prompt('タスクメモを編集', t.memoText||'');
  if (newMemo===null) return;
  gsr().withSuccessHandler(()=>refresh()).saveTaskMemo(id, newMemo);
}

// Docs for Project: create & open (クライアントは差分適用のみ)
async function createProjectDoc() {
  await ensureUsersLoaded();

  const projs = DATA.projects || [];
  const name  = val('p_name').trim();
  const target = projs.find(p => p.name === name) || projs[projs.length - 1];
  if (!target) { alert('先にプロジェクトを追加してください'); return; }

  gsr()
    .withSuccessHandler((res) => {
      // サーバは { ok:true, project, url } を返す想定
      if (res && res.project) { patchRow('projects', res.project); }
      rerenderAfter('projects');
      if (res && res.url) window.open(res.url, '_blank');
    })
    .withFailureHandler((err) => {
      alert('Docs 作成エラー: ' + (err && err.message ? err.message : err));
    })
    .createProjectDoc(target.id);
}


function syncProjectDoc(mode) {
  const ds = document.getElementById('p_doc_status').dataset||{};
  const docId = ds.docid;
  if (!docId) { alert('先にDocs作成/取得を実行してください'); return; }
  const memo = val('p_memo');
  const fn = (mode==='replace') ? 'replaceDocWithMemo' : 'appendDocWithMemo';
  gsr().withSuccessHandler(()=>alert('Docsへ同期しました'))[fn](docId, memo);
}
function openProjectDoc() {
  const ds = document.getElementById('p_doc_status')?.dataset||{};
  if (ds.docurl) window.open(ds.docurl, '_blank'); else alert('Docsが未作成です');
}

// Docs for Task: create & auto header
async function createTaskDoc() {
  await ensureUsersLoaded();

  const tasks = safeArr(DATA.tasks);
  const title = val('t_title');
  let target = tasks.find(t => t.title === title) || tasks[tasks.length - 1];
  if (!target) { alert('先にタスクを追加してください'); return; }

  gsr().withSuccessHandler(function (res) {
    const idx = DATA.tasks.findIndex(t => t.id === target.id);
    if (idx >= 0) { DATA.tasks[idx].docId = res.docId; DATA.tasks[idx].docUrl = res.url; renderTasksTable(); renderKanban(); }

    const proj = projectById(target.projectId || '');
    const parentProj = proj ? projectById(proj.parentProjectId || '') : null;
    const parentName = parentProj?.name || '';
    const owner = displayUser(target.ownerUserId || '');
    const assignees = Array.from(new Set(String(target.assignees||'').split(',').map(s=>s.trim()).filter(Boolean))).map(displayUser).join(', ');

    const now = new Date(); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');

    const projName = proj?.name || '-';
    const projStart = proj?.startDate || '-';
    const projEnd   = proj?.endDate   || '-';
    const projBudgetNum = Number(proj?.budget||0);

    let body = '# タスク: ' + (target.title || '') + '\n';
    body += 'プロジェクト: ' + projName + (parentName ? '（親: ' + parentName + '）' : '') + '\n';
    body += 'Docs作成日時: ' + `${y}-${m}-${d} ${hh}:${mm}` + '　プロジェクト期間: ' + projStart + '?' + projEnd + '\n';
    if (projBudgetNum) body += '予算: ' + projBudgetNum.toLocaleString() + ' 円\n';
    body += '主担当者: ' + (owner || '-') + '　担当者: ' + (assignees || '-') + '\n\n---';

    gsr().withSuccessHandler(function () { }).replaceDocWithMemo(res.docId, body);

    const st = document.getElementById('t_doc_status');
    if (st) { st.textContent = '作成済み'; st.dataset.docid = res.docId; st.dataset.docurl = res.url; }
  }).createTaskDoc(target.id);
}


function syncTaskDoc(mode) {
  const ds = document.getElementById('t_doc_status').dataset||{};
  const docId = ds.docid;
  if (!docId) { alert('先にDocs作成/取得を実行してください'); return; }
  const memo = val('t_memo');
  const fn = (mode==='replace') ? 'replaceDocWithMemo' : 'appendDocWithMemo';
  gsr().withSuccessHandler(()=>alert('Docsへ同期しました'))[fn](docId, memo);
}
function openTaskDoc() {
  const ds = document.getElementById('t_doc_status')?.dataset||{};
  if (ds.docurl) window.open(ds.docurl, '_blank'); else alert('Docsが未作成です');
}

// Status & deletion
function moveStatus(id, status) {
  gsr().withSuccessHandler((t)=>{
    const idx = safeArr(DATA.tasks).findIndex(x=>x.id===id);
    if (DATA && Array.isArray(DATA.tasks) && idx >= 0) DATA.tasks[idx].status = t.status;
    renderTasksTable(); renderKanban(); if (ACTIVE_TAB==='gantt') renderGantt();
  }).setTaskStatus(id, status);
}
function delTask(id) { gsr().withSuccessHandler(()=>{ dropRow('tasks', id); rerenderAfter('tasks'); }).deleteTask(id); }
function delSub(id)  { gsr().withSuccessHandler(()=>refresh()).deleteSubscription(id); }

// Edit/Archive project
function editProject(id){
  const p = safeArr(DATA.projects).find(x=>x.id===id); if(!p) return;
  el('p_name').value = p.name||'';
  el('p_parent_select').value = p.parentProjectId||'';
  el('p_owner_select').value = p.ownerUserId||'';
  el('p_priority').value = normPriority(p.priority||'')||'';
  el('p_budget').value = p.budget||'';
  el('p_start').value = p.startDate||'';
  el('p_end').value = p.endDate||'';
  el('p_memo').value = p.memoText||'';
  el('p_editing_id').value = p.id||'';
  if (el('p_color')) {
    el('p_color').value = (p.color && /^#[0-9a-fA-F]{6}$/.test(p.color)) ? p.color : '#ffffff';
  }
  el('p_editing_id').value = p.id||'';
  // ▼ 追加：編集開始時の元名称を保持
  el('p_editing_id').dataset.orig = p.name || '';
  const btn = el('btn_add_project'); if (btn) btn.textContent='プロジェクト更新';
}
function toggleArchiveProject(id){
  const p = safeArr(DATA.projects).find(x=>x.id===id); if(!p) return;
  const ns = (String(p.status||'').toLowerCase()==='archived') ? 'active' : 'archived';
  gsr().withSuccessHandler(()=>refresh()).upsertProject(Object.assign({}, p, {status: ns}));
}

// Subs page
function addSubscription(){
  const editId = val('s_editing_id');
  const amountRaw = Number(val('s_amount')||0);
  const taxRate = parseTaxRate(val('s_taxCode'));
  const taxIncl = (sel('s_taxIncl')==='true');
  let amountExclTax = amountRaw;
  let amountInclTax = amountRaw;
  if (taxRate > 0) {
    if (taxIncl) {
      amountInclTax = amountRaw;
      amountExclTax = amountRaw / (1 + taxRate);
    } else {
      amountExclTax = amountRaw;
      amountInclTax = amountRaw * (1 + taxRate);
    }
  }
  amountExclTax = Math.round(amountExclTax);
  amountInclTax = Math.round(amountInclTax);
  const s = {
    id: editId || undefined,
    serviceName: val('s_service'),
    vendor: val('s_vendor'),
    startDate: '',
    amount: amountRaw,
    taxIncluded: taxIncl,
    projectId: sel('s_project'),
    taxCode: val('s_taxCode'),
    amountInclTax,
    amountExclTax,
    account: val('s_account')||'サブスク費用',
    cycle: sel('s_cycle')||'monthly',
    nextBillDate: val('s_nextBill'),
    autoJournal: (sel('s_autoJournal')==='true'),
    memo: val('s_memo')
  };
  if (!s.serviceName){ alert('サービス名は必須です'); return; }
  gsr().withSuccessHandler(()=>{
    resetSubscriptionForm();
    refresh();
  }).upsertSubscription(s);
}
function renderSubsPage(){
  if (PAGE !== 'subs') return;
  const tb = document.querySelector('#subsTable tbody'); if (!tb) return;
  tb.innerHTML='';
  const rows = safeArr(DATA.subs).slice(0,500);
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.serviceName||'')}</td><td>${escapeHtml(r.vendor||'')}</td><td>${Number(r.amount||0).toLocaleString()}</td><td>${r.cycle||''}</td><td>${r.nextBillDate||''}</td><td>${(safeArr(DATA.projects).find(p=>p.id===r.projectId)?.name)||''}</td><td><button class="secondary" onclick="editSubscription('${r.id}')">編集</button> <button class="secondary" onclick="delSub('${r.id}')">削除</button></td>`;
    tb.appendChild(tr);
  });
}

function resetSubscriptionForm(){
  if (el('s_editing_id')) el('s_editing_id').value = '';
  if (el('s_service')) el('s_service').value = '';
  if (el('s_vendor')) el('s_vendor').value = '';
  if (el('s_amount')) el('s_amount').value = '';
  if (el('s_taxIncl')) el('s_taxIncl').value = 'true';
  if (el('s_taxCode')) el('s_taxCode').value = '';
  if (el('s_account')) el('s_account').value = '';
  if (el('s_cycle')) el('s_cycle').value = 'monthly';
  if (el('s_nextBill')) el('s_nextBill').value = '';
  if (el('s_project')) el('s_project').value = '';
  if (el('s_autoJournal')) el('s_autoJournal').value = 'false';
  if (el('s_memo')) el('s_memo').value = '';
}

function editSubscription(id){
  const s = safeArr(DATA.subs).find(x=>String(x.id)===String(id));
  if (!s) return;
  if (el('s_editing_id')) el('s_editing_id').value = s.id || '';
  if (el('s_service')) el('s_service').value = s.serviceName || '';
  if (el('s_vendor')) el('s_vendor').value = s.vendor || '';
  if (el('s_amount')) el('s_amount').value = s.amount != null ? s.amount : '';
  if (el('s_taxIncl')) el('s_taxIncl').value = String(!!s.taxIncluded);
  if (el('s_taxCode')) el('s_taxCode').value = s.taxCode || '';
  if (el('s_account')) el('s_account').value = s.account || '';
  if (el('s_cycle')) el('s_cycle').value = s.cycle || 'monthly';
  if (el('s_nextBill')) el('s_nextBill').value = s.nextBillDate || '';
  if (el('s_project')) el('s_project').value = s.projectId || '';
  if (el('s_autoJournal')) el('s_autoJournal').value = String(!!s.autoJournal);
  if (el('s_memo')) el('s_memo').value = s.memo || s.memoText || '';
}

let FACILITY_TAB = 'reservations';
try { const ft = localStorage.getItem('facility_tab'); if (ft) FACILITY_TAB = ft; } catch(_){ }
if (FACILITY_TAB !== 'reservations' && FACILITY_TAB !== 'assets') FACILITY_TAB = 'reservations';

function applyFacilityTabState(){
  if (PAGE !== 'facility') return;
  const grid = el('facility-grid');
  if (grid) grid.classList.toggle('single', FACILITY_TAB === 'reservations' || FACILITY_TAB === 'assets');
  document.querySelectorAll('#facility-tabs .tab').forEach(btn=>{
    const t = btn.getAttribute('data-tab');
    btn.classList.toggle('active', t === FACILITY_TAB);
  });
  document.querySelectorAll('#page-facility .facility-panel').forEach(panel=>{
    const t = panel.getAttribute('data-facility-tab');
    panel.classList.toggle('active', t === FACILITY_TAB);
  });
  if (FACILITY_TAB === 'assets') renderFacilityAssets();
  if (FACILITY_TAB === 'reservations') renderFacilityGantt();
}

function setFacilityTab(tab){
  FACILITY_TAB = tab || 'reservations';
  try { localStorage.setItem('facility_tab', FACILITY_TAB); } catch(_){ }
  applyFacilityTabState();
}

function resetFacilityAssetForm(){
  if (el('fa_editing_id')) el('fa_editing_id').value = '';
  if (el('fa_name')) el('fa_name').value = '';
  if (el('fa_color')) el('fa_color').value = '#60a5fa';
  if (el('fa_sort')) el('fa_sort').value = '';
  if (el('fa_active')) el('fa_active').value = 'true';
}

function addFacilityAsset(){
  const id = val('fa_editing_id');
  const payload = {
    id: id || undefined,
    name: val('fa_name'),
    color: val('fa_color'),
    sortOrder: val('fa_sort') ? Number(val('fa_sort')) : null,
    active: (sel('fa_active') === 'true'),
  };
  if (!payload.name){ alert('設備名は必須です'); return; }
  gsr().withSuccessHandler(()=>{
    resetFacilityAssetForm();
    refresh();
  }).upsertFacilityAsset(payload);
}

function editFacilityAsset(id){
  const r = safeArr(DATA.facilityAssets).find(x=>String(x.id)===String(id));
  if (!r) return;
  if (el('fa_editing_id')) el('fa_editing_id').value = r.id || '';
  if (el('fa_name')) el('fa_name').value = r.name || '';
  if (el('fa_color')) el('fa_color').value = (r.color && /^#[0-9a-fA-F]{6}$/.test(r.color)) ? r.color : '#60a5fa';
  if (el('fa_sort')) el('fa_sort').value = r.sortOrder != null ? r.sortOrder : '';
  if (el('fa_active')) el('fa_active').value = String(r.active !== false);
}

function delFacilityAsset(id){
  if(!confirmDel('設備')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteFacilityAsset(id);
}

function renderFacilityAssets(){
  if (PAGE !== 'facility') return;
  const tb = document.querySelector('#facilityAssetTable tbody'); if (!tb) return;
  tb.innerHTML = '';
  const rows = safeArr(DATA.facilityAssets).slice().sort((a,b)=>{
    const ao = Number(a.sortOrder||0);
    const bo = Number(b.sortOrder||0);
    if (ao !== bo) return ao - bo;
    return String(a.name||'').localeCompare(String(b.name||''),'ja');
  });
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const color = (r.color && /^#[0-9a-fA-F]{6}$/.test(r.color)) ? r.color : '#9ca3af';
    tr.innerHTML = `
      <td><span class="color-swatch" style="background:${color}"></span></td>
      <td>${escapeHtml(r.name||'')}</td>
      <td>${escapeHtml(String(r.sortOrder??''))}</td>
      <td>${r.active === false ? '無効' : '有効'}</td>
      <td style="white-space:nowrap;">
        <button class="secondary" onclick="editFacilityAsset('${escapeJsSq(String(r.id||''))}')">編集</button>
        <button class="secondary" onclick="delFacilityAsset('${escapeJsSq(String(r.id||''))}')">削除</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function resetFacilityForm(){
  if (el('fac_editing_id')) el('fac_editing_id').value = '';
  if (el('fac_facility')) el('fac_facility').value = '';
  if (el('fac_title')) el('fac_title').value = '';
  if (el('fac_user')) el('fac_user').value = '';
  const today = todayStr();
  if (el('fac_start_date')) el('fac_start_date').value = today;
  if (el('fac_end_date')) el('fac_end_date').value = today;
  if (el('fac_start_time')) el('fac_start_time').value = '';
  if (el('fac_end_time')) el('fac_end_time').value = '';
  if (el('fac_location')) el('fac_location').value = '';
  if (el('fac_project')) el('fac_project').value = '';
  if (el('fac_memo')) el('fac_memo').value = '';
}

function facilityStatusLabel(status){
  const map = { pending:'申請中', approved:'承認', rejected:'却下', canceled:'取消' };
  return map[String(status||'').toLowerCase()] || String(status||'');
}

let FAC_TIME_BOUND = false;
function bindFacilityTimeDefaults(){
  if (FAC_TIME_BOUND) return;
  const st = el('fac_start_time');
  const et = el('fac_end_time');
  const bind = (node)=>{
    if (!node) return;
    node.addEventListener('focus', ()=>facilitySuggestTimes());
    node.addEventListener('click', ()=>facilitySuggestTimes());
  };
  bind(st); bind(et);
  FAC_TIME_BOUND = true;
}

function facilitySuggestTimes(){
  const stEl = el('fac_start_time');
  const etEl = el('fac_end_time');
  if (!stEl || !etEl) return;

  const now = new Date();
  const mins = now.getMinutes();
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), 0, 0, 0);
  const addMin = mins === 0 ? 30 : (mins <= 30 ? 30 : 60);
  const next = new Date(base.getTime() + addMin * 60000);
  const fmt = (d)=> String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');

  if (!stEl.value) stEl.value = fmt(next);
  if (!etEl.value) etEl.value = fmt(new Date(next.getTime() + 60 * 60000));
}

function isFacilityOverlap(payload){
  const pid = String(payload.facilityId||'').trim();
  if (!pid) return false;
  const startDate = payload.startDate || '';
  const endDate = payload.endDate || payload.startDate || '';
  if (!startDate) return false;

  const startDay = parseYMDLocal(startDate);
  const endDay = parseYMDLocal(endDate);
  if (!startDay || !endDay) return false;

  const selfId = String(payload.id||'');
  const stMinRaw = minutesFromTime(payload.startTime);
  const etMinRaw = minutesFromTime(payload.endTime);
  const stMin = (stMinRaw == null) ? 0 : stMinRaw;
  const etMin = (etMinRaw == null) ? 24 * 60 : etMinRaw;

  for (const r of safeArr(DATA.facilityReservations)){
    if (String(r.facilityId||'') !== pid) continue;
    if (selfId && String(r.id||'') === selfId) continue;
    const rStatus = String(r.status||'').toLowerCase();
    if (rStatus === 'canceled' || rStatus === 'rejected') continue;

    const rStartDate = r.startDate || '';
    const rEndDate = r.endDate || r.startDate || '';
    const rStartDay = parseYMDLocal(rStartDate);
    const rEndDay = parseYMDLocal(rEndDate);
    if (!rStartDay || !rEndDay) continue;

    const maxStart = (rStartDay > startDay) ? rStartDay : startDay;
    const minEnd = (rEndDay < endDay) ? rEndDay : endDay;
    if (minEnd < maxStart) continue;

    const rStRaw = minutesFromTime(r.startTime);
    const rEtRaw = minutesFromTime(r.endTime);
    const rSt = (rStRaw == null) ? 0 : rStRaw;
    const rEt = (rEtRaw == null) ? 24 * 60 : rEtRaw;

    const overlap = Math.max(stMin, rSt) < Math.min(etMin, rEt);
    if (overlap) return true;
  }
  return false;
}

function addFacilityReservation(){
  const id = val('fac_editing_id');
  const facilityId = sel('fac_facility');
  const facility = safeArr(DATA.facilityAssets).find(f=>String(f.id)===String(facilityId));
  const facilityName = facility ? (facility.name || facility.id) : '';
  const startDate = val('fac_start_date');
  const endDate = val('fac_end_date') || startDate;
  const payload = {
    id: id || undefined,
    facilityId: facilityId || '',
    facilityName: facilityName || '',
    title: val('fac_title'),
    userId: sel('fac_user'),
    status: 'approved',
    startDate: startDate,
    endDate: endDate,
    startTime: val('fac_start_time'),
    endTime: val('fac_end_time'),
    location: val('fac_location'),
    projectId: sel('fac_project'),
    memoText: val('fac_memo'),
  };
  if (!payload.facilityId || !payload.facilityName){ alert('設備名は必須です'); return; }
  if (!payload.startDate){ alert('開始日は必須です'); return; }
  if (payload.endDate && payload.endDate < payload.startDate){
    alert('終了日は開始日以降にしてください。'); return;
  }
  if (payload.startDate === payload.endDate){
    const st = minutesFromTime(payload.startTime);
    const et = minutesFromTime(payload.endTime);
    if (st != null && et != null && et <= st){
      alert('終了時刻は開始時刻より後にしてください。'); return;
    }
  }
  if (isFacilityOverlap(payload)){
    alert('同じ設備は同時間帯に予約できません。時間を変更してください。');
    return;
  }
  gsr().withSuccessHandler(()=>{
    resetFacilityForm();
    refresh();
  }).upsertFacilityReservation(payload);
}

function editFacilityReservation(id){
  const r = safeArr(DATA.facilityReservations).find(x=>String(x.id)===String(id));
  if (!r) return;
  if (el('fac_editing_id')) el('fac_editing_id').value = r.id || '';
  if (el('fac_facility')) el('fac_facility').value = r.facilityId || '';
  if (el('fac_title')) el('fac_title').value = r.title || '';
  if (el('fac_user')) el('fac_user').value = r.userId || '';
  if (el('fac_start_date')) el('fac_start_date').value = r.startDate || '';
  if (el('fac_end_date')) el('fac_end_date').value = r.endDate || '';
  if (el('fac_start_time')) el('fac_start_time').value = r.startTime || '';
  if (el('fac_end_time')) el('fac_end_time').value = r.endTime || '';
  if (el('fac_location')) el('fac_location').value = r.location || '';
  if (el('fac_project')) el('fac_project').value = r.projectId || '';
  if (el('fac_memo')) el('fac_memo').value = r.memoText || '';
}

function delFacilityReservation(id){
  if(!confirmDel('設備予約')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteFacilityReservation(id);
}

function renderFacilityPage(){
  if (PAGE !== 'facility') return;
  const tb = document.querySelector('#facilityTable tbody'); if (!tb) return;
  const today = todayStr();
  if (el('fac_start_date') && !el('fac_start_date').value) el('fac_start_date').value = today;
  if (el('fac_end_date') && !el('fac_end_date').value) el('fac_end_date').value = today;
  bindFacilityTimeDefaults();
  tb.innerHTML = '';
  const facilityMap = new Map(safeArr(DATA.facilityAssets).map(f=>[String(f.id), f]));
  const rows = safeArr(DATA.facilityReservations).slice()
    .filter(r=>{
      const st = r.startDate || '';
      const ed = r.endDate || r.startDate || '';
      return st && ed && st <= today && ed >= today;
    })
    .sort((a,b)=>String(a.startDate||'').localeCompare(String(b.startDate||'')));
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const date = r.startDate || '';
    const dateEnd = r.endDate && r.endDate !== r.startDate ? ` - ${r.endDate}` : '';
    const timeStart = r.startTime || '';
    const timeEnd = r.endTime ? `-${r.endTime}` : '';
    const period = [date + dateEnd, (timeStart || timeEnd) ? (timeStart + timeEnd) : ''].filter(Boolean).join(' ');
    const fac = facilityMap.get(String(r.facilityId||'')) || null;
    const facColor = (fac && fac.color && /^#[0-9a-fA-F]{6}$/.test(fac.color)) ? fac.color : '#9ca3af';
    const facName = fac ? (fac.name || fac.id) : (r.facilityName || '');
    const loc = r.location || '';
    tr.innerHTML = `
      <td>${escapeHtml(period)}</td>
      <td><span class="color-swatch" style="background:${facColor}"></span>${escapeHtml(facName)}</td>
      <td>${escapeHtml(loc)}</td>
      <td>${escapeHtml(r.title||'')}</td>
      <td>${escapeHtml(nameByUserId(r.userId||''))}</td>
      <td>${escapeHtml(nameByProjectId(r.projectId||''))}</td>
      <td style="white-space:nowrap;">
        <button class="secondary" onclick="editFacilityReservation('${escapeJsSq(String(r.id||''))}')">編集</button>
        <button class="secondary" onclick="delFacilityReservation('${escapeJsSq(String(r.id||''))}')">削除</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  applyFacilityTabState();
}

const FAC_GANTT = { startHour: 6, endHour: 22, hourHeight: 48 };

function ensureFacilityWeekInput(){
  const input = el('fac_week_start');
  if (!input) return '';
  if (!input.value) input.value = mondayStart(todayStr());
  return input.value;
}

function shiftFacilityWeek(days){
  const input = el('fac_week_start'); if (!input) return;
  const base = input.value || mondayStart(todayStr());
  input.value = addDaysKey(base, Number(days||0));
  renderFacilityGantt();
}

function setFacilityWeekToday(){
  const input = el('fac_week_start'); if (!input) return;
  input.value = mondayStart(todayStr());
  renderFacilityGantt();
}

function minutesFromTime(t){
  if (!t) return null;
  const m = String(t).split(':').map(v=>Number(v));
  if (m.length < 2 || Number.isNaN(m[0]) || Number.isNaN(m[1])) return null;
  return (m[0] * 60) + m[1];
}

function ymdLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function renderFacilityGantt(){
  if (PAGE !== 'facility') return;
  const host = el('facility-gantt'); if (!host) return;
  const ws = ensureFacilityWeekInput();
  if (!ws) return;

  const days = Array.from({length:7}, (_,i)=>addDaysKey(ws, i));
  const dayNames = ['日','月','火','水','木','金','土'];
  const head = ['<div class="cell"></div>'].concat(days.map(d=>{
    const dt = new Date(`${d}T00:00:00`);
    const label = `${dt.getMonth()+1}/${dt.getDate()}(${dayNames[dt.getDay()]})`;
    return `<div class="cell">${escapeHtml(label)}</div>`;
  })).join('');

  const hours = [];
  for (let h = FAC_GANTT.startHour; h < FAC_GANTT.endHour; h++){
    hours.push(`<div class="time">${String(h).padStart(2,'0')}:00</div>`);
  }
  const body = days.map(d=>`<div class="fac-day-col${d===todayStr()?' today':''}" data-date="${d}"></div>`).join('');

  host.innerHTML = `
    <div class="fac-gantt">
      <div class="fac-gantt-head">${head}</div>
      <div class="fac-gantt-body">
        <div class="fac-gantt-timecol">${hours.join('')}</div>
        ${body}
      </div>
    </div>
  `;

  const colMap = {};
  host.querySelectorAll('.fac-day-col').forEach(col=>{
    const key = col.getAttribute('data-date');
    if (key) colMap[key] = col;
  });

  const facilityMap = new Map(safeArr(DATA.facilityAssets).map(f=>[String(f.id), f]));
  const reservations = safeArr(DATA.facilityReservations);
  const dayStartMin = FAC_GANTT.startHour * 60;
  const dayEndMin = FAC_GANTT.endHour * 60;
  const dayEvents = {};

  reservations.forEach(r=>{
    if (!r.startDate) return;
    const startDate = r.startDate;
    const endDate = r.endDate || r.startDate;
    const start = new Date(`${startDate}T00:00:00`);
    const end = new Date(`${endDate}T00:00:00`);
    if (!(end >= start)) return;
    for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const dateKey = ymdLocal(d);
      if (!colMap[dateKey]) continue;
      let startMin = dayStartMin;
      let endMin = dayEndMin;
      const st = minutesFromTime(r.startTime);
      const et = minutesFromTime(r.endTime);
      if (dateKey === startDate && st != null) startMin = Math.max(dayStartMin, st);
      if (dateKey === endDate && et != null) endMin = Math.min(dayEndMin, et);
      if (endMin <= startMin) {
        if (st != null && et == null) endMin = Math.min(dayEndMin, startMin + 60);
      }
      if (endMin <= startMin) continue;

      const fac = facilityMap.get(String(r.facilityId||'')) || null;
      const color = (fac && fac.color && /^#[0-9a-fA-F]{6}$/.test(fac.color)) ? fac.color : '#64748b';
      const facName = fac ? (fac.name || fac.id) : (r.facilityName || '');
      const who = nameByUserId(r.userId||'') || '';
      const loc = r.location ? ` / ${r.location}` : '';
      const labelTime = `${String(Math.floor(startMin/60)).padStart(2,'0')}:${String(startMin%60).padStart(2,'0')}-${String(Math.floor(endMin/60)).padStart(2,'0')}:${String(endMin%60).padStart(2,'0')}`;

      if (!dayEvents[dateKey]) dayEvents[dateKey] = [];
      dayEvents[dateKey].push({
        startMin,
        endMin,
        labelTime,
        who,
        loc,
        facName,
        color,
        status: String(r.status||''),
        title: r.title || ''
      });
    }
  });

  Object.keys(dayEvents).forEach(dateKey=>{
    const col = colMap[dateKey];
    if (!col) return;
    const list = dayEvents[dateKey].slice()
      .sort((a,b)=> (a.startMin - b.startMin) || (a.endMin - b.endMin));

    const colEnds = [];
    let maxCols = 0;
    list.forEach(ev=>{
      let placed = false;
      for (let i=0; i<colEnds.length; i++){
        if (colEnds[i] <= ev.startMin){
          colEnds[i] = ev.endMin;
          ev.col = i;
          placed = true;
          break;
        }
      }
      if (!placed){
        ev.col = colEnds.length;
        colEnds.push(ev.endMin);
      }
      if (colEnds.length > maxCols) maxCols = colEnds.length;
    });

    list.forEach(ev=>{
      const colCount = Math.max(1, maxCols);
      const colWidth = 100 / colCount;
      const leftPct = ev.col * colWidth;
      const evEl = document.createElement('div');
      evEl.className = 'fac-event';
      evEl.style.background = ev.color;
      evEl.style.top = `${((ev.startMin - dayStartMin) / 60) * FAC_GANTT.hourHeight}px`;
      evEl.style.height = `${((ev.endMin - ev.startMin) / 60) * FAC_GANTT.hourHeight}px`;
      evEl.style.left = `${leftPct}%`;
      evEl.style.width = `${colWidth}%`;
      evEl.style.right = 'auto';
      if (ev.status === 'rejected' || ev.status === 'canceled') {
        evEl.style.opacity = '0.4';
      }
      evEl.innerHTML = `
        <div>${escapeHtml(ev.facName)} ${escapeHtml(ev.title||'')}</div>
        <div class="meta">${escapeHtml(ev.labelTime)} ${escapeHtml(ev.who||'')}${escapeHtml(ev.loc||'')}</div>
      `;
      col.appendChild(evEl);
    });
  });
}

function resetWorkflowForm(){
  if (el('wf_editing_id')) el('wf_editing_id').value = '';
  if (el('wf_title')) el('wf_title').value = '';
  if (el('wf_requester')) el('wf_requester').value = '';
  if (el('wf_amount')) el('wf_amount').value = '';
  if (el('wf_due')) el('wf_due').value = '';
  if (el('wf_vendor')) el('wf_vendor').value = '';
  if (el('wf_account')) el('wf_account').value = '';
  if (el('wf_project')) el('wf_project').value = '';
  if (el('wf_status')) el('wf_status').value = 'draft';
  if (el('wf_memo')) el('wf_memo').value = '';
  if (el('wf_approvers')) Array.from(el('wf_approvers').options).forEach(o=>o.selected=false);
}

function workflowStatusLabel(status){
  const map = { draft:'下書き', pending:'申請中', approved:'承認', rejected:'却下', paid:'支払済' };
  return map[String(status||'').toLowerCase()] || String(status||'');
}

function addWorkflowRequest(){
  const id = val('wf_editing_id');
  const existing = id ? safeArr(DATA.workflowRequests).find(x=>String(x.id)===String(id)) : null;
  const approvers = selMulti('wf_approvers').join(',');
  const payload = {
    id: id || undefined,
    title: val('wf_title'),
    requesterId: sel('wf_requester'),
    amount: Number(val('wf_amount')||0),
    dueDate: val('wf_due'),
    vendor: val('wf_vendor'),
    account: val('wf_account'),
    projectId: sel('wf_project'),
    status: sel('wf_status') || 'draft',
    memoText: val('wf_memo'),
    approverIds: approvers,
    currentStep: existing?.currentStep ?? 0,
    requestDate: existing?.requestDate || todayStr(),
  };
  if (!payload.title){ alert('件名は必須です'); return; }
  if (!payload.requesterId){ alert('申請者は必須です'); return; }
  gsr().withSuccessHandler(()=>{
    resetWorkflowForm();
    refresh();
  }).upsertWorkflowRequest(payload);
}

function editWorkflowRequest(id){
  const r = safeArr(DATA.workflowRequests).find(x=>String(x.id)===String(id));
  if (!r) return;
  if (el('wf_editing_id')) el('wf_editing_id').value = r.id || '';
  if (el('wf_title')) el('wf_title').value = r.title || '';
  if (el('wf_requester')) el('wf_requester').value = r.requesterId || '';
  if (el('wf_amount')) el('wf_amount').value = r.amount != null ? r.amount : '';
  if (el('wf_due')) el('wf_due').value = r.dueDate || '';
  if (el('wf_vendor')) el('wf_vendor').value = r.vendor || '';
  if (el('wf_account')) el('wf_account').value = r.account || '';
  if (el('wf_project')) el('wf_project').value = r.projectId || '';
  if (el('wf_status')) el('wf_status').value = r.status || 'draft';
  if (el('wf_memo')) el('wf_memo').value = r.memoText || '';
  if (el('wf_approvers')) {
    const arr = String(r.approverIds||'').split(',').map(s=>s.trim()).filter(Boolean);
    Array.from(el('wf_approvers').options).forEach(o=>{ o.selected = arr.includes(o.value); });
  }
}

function delWorkflowRequest(id){
  if(!confirmDel('決済申請申請')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteWorkflowRequest(id);
}

function addWorkflowApproval(id, action){
  const selId = `wf_user_${safeId(id)}`;
  const approverId = el(selId)?.value || '';
  if (!approverId) { alert('承認者を選択してください'); return; }
  const comment = prompt(action==='approve' ? '承認コメント（任意）' : '却下理由（任意）') || '';
  const approvals = safeArr(DATA.workflowApprovals).filter(a=>String(a.workflowId)===String(id));
  const step = approvals.length + 1;
  const req = safeArr(DATA.workflowRequests).find(r=>String(r.id)===String(id));
  const approverIds = String(req?.approverIds||'').split(',').map(s=>s.trim()).filter(Boolean);
  const nextStatus = action==='reject' ? 'rejected' : (step >= approverIds.length ? 'approved' : 'pending');
  Busy.push();
  gsr().withSuccessHandler(()=>{
    gsr().withSuccessHandler(()=>refresh()).upsertWorkflowRequest({
      id,
      status: nextStatus,
      currentStep: step,
    });
    Busy.pop();
  }).addWorkflowApproval({
    workflowId: id,
    step,
    approverId,
    action,
    comment,
    actedAt: new Date().toISOString(),
  });
}

function renderWorkflowPage(){
  if (PAGE !== 'workflow') return;
  const tb = document.querySelector('#workflowTable tbody'); if (!tb) return;
  tb.innerHTML = '';
  const rows = safeArr(DATA.workflowRequests).slice()
    .sort((a,b)=>String(a.dueDate||'').localeCompare(String(b.dueDate||'')));
  const approvals = safeArr(DATA.workflowApprovals);
  const users = safeArr(DATA.users);
  const userOptions = ['<option value="">承認者</option>'].concat(users.map(u=>`<option value="${escapeHtml(u.id)}">${escapeHtml(u.name||u.email||u.id)}</option>`)).join('');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const route = String(r.approverIds||'').split(',').map(s=>s.trim()).filter(Boolean)
      .map(id=>escapeHtml(nameByUserId(id)||id)).join(' → ');
    const hist = approvals
      .filter(a=>String(a.workflowId)===String(r.id))
      .sort((a,b)=>Number(a.step||0)-Number(b.step||0))
      .map(a=>{
        const who = nameByUserId(a.approverId||'') || a.approverId || '';
        const when = a.actedAt ? attFormatMDHM(a.actedAt) : '';
        const label = a.action === 'approve' ? '承認' : (a.action === 'reject' ? '却下' : (a.action||''));
        const note = a.comment ? `(${escapeHtml(a.comment)})` : '';
        return `<div style="font-size:11px;">${escapeHtml(when)} ${escapeHtml(who)} ${escapeHtml(label)} ${note}</div>`;
      }).join('') || '<div class="muted" style="font-size:11px;">履歴なし</div>';

    tr.innerHTML = `
      <td>${escapeHtml(r.title||'')}</td>
      <td>${Number(r.amount||0).toLocaleString()}</td>
      <td>${escapeHtml(nameByUserId(r.requesterId||''))}</td>
      <td>${route ? route : '<span class="muted">未設定</span>'}</td>
      <td>${escapeHtml(r.dueDate||'')}</td>
      <td>${escapeHtml(workflowStatusLabel(r.status))}</td>
      <td>${hist}</td>
      <td style="white-space:nowrap;">
        <select id="wf_user_${safeId(r.id)}" style="margin-bottom:4px;">${userOptions}</select>
        <div class="toolbar" style="gap:6px;">
          <button class="secondary" onclick="addWorkflowApproval('${escapeJsSq(String(r.id||''))}','approve')">承認</button>
          <button class="secondary" onclick="addWorkflowApproval('${escapeJsSq(String(r.id||''))}','reject')">却下</button>
          <button class="secondary" onclick="editWorkflowRequest('${escapeJsSq(String(r.id||''))}')">編集</button>
          <button class="secondary" onclick="delWorkflowRequest('${escapeJsSq(String(r.id||''))}')">削除</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}
// --- Gantt ---
// 日幅は固定（ズーム廃止）
const GANTT_DAY_W = 40;

function applyGanttRange(){ renderGantt(false); }

function renderGantt(forceDefaults){
  if (ACTIVE_TAB !== 'gantt') return;
  const wrap = document.getElementById('gantt-container'); if (!wrap) return;

  const allTasks = filterTasks(safeArr(DATA.tasks));
  const projects = safeArr(DATA.projects);
  if (!allTasks.length) { wrap.innerHTML = '<div class="muted">該当タスクがありません</div>'; return; }

  let startInput = el('gantt-start').value;
  let endInput   = el('gantt-end').value;

  // 置き換え前の computeDefaults() を下記に差し替え
    function computeDefaults(){
      const today = parseYMDLocal(todayStr());  // ← 今日 (ローカル) を取得
      let latestDue = null;

      // 未完のタスク期限の最大を拾う
      allTasks.forEach(t=>{
        const done = (String(t.status||'').toLowerCase()==='done');
        if (!done && t.dueDate){
          const d = parseYMDLocal(t.dueDate);
          if (d && (!latestDue || d > latestDue)) latestDue = d;
        }
      });

      // 期限が取れない場合のフォールバック（作成日等）
      if (!latestDue){
        allTasks.forEach(t=>{
          const cand = parseYMDLocal(t.dueDate||t.nextOccurrence||t.startDate||t.createdAt);
          if (cand && (!latestDue || cand > latestDue)) latestDue = cand;
        });
      }

      // 左端は常に今日。右端は最大期限+2日 もしくは 今日+60日 の遅い方
      const endCandidateA = latestDue ? addDays(latestDue, 2) : null;
      const endCandidateB = addDays(today, 60);
      const end = (endCandidateA && endCandidateA > endCandidateB) ? endCandidateA : endCandidateB;

      return { start: today, end };
    }


  if (!startInput || !endInput || forceDefaults===true){
    const {start, end} = computeDefaults();
    const fmt = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if (!startInput || forceDefaults===true) { el('gantt-start').value = fmt(start); startInput = el('gantt-start').value; }
    if (!endInput   || forceDefaults===true) { el('gantt-end').value   = fmt(end);   endInput   = el('gantt-end').value; }
  }

  const minD = parseYMDLocal(startInput);
  const maxD = parseYMDLocal(endInput);
  if (!minD || !maxD || (maxD<minD)){ wrap.innerHTML = '<div class="muted">表示範囲の日付が不正です</div>'; return; }

  const projMap = Object.fromEntries(projects.map(p=>[p.id,p]));
  const grouped = {};
  allTasks.forEach(t=>{ (grouped[t.projectId||'']||(grouped[t.projectId||'']=[])).push(t); });
  const projIds = Object.keys(grouped);

  const pxPerDay = GANTT_DAY_W;
  const weekCellW = pxPerDay * 7;
  const monthCellW = Math.max(90, pxPerDay*5);
  const cellW = Math.round(GANTT_SCALE==='month' ? monthCellW : (GANTT_SCALE==='week' ? weekCellW : pxPerDay));

  // ベースの縦罫
  const baseGrid = `repeating-linear-gradient(to right, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent ${cellW}px)`;
  let headBgImage = baseGrid;
  let headBgPos   = '0 0';

  let gridW, scaleHtml;

  if (GANTT_SCALE==='month'){
    const months=[]; let d=new Date(minD.getFullYear(),minD.getMonth(),1), end=new Date(maxD.getFullYear(),maxD.getMonth(),1);
    while (d<=end){ months.push(new Date(d)); d=new Date(d.getFullYear(), d.getMonth()+1, 1); }
    gridW = months.length * cellW;

    scaleHtml = `<div class="gantt-scale" style="width:${gridW}px; display:flex; background-image:${headBgImage}; background-size:auto 100%;">` +
      months.map(md=>{
        const label = md.getFullYear()+'/'+String(md.getMonth()+1).padStart(2,'0');
        return `<div style="flex:0 0 ${cellW}px; text-align:center; font-size:11px;">${label}</div>`;
      }).join('') + `</div>`;

  } else {
    // day / week はピクセル幅は常に「日×pxPerDay」
    const totalDays = diffDays(minD, maxD) + 1;
    gridW = totalDays * pxPerDay;

    let cells='';
    if (GANTT_SCALE==='day'){
      // 週末ストライプ
      const dow = minD.getDay(); // Sun=0
      const sunOffset = ((7 - (dow % 7)) % 7) * pxPerDay;
      const satOffset = ((6 - dow + 7) % 7) * pxPerDay;
      const sunStripe = `repeating-linear-gradient(to right, rgba(220,38,38,.22) 0, rgba(220,38,38,.22) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
      const satStripe = `repeating-linear-gradient(to right, rgba(37,99,235,.18) 0, rgba(37,99,235,.18) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
      headBgImage = `${baseGrid}, ${sunStripe}, ${satStripe}`;
      headBgPos   = `0 0, ${sunOffset}px 0, ${satOffset}px 0`;

      for(let i=0;i<totalDays;i++){
        const d=addDays(minD, i);
        const label=(d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getDate().toString().padStart(2,'0');
        cells += `<div style="flex:0 0 ${pxPerDay}px; text-align:center; font-size:11px;">${label}</div>`;
      }

    } else {
      // week: 月曜はじまりの週で区切る。縦罫は週境界に合わせる
      const preDaysMon = ( (minD.getDay()+6) % 7 ); // Mon=0 ... Sun=6
      headBgPos = `${-preDaysMon*pxPerDay}px 0`;    // 罫線を週に整列

      const firstSpan = Math.min(7 - preDaysMon, totalDays);
      const rest = totalDays - firstSpan;
      const fullWeeks = Math.floor(rest / 7);
      const tail = rest % 7;

      const segs = [];
      let cursor = new Date(minD);

      // 1) 先頭の端数
      if (firstSpan>0){
        const end = addDays(cursor, firstSpan-1);
        segs.push({days:firstSpan, label:`${String(cursor.getMonth()+1).padStart(2,'0')}/${String(cursor.getDate()).padStart(2,'0')}?${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
        cursor = addDays(cursor, firstSpan);
      }
      // 2) フル週
      for(let i=0;i<fullWeeks;i++){
        const start = new Date(cursor);
        const end = addDays(start, 6);
        segs.push({days:7, label:`W${i+1} ${String(start.getMonth()+1).padStart(2,'0')}/${String(start.getDate()).padStart(2,'0')}?${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
        cursor = addDays(cursor, 7);
      }
      // 3) 末尾の端数
      if (tail>0){
        const start = new Date(cursor);
        const end = addDays(start, tail-1);
        segs.push({days:tail, label:`${String(start.getMonth()+1).padStart(2,'0')}/${String(start.getDate()).padStart(2,'0')}?${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`});
      }

      cells = segs.map(s=>`<div style="flex:0 0 ${s.days*pxPerDay}px; text-align:center; font-size:11px;">${s.label}</div>`).join('');
    }

    scaleHtml = `<div class="gantt-scale" style="width:${gridW}px; display:flex; background-image:${headBgImage}; background-position:${headBgPos}; background-size:auto 100%;">${cells}</div>`;
  }

  // ラベル／レーン
  const labelHtml = [];
  const laneHtml  = [];

  projIds.forEach(pid=>{
    const proj = projMap[pid];
    const color = hashColor(pid); // 既存
    const ownerName = nameByUserId(proj?.ownerUserId || '');
    const pDocUrl = getProjectDocUrl(pid);
    const docBadgeP = pDocUrl
      ? `<span class="doc-badge" title="Project Doc" data-tip="プロジェクトのドキュメントを開きます" onclick="openProjectDocById('${pid}')">📄PJDoc</span>`
      : '';
    const attNP = countAttachments('project', pid);
    const attBadgeP = attNP
      ? `<span class="doc-badge" title="添付 ${attNP}件" onclick="openAttachmentManager('project','${pid}')">??${attNP}</span>`
      : '';

    labelHtml.push(
      `<div style="height:26px; line-height:26px; padding:0 8px; font-weight:700; border-bottom:1px solid var(--border); background:#f3f4f6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ${escapeHtml(proj?.name || '(未割当)')}
        ${ownerName ? `<span class="muted"> / ${escapeHtml(ownerName)}</span>` : ''}
        ${docBadgeP} ${attBadgeP}
      </div>`
    );
    laneHtml.push(`<div style="position:relative; height:26px; border-bottom:1px solid var(--border); width:${gridW}px; background:#fafafa;"></div>`);

    (grouped[pid]||[]).forEach(t=>{
      const sDate = parseYMDLocal(t.startDate||t.createdAt);
      const eDate = parseYMDLocal(t.dueDate||t.nextOccurrence||t.startDate||t.createdAt);

      let off=0, w=0;
      if (sDate && eDate){
        if (GANTT_SCALE==='month'){
          const sm=sDate.getFullYear()*12+sDate.getMonth();
          const mm=minD.getFullYear()*12+minD.getMonth();
          const em=eDate.getFullYear()*12+eDate.getMonth();
          off=Math.max(0,(sm-mm)*cellW);
          w  =Math.max(6,(em-sm+1)*cellW-6);
        } else {
          off=Math.max(0, diffDays(minD, sDate)*pxPerDay);                          // 日→px
          w  =Math.max(6,(diffDays(sDate, eDate)+1)*pxPerDay-4);
        }
      }
      const title = escapeHtml(t.title||'');
      const bar = `<div title="${title}" style="position:absolute; left:${off}px; width:${w}px; top:4px; height:16px; border-radius:8px; background:${color.bg}; border:1px solid ${color.border};">
        <div style="position:absolute; left:0; right:0; top:-2px; font-size:11px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
      </div>`;

      // renderGantt 内、各タスクのラベル生成箇所を置き換え
      // 置換前：labelHtml.push(`<div ...>${escapeHtml(proj?.name || '(未割当)')} / <span class="muted">${title}</span></div>`);
      const tDocUrl = getTaskDocUrl(t.id);
      const docBadge = tDocUrl ? `<span class="doc-badge" title="Task Doc" data-tip="タスクのドキュメントを開きます" onclick="openTaskDocById('${t.id}')">📄PJDoc</span>` : '';
      const attN = countAttachments('task', t.id);

      const attBadge = attN ? `<span class="doc-badge" title="添付 ${attN}件" onclick="openAttachmentManager('task','${t.id}')">??${attN}</span>` : '';

      labelHtml.push(
        `<div style="height:24px; line-height:24px; padding:0 8px; border-bottom:1px solid var(--border); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          <strong>${title}</strong> ${docBadge} ${attBadge}
        </div>`
      );

      // 本体背景（dayのみ週末帯）
      let bgImage = baseGrid, bgPos='0 0', bgSize='auto 100%';
      if (GANTT_SCALE==='day'){
        const dow = minD.getDay();
        const sunOffset = ((7 - (dow % 7)) % 7) * pxPerDay;
        const satOffset = ((6 - dow + 7) % 7) * pxPerDay;
        const sunStripe = `repeating-linear-gradient(to right, rgba(220,38,38,.28) 0, rgba(220,38,38,.28) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
        const satStripe = `repeating-linear-gradient(to right, rgba(37,99,235,.24) 0, rgba(37,99,235,.24) ${pxPerDay}px, transparent ${pxPerDay}px, transparent ${pxPerDay*7}px)`;
        bgImage = `${baseGrid}, ${sunStripe}, ${satStripe}`;
        bgPos   = `0 0, ${sunOffset}px 0, ${satOffset}px 0`;
      } else if (GANTT_SCALE==='week'){
        const preDaysMon = ( (minD.getDay()+6) % 7 );
        bgPos = `${-preDaysMon*pxPerDay}px 0`; // 週境界に合わせる
      }

      // 今日ライン
      let todayBar = '';
      const today = new Date(); today.setHours(0,0,0,0);
      if (today >= minD && today <= maxD) {
        let left;
        if (GANTT_SCALE === 'month') {
          const sm = minD.getFullYear()*12+minD.getMonth();
          const tm = today.getFullYear()*12+today.getMonth();
          left = Math.max(0, (tm-sm)*cellW);
        } else {
          left = Math.max(0, diffDays(minD, today)*pxPerDay);
        }
        todayBar = `<div style="position:absolute; left:${left}px; top:0; bottom:0; width:2px; background:#ef4444; opacity:.5; pointer-events:none;"></div>`;
      }

      laneHtml.push(
        `<div style="position:relative; height:24px; border-bottom:1px solid var(--border); width:${gridW}px;
                    background-image:${bgImage}; background-position:${bgPos}; background-size:${bgSize};">
           ${todayBar}${bar}
         </div>`
      );
    });
  });

  wrap.innerHTML =
    '<div class="gantt-wrap" style="border:1px solid var(--border); border-radius:8px; overflow:hidden; width:100%; max-width:100%;">'
    + '<div class="gantt-head" style="display:flex; border-bottom:1px solid var(--border);">'
    +   '<div class="gantt-left" style="width:320px; flex:0 0 320px; font-weight:600; background:var(--card); border-right:1px solid var(--border);">プロジェクト / タスク</div>'
    +   `<div class="gantt-right show-scrollbars" id="gantt-head-scroll" style="overflow:auto; flex:1 1 auto; max-width:100%;">${scaleHtml}</div>`
    + '</div>'
    + '<div class="gantt-main" style="display:flex; max-height:60vh;">'
    +   '<div class="gantt-left show-scrollbars" style="width:320px; flex:0 0 320px; border-right:1px solid var(--border); overflow:auto;">'+ labelHtml.join('') +'</div>'
    +   '<div class="gantt-right show-scrollbars" id="gantt-body-scroll" style="overflow:auto; flex:1 1 auto; max-width:100%;">'+ laneHtml.join('') +'</div>'
    + '</div>'
    + '</div>';

  // スクロール同期（ヘッダー?本体）? 双方向 & ループ防止
  const head = document.getElementById('gantt-head-scroll');
  const body = document.getElementById('gantt-body-scroll');
  if (head && body){
    let lock=false;
    head.addEventListener('scroll', ()=>{ if(lock) return; lock=true; body.scrollLeft = head.scrollLeft; lock=false; }, {passive:true});
    body.addEventListener('scroll', ()=>{ if(lock) return; lock=true; head.scrollLeft = body.scrollLeft; lock=false; }, {passive:true});
  }
}


// --- Ledger entry/plan (existing) ---
function addLedgerEntry(){
  const e = {
    date: val('l_date'),
    type: sel('l_type'),
    title: val('l_title'),             // ★ 追加
    amount: Number(val('l_amount')||0),
    account: val('l_account'),
    counterpart: val('l_counterpart'),
    projectId: sel('l_project'),
    memoText: val('l_memo')
  };
  if (!e.date || !e.type || !e.amount){ alert('日付・区分・金額は必須です'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertLedgerEntry(e);
}
function combinedLedgerRows(){
  const singles = safeArr(DATA.ledger).map(e => ({
    kind: '単発',
    date: e.date || '',
    type: e.type,
    title: e.title || '',
    amount: Number(e.amount||0),
    account: e.account,
    counterpart: e.counterpart,
    projectId: e.projectId,
    memoText: e.memoText || '',
    id: e.id || ''
  }));

  // 次回発生日がある定期のみ一覧に混ぜる
  const plans = safeArr(DATA.ledgerPlans).map(p => ({
    kind: '定期',
    date: p.nextOccurrence || '',   // 一覧上は「次回」を日付として扱う
    type: p.type,
    title: p.title || '',
    amount: Number(p.amount||0),
    account: p.account,
    counterpart: p.counterpart,
    projectId: p.projectId,
    memoText: p.memoText || '',
    rrule: p.rrule || '',
    id: p.id || ''
  }));

  return [...singles, ...plans]
    .filter(r => r.date)  // 日付未設定は除外
    .sort((a,b)=> String(b.date).localeCompare(String(a.date)));
}

function addLedgerPlan(){
  const p = {
    title: val('lp_title'),
    type: sel('lp_type'),
    amount: Number(val('lp_amount')||0),
    account: val('lp_account'),
    counterpart: val('lp_counterpart'),
    projectId: sel('lp_project'),
    rrule: val('lp_rrule'),
    nextOccurrence: val('lp_next'),
    memoText: val('lp_memo')
  };
  if (!p.title || !p.type || !p.amount || !p.rrule){ alert('名称・区分・金額・RRULEは必須です'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertLedgerPlan(p);
}
function delLedgerPlan(id){ gsr().withSuccessHandler(()=>refresh()).deleteLedgerPlan(id); }

function renderLedgerPage(){
  if (PAGE !== 'ledger') return;

  // 定期の管理テーブル（既存）?そのまま
  const tbp = document.querySelector('#ledgerPlanTable tbody');
  if (tbp){
    tbp.innerHTML='';
    safeArr(DATA.ledgerPlans)
      .slice()
      .sort((a,b)=> String(a.nextOccurrence||'').localeCompare(String(b.nextOccurrence||'')))
      .forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.title||'')}</td>
          <td>${escapeHtml(r.type||'')}</td>
          <td>${Number(r.amount||0).toLocaleString()}</td>
          <td>${escapeHtml(r.rrule||'')}</td>
          <td>${escapeHtml(r.nextOccurrence||'')}</td>
          <td><button class="secondary" onclick="delLedgerPlan('${r.id}')">削除</button></td>`;
        tbp.appendChild(tr);
      });
  }

  // ★ 単発＋定期（次回）を統合した一覧（最新50件）
  const tbl = document.querySelector('#ledgerTableFull tbody');
  if (tbl){
    tbl.innerHTML='';
    combinedLedgerRows().slice(0,50).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date||''}</td>
        <td>${r.kind}</td>
        <td>${r.type||''}</td>
        <td>${escapeHtml(r.title||'')}</td>
        <td>${Number(r.amount||0).toLocaleString()}</td>
        <td>${escapeHtml(r.account||'')}</td>
        <td>${escapeHtml(r.counterpart||'')}</td>
        <td>${escapeHtml(nameByProjectId(r.projectId||''))}</td>
        <td>${escapeHtml(r.memoText||'')}</td>`;
      tbl.appendChild(tr);
    });
  }
}



// --- Misc/Utils ---
function parseISODateOnly(s){ const m=/^(\d{4})-(\d{2})-(\d{2})/.exec(String(s||'')); return m?new Date(+m[1],+m[2]-1,+m[3]):null; }
function ageDaysForTask(t){
  // 更新日があれば優先、なければ作成日。完了は0固定
  if (String(t.status||'').toLowerCase()==='done') return 0;
  const base = parseISODateOnly(t.updatedAt) || parseISODateOnly(t.createdAt);
  if(!base) return 0;
  const today = new Date(); today.setHours(0,0,0,0);
  return Math.max(0, Math.floor((today - base) / (24*60*60*1000)));
}
function ageClass(t){
  const d = ageDaysForTask(t);
  if (d>=14) return 'age-14';
  if (d>=7)  return 'age-7';
  if (d>=3)  return 'age-3';
  return '';
}
function showToast(kind, msg, ms=2200){
  const host = document.getElementById('toast-stack'); if(!host) return alert(msg);
  const div = document.createElement('div');
  div.className = 'toast ' + (kind==='ok'?'ok':(kind==='ng'?'ng':'')); div.textContent = msg;
  host.appendChild(div);
  setTimeout(()=>{ div.style.opacity=.0; div.style.transform='translateY(6px)'; }, ms);
  setTimeout(()=>div.remove(), ms+350);
}

function val(id){
  const n = document.getElementById(id);
  return n ? n.value : '';
}

function sel(id){ const el=document.getElementById(id); return el ? (el.value||'') : ''; }
function selMulti(id){ const el=document.getElementById(id); if (!el) return []; return Array.from(el.selectedOptions).map(o=>o.value); }
function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }

// Escape for embedding into single-quoted JS string literals inside onclick="...".
function escapeJsSq(s){
  return String(s ?? '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\r/g, '\\r')
    .replace(/\n/g, '\\n')
    .replace(/\u2028/g, '\\u2028')
    .replace(/\u2029/g, '\\u2029');
}
function el(id){ return document.getElementById(id); }
function forceResync(){ refresh(); }
// ---- Theme Color helpers (Spreadsheetの color 列を優先) ----
function hashColor(id){
  const s = String(id||'0'); let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  const hue = Math.abs(h)%360;
  return { bg: `hsl(${hue}, 80%, 85%)`, border: `hsl(${hue}, 70%, 55%)` };
}
function hexToRgb(hex){
  if(!hex) return null;
  let h = String(hex).trim();
  if(h.startsWith('#')) h = h.slice(1);
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return null;
  const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
  return {r,g,b};
}

function transparentTheme(){ return { bg: 'transparent', border: 'rgba(0,0,0,.1)' }; }

// 既存 themeFromHex / themeFor を調整
function themeFromHex(hex, fallbackId){
  if (!hex) return hashColor(fallbackId||'0');
  if (String(hex).toLowerCase()==='#ffffff') return transparentTheme(); // 白は透明扱い
  const rgb = hexToRgb(hex);
  if(!rgb){ return hashColor(fallbackId||'0'); }
  // 以降は既存のまま（パステル生成）...
  const r=rgb.r/255, g=rgb.g/255, b=rgb.b/255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=0; s=0; } else {
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      default: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  const H=Math.round(h*360);
  const S=Math.round(Math.min(0.45, s)*100);
  const L=96;
  return { bg: `hsl(${H}, ${S}%, ${L}%)`, border: `rgb(${rgb.r},${rgb.g},${rgb.b})` };
}

function themeFor(projectId, task){
  const p = projectById(projectId||'');
  const tHex = (task && task.color) ? String(task.color).trim() : '';
  const pHex = (p && p.color) ? String(p.color).trim() : '';
  // 無指定 or #ffffff は透明背景
  if(!tHex || tHex.toLowerCase()==='#ffffff'){
    if(!pHex || pHex.toLowerCase()==='#ffffff') return transparentTheme();
    return themeFromHex(pHex, projectId||'0');
  }
  return themeFromHex(tHex, projectId||'0');
}

function setVersionAndDebug(v){
  const badge = document.getElementById('app-version');
  const displayV = newerVersionPrefer(APP_VERSION, v); // 古い値で上書きさせない
  if (badge) badge.textContent = displayV;

  const bar = document.getElementById('debug-bar');
  if (!bar) return;
  const chip = document.getElementById('sheet-chip'); if (chip) { chip.textContent=''; }
  bar.innerHTML = '';
  const btn = document.createElement('button');
  btn.className = 'secondary';
  btn.textContent = 'データ再取得';
  btn.onclick = ()=>refresh();
  bar.appendChild(btn);

  const span = document.createElement('span');
  span.className = 'muted';
  const u = safeArr(DATA.users).length;
  const p = safeArr(DATA.projects).length;
  const t = safeArr(DATA.tasks).length;
  const s = safeArr(DATA.subs).length;
  span.textContent = `Users:${u} / Projects:${p} / Tasks:${t} / Subs:${s}`;
  bar.appendChild(span);


  gsr().withSuccessHandler((info)=>{
    const chip2 = document.getElementById('sheet-chip');
    if (chip2 && info && info.id) {
      chip2.textContent = `Sheet: ${info.name} (${info.id.slice(0,6)}...)`;
      chip2.onclick = ()=>window.open(info.url,'_blank'); chip2.style.cursor='pointer';
    }
  }).getSpreadsheetInfo();
     rpc('getLogoDataUrl')
    .then(url => {
      setWatermark(url, 0.05, '820px');
      //setHeaderLogo(url);
    })
    .catch(() => { /* ロゴは無くても動作には支障なし */ });
}


function fetchSpreadsheetInfo(){
  gsr().withSuccessHandler((info)=>{
    const elx = document.getElementById('ss-info');
    if (elx) elx.value = info && info.url ? `${info.name} (${info.id}) [via:${info.via}]` : '[未設定]';
  }).getSpreadsheetInfo();
}
function saveSpreadsheetId(){
  const id = (document.getElementById('ss-input')||{}).value || '';
  if (!id) { alert('スプレッドシートIDを入力してください'); return; }
  gsr().withSuccessHandler(()=>{
    alert('接続先を更新しました。ページを再読み込みします。');
    try{ fetchSpreadsheetInfo(); }catch(_){}
    try{ refresh(); }catch(_){}
  }).setTargetSpreadsheetId(id);
}

async function runDiagnostics(){
  const log = (m)=>{ const elx=document.getElementById('dbg_log'); if(elx){ elx.textContent += m+'\n'; elx.scrollTop = elx.scrollHeight; } };
  try{
    log('start');
    const meta = await rpc('getSpreadsheetInfo'); document.getElementById('dbg_sheet').textContent = JSON.stringify(meta,null,2);
    const ping = await rpc('ping'); const client = {users:safeArr(DATA.users).length, projects:safeArr(DATA.projects).length, tasks:safeArr(DATA.tasks).length, subs:safeArr(DATA.subs).length};
    document.getElementById('dbg_counts').textContent = JSON.stringify({server: ping.counts, client}, null, 2);
    const all = await rpc('getAllDataPlain'); document.getElementById('dbg_all').textContent = JSON.stringify({version:all.version, users:(all.users||[]).length, projects:(all.projects||[]).length, sampleUser:(all.users||[])[0]||null, sampleProject:(all.projects||[])[0]||null}, null, 2);
    const u = await rpc('debugPeek','Users',5); const p = await rpc('debugPeek','Projects',5);
    document.getElementById('dbg_users').textContent = JSON.stringify(u.rows, null, 2);
    document.getElementById('dbg_projects').textContent = JSON.stringify(p.rows, null, 2);
    log('done');
  }catch(e){ alert('Diagnostics error: '+(e && e.message ? e.message : e)); log('ERROR '+(e && e.message ? e.message : e)); }
}

function openHelpPopup(){ alert('上部の「使い方」タブに、詳細な手引きを用意しています。'); }

// rpcRun helper
function gsr(){
  try {
    return rpcRun.withFailureHandler(function(e){
      alert('サーバーエラー: ' + (e && e.message ? e.message : e));
    });
  } catch (err) {
    alert('初期化エラー: ' + err);
    throw err;
  }
}

window.addEventListener('error', (e)=>{
  try { alert('クライアント側エラー: ' + (e.message||e.error||e)); } catch(_) {}
});

document.addEventListener('DOMContentLoaded', function(){
  initTenantFromUrl();
  loadTenantLabel();
  loadAppSettings();
  syncSettingsForm();
  // Settings are loaded when the Settings page opens.
// --- RRULE helpers ---
function rruleFromMode(mode, baseDate){
  // baseDate: 'YYYY-MM-DD' or ''
  const d = parseYMDLocal(baseDate || '');
  const dow = ['SU','MO','TU','WE','TH','FR','SA'];
  if (!mode) return '';
  switch(mode){
    case 'DAILY':
      return 'FREQ=DAILY;INTERVAL=1';
    case 'WEEKLY':
      if (d) return 'FREQ=WEEKLY;INTERVAL=1;BYDAY=' + dow[d.getDay()];
      return 'FREQ=WEEKLY;INTERVAL=1';
    case 'BIWEEKLY':
      if (d) return 'FREQ=WEEKLY;INTERVAL=2;BYDAY=' + dow[d.getDay()];
      return 'FREQ=WEEKLY;INTERVAL=2';
    case 'MONTHLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=1;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=1';
    case 'BIMONTHLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=2;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=2';
    case 'QUARTERLY':
      if (d) return 'FREQ=MONTHLY;INTERVAL=3;BYMONTHDAY=' + d.getDate();
      return 'FREQ=MONTHLY;INTERVAL=3';
    case 'YEARLY':
      if (d) return 'FREQ=YEARLY;INTERVAL=1;BYMONTH='+(d.getMonth()+1)+';BYMONTHDAY='+d.getDate();
      return 'FREQ=YEARLY;INTERVAL=1';
    default:
      return '';
  }
}

function bindRruleUI(){
  // Task quick form
  const modeT = el('t_rrule_mode'), inputT = el('t_rrule'), dueT = el('t_due'), typeT = el('t_type');
  function updateTaskRrule(){ if(!modeT) return;
    const m = modeT.value;
    if(!m){ return; }
    const base = dueT && dueT.value ? dueT.value : '';
    inputT.value = rruleFromMode(m, base);
  }
  if (modeT && inputT){
    modeT.addEventListener('change', updateTaskRrule);
    if (dueT) dueT.addEventListener('change', function(){ if(modeT.value) updateTaskRrule(); });
    if (typeT) typeT.addEventListener('change', function(){ const wrap = modeT.closest('div'); if(!wrap) return; wrap.style.opacity = (typeT.value==='recurring') ? '1' : '.6'; });
  }

  // Ledger plan form
  const modeL = el('lp_rrule_mode'), inputL = el('lp_rrule'), nextL = el('lp_next');
  function updateLedgerRrule(){ if(!modeL) return;
    const m = modeL.value;
    if(!m){ return; }
    const base = nextL && nextL.value ? nextL.value : '';
    inputL.value = rruleFromMode(m, base);
  }
  if (modeL && inputL){
    modeL.addEventListener('change', updateLedgerRrule);
    if (nextL) nextL.addEventListener('change', function(){ if(modeL.value) updateLedgerRrule(); });
  }
}

  loadFiltersFromLS();  // まずローカル保存を読む
  applyHash();          // URL指定があれば上書き
  try { applyRouteFromUrl(); } catch(_){ }
  try { bindDashboardTabs?.(); } catch(_){ }
  // 既存指定（LS/ハッシュ）が無ければ「完了以外」を初期値に
  if (!FILTERS.status && !OVERDUE) {
    FILTERS.status = 'notdone';
    const s = el('f_status'); if (s) s.value = 'notdone';
  }
  try { const m=document.getElementById('gantt-scale-mode'); if(m) m.value=GANTT_SCALE; } catch(_){ }
  try { setVersionAndDebug(APP_VERSION); fetchSpreadsheetInfo(); refresh(); bindRruleUI(); } catch(e){ alert('初期化時エラー: ' + e); }
  applyAppSettings({ respectRoute: true });

  // クイック追加の折りたたみ状態を反映
  //try { QUICK_COLLAPSED = (localStorage.getItem('quick_collapsed')==='1'); applyQuickPanelState(); } catch(_){}
  try { QUICK_COLLAPSED = (localStorage.getItem('quick_collapsed')==='0'); applyQuickPanelState(); } catch(_){}
});

function setWatermark(url, opacity, size){
  const wm = document.getElementById('watermark');
  if(!wm) return;
  if (typeof opacity === 'number') wm.style.setProperty('--wm-opacity', String(opacity));
  if (size) wm.style.setProperty('--wm-size', size);
  wm.style.backgroundImage = `url('${url}')`;
}
function toCSV(rows, headers){
  const esc = (v)=>{ const s=(v==null?'':String(v)); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; };
  return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
}
function exportCSV(kind){
  let rows, headers, name;
  if (kind==='tasks'){
    rows = filterTasks(safeArr(DATA.tasks));
    headers = ['id','projectId','title','type','ownerUserId','assignees','dueDate','status','priority','memoText','createdAt','updatedAt','docId','docUrl'];
    name = 'tasks';
  } else {
    rows = safeArr(DATA.projects);
    headers = ['id','name','parentProjectId','ownerUserId','priority','budget','startDate','endDate','status','memoText','createdAt','updatedAt','docId','docUrl'];
    name = 'projects';
  }
  const csv = '\ufeff' + toCSV(rows, headers); // BOM付き（Excel想定）
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${name}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}



// --- Local date helpers（UTCズレ防止） ---
function parseYMDLocal(s){
  if(!s) return null;
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]); // local midnight
  const d = new Date(s);
  if (isNaN(d)) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function diffDays(a, b){
  const aa = new Date(a.getFullYear(), a.getMonth(), a.getDate());
  const bb = new Date(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((bb - aa)/dayMs);
}

function setHeaderLogo(url){
  const img = document.getElementById('brandmark');
  if (img){ img.src = url; img.style.display = 'inline-block'; }
}

/* --- Quick panel collapse --- */
let QUICK_COLLAPSED = false;
function applyQuickPanelState(){
  const grid=document.getElementById('dashboard-grid');
  const panel=document.getElementById('quick-panel');
  const btn=document.getElementById('qp-toggle');
  if(!grid||!panel) return;
  if (panel.dataset && panel.dataset.disabled === '1'){
    grid.classList.remove('collapsed-left');
    panel.classList.remove('collapsed');
    if (btn) btn.style.display = 'none';
    return;
  }
  if(!btn) return;
  grid.classList.toggle('collapsed-left', QUICK_COLLAPSED);
  panel.classList.toggle('collapsed', QUICK_COLLAPSED);
  btn.textContent = QUICK_COLLAPSED ? '?' : '?';
  btn.title = QUICK_COLLAPSED ? '展開' : '折りたたみ';
}
function toggleQuickPanel(){
  const panel=document.getElementById('quick-panel');
  if (panel && panel.dataset && panel.dataset.disabled === '1') return;
  QUICK_COLLAPSED = !QUICK_COLLAPSED;
  try{ localStorage.setItem('quick_collapsed', QUICK_COLLAPSED ? '1':'0'); }catch(_){}
  applyQuickPanelState();
}
function parseAttachmentLines(text){
  // 1行に1添付。URLだけ or "タイトル,URL" 両対応。Drive URLは fileId 抜き出し
  const lines = String(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return lines.map(line=>{
    let title='', url=line;
    const m = line.split(',').map(s=>s.trim());
    if(m.length>=2){ title=m[0]; url=m[1]; }
    // Drive ID 抜き出し
    const dm = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    const fileId = dm ? dm[1] : '';
    const type = fileId ? 'drive' : 'url';
    if(!title) title = url.replace(/^https?:\/\//,'').slice(0,80);
    return {type, title, url, fileId};
  });
}

// 置き換え
function targetFromQuick(kind){
  
  if(kind==='project'){
    const projs = safeArr(DATA.projects);
    const name = val('p_name');
    return projs.find(p=>p.name===name) || projs[projs.length-1];

 } else if (kind==='task'){
   const tasks = safeArr(DATA.tasks);
   const title = val('t_title');
   return tasks.find(t=>t.title===title) || tasks[tasks.length-1];
 } else if(kind==='shared'){
    const list = safeArr(DATA.shareds);
    const editId = (document.getElementById('sh_editing_id')||{}).value || '';
    if (editId) {
      const hit = list.find(s => String(s.id) === String(editId));
      if (hit) return hit;
    }
    const name = (document.getElementById('sh_name')||{}).value || '';
    if (name) {
      const byName = list.find(s => s.name === name);
      if (byName) return byName;
    }
    return list[list.length - 1]; // 最終追加をフォールバック
  } else {
   // 必要なら minute/daily などもここに追加
   return null;
  }
}

function openAttachDialog(kind){
  const tgt = targetFromQuick(kind);
  if (!tgt){
    alert(kind === 'shared'
      ? '先に「共有資料を追加」してから添付してください'
      : '先に対象を追加してください');
    return;
  }
  openAttachmentModal(kind, tgt.id, tgt.name || tgt.title || tgt.id);
}


function openAttachmentManager(kind, id){
  openAttachmentModal(kind, id, id);
}
function renderMinutesPage(){
  if (PAGE!=='minutes') return;
  const md = document.getElementById('m_date');
  if (md && !md.value) md.value = todayStr();  // ★ 追加
  const tb = document.querySelector('#minutesTable tbody'); if(!tb) return;
  tb.innerHTML='';
  safeArr(DATA.minutes).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).forEach(m=>{
    const proj = nameByProjectId(m.projectId||'');
    const idsCsv = m.taskIds || m.taskId || '';
    const taskTitles = String(idsCsv).split(',')
      .map(id => safeArr(DATA.tasks).find(t=>t.id===id)?.title)
      .filter(Boolean).join(', ');
    const link = m.docUrl ? `<button class="secondary" onclick="window.open('${m.docUrl}','_blank')">Docs</button>` : '';
    const attN = countAttachments('minute', m.id||'');
    const attB = attN? `<button class="secondary" onclick="openAttachmentManager('minute','${m.id}')">??${attN}</button>`:'';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.date||''}</td>
      <td>${escapeHtml(m.title||'')}</td>
      <td>${escapeHtml(proj)}${taskTitles?(' / '+escapeHtml(taskTitles)) : ''}</td>
      <td>${escapeHtml(m.attendees||'')}</td>
      <td>
        ${link} ${attB}
        <button class="secondary" onclick="delMinute('${m.id}')">削除</button>
    </td>`;
    tb.appendChild(tr);
  });
}


async function createMinuteDocFromForm(){
  return guardRun('createMinute', async () => {
    const taskIdsCsv = selMulti('m_tasks').join(',');
    const m = {
      date: val('m_date'),
      title: val('m_title'),
      projectId: sel('m_project'),
      taskIds: taskIdsCsv,
      taskId: taskIdsCsv.split(',')[0] || '',
      attendees: val('m_attendees')
    };
    if(!m.date || !m.title){ alert('日付と件名は必須です'); return; }
    await ensureUsersLoaded();

    Busy.push();
    rpcRun
      .withSuccessHandler((res)=>{
        if(res && res.docId){
          const body = buildMinutesBody(m);
          rpcRun
            .withSuccessHandler(()=>{
              // ▼▼ ここで自動添付 ▼▼
              // ▼▼ ここで自動添付（project + 複数 task）▼▼
              if (res.url) {
                const niceTitle = `議事録：${m.title}（${m.date}）`;
                const attachments = [{ type: 'url', title: niceTitle, url: res.url }];

                // 複数タスクIDを配列化（空要素除去）
                const taskIds = (m.taskIds || '')
                  .split(',')
                  .map(s => s.trim())
                  .filter(Boolean);

                // 何件添付するかをカウント（project分 + task分）
                let pending = 0;
                const done = () => {
                  pending--;
                  if (pending <= 0) { Busy.pop(); refresh(); }
                };
                const fail = (err) => {
                  alert('添付に失敗: ' + err);
                  done();
                };

                // project への添付
                if (m.projectId) {
                  pending++;
                  rpcRun
                    .withSuccessHandler(done)
                    .withFailureHandler(fail)
                    .upsertAttachments('project', m.projectId, attachments);
                }

                // 各 task への添付（複数）
                taskIds.forEach(taskId => {
                  pending++;
                  rpcRun
                    .withSuccessHandler(done)
                    .withFailureHandler(fail)
                    .upsertAttachments('task', taskId, attachments);
                });

                // 添付対象が1件もない場合は即終了
                if (pending === 0) {
                  Busy.pop();
                  refresh();
                }
              } else {
                Busy.pop();
                refresh();
              }
              // ▲▲ 自動添付ここまで ▲▲
            })
            .withFailureHandler(()=>Busy.pop())
            .replaceDocWithMemo(res.docId, body);
        }else{
          refresh();
          Busy.pop();
        }
      })
      .withFailureHandler(()=>Busy.pop())
      .createMinuteDoc(m);
  });
}



function renderDailyPage(){
  if (PAGE!=='daily') return;
  const dIn = document.getElementById('dr_date');
  if (dIn && !dIn.value) dIn.value = todayStr();   // ★ これを追加
  const tb = document.querySelector('#dailyTable tbody'); if(!tb) return;
  tb.innerHTML='';
  safeArr(DATA.dailyReports).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).forEach(r=>{
    const user = nameByUserId(r.userId||'');
    const proj = nameByProjectId(r.projectId||'');
    const tasks = r.tasks||'';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date||''}</td><td>${escapeHtml(user||'')}</td><td>${Number(r.hours||0)}</td>
      <td>${escapeHtml(r.body||'')}</td><td>${escapeHtml(proj)}${tasks?(' / '+escapeHtml(tasks)) : ''}</td>`;
    tb.appendChild(tr);
  });
}
function addDailyReport(){
  const tasksCsv = selMulti('dr_tasks').join(',');
  const r = { date: val('dr_date'), userId: sel('dr_user'), hours: Number(val('dr_hours')||0), projectId: sel('dr_project'), body: val('dr_body'), tasks: tasksCsv };
  if(!r.date || !r.userId ){ alert('日付・ユーザーは必須です'); return; }
  gsr().withSuccessHandler(()=>refresh()).upsertDailyReport(r);
}

// 全体レンダリングに統合
//(function(orig){ window.renderAll = function(){ orig && orig(); renderLedgerPage(); renderMinutesPage(); renderDailyPage(); } })(window.renderAll||null);

function countProjectAttachmentsDeep(projectId){
  const pid = String(projectId||'');
  const direct = listAttachments('project', pid).length;
  const taskIds = safeArr(DATA.tasks).filter(t=>String(t.projectId)===pid).map(t=>String(t.id));
  const taskAtt = safeArr(DATA.attachments)
    .filter(a=>String(a.parentType||a.parent_type||a.type||'')==='task' && taskIds.includes(String(a.parentId||a.parent_id||'')))
    .filter(isValidAttachment).length;
  const minuteIds = safeArr(DATA.minutes).filter(m=>String(m.projectId)===pid).map(m=>String(m.id));
  const minuteAtt = safeArr(DATA.attachments)
    .filter(a=>String(a.parentType||a.parent_type||a.type||'')==='minute' && minuteIds.includes(String(a.parentId||a.parent_id||'')))
    .filter(isValidAttachment).length;
  return direct + taskAtt + minuteAtt;
}
async function createDailyReportDocFromForm(){
  return guardRun('createDaily', async () => {
    const tasksCsv = selMulti('dr_tasks').join(',');
    const r = { date: val('dr_date'), userId: sel('dr_user'), hours: Number(val('dr_hours')||0), projectId: sel('dr_project'), body: val('dr_body'), tasks: tasksCsv };
    if(!r.date || !r.userId){ alert('日付とユーザーは必須です'); return; }
    await ensureUsersLoaded();

    Busy.push();
    rpcRun
      .withSuccessHandler((res)=>{
        if(res && res.docId){
          const body = buildDailyBody(r);
          rpcRun
            .withSuccessHandler(()=>refresh())
            .withFailureHandler(()=>Busy.pop())
            .replaceDocWithMemo(res.docId, body);
        }else{
          refresh();
          Busy.pop();
        }
      })
      .withFailureHandler(()=>Busy.pop())
      .createDailyReportDoc(r);
  });
}

// ユーザーセレクトにも反映
(function(orig){
  window.renderDailyPage = function(){
    orig && orig();
    if (PAGE!=='daily') return;

    // 月の初期値
    const m = el('dr_month');
    if (m && !m.value){
      const now = new Date(); m.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
    // ユーザーフィルタ
    const uf = el('dr_user_filter');
    if (uf){
      while (uf.options.length) uf.remove(0);
      uf.add(new Option('全ユーザー', ''));
      safeArr(DATA.users).forEach(u=> uf.add(new Option(u.name||u.email||u.id, u.id)));
      uf.onchange = renderDailyCalendar;
    }
    renderDailyCalendar();
  };
})(window.renderDailyPage);

function renderDailyCalendar(){
  if (PAGE!=='daily') return;
  const cont = el('daily-calendar'); if(!cont) return;

  const monthStr = el('dr_month')?.value || new Date().toISOString().slice(0,7);
  const [yy,mm] = monthStr.split('-').map(Number);
  const first = new Date(yy, mm-1, 1), last = new Date(yy, mm, 0);

  // 表示範囲（前後の端数を含めて日曜?土曜で埋める）
  const start = new Date(first); start.setDate(first.getDate() - first.getDay());
  const end   = new Date(last);  end.setDate(last.getDate() + (6 - last.getDay()));

  const userFilter = el('dr_user_filter')?.value || '';
  let html = '<div class="calendar-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;">';
  for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const inMonth = (d.getMonth()===first.getMonth());
    const items = safeArr(DATA.dailyReports).filter(r=>r.date===ymd && (!userFilter || r.userId===userFilter));
    const lis = items.map(r=>{
      const u = nameByUserId(r.userId||'');
      const label = `${u}${r.docUrl?'':'（未作成）'}`;
      return r.docUrl
        ? `<div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">&bull; <a href="${r.docUrl}" target="_blank">${escapeHtml(label)}</a></div>`
        : `<div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">&bull; ${escapeHtml(label)}</div>`;
    }).join('');
    html += `<div class="card see-through" style="padding:6px; min-height:84px; ${inMonth?'':'opacity:.6;'}">
      <div style="font-weight:700; font-size:12px; margin-bottom:4px;">${d.getDate()}</div>
      ${lis || '<div class="muted" style="font-size:12px;">-</div>'}
    </div>`;
  }
  html += '</div>';
  cont.innerHTML = html;
}
// ── 添付一覧を行の下にスライド表示 ──
function toggleAttachmentList(kind, id, anchor){
  try{
    const tr = anchor && anchor.closest ? anchor.closest('tr') : null;
    if (!tr) { openAttachmentModal(kind, id, id); return; }

    const next = tr.nextElementSibling;
    if (next && next.classList.contains('attachment-inline-row')) {
      const panel = next.querySelector('.inline-attachments');
      if (panel) {
        panel.style.maxHeight = panel.scrollHeight + 'px';
        requestAnimationFrame(()=>{ panel.classList.remove('open'); panel.style.maxHeight = '0px'; });
        setTimeout(()=>next.remove(), 220);
      } else {
        next.remove();
      }
      return;
    }

    const items = listAttachments(kind, id);
    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;
    const holder = document.createElement('tr');
    holder.className = 'attachment-inline-row';
    const td = document.createElement('td');
    td.colSpan = cols;

    if (!items.length) {
      td.innerHTML = `<div class="inline-attachments muted">添付はありません</div>`;
    } else {
      const html = items.map(a=>{
        const href = attachmentHref(a);
        const title = escapeHtml(a.title || href || '(無題)');
        return `<div style="margin:4px 0;">?? <a href="${escapeHtml(href)}" target="_blank" rel="noopener">${title}</a></div>`;
      }).join('');
      td.innerHTML = `<div class="inline-attachments slide">${html}</div>`;
    }

    holder.appendChild(td);
    tr.after(holder);

    const panel = td.querySelector('.inline-attachments.slide');
    if (panel) {
      requestAnimationFrame(()=>{
        panel.classList.add('open');
        panel.style.maxHeight = panel.scrollHeight + 'px';
      });
      panel.addEventListener('transitionend', ()=>{ panel.style.maxHeight = 'none'; }, { once:true });
    }
  }catch(e){ console.error(e); }
}
// ── プロジェクトの関連タスク一覧トグル（表の行の直下に差し込む） ──
function toggleProjectTaskList(projectId, anchor){
  try{
    const tr = anchor.closest('tr');
    if(!tr) return;

    // 既に開いていたら閉じる
    const next = tr.nextElementSibling;
    if(next && next.classList.contains('proj-task-row')){
      next.remove();
      return;
    }

    const list = safeArr(DATA.tasks)
      .filter(t => String(t.projectId) === String(projectId))
      // 未完→完了 の順でざっくり並べる
      .sort((a,b) => {
        const ad = String(a.status||'').toLowerCase()==='done' ? 1 : 0;
        const bd = String(b.status||'').toLowerCase()==='done' ? 1 : 0;
        if (ad !== bd) return ad - bd;
        return String(a.dueDate||'9999-12-31').localeCompare(String(b.dueDate||'9999-12-31'));
      });

    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;
    const holder = document.createElement('tr');
    holder.className = 'proj-task-row';
    const td = document.createElement('td');
    td.colSpan = cols;

    if(!list.length){
      td.innerHTML = `<div class="inline-attachments muted">このプロジェクトのタスクはありません</div>`;
    }else{
      const items = list.map(t=>{
        const title = escapeHtml(t.title||'');
        const due   = t.dueDate ? ` [${t.dueDate}]` : '';
        const st    = labelStatus(t.status||'');              // 例: 未着手/進行中/保留中/完了
        const ass   = String(t.assignees||'')
                        .split(',').filter(Boolean).map(nameByUserId).join(', ');
        const tDoc  = getTaskDocUrl(t.id);
        const attN  = countAttachments('task', t.id);
        const docLink = tDoc ? `<a href="${tDoc}" target="_blank" rel="noopener">??</a>` : '';
        const attBtn  = attN ? `<button class="secondary mini" onclick="openAttachmentManager('task','${t.id}')">??${attN}</button>` : '';
        return `
          <div style="display:flex; gap:8px; align-items:center; padding:2px 0;">
            <span style="min-width:72px;" class="muted">${escapeHtml(st)}</span>
            <span style="flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              <strong>${title}</strong>${due}
              ${ass ? `<span class="muted"> ・ ${escapeHtml(ass)}</span>` : ''}
            </span>
            <span class="toolbar" style="gap:6px;">
              ${docLink} ${attBtn}
              <button class="secondary mini" onclick="openTaskDocById('${t.id}')">Task</button>
              <button class="secondary mini" onclick="moveStatus('${t.id}','done')">完了</button>
            </span>
          </div>`;
      }).join('');

      // 既存の添付UIのスタイルを流用
      td.innerHTML = `<div class="inline-attachments">${items}</div>`;
    }

    holder.appendChild(td);
    tr.after(holder);
  }catch(e){ console.error(e); }
}
function getProjectTaskCounts(pid){
  const list = safeArr(DATA.tasks).filter(t => String(t.projectId) === String(pid));
  const done = list.filter(t => String(t.status||'').toLowerCase() === 'done').length;
  const open = list.length - done;
  return {open, done, list};
}

function projectStatusLabel(s){
  return String(s||'').toLowerCase()==='archived' ? '完了' : 'アクティブ';
}

function toggleProjectTasks(projectId, anchor){
  try{
    const tr = anchor.closest('tr'); if(!tr) return;
    const next = tr.nextElementSibling;
    if(next && next.classList.contains('proj-task-row')){ next.remove(); return; }
    const {list} = getProjectTaskCounts(projectId);
    const cols = tr.parentElement.closest('table')?.querySelectorAll('thead th')?.length || 1;

    const html = list.length ? list.map(t=>{
      const st = String(t.status||'').toLowerCase();
      const pr = normPriority(t.priority||'');
      const tDoc = getTaskDocUrl(t.id);
      const attN = countAttachments('task', t.id);
      const att = attN ? ` <span class="doc-badge" title="添付 ${attN}件" onclick="openAttachmentManager('task','${t.id}')">??${attN}</span>` : '';
      const doc = tDoc ? ` <span class="doc-badge" title="Task Doc" data-tip="タスクのドキュメントを開きます" onclick="openTaskDocById('${t.id}')">📄PJDoc</span>` : '';
      return `<div style="padding:2px 0;">
        <span class="pill" style="margin-right:6px;">${labelStatus(st)}</span>
        <span class="pill prio-badge ${pr==='高'?'prio-high':pr==='中'?'prio-mid':pr==='低'?'prio-low':''}" style="margin-right:6px;">${escapeHtml(pr)}</span>
        <strong>${escapeHtml(t.title||'')}</strong>
        <span class="muted">（期限: ${t.dueDate||'-'}）</span>${doc}${att}
      </div>`;
    }).join('') : '<div class="muted">タスクはありません</div>';

    const holder = document.createElement('tr');
    holder.className = 'proj-task-row';
    const td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = `<div class="inline-attachments">${html}</div>`;
    holder.appendChild(td);
    tr.after(holder);
  }catch(e){ console.error(e); }
}
function renderProjectsPage(){
  if (PAGE !== 'projects') return;
  const tb = document.querySelector('#projAllTable tbody'); if (!tb) return;
  tb.innerHTML='';

  // フィルタ収集
  const kw  = (document.getElementById('proj_f_keyword')?.value || '').trim().toLowerCase();
  const own = document.getElementById('proj_f_owner')?.value || '';
  const pri = document.getElementById('proj_f_priority')?.value || '';
  const stf = document.getElementById('proj_f_status')?.value || ''; // ''|'active'|'archived'

  // 絞り込み（完了含む！）
  let rows = safeArr(DATA.projects).slice(0,1000).filter(p=>{
    if (stf && String(p.status||'').toLowerCase() !== stf) return false;
    if (own && String(p.ownerUserId||'') !== own) return false;
    if (pri && normPriority(p.priority||'') !== pri) return false;
    if (kw){
      const ownerName = nameByUserId(p.ownerUserId||'') || '';
      const memberIds = String(p.members || p.assignees || p.memberIds || '')
        .split(',').map(s=>s.trim()).filter(Boolean);
      const memberNames = memberIds.map(id=>nameByUserId(id) || displayUser(id) || id).join(' ');
      const hay = (p.name||'') + ' ' + (p.memoText||'') + ' ' + ownerName + ' ' + memberNames;
      if (!hay.toLowerCase().includes(kw)) return false;
    }
    return true;
  });

  rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));

  for (const r of rows){
    const pDocUrl = getProjectDocUrl(r.id);
    const badge   = pDocUrl ? `<span class="doc-badge" title="Project Doc" data-tip="プロジェクトのドキュメントを開きます" onclick="openProjectDocById('${r.id}')">📄PJDoc</span>` : '';
    const docBtn  = pDocUrl ? `<button class="secondary" data-tip="プロジェクトのドキュメントを開きます" onclick="openProjectDocById('${r.id}')">📄PJ Doc</button>` : '';
    const attN    = countProjectAttachmentsDeep(r.id);
    const attBadge= attN ? `<span class="doc-badge" data-tip="添付URL一覧を表示します。" title="添付 ${attN}件" onclick="toggleAttachmentList('project','${r.id}', this)">??${attN}添付を表示</span>` : '';

    const theme = themeFor(r.id, null);
    const bg = ` style="background:${theme.bg}"`;

    // 優先度の色分け（タスク一覧と同様）
    const prioLabel = normPriority(r.priority || '');
    const prc = prioLabel==='高' ? 'high' : prioLabel==='中' ? 'mid' : prioLabel==='低' ? 'low' : '';

    const {open, done} = getProjectTaskCounts(r.id);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td${bg}>${escapeHtml(r.name||'')}${badge} ${attBadge}</td>
      <td${bg}>${projectStatusLabel(r.status)}</td>
      <td${bg}>${(safeArr(DATA.projects).find(p=>p.id===r.parentProjectId)?.name)||''}</td>
      <td${bg}>${escapeHtml(nameByUserId(r.ownerUserId||''))}</td>
      <td class="cell-prio ${prc?('prio-'+prc):''}">
        <span class="pill prio-badge ${prc?('prio-'+prc):''}">${escapeHtml(prioLabel||'')}</span>
      </td>
      <td${bg}>${Number(r.budget||0).toLocaleString()}</td>
      <td${bg}>${r.startDate||''}?${r.endDate||''}</td>
      <td${bg}><b>${open}</b></td>
      <td${bg}><b>${done}</b></td>
      <td${bg}>${attN||0}</td>
      <td style="white-space:nowrap;">
        ${docBtn}
        <button class="secondary" onclick="toggleProjectTasks('${r.id}', this)">関連タスク</button>
        <button class="secondary" onclick="editProject('${r.id}')">編集</button>
        <button class="secondary" onclick="toggleArchiveProject('${r.id}')">${(String(r.status||'').toLowerCase()==='archived')?'復活':'完了'}</button>
        <button class="secondary" data-tip="このプロジェクトと関連タスク/添付URLを完全削除します（元に戻せません）。" onclick="deleteProjectHard('${r.id}')">完全削除</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}
function applyProjectsFilters(){ try{ renderProjectsPage(); }catch(_){} }
function clearProjectsFilters(){
  ['proj_f_keyword','proj_f_owner','proj_f_priority','proj_f_status'].forEach(id=>{
    const e=document.getElementById(id); if(e) e.value='';
  });
  applyProjectsFilters();
}
// ★追加：Usersを確実に揃えてから続行
function ensureUsersLoaded(timeoutMs=1500){
  return new Promise(res=>{
    if (safeArr(DATA.users).length) return res();
    gsr().withSuccessHandler(x=>{
      DATA.users = Array.isArray(x) ? x : safeArr((x||{}).users);
      res();
    }).getUsers();
    setTimeout(res, timeoutMs);  // サーバ遅延時の逃げ道
  });
}

// ★追加：UUIDを素通ししない“寛容”な名前解決
function displayUser(id){
  const s = String(id||'').trim();
  if(!s) return '';
  const u = safeArr(DATA.users).find(x => x.id===s || x.email===s || x.name===s);
  if (u) return u.name || u.email || u.id;
  if (/^\S+@\S+\.\S+$/.test(s)) return s; // emailならそのまま表示
  return '（未登録）';                     // UUID等はここに落とす
}
function buildMinutesBody(m){
  const projName = nameByProjectId(m.projectId||'') || '-';
  const idsCsv = m.taskIds || m.taskId || '';
  const titles = String(idsCsv)
    .split(',')
    .map(id => safeArr(DATA.tasks).find(t => t.id === id)?.title)
    .filter(Boolean)
    .join(', ');
  const attendees = (m.attendees||'')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .join(', ');

  return `# 議事録: ${m.title||''}
日付: ${m.date||''}
プロジェクト: ${projName}
参加者: ${attendees || '-'}
関連タスク: ${titles || '-'}
---
`;
}



// ★Dailyテンプレート生成
function buildDailyBody(r){
  const userName = displayUser(r.userId||'');
  const projName = nameByProjectId(r.projectId||'') || '-';
  // r.tasks は CSV で来る前提（createDailyReportDocFromForm内）
  const taskTitles = String(r.tasks||'').split(',').map(id=>safeArr(DATA.tasks).find(t=>t.id===id)?.title).filter(Boolean).join(', ') || '-';

  return (
`# 日報 ${r.date||''} / ${userName||'-'}

`
  );
}
async function openIcsDialog(){
  try{
    const base = await rpc('getIcsBaseUrl'); // 先ほどのサーバ関数
    if(!base){ alert('ICSのベースURLが未設定です（管理者向け: setIcsBaseUrl を一度実行してください）'); return; }
    const who = prompt('購読対象: 空=すべて / ユーザーIDを入力で担当者別（例: u_123）', '');
    const url = base.replace(/\/exec.*/,'/exec') + '?feed=tasks' + (who?('&assignee='+encodeURIComponent(who)):'');
    prompt('このURLをGoogle/Outlookのカレンダー購読に貼り付けてください', url);
  }catch(e){ alert('ICS URL 取得に失敗: '+(e && e.message ? e.message : e)); }
}
function toggleUpdatesPanel(){
  const p = document.getElementById('updates-panel');
  if(!p) return;
  const visible = getComputedStyle(p).display !== 'none';
  p.style.display = visible ? 'none' : '';
  if (!visible) {
    try { renderUpdates(); } catch(_) {}
    try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){}
  }
}
// スイムOFF時に、標準の4カラム骨組みが無ければ復元する
function ensureDefaultBoardColumns() {
  const host = document.querySelector('#view-board .kanban');
  if (!host) return;
  const need =
    !document.getElementById('col_todo') ||
    !document.getElementById('col_doing') ||
    !document.getElementById('col_blocked') ||
    !document.getElementById('col_done');

  if (need) {
    host.innerHTML = `
      <div class="col see-through" data-status="todo" ondragover="allowDrop(event)" ondrop="onDrop(event, 'todo')">
        <h3>未着手 <span class="muted" id="cnt_todo">0</span></h3>
        <div id="col_todo"></div>
      </div>
      <div class="col see-through" data-status="doing" ondragover="allowDrop(event)" ondrop="onDrop(event, 'doing')">
        <h3>進行中 <span class="muted" id="cnt_doing">0</span></h3>
        <div id="col_doing"></div>
      </div>
      <div class="col see-through" data-status="blocked" ondragover="allowDrop(event)" ondrop="onDrop(event, 'blocked')">
        <h3>保留中 <span class="muted" id="cnt_blocked">0</span></h3>
        <div id="col_blocked"></div>
      </div>
      <div class="col see-through" data-status="done" ondragover="allowDrop(event)" ondrop="onDrop(event, 'done')">
        <h3>完了 <span class="muted" id="cnt_done">0</span></h3>
        <div id="col_done"></div>
      </div>`;
  }
}
// ▼ 同一人物を一意にするための正規化
function userKey(any){
  const s = String(any||'').trim();
  const u = safeArr(DATA.users).find(x => x.id===s || x.email===s || x.name===s);
  return u ? String(u.id) : s; // 見つかれば内部ID、なければそのまま
}
function orderedAssigneeIds(ownerUserId, assignees){
  const owner = String(ownerUserId||'').trim();
  const raw = Array.isArray(assignees) ? assignees : String(assignees||'').split(',');
  const ids = raw.map(s=>String(s||'').trim()).filter(Boolean);
  const seen = new Set();
  const uniq = [];
  for (const id of ids) { if (!seen.has(id)) { seen.add(id); uniq.push(id); } }
  if (!owner) return uniq;
  return [owner, ...uniq.filter(x=>x!==owner)];
}
function primaryAssigneeKey(t){
  if (t.ownerUserId) return userKey(t.ownerUserId);
  const tokens = String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean);
  if (tokens.length) return userKey(tokens[0]);
  return '__NONE__';
}
function displayNameFromKey(key){
  if (key==='__NONE__') return '未割当';
  return nameByUserId(key) || displayUser(key) || key;
}
// id属性用の安全な文字列
function safeId(s){ return 'x' + String(s).replace(/[^a-zA-Z0-9_-]+/g,'_'); }
function resetProjectForm(){
  const ids = ['p_name','p_parent_select','p_owner_select','p_priority','p_budget','p_start','p_end','p_memo','p_color'];
  ids.forEach(id=>{
    const e = el(id); if(!e) return;
    if (e.tagName === 'SELECT') e.value = '';
    else if (e.type === 'color') e.value = '#ffffff';
    else e.value = '';
  });
  const hid = el('p_editing_id'); if (hid){ hid.value=''; hid.dataset.orig=''; }
  const btn = el('btn_add_project'); if (btn){ btn.textContent='プロジェクト追加'; btn.title=''; }
  showToast('ok','新規追加モードに切り替えました');
}

function resetTaskForm(){
  const ms = el('t_assignees_select'); if (ms) Array.from(ms.options).forEach(o=> o.selected=false);

  const ids = ['t_title','t_project_select','t_type','t_due','t_owner_select','t_prio','t_rrule','t_memo','t_color'];
  ids.forEach(id=>{
    const e = el(id); if(!e) return;
    if (e.id==='t_type') e.value='single';
    else if (e.tagName === 'SELECT') e.value = '';
    else if (e.type === 'color') e.value = '#ffffff';
    else e.value = '';
  });

  const hid = el('t_editing_id'); if (hid){ hid.value=''; hid.dataset.orig=''; }
  const btn = el('btn_add_task'); if (btn){ btn.textContent='タスク追加'; btn.title=''; }
  showToast('ok','新規追加モードに切り替えました');
}
function bindQuickNameGuards(){
  const pName = el('p_name'), pHid = el('p_editing_id'), pBtn = el('btn_add_project');
  if (pName && pHid && pBtn) {
    const upd = ()=> {
      const edit = !!pHid.value;
      const orig = pHid.dataset.orig || '';
      const now  = (pName.value||'').trim();
      pBtn.textContent = (edit && orig && now && now!==orig) ? '? 上書き更新' : (edit ? 'プロジェクト更新' : 'プロジェクト追加');
      pBtn.title = (pBtn.textContent==='? 上書き更新') ? '編集中のプロジェクトをリネームして上書きします' : '';
    };
    pName.addEventListener('input', upd);
  }

  const tName = el('t_title'), tHid = el('t_editing_id'), tBtn = el('btn_add_task');
  if (tName && tHid && tBtn) {
    const upd = ()=> {
      const edit = !!tHid.value;
      const orig = tHid.dataset.orig || '';
      const now  = (tName.value||'').trim();
      tBtn.textContent = (edit && orig && now && now!==orig) ? '? 上書き更新' : (edit ? 'タスク更新' : 'タスク追加');
      tBtn.title = (tBtn.textContent==='? 上書き更新') ? '編集中のタスクをリネームして上書きします' : '';
    };
    tName.addEventListener('input', upd);
  }
}

// DOMContentLoaded の末尾あたりに一行追加
// 既存: setVersionAndDebug(APP_VERSION); fetchSpreadsheetInfo(); refresh(); bindRruleUI();
bindQuickNameGuards();
// 追加：共有資料 CRUD + 表示
function resetSharedForm(){
  el('sh_editing_id').value = '';
  el('sh_name').value = '';
  el('sh_category').value = '';
  el('sh_owner').value = '';
  el('sh_tags').value = '';
  if (el('sh_color')) el('sh_color').value = '#ffffff';
  el('sh_memo').value = '';
}

function addShared(){
  return guardRun('addShared', async () => {
    const s = {
      name: val('sh_name'),
      category: val('sh_category'),
      ownerUserId: sel('sh_owner'),
      tags: val('sh_tags'),
      color: val('sh_color'),
      memoText: val('sh_memo')
    };
    if(!s.name){ alert('名称は必須です'); return; }
    Busy.wrap(
      rpcRun
        .withSuccessHandler(()=>refresh())
        .upsertShared(s)
    );
  });
}


function editShared(id){
  const s = safeArr(DATA.shareds).find(x=>x.id===id); if(!s) return;
  el('sh_editing_id').value = s.id || '';
  el('sh_name').value       = s.name || '';
  el('sh_category').value   = s.category || '';
  el('sh_owner').value      = s.ownerUserId || '';
  el('sh_tags').value       = s.tags || '';
  if (el('sh_color')) el('sh_color').value = (s.color && /^#[0-9a-fA-F]{6}$/.test(s.color)) ? s.color : '#ffffff';
  el('sh_memo').value       = s.memoText || '';
}

function toggleArchiveShared(id){
  const s = safeArr(DATA.shareds).find(x=>x.id===id); if(!s) return;
  const ns = (String(s.status||'').toLowerCase()==='archived')?'active':'archived';
  const send = Object.assign({}, s, {status: ns});
  gsr().withSuccessHandler(()=>refresh()).upsertShared(send);
}

function delShared(id){
  if(!confirm('削除しますか？')) return;
  gsr().withSuccessHandler(()=>{ dropRow('shareds', id); rerenderAfter('shareds'); }).deleteShared(id);
}

// 「共有資料」表示
function renderShareds(){
  // ページ外でも安全に空振りする作りに
  const tb = document.querySelector('#sharedTable tbody');
  if (!tb) return;

  tb.innerHTML = '';
  const rows = safeArr(DATA.shareds).slice(0, 1000)
    .sort((a,b)=> String(a.category||'').localeCompare(String(b.category||'')) || String(a.name||'').localeCompare(String(b.name||'')));

  rows.forEach(r=>{
    const owner = nameByUserId(r.ownerUserId||'');
    const tags  = String(r.tags||'').split(',').map(s=>s.trim()).filter(Boolean).join(', ');
    const attN  = countAttachments('shared', r.id);   // parentType 'shared' を使う

    const attBadge = attN
      ? `<span class="doc-badge" title="添付 ${attN}件" onclick="toggleAttachmentList('shared','${r.id}', this)">??${attN}</span>`
      : '';

    // 状態は任意で：active/archived などがあれば表示、なければ空
    const state = r.status || '';
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>${escapeHtml(r.name||'')}</td>
      <td>${escapeHtml(r.category||'')}</td>
      <td>${escapeHtml(owner)}</td>
      <td>${escapeHtml(tags)}</td>
      <td>${attBadge}</td>
      <td>${escapeHtml(state)}</td>
      <td style="white-space:nowrap;">
        <button class="secondary" data-tip="この項目を編集します" onclick="editShared('${r.id}')">編集</button>
        <button class="secondary" onclick="openAttachmentManager('shared','${r.id}')">??管理</button>
        <button class="secondary" onclick="delShared('${r.id}')">削除</button>
      </td>`;
    tb.appendChild(tr);
  });
}

function renderAttachmentInline(list){
  if(!list.length) return '';
  const icon = (a)=>{
    if (a.type === 'drive' || a.fileId) return '??';
    const u = String(a.url||'').toLowerCase();
    if (/\.(png|jpe?g|gif|webp|svg)$/.test(u)) return '???';
    if (/\.(pdf)$/.test(u)) return '??';
    return '??';
  };
  return list.map(a=>{
    const href = a.url || (a.fileId ? `https://drive.google.com/file/d/${a.fileId}/view` : '#');
    const title = escapeHtml(a.title || a.url || a.fileId || '(無題)');
    return `<div style="margin:4px 0;">
      ${icon(a)} <a href="${escapeHtml(href)}" target="_blank" rel="noopener">${title}</a>
    </div>`;
  }).join('');
}

// 共有資料 追加/更新
function addShared(){
  const editId = el('sh_editing_id')?.value || '';
  const payload = {
    id: editId,
    name: val('sh_name').trim(),
    category: val('sh_category').trim(),
    ownerUserId: sel('sh_owner'),
    tags: val('sh_tags').trim(),
    color: val('sh_color'),
    memoText: val('sh_memo')
  };
  if (!payload.name){ alert('名称は必須です'); return; }

  // サーバの関数名はプロジェクトに合わせてください
  gsr().withSuccessHandler(row => {
    patchRow('shareds', row);
    rerenderAfter('shareds');   // 追加：再描画ディスパッチに対応
    resetSharedForm();
    renderShareds();
    showToast && showToast('ok','共有資料を保存しました');
  }).upsertShared(payload);
}

// 共有資料 編集開始
function editShared(id){
  const r = safeArr(DATA.shareds).find(x=>String(x.id)===String(id));
  if(!r) return;
  el('sh_editing_id').value = r.id || '';
  el('sh_name').value       = r.name || '';
  el('sh_category').value   = r.category || '';
  el('sh_owner').value      = r.ownerUserId || '';
  el('sh_tags').value       = r.tags || '';
  if(el('sh_color')) el('sh_color').value = (r.color && /^#[0-9a-fA-F]{6}$/.test(r.color)) ? r.color : '#ffffff';
  el('sh_memo').value       = r.memoText || '';
}

// 共有資料 削除
function delShared(id){
  if(!confirm('削除してよろしいですか？')) return;
  gsr().withSuccessHandler(()=>{
    dropRow('shareds', id);
    renderShareds();
  }).deleteShared(id);
}

// 共有資料 入力フォーム リセット
function resetSharedForm(){
  if (el('sh_editing_id')) el('sh_editing_id').value = '';
  if (el('sh_name'))       el('sh_name').value = '';
  if (el('sh_category'))   el('sh_category').value = '';
  if (el('sh_owner'))      el('sh_owner').value = '';
  if (el('sh_tags'))       el('sh_tags').value = '';
  if (el('sh_color'))      el('sh_color').value = '#ffffff';
  if (el('sh_memo'))       el('sh_memo').value = '';
}
// --- Click guard (multi-press protection) ---
const InFlight = new Set();
// ---- Click/submit 連打ガード（共通） ----
const __GUARDS__ = new Map();
/**
 * 同じ key の処理が「実行中」または「終了直後のクールダウン中」は弾く。
 * 使い方: return guardRun('addTask', async () => { ... });
 */
async function guardRun(key, fn, cooldownMs = 800) {
  const now = Date.now();
  const g = __GUARDS__.get(key);

  // 実行中 or 直近終了からクールダウン未満 → 2回目以降を捨てる
  if (g && (g.running || (now - (g.endedAt || 0)) < cooldownMs)) return;

  __GUARDS__.set(key, { running: true, startedAt: now, endedAt: 0 });
  try {
    return await fn();
  } finally {
    __GUARDS__.set(key, { running: false, startedAt: g?.startedAt || now, endedAt: Date.now() });
  }
}

/**
 * ボタンも同時に安全にロックしたい場合の糖衣。
 * 例: onclick="guardBtn(this, 'addTask', () => addTask())"
 */
function guardBtn(btn, key, fn, cooldownMs = 800) {
  return guardRun(key, async () => {
    const prevDisabled = btn.disabled;
    btn.disabled = true;
    btn.classList.add('disabled');  // 見た目用（任意）
    try { return await fn(); }
    finally {
      btn.disabled = prevDisabled;
      btn.classList.remove('disabled');
    }
  }, cooldownMs);
}


function confirmDel(label){ return confirm(`本当に${label}を削除しますか？\nこの操作は取り消せません。`); }

function delTask(id){ if(!confirmDel('タスク')) return;
  gsr().withSuccessHandler(()=>{ dropRow('tasks', id); rerenderAfter('tasks'); }).deleteTask(id);
}
function delUser(id){ if(!confirmDel('ユーザー')) return;
  gsr().withSuccessHandler(()=>{ dropRow('users', id); rerenderAfter('users'); }).deleteUser(id);
}
function delMinute(id){ if(!confirmDel('議事録')) return;
  gsr().withSuccessHandler(()=>{ dropRow('minutes', id); rerenderAfter('minutes'); }).deleteMinute(id);
}
function delSub(id){ if(!confirmDel('サブスク項目')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteSubscription(id);
}
function delLedgerPlan(id){ if(!confirmDel('定期入出金')) return;
  gsr().withSuccessHandler(()=>refresh()).deleteLedgerPlan(id);
}
function delCredential(id){ if(!confirmDel('認証情報')) return;
  gsr().withSuccessHandler(()=>{ dropRow('credentials', id); rerenderAfter('credentials'); }).deleteCredential(id);
}
let MEMO_BOUND = false;
function attachDefaultMemoEditors(){
  if (MEMO_BOUND) return; MEMO_BOUND = true;

  const handlerKeydown = (ev)=>{
    const ta = ev.target;
    if (!ta || !ta.classList || !ta.classList.contains('memo-edit')) return;
    if (ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)) {
      ev.preventDefault();
      saveMemoNow(ta);
    }
    if (ev.key === 'Escape') {
      // 直前保存値でリセットしたい場合はここに復元処理を入れる（今回は何もしない）
    }
  };

  const handlerBlur = (ev)=>{
    const ta = ev.target;
    if (!ta || !ta.classList || !ta.classList.contains('memo-edit')) return;
    saveMemoNow(ta);
  };

  document.addEventListener('keydown', handlerKeydown, true);
  document.addEventListener('blur', handlerBlur, true);

  function saveMemoNow(ta){
    const kind = ta.dataset.kind;    // 'task' | 'project'
    const id   = ta.dataset.id;
    const text = ta.value;

    if (!kind || !id) return;

    if (kind === 'task'){
      try{
        rpcRun
          .withSuccessHandler(()=>{
            // クライアント即時反映
            const idx = safeArr(DATA.tasks).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.tasks[idx].memoText = text;
            ta.closest('td')?.classList.add('cell-flash');
            setTimeout(()=>ta.closest('td')?.classList.remove('cell-flash'), 1200);
            showToast('ok','メモを保存しました');
          })
          .withFailureHandler(err=>showToast('ng', (err&&err.message)?err.message:'保存に失敗しました'))
          .saveTaskMemo(id, text);
      }catch(e){ showToast('ng','通信エラー'); }
      return;
    }

    if (kind === 'project'){
      const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
      if (!p) return;
      const patch = Object.assign({}, p, { memoText: text });
      try{
        rpcRun
          .withSuccessHandler(()=>{
            // 即時反映
            const idx = safeArr(DATA.projects).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.projects[idx].memoText = text;
            ta.closest('td')?.classList.add('cell-flash');
            setTimeout(()=>ta.closest('td')?.classList.remove('cell-flash'), 1200);
            showToast('ok','メモを保存しました');
          })
          .withFailureHandler(err=>showToast('ng', (err&&err.message)?err.message:'保存に失敗しました'))
          .upsertProject(patch);
      }catch(e){ showToast('ng','通信エラー'); }
    }
  }
}
function attachDefaultMemoEditors(){
  // 画面内の .memo-edit を拾って、重複配線を防止
  document.querySelectorAll('textarea.memo-edit').forEach(ta=>{
    if(ta.dataset._bound === '1') return;
    ta.dataset._bound = '1';

    let orig = ta.value;
    let timer = null;

    const save = ()=>{
      const id   = ta.dataset.id;
      const kind = (ta.dataset.kind || '').toLowerCase();
      const val  = ta.value;

      if (!id) return;
      if (val === orig) return;

      if (kind === 'task'){
        rpcRun
          .withSuccessHandler(()=>{
            orig = val;
            showToast('ok','メモを保存しました');
            // クライアント側も即反映
            const idx = safeArr(DATA.tasks).findIndex(x=>String(x.id)===String(id));
            if (idx>=0) DATA.tasks[idx].memoText = val;
          })
          .withFailureHandler(err=>{
            showToast('ng', (err && err.message) ? err.message : '保存に失敗しました');
            ta.value = orig; // ロールバック
          })
          .saveTaskMemo(id, val);

      } else if (kind === 'project'){
        const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
        if (!p) return;

        const patch = Object.assign({}, p, { memoText: val });
        rpcRun
          .withSuccessHandler(row=>{
            orig = val;
            showToast('ok','メモを保存しました');
            // 差分適用
            if (row && row.id) { patchRow('projects', row); }
          })
          .withFailureHandler(err=>{
            showToast('ng', (err && err.message) ? err.message : '保存に失敗しました');
            ta.value = orig; // ロールバック
          })
          .upsertProject(patch);
      }
    };

    const debounced = ()=>{
      if (timer) clearTimeout(timer);
      timer = setTimeout(save, 500); // タイプ中はデバウンス
    };

    ta.addEventListener('input', debounced); // 入力中は遅延保存
    ta.addEventListener('change', save);     // フォーム確定
    ta.addEventListener('blur', save);       // フォーカス外れ時に確定
  });
}
// === メモのデフォルトエディタ：自動伸長＆自動保存 ===
function attachDefaultMemoEditors(){
  const areas = document.querySelectorAll('textarea.memo-edit');
  areas.forEach(ta => {
    if (ta.dataset.bound === '1') return;
    ta.dataset.bound = '1';

    const kind = ta.getAttribute('data-kind');   // "task" / "project"
    const id   = ta.getAttribute('data-id') || '';

    // 高さを内容に合わせてフィット
    const fit = () => {
      ta.style.height = 'auto';
      ta.style.height = ta.scrollHeight + 'px';
    };
    fit();
    ta.addEventListener('input', fit);
    ta.addEventListener('focus', fit);

    // 入力の小休止で保存（デバウンス）＋フォーカスアウトで最終保存
    let tmr = null;
    let last = ta.value;

    const commit = () => {
      const val = ta.value;
      if (val === last) return;
      last = val;

      if (kind === 'task') {
        // 即時ローカル反映（体感を軽く）
        const idx = safeArr(DATA.tasks).findIndex(x => String(x.id) === String(id));
        if (idx >= 0) DATA.tasks[idx].memoText = val;

        rpcRun
          .withSuccessHandler(() => { showToast('ok', 'タスクのメモを保存しました'); })
          .withFailureHandler((err) => { showToast('ng', (err && err.message) || '保存に失敗しました'); })
          .saveTaskMemo(id, val);

      } else if (kind === 'project') {
        const p = safeArr(DATA.projects).find(x => String(x.id) === String(id)) || { id };
        const payload = Object.assign({}, p, { memoText: val });

        rpcRun
          .withSuccessHandler((row) => {
            if (row) patchRow('projects', row);
            showToast('ok', 'プロジェクトのメモを保存しました');
          })
          .withFailureHandler((err) => { showToast('ng', (err && err.message) || '保存に失敗しました'); })
          .upsertProject(payload);
      }
    };

    ta.addEventListener('input', () => {
      clearTimeout(tmr);
      tmr = setTimeout(commit, 600);  // 0.6秒無入力で保存
    });
    ta.addEventListener('blur', commit);
  });
}


// ===== フライアウトの開閉・初期化 =====
function openFlyout(kind){
  const mask = document.getElementById('flyout-mask');
  const pane = document.getElementById(kind==='project' ? 'flyout-project' : 'flyout-task');
  if (mask) { mask.style.display='block'; mask.setAttribute('aria-hidden','false'); }
  if (pane) { pane.classList.add('open'); setTimeout(()=>{ pane.querySelector('input,select,textarea')?.focus(); }, 60); }
}
function closeFlyout(kind){
  const mask = document.getElementById('flyout-mask');
  const pane = document.getElementById(kind==='project' ? 'flyout-project' : 'flyout-task');
  if (pane) pane.classList.remove('open');
  if (mask) { mask.style.display='none'; mask.setAttribute('aria-hidden','true'); }
}
document.getElementById('fab-add-project')?.addEventListener('click', ()=>openFlyout('project'));
document.getElementById('fab-add-task')?.addEventListener('click', ()=>openFlyout('task'));
document.getElementById('flyout-mask')?.addEventListener('click', ()=>{ closeFlyout('project'); closeFlyout('task'); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeFlyout('project'); closeFlyout('task'); }});

// ===== フライアウトのセレクトへデータを流し込む =====
function hydrateFlyouts(){
  const users = safeArr(DATA.users), projects = safeArr(DATA.projects).filter(p=>String(p.status||'').toLowerCase()!=='archived');
  // プロジェクト側
  const prParent = document.getElementById('fly_p_parent');
  const prOwner  = document.getElementById('fly_p_owner');
  if (prParent){ prParent.innerHTML=''; prParent.add(new Option('（なし）','')); projects.forEach(p=>prParent.add(new Option(p.name||p.id, p.id))); }
  if (prOwner){  prOwner.innerHTML='';  prOwner.add(new Option('（未選択）','')); users.forEach(u=>prOwner.add(new Option(u.name||u.email||u.id, u.id))); }
  // タスク側
  const tProj = document.getElementById('fly_t_project');
  const tAss  = document.getElementById('fly_t_assignees');
  if (tProj){ tProj.innerHTML=''; tProj.add(new Option('（選択してください）','')); projects.forEach(p=>tProj.add(new Option(p.name||p.id, p.id))); }
  if (tAss){  tAss.innerHTML=''; users.forEach(u=>tAss.add(new Option(u.name||u.email||u.id, u.id))); tAss.size = Math.min(Math.max(users.length, 3), 8); }
}
// 既存の refresh/renderAll の後にも流し込まれるようにフック
(function(orig){
  window.renderAll = function(){ orig && orig(); try{ hydrateFlyouts(); }catch(_){} };
})(window.renderAll);

// ===== 送信：既存の addProject / addTask を再利用 =====
function submitFlyoutProject(){
  // フライアウト値をクイック追加フォームへ転送してから addProject()
  const map = [
    ['fly_p_name','p_name'], ['fly_p_parent','p_parent_select'], ['fly_p_owner','p_owner_select'],
    ['fly_p_prio','p_priority'], ['fly_p_color','p_color'], ['fly_p_budget','p_budget'],
    ['fly_p_start','p_start'], ['fly_p_end','p_end'], ['fly_p_memo','p_memo'],
  ];
  for(const [src,dst] of map){ const s=document.getElementById(src), d=document.getElementById(dst); if(s&&d){ d.value = s.value; } }
  // 新規モードへ（念のため）
  try{ document.getElementById('p_editing_id').value=''; }catch(_){}
  addProject();
  closeFlyout('project');
  showToast('ok','プロジェクトを追加しました');
}
function submitFlyoutTask(){
  // フライアウト値 → クイック追加フォームへ
  const copy = (src,dst)=>{ const s=document.getElementById(src), d=document.getElementById(dst); if(s&&d) d.value = s.value; };
  copy('fly_t_title','t_title');
  copy('fly_t_project','t_project_select');
  copy('fly_t_due','t_due');
  copy('fly_t_prio','t_prio');
  copy('fly_t_type','t_type');
  copy('fly_t_color','t_color');
  copy('fly_t_memo','t_memo');

  // 担当（複数）を転送
  const flyAss = document.getElementById('fly_t_assignees');
  const mainAss = document.getElementById('t_assignees_select');
  if (flyAss && mainAss){
    const vals = Array.from(flyAss.selectedOptions).map(o=>o.value);
    Array.from(mainAss.options).forEach(o => o.selected = vals.includes(o.value));
  }

  // 新規モードで確実に追加
  try{ document.getElementById('t_editing_id').value=''; }catch(_){}
  addTask();
  closeFlyout('task');
  showToast('ok','タスクを追加しました');
}

// ===== 既存UIに軽い説明（ツールチップ）を付与 =====
(function addInlineHints(){
  const hints = [
    ['nav-dashboard',"ここがメインです。進捗・一覧・ガントに切替できます"],
    ['qp-toggle',"左のクイック追加を折りたたみ／展開します"],
    ['tab-list',"タスクを表形式で確認・インライン編集できます"],
    ['tab-board',"ドラッグ＆ドロップで状態を移動できます"],
    ['tab-board',"担当者別スイムレーンはチェックで切替"],
    ['tab-board',"カードの??でDocs、??で添付を開きます"],
    ['tab-list',"右上のCSVでエクスポートできます"],
    ['f_keyword',"タイトル・メモを横断検索"],
    ['f_project',"プロジェクトで絞り込み"],
    ['f_assignee',"担当者で絞り込み"],
    ['f_from',"この日付以降の期限で絞り込み"],
    ['f_to',"この日付以前の期限で絞り込み"],
    ['f_priority',"優先度で絞り込み"],
    ['f_status',"状態（未着手/進行中/…）で絞り込み"],
    ['gantt-scale-mode',"日/週/月のスケールを切替"],
  ];
  for(const [id,tip] of hints){
    const el = document.getElementById(id);
    if (el && !el.hasAttribute('data-tip')) el.setAttribute('data-tip', tip);
  }
})();


/* ========= フライアウト制御 ========= */
const Flyout = (function(){
  const mask = document.getElementById('flyout-mask');
  const panel = document.getElementById('flyout');
  const btnClose = document.getElementById('flyout-close');
  const btnCancel = document.getElementById('flyout-cancel');
  const btnSubmit = document.getElementById('flyout-submit');

  function open(){
    mask?.classList.add('open');
    panel?.classList.add('open');
    document.body.classList.add('flyout-open');
    hydrateQuickForm(); // セレクト等を流し込む
    // 初期フォーカス
    setTimeout(()=> document.getElementById('qx_t_title')?.focus(), 10);
  }
  function close(){
    mask?.classList.remove('open');
    panel?.classList.remove('open');
    document.body.classList.remove('flyout-open');
  }
  function toggle(){ panel?.classList.contains('open') ? close() : open(); }

  // ESC/クリックで閉じる
  mask?.addEventListener('click', close);
  btnClose?.addEventListener('click', close);
  btnCancel?.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && panel?.classList.contains('open')) close(); });

  // 作成ボタン → 既存addTask()を利用
  btnSubmit?.addEventListener('click', submitQuickTask);

  return { open, close, toggle };
})();

// FAB クリックでフライアウト
(function bindFab(){
  const fab = document.getElementById('fab-main');
  if (!fab) return;
  fab.addEventListener('click', ()=> Flyout.toggle());
})();

/* ========= フライアウト内：クイックタスク ========= */
function hydrateQuickForm(){
  // Users / Projects を既存DATAから注入
  const users = safeArr(DATA.users);
  const projs = safeArr(DATA.projects).filter(p => String(p.status||'').toLowerCase()!=='archived');

  const set = (sel, opts, label, value) => {
    sel.innerHTML = '';
    opts.forEach(o => sel.add(new Option(label(o), value(o))));
  };

  const pjSel = document.getElementById('qx_t_project');
  const asSel = document.getElementById('qx_t_assignees');

  if (pjSel) set(pjSel, projs, p => p.name||p.id, p => p.id);
  if (asSel) {
    asSel.innerHTML = '';
    users.forEach(u => asSel.add(new Option(u.name||u.email||u.id, u.id)));
    asSel.size = Math.min(Math.max(users.length, 3), 10);
  }

  // 期限初期値=今日
  const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const today = `${y}-${m}-${dd}`;
  const due = document.getElementById('qx_t_due'); if (due && !due.value) due.value = today;
}

function submitQuickTask(){
  const title = (document.getElementById('qx_t_title')||{}).value?.trim();
  if(!title){ alert('タイトルを入力してください'); document.getElementById('qx_t_title')?.focus(); return; }

  // 既存 addTask() と同じフィールドに写してから addTask 呼び出し
  const to = (id, v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
  to('t_title', title);
  to('t_project_select', (document.getElementById('qx_t_project')||{}).value||'');
  to('t_due', (document.getElementById('qx_t_due')||{}).value||'');
  to('t_prio', (document.getElementById('qx_t_prio')||{}).value||'');
  to('t_memo', (document.getElementById('qx_t_memo')||{}).value||'');
  // 担当（複数）を移す
  const qxAss = Array.from((document.getElementById('qx_t_assignees')||{}).selectedOptions||[]).map(o=>o.value);
  const ms = document.getElementById('t_assignees_select');
  if (ms) Array.from(ms.options).forEach(o => o.selected = qxAss.includes(o.value));

  // 種別/色などはデフォルト利用
  to('t_type','single');
  // 実行
  addTask();
  showToast('ok','タスクを作成しました');
  Flyout.close();
}

// Enterで作成
document.getElementById('flyout')?.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey)) return; // 修飾は無視
  if(e.key==='Enter'){ e.preventDefault(); submitQuickTask(); }
});

// ===== フライアウト制御 =====
function hydrateFlyoutSelects(){
  // 既存DATAから選択肢を流用
  const users = safeArr(DATA.users);
  const projects = safeArr(DATA.projects).filter(p => String(p.status||'').toLowerCase()!=='archived');

  const fill = (el, opts, getLabel, getVal) => {
    if (!el) return;
    while (el.options.length) el.remove(0);
    opts.forEach(o => el.add(new Option(getLabel(o), getVal(o))));
  };

  // task用
  fill(document.getElementById('ft_project'), projects, p => p.name||p.id, p => p.id);
  fill(document.getElementById('ft_owner'), users, u => u.name||u.email||u.id, u => u.id);
  const ass = document.getElementById('ft_assignees');
  if (ass){
    while (ass.options.length) ass.remove(0);
    users.forEach(u => ass.add(new Option(u.name||u.email||u.id, u.id)));
    ass.size = Math.min(Math.max(users.length, 3), 10);
  }
  // project用
  fill(document.getElementById('fp_parent'), projects, p => p.name||p.id, p => p.id);
  fill(document.getElementById('fp_owner'), users, u => u.name||u.email||u.id, u => u.id);
}

function openFlyout(kind){
  hydrateFlyoutSelects();
  document.body.classList.add('flyout-open');
  document.getElementById('flyout-mask')?.classList.add('open');
  const pane = document.getElementById(kind==='task' ? 'flyout-task' : 'flyout-project');
  pane?.classList.add('open');
  pane?.setAttribute('aria-hidden','false');
  // フォーカス初期化
  (kind==='task' ? document.getElementById('ft_title') : document.getElementById('fp_name'))?.focus();
}
function closeFlyout(){
  document.body.classList.remove('flyout-open');
  document.getElementById('flyout-mask')?.classList.remove('open');
  ['flyout-task','flyout-project'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
  });
}
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeFlyout(); });

// ===== 送信（RPCに直接保存） =====
function submitFlyoutTask(){
  const ownerId = sel('ft_owner');
  const assigneesArr = Array.from((document.getElementById('ft_assignees')||{selectedOptions:[]}).selectedOptions).map(o=>o.value);
  if (ownerId && !assigneesArr.includes(ownerId)) assigneesArr.push(ownerId);

  const t = {
    projectId: sel('ft_project'),
    parentTaskId: '',
    type: sel('ft_type') || 'single',
    title: val('ft_title').trim(),
    ownerUserId: ownerId,
    assignees: assigneesArr.join(','),
    dueDate: val('ft_due'),
    status: 'todo',
    priority: val('ft_prio'),
    color: (val('ft_color')||'') === '#ffffff' ? '' : val('ft_color'),
    memoText: val('ft_memo'),
    estimateHours: '',
    actualHours: '',
    rrule: '',
    nextOccurrence: ''
  };
  if(!t.title){ alert('タスク名は必須です'); return; }
  gsr().withSuccessHandler(row => {
    patchRow('tasks', row); rerenderAfter('tasks'); closeFlyout();
  }).upsertTask(t);
}

function submitFlyoutProject(){
  const p = {
    name: val('fp_name').trim(),
    parentProjectId: sel('fp_parent'),
    ownerUserId: sel('fp_owner'),
    priority: val('fp_priority'),
    color: (val('fp_color')||'') === '#ffffff' ? '' : val('fp_color'),
    budget: val('fp_budget'),
    startDate: val('fp_start'),
    endDate: val('fp_end'),
    memoText: val('fp_memo'),
    status: 'active',
    fiscalYear: new Date().getFullYear()
  };
  if(!p.name){ alert('名称は必須です'); return; }
  gsr().withSuccessHandler(row => {
    patchRow('projects', row); rerenderAfter('projects'); closeFlyout();
  }).upsertProject(p);
}
// ======== Center Modal API ========
function openModal(title, html, onOpen){
  const mask = document.getElementById('modal-mask');
  const tt   = document.getElementById('modal-title');
  const ct   = document.getElementById('modal-content');
  if(!mask || !tt || !ct) return alert('Modal host not found');
  tt.textContent = title || '';
  ct.innerHTML = html || '';
  mask.style.display = 'flex';
  document.body.dataset.modalOpen = '1';
  try{
    if (typeof onOpen === 'function') {
      const modalRoot = document.getElementById('modal') || mask;
      onOpen(modalRoot);
    }
  }catch(e){
    console.error(e);
  }
}
function closeModal(){
  const mask = document.getElementById('modal-mask');
  if(mask) mask.style.display = 'none';
  document.body.dataset.modalOpen = '';
}
// 外側クリックで閉じる
document.addEventListener('click', (e)=>{
  const mask = document.getElementById('modal-mask');
  const dlg  = document.getElementById('modal');
  if(!mask || !dlg) return;
  if(mask.style.display !== 'flex') return;
  if(e.target === mask){ closeModal(); }
});
// ESCで閉じる
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && document.body.dataset.modalOpen === '1'){ closeModal(); }
});

// 既存の「右フライアウト」をモーダルへ差し替え（互換フック）
function openFlyoutCompat(title, html){ openModal(title, html); }
async function fetchDocsMarkdown(name){
  const normalized = String(name || '').trim().toUpperCase();
  const fileName = normalized === 'BEGINNER' ? 'BEGINNER.md'
    : (normalized === 'USER_GUIDE' || normalized === 'USERGUIDE' || normalized === 'USER-GUIDE') ? 'USER_GUIDE.md'
    : normalized === 'SPEC' ? 'SPEC.md'
    : '';
  if (!fileName) throw new Error('Invalid or missing name');

  // Prefer static docs to avoid server cwd/path differences.
  try{
    const url = '/docs/' + encodeURIComponent(fileName);
    const resp = await fetch(url, { method:'GET' });
    if (resp.ok) {
      // Docs may be Shift_JIS; pick the decode with fewer replacement chars.
      try{
        const buf = await resp.arrayBuffer();
        const countReplacement = (s)=>{
          try { return (String(s||'').match(/\uFFFD|\?/g) || []).length; } catch(_){ return 0; }
        };
        const tryDecode = (enc)=>{
          try { return new TextDecoder(enc).decode(buf); } catch(_){ return null; }
        };
        const utf8 = tryDecode('utf-8');
        const sjis = tryDecode('shift_jis');
        const utf8Score = utf8 == null ? 1e9 : countReplacement(utf8);
        const sjisScore = sjis == null ? 1e9 : countReplacement(sjis);
        if (sjis != null && sjisScore <= utf8Score) return sjis;
        if (utf8 != null) return utf8;
        return await resp.text();
      }catch(_){
        return await resp.text();
      }
    }
  }catch(_){ }

  // Backward-compatible fallback.
  const apiUrl = '/api/docs?name=' + encodeURIComponent(normalized);
  const resp = await fetch(apiUrl, { method:'GET' });
  const raw = await resp.text().catch(()=> '');
  let data = null;
  try { data = raw ? JSON.parse(raw) : null; } catch { data = null; }
  if (!resp.ok || !data || data.ok !== true) {
    const msg = (data && data.error) ? data.error : (raw || ('HTTP '+resp.status));
    throw new Error(msg);
  }
  return String(data.markdown || '');
}

function mdToHtml(md){
  try{
    if (window.marked && typeof window.marked.parse === 'function') {
      return window.marked.parse(String(md||''), { gfm:true, breaks:true });
    }
  }catch(_){ }
  return '<pre>' + escapeHtml(String(md||'')) + '</pre>';
}

function renderMermaidIn(container){
  try{
    if (!window.mermaid) return;
    try { window.mermaid.initialize({ startOnLoad:false }); } catch(_){ }

    // Convert fenced ```mermaid blocks (marked emits code.language-mermaid)
    const codes = container.querySelectorAll('pre > code.language-mermaid, pre > code.mermaid');
    codes.forEach(code => {
      const pre = code.parentElement;
      if (!pre) return;
      const div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = code.textContent || '';
      pre.replaceWith(div);
    });

    // Render
    const nodes = container.querySelectorAll('.mermaid');
    if (nodes && nodes.length) {
      window.mermaid.run({ nodes });
    }
  }catch(e){
    console.error(e);
  }
}

async function loadUsageDocsInto(modalRoot, name){
  const host = modalRoot.querySelector('#usage-docs-host');
  if (!host) return;
  host.innerHTML = '<div class="muted">読み込み中...</div>';
  try{
    const md = await fetchDocsMarkdown(name);
    host.innerHTML = '<div class="md-docs">' + mdToHtml(md) + '</div>';
    renderMermaidIn(host);
    // ensure top scroll
    try { host.scrollTop = 0; } catch(_){ }
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    host.innerHTML = '<div class="muted">表示に失敗しました: ' + escapeHtml(msg) + '</div>';
  }
}

function openUsageGuide(initial){
  const first = (String(initial||'').toUpperCase()==='USER_GUIDE') ? 'USER_GUIDE' : 'BEGINNER';
  const body = `
    <div class="md-docs-nav">
      <button id="btn-usage-beginner" class="secondary">初使用者向け（BEGINNER）</button>
      <button id="btn-usage-user" class="secondary">使用者向け（USER_GUIDE）</button>
      <button id="btn-usage-spec" class="secondary">仕様書（SPEC）</button>
    </div>
    <div id="usage-docs-host" style="max-height:65vh; overflow:auto;"></div>
  `;
  openModal('使い方', body, (modalRoot)=>{
    const b0 = modalRoot.querySelector('#btn-usage-beginner');
    const b1 = modalRoot.querySelector('#btn-usage-user');
    const b2 = modalRoot.querySelector('#btn-usage-spec');
    function setActive(name){
      if (b0) b0.classList.toggle('active', name==='BEGINNER');
      if (b1) b1.classList.toggle('active', name==='USER_GUIDE');
      if (b2) b2.classList.toggle('active', name==='SPEC');
    }
    if (b0) b0.addEventListener('click', ()=>{ setActive('BEGINNER'); loadUsageDocsInto(modalRoot, 'BEGINNER'); });
    if (b1) b1.addEventListener('click', ()=>{ setActive('USER_GUIDE'); loadUsageDocsInto(modalRoot, 'USER_GUIDE'); });
    if (b2) b2.addEventListener('click', ()=>{ setActive('SPEC'); loadUsageDocsInto(modalRoot, 'SPEC'); });
    setActive(first);
    loadUsageDocsInto(modalRoot, first);
  });
}

let UPDATES_MODAL_BOUND = false;
let UPDATES_ESC_BOUND = false;
function bindUpdatesModalClose(){
  const modal = el('updates-modal');
  if (!modal || UPDATES_MODAL_BOUND) return;
  modal.addEventListener('click', (e)=>{
    if (e.target === modal) closeUpdatesModal();
  });
  UPDATES_MODAL_BOUND = true;
}
function bindUpdatesEscClose(){
  if (UPDATES_ESC_BOUND) return;
  document.addEventListener('keydown', (e)=>{
    if (e.key !== 'Escape') return;
    const modal = el('updates-modal');
    if (modal && modal.style.display === 'flex') closeUpdatesModal();
  });
  UPDATES_ESC_BOUND = true;
}

async function openUpdatesModal(){
  const modal = el('updates-modal');
  const body = el('updates-body');
  if (body) body.innerHTML = '<div class="muted">読み込み中...</div>';
  if (modal) modal.style.display = 'flex';
  bindUpdatesModalClose();
  bindUpdatesEscClose();
  try{
    const resp = await fetch('/update.md');
    if (!resp.ok) throw new Error('update.md を取得できませんでした');
    const md = await resp.text();
    if (body) {
      body.innerHTML = '<div class="md-docs">' + mdToHtml(md) + '</div>';
      renderMermaidIn(body);
    }
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    if (body) body.innerHTML = '<div class="muted">表示に失敗しました: ' + escapeHtml(msg) + '</div>';
  }
}
function closeUpdatesModal(){
  const modal = el('updates-modal');
  if (modal) modal.style.display = 'none';
}
// 現在のクイック追加の入力欄をそのまま使い、モーダルに「複製」して表示する。
// 保存時は既存の addProject / addTask をそのまま呼ぶ。
function openProjectFormModal(){
  

  const html = `
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h3 class="modal-title" style="margin:0;">プロジェクトを追加</h3>
      <ul>
        <li>プロジェクトを新規に追加します。</li>
        <li>※添付URLは項目作成後一覧もしくは編集ボタンより追加可能です</li>
        <li>プロジェクト毎にGoodleドキュメントが自動で作成されます</li>
      </ul>
      <button class="secondary" onclick="openUsageGuide()">使い方</button>
    </div>

    <div class="row">
      <div><label>プロジェクト名(必須)</label><input id="mp_name" value="${escapeHtml(val('p_name'))}"/></div>
      <div><label data-tip="このプロジェクトがほかのプロジェクトの下位プロジェクトである場合入力します" >親プロジェクト(任意)</label>${document.getElementById('p_parent_select').outerHTML.replace('p_parent_select','mp_parent_select')}</div>
    </div>
    <div class="row">
      <div><label>主担当者（Users）(必須)</label>${document.getElementById('p_owner_select').outerHTML.replace('p_owner_select','mp_owner_select')}</div>
      <div><label>優先度(必須)</label>${document.getElementById('p_priority').outerHTML.replace('p_priority','mp_priority')}</div>
    </div>
    <div class="row">
      <div><label>カラー(任意)</label><input id="mp_color" data-tip="タスクに色を指定すると、一覧中でタスクが見つけやすくなります。" type="color" value="${escapeHtml(val('p_color'))||'#ffffff'}"/></div>
      <div><label>予算（円）(任意)</label><input id="mp_budget" type="number" value="${escapeHtml(val('p_budget'))}"/></div>
    </div>
    <div class="row">
      <div><label>開始日(任意)</label><input id="mp_start" type="date" value="${escapeHtml(val('p_start'))}"/></div>
      <div><label>終了日(任意)</label><input id="mp_end" type="date" value="${escapeHtml(val('p_end'))}"/></div>
    </div>
    <div><label>メモ(任意)</label><textarea id="mp_memo">${escapeHtml(val('p_memo'))}</textarea></div>

    <div class="toolbar" style="justify-content:flex-end; gap:8px;">
      
      <button data-tip="この内容でタスクを登録します" onclick="(function(){
        // モーダル→実体フォームへ値を戻す
        el('p_name').value = val('mp_name');
        el('p_parent_select').value = sel('mp_parent_select');
        el('p_owner_select').value = sel('mp_owner_select');
        el('p_priority').value = val('mp_priority');
        el('p_color').value = val('mp_color');
        el('p_budget').value = val('mp_budget');
        el('p_start').value = val('mp_start');
        el('p_end').value = val('mp_end');
        el('p_memo').value = val('mp_memo');
        closeModal();
        addProject();
      })()">保存して追加</button>
    </div>
  `;
  openModal('プロジェクトを追加', html);
}

function openTaskFormModal(){
  // フェイルセーフ呼び出しヘルパー
  

  // 担当者の複数選択は簡易入力に寄せる（保存時に既存UIへ反映）
  const assigneeSel = document.getElementById('t_assignees_select');
  const assigneeHtml = assigneeSel ? assigneeSel.outerHTML.replace('t_assignees_select','mt_assignees_select') : '';

  const html = `
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h3 class="modal-title" style="margin:0;">タスクを追加</h3>
      <ul>
        <li>タスクを新規に追加します。</li>
        <li>※添付URLは項目作成後一覧もしくは編集ボタンより追加可能です</li>
        <li>※タスク毎にGoodleドキュメントが自動で作成されます</li>
      </ul>
      <button class="secondary" onclick="openUsageGuide()">使い方</button>
    </div>

    <div class="row">
      <div><label>タスク名(必須)</label><input data-tip="このタスクの識別名です。"  id="mt_title" value="${escapeHtml(val('t_title'))}"/></div>
      <div><label data-tip="このタスクが所属するプロジェクトを指定します。親となるプロジェクトがない場合、先に作成してください。">プロジェクト(必須)</label>${document.getElementById('t_project_select').outerHTML.replace('t_project_select','mt_project_select')}</div>
    </div>
    <div class="row">
      <div><label>種別(任意)</label>${document.getElementById('t_type').outerHTML.replace('t_type','mt_type')}</div>
      <div><label>期限(任意)</label><input id="mt_due" type="date" value="${escapeHtml(val('t_due'))}"/></div>
    </div>
    <div class="row">
      <div><label>主担当者（Users）(必須)</label>${document.getElementById('t_owner_select').outerHTML.replace('t_owner_select','mt_owner_select')}</div>
      <div><label data-tip="このタスクに実際に関わるメンバーをすべて選択します。ctrl+クリックで複数人指定可能です。主担当者は自動で担当に含めます。">担当者（複数選択可）(任意)</label>${assigneeHtml}</div>
    </div>
    <div class="row">
      <div><label>優先度(必須)</label>${document.getElementById('t_prio').outerHTML.replace('t_prio','mt_prio')}</div>
      <div><label>カラー(任意)</label><input id="mt_color" data-tip="タスクに色を指定すると、一覧中でタスクが見つけやすくなります。" type="color" value="${escapeHtml(val('t_color'))||'#ffffff'}"/></div>
    </div>
    <div><label>メモ(任意)</label><textarea id="mt_memo">${escapeHtml(val('t_memo'))}</textarea></div>

    <div class="toolbar" style="justify-content:flex-end; gap:8px;">
      
      <button data-tip="この内容でタスクを登録します" onclick="(function(){
        el('t_title').value = val('mt_title');
        el('t_project_select').value = sel('mt_project_select');
        el('t_type').value = sel('mt_type');
        el('t_due').value = val('mt_due');
        el('t_owner_select').value = sel('mt_owner_select');
        // 担当者 複数
        const src = document.getElementById('mt_assignees_select');
        const dst = document.getElementById('t_assignees_select');
        if(src && dst){
          Array.from(dst.options).forEach(o => o.selected = false);
          Array.from(src.selectedOptions).forEach(o => {
            const hit = Array.from(dst.options).find(x => x.value === o.value);
            if(hit) hit.selected = true;
          });
        }
        el('t_prio').value = sel('mt_prio');
        el('t_color').value = val('mt_color');
        el('t_memo').value = val('mt_memo');
        closeModal();
        addTask();
      })()">保存して追加</button>
    </div>
  `;
  openModal('タスクを追加', html);
}
// ===== モーダル汎用ヘルパ =====
function openModal(title, bodyHtml, onMount){
  const mask = document.getElementById('modal-mask');
  const modal = document.getElementById('modal');
  if(!mask || !modal){ alert('モーダルDOMが見つかりません'); return; }
  modal.innerHTML = `
    <header>
      <strong>${escapeHtml(title||'')}</strong>
      <button class="close" onclick="closeModal()">?</button>
    </header>
    <div class="content">${bodyHtml||''}</div>
  `;
  mask.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  try{ onMount && onMount(modal); }catch(_){}
}
function closeModal(){
  const mask = document.getElementById('modal-mask');
  if(mask) mask.style.display = 'none';
  document.body.style.overflow = '';
}
// ===== 編集モーダル（プロジェクト） =====
function showProjectModal(id){
  const p = safeArr(DATA.projects).find(x=>String(x.id)===String(id));
  if(!p){ alert('対象のプロジェクトが見つかりません'); return; }

  const projOpts = (safeArr(DATA.projects).map(q =>
    `<option value="${escapeHtml(q.id)}" ${String(q.id)===String(p.parentProjectId)?'selected':''}>${escapeHtml(q.name||q.id)}</option>`
  ).join(''));
  const userOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${String(u.id)===String(p.ownerUserId)?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const prio = (v)=> (String(v).trim()==='高'?'高':String(v).trim()==='中'?'中':String(v).trim()==='低'?'低':'');
  const body = `
    <div class="row">
      <div><label>名称</label><input id="pm_name" value="${escapeHtml(p.name||'')}"/></div>
      <div><label>親プロジェクト</label><select id="pm_parent"><option value="">（なし）</option>${projOpts}</select></div>
    </div>
    <div class="row">
      <div><label>主担当者</label><select id="pm_owner"><option value="">（未選択）</option>${userOpts}</select></div>
      <div><label>優先度</label>
        <select id="pm_prio">
          <option value="">-</option>
          <option ${prio(p.priority)==='高'?'selected':''}>高</option>
          <option ${prio(p.priority)==='中'?'selected':''}>中</option>
          <option ${prio(p.priority)==='低'?'selected':''}>低</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label>カラー</label><input id="pm_color" type="color" value="${/^#[0-9a-fA-F]{6}$/.test(p.color||'')?escapeHtml(p.color):'#ffffff'}"/></div>
      <div><label>予算（円）</label><input id="pm_budget" type="number" value="${escapeHtml(String(p.budget||''))}"/></div>
    </div>
    <div class="row">
      <div><label>開始日</label><input id="pm_start" type="date" value="${escapeHtml(p.startDate||'')}"/></div>
      <div><label>終了日</label><input id="pm_end" type="date" value="${escapeHtml(p.endDate||'')}"/></div>
    </div>
    <div class="row">
      <div>
        <label>メモ</label>
        <textarea id="pm_memo" style="min-height:120px;">${escapeHtml(p.memoText||'')}</textarea>
      </div>
      <div>
        <label>添付</label>
        <div class="toolbar">
          <button class="secondary" onclick="openAttachDialogFor('project','${escapeHtml(p.id)}')">📎添付を追加</button>
          <button class="secondary" onclick="openAttachmentManager('project','${escapeHtml(p.id)}')">添付一覧</button>
        </div>
        <div class="muted"></div>
      </div>
    </div>
    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button class="secondary" onclick="closeModal()">キャンセル</button>
      <button onclick="saveProjectFromModal('${escapeHtml(p.id)}')">更新</button>
    </div>
  `;

  openModal('プロジェクトを編集', body);
}

function saveProjectFromModal(id){
  const payload = {
    id,
    name: val('pm_name').trim(),
    parentProjectId: sel('pm_parent'),
    ownerUserId: sel('pm_owner'),
    priority: val('pm_prio'),
    color: val('pm_color'),
    budget: val('pm_budget'),
    startDate: val('pm_start'),
    endDate: val('pm_end'),
    memoText: val('pm_memo'),
    status: 'active'
  };
  gsr().withSuccessHandler(row=>{
    patchRow('projects', row);
    rerenderAfter('projects');
    closeModal();
    showToast('ok','更新しました');
  }).upsertProject(payload);
}


// ===== 編集モーダル（タスク） =====
function showTaskModal(id){
  const t = safeArr(DATA.tasks).find(x=>String(x.id)===String(id));
  if(!t){ alert('対象のタスクが見つかりません'); return; }

  const projOpts = (safeArr(DATA.projects).filter(p=>String(p.status||'').toLowerCase()!=='archived').map(p =>
    `<option value="${escapeHtml(p.id)}" ${String(p.id)===String(t.projectId)?'selected':''}>${escapeHtml(p.name||p.id)}</option>`
  ).join(''));
  const userOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${String(u.id)===String(t.ownerUserId)?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const assSet = new Set(String(t.assignees||'').split(',').map(s=>s.trim()).filter(Boolean));
  const assOpts = (safeArr(DATA.users).map(u =>
    `<option value="${escapeHtml(u.id)}" ${assSet.has(String(u.id))?'selected':''}>${escapeHtml(u.name||u.email||u.id)}</option>`
  ).join(''));
  const prio = (v)=> (String(v).trim()==='高'?'高':String(v).trim()==='中'?'中':String(v).trim()==='低'?'低':'');
  const body = `
    <div class="row">
      <div><label>タイトル</label><input id="tm_title" value="${escapeHtml(t.title||'')}"/></div>
      <div><label>プロジェクト</label><select id="tm_project"><option value="">（未選択）</option>${projOpts}</select></div>
    </div>
    <div class="row">
      <div><label>種別</label>
        <select id="tm_type">
          <option value="single" ${String(t.type||'single')==='single'?'selected':''}>単発</option>
          <option value="recurring" ${String(t.type)==='recurring'?'selected':''}>定期</option>
        </select>
      </div>
      <div><label>期限</label><input id="tm_due" type="date" value="${escapeHtml(t.dueDate||'')}"/></div>
    </div>
    <div class="row">
      <div><label>主担当者</label><select id="tm_owner"><option value="">（未選択）</option>${userOpts}</select></div>
      <div>
        <label>担当者（複数可）</label>
        <select id="tm_assignees" multiple size="6" style="min-height:110px;">${assOpts}</select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>優先度</label>
        <select id="tm_prio">
          <option value="">-</option>
          <option ${prio(t.priority)==='高'?'selected':''}>高</option>
          <option ${prio(t.priority)==='中'?'selected':''}>中</option>
          <option ${prio(t.priority)==='低'?'selected':''}>低</option>
        </select>
      </div>
      <div>
        <label>カラー</label>
        <input id="tm_color" type="color" value="${/^#[0-9a-fA-F]{6}$/.test(t.color||'')?escapeHtml(t.color):'#ffffff'}"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>タスクメモ</label>
        <textarea id="tm_memo" style="min-height:120px;">${escapeHtml(t.memoText||'')}</textarea>
      </div>
      <div>
        <label>添付</label>
        <div class="toolbar">
          <button class="secondary" onclick="openAttachDialogFor('task','${escapeHtml(t.id)}')">📎添付を追加</button>
          <button class="secondary" onclick="openAttachmentManager('task','${escapeHtml(t.id)}')">添付一覧</button>
        </div>
        <div class="muted"></div>
      </div>
    </div>
    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button class="secondary" onclick="closeModal()">キャンセル</button>
      <button onclick="saveTaskFromModal('${escapeHtml(t.id)}')">更新</button>
    </div>
  `;
  openModal('タスクを編集', body);
}

function saveTaskFromModal(id){
  const ass = Array.from(document.querySelectorAll('#tm_assignees option:checked')).map(o=>o.value);
  const ownerUserId = sel('tm_owner');
  const payload = {
    id,
    projectId: sel('tm_project'),
    parentTaskId: '',
    type: sel('tm_type')||'single',
    title: val('tm_title').trim(),
    ownerUserId,
    assignees: orderedAssigneeIds(ownerUserId, ass).join(','),
    dueDate: val('tm_due'),
    status: (safeArr(DATA.tasks).find(x=>String(x.id)===String(id))?.status)||'todo',
    priority: val('tm_prio'),
    color: val('tm_color'),
    memoText: val('tm_memo')
  };
  gsr().withSuccessHandler(row=>{
    patchRow('tasks', row);
    rerenderAfter('tasks');
    closeModal();
    showToast('ok','更新しました');
  }).upsertTask(payload);
}
// 置換後：一覧の「編集」ボタンはモーダルを開く
function editProject(id){ showProjectModal(id); }
function editTask(id){ showTaskModal(id); }
function openAppUsageGuide() {
  // Vercel/static版は、docs/*.md を表示する（Mermaid対応）
  try { openUsageGuide('BEGINNER'); } catch(_){ }
  }
(() => {
  const OFFSET_X = 12;   // マウスから右へ
  const OFFSET_Y = 12;   // マウスから“上へ” (上に出すので使用時は引き算)
  let bubble = null;
  let moveHandler = null;

  function createBubble(text){
    const el = document.createElement('div');
    el.className = 'tooltip-bubble';
    el.textContent = text || '';
    document.body.appendChild(el);
    return el;
  }

  function positionBubble(e){
    if(!bubble) return;
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    // まず “右上” に出す（＝カーソルより上・右）
    let left = e.clientX + OFFSET_X;
    let top  = e.clientY - (bubble.offsetHeight + OFFSET_Y);

    // 画面上端に食い込むなら“下側”に出す
    if (top < 8) {
      top = e.clientY + OFFSET_Y;
      bubble.classList.add('below');
    } else {
      bubble.classList.remove('below');
    }

    // 右端に食い込むなら左側にフリップ
    const width = bubble.offsetWidth;
    if (left + width > vw - 8) {
      left = e.clientX - width - OFFSET_X;
      bubble.classList.add('left');
    } else {
      bubble.classList.remove('left');
    }

    // 左端の最終保護
    if (left < 8) left = 8;
    // 下端の最終保護
    if (top + bubble.offsetHeight > vh - 8) top = vh - bubble.offsetHeight - 8;

    bubble.style.left = left + 'px';
    bubble.style.top  = top + 'px';
  }

  function onEnter(e){
    if (!TOOLTIPS_ENABLED) return;
    const target = closestSafe(e.target,'[data-tip]');
    if(!target) return;
    const text = target.getAttribute('data-tip');
    if(!text) return;

    bubble = createBubble(text);
    moveHandler = (ev) => positionBubble(ev);
    // すぐ1回座標を反映
    positionBubble(e);

    target.addEventListener('pointermove', moveHandler);
    target.addEventListener('pointerleave', onLeave, { once: true });
    target.addEventListener('pointerdown',  onLeave, { once: true });
  }

  function onLeave(e){
    const target = e.currentTarget || e.target;
    if (moveHandler) target.removeEventListener('pointermove', moveHandler);
    moveHandler = null;
    if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble);
    bubble = null;
  }

  // デリゲーションで data-tip 全体に適用
  document.addEventListener('pointerenter', onEnter, true);
})();

// どんな target が来ても安全に closest を使うヘルパー
function closestSafe(target, selector){
  if (!target) return null;
  // target が要素でなければ親の要素を起点にする（Text ノードなどの対策）
  let el = (target.nodeType === 1) ? target : target.parentElement;
  if (!el) return null;
  return el.closest ? el.closest(selector) : null; // 念のため古い環境も考慮
}

</script>



<!-- ===== フライアウト：プロジェクト追加 ===== -->
<div id="flyout-mask" class="flyout-mask" tabindex="-1" aria-hidden="true"></div>

<aside id="flyout-project" class="flyout" role="dialog" aria-modal="true" aria-labelledby="fly-prj-title">
  <header>
    <h3 id="fly-prj-title" style="margin:0;font-size:16px;">プロジェクトを追加</h3>
    <button class="secondary" onclick="closeFlyout('project')" aria-label="閉じる">?</button>
  </header>
  <div class="content">
    <div class="row">
      <div>
        <label>プロジェクト名 <span class="pill">必須</span></label>
        <input id="fly_p_name" placeholder="例: 2025上期 新製品A"/>
        <div class="hint">名称は後から変更できます</div>
      </div>
      <div>
        <label>親プロジェクト（任意）</label>
        <select id="fly_p_parent"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>主担当者</label>
        <select id="fly_p_owner"></select>
      </div>
      <div>
        <label>優先度</label>
        <select id="fly_p_prio"><option value="">-</option><option>高</option><option>中</option><option>低</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>カラー</label><input id="fly_p_color" type="color" value="#ffffff"/></div>
      <div><label>予算（円）</label><input id="fly_p_budget" type="number" min="0"/></div>
    </div>
    <div class="row">
      <div><label>開始日</label><input id="fly_p_start" type="date"/></div>
      <div><label>終了日</label><input id="fly_p_end" type="date"/></div>
    </div>
    <label>メモ</label>
    <textarea id="fly_p_memo" placeholder="目的や背景など"></textarea>
  </div>
  <div class="actions">
    <button class="secondary" onclick="closeFlyout('project')">キャンセル</button>
    <button onclick="submitFlyoutProject()">作成</button>
  </div>
</aside>

<!-- ===== フライアウト：タスク追加 ===== -->
<aside id="flyout-task" class="flyout" role="dialog" aria-modal="true" aria-labelledby="fly-task-title">
  <header>
    <h3 id="fly-task-title" style="margin:0;font-size:16px;">タスクを追加</h3>
    <button class="secondary" onclick="closeFlyout('task')" aria-label="閉じる">?</button>
  </header>
  <div class="content">
    <div class="row">
      <div>
        <label>タスク名 <span class="pill">必須</span></label>
        <input id="fly_t_title" placeholder="例: 取説ドラフト"/>
      </div>
      <div>
        <label>プロジェクト</label>
        <select id="fly_t_project"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>担当者（複数可）</label>
        <select id="fly_t_assignees" multiple size="4"></select>
        <div class="hint">主担当者は自動で担当に含めます</div>
      </div>
      <div>
        <label>期限</label>
        <input id="fly_t_due" type="date"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>優先度</label>
        <select id="fly_t_prio"><option value="">-</option><option>高</option><option>中</option><option>低</option></select>
      </div>
      <div>
        <label>種別</label>
        <select id="fly_t_type"><option value="single">単発</option><option value="recurring">定期</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>カラー</label><input id="fly_t_color" type="color" value="#ffffff"/></div>
      <div></div>
    </div>
    <label>メモ</label>
    <textarea id="fly_t_memo" placeholder="詳細や注意点"></textarea>
  </div>
  <div class="actions">
    <button class="secondary" onclick="closeFlyout('task')">キャンセル</button>
    <button onclick="submitFlyoutTask()">作成</button>
  </div>
</aside>
<!-- ▼ フローティングアクション（FAB） -->
<div id="fab-stack" aria-live="polite">
  <button id="fab-main" class="fab-btn tooltip-host"
          data-tip="プロジェクト／タスクのクイック操作を開きます\nEscで閉じる・右上×でも閉じます"
          data-tip-pos="left">
    ＋ クイック操作
  </button>
  <!-- 予備：将来の拡張用に小ボタンを並べたい場合
  <button class="fab-btn secondary tooltip-host"
          data-tip="今日の遅延タスクをハイライト" data-tip-pos="left"
          onclick="quickOverdue()">? 遅延フィルタ</button>
  -->
</div>

<!-- ▼ フライアウト（右スライド） -->
<div id="flyout-mask" class="flyout-mask" tabindex="-1" aria-hidden="true"></div>
<aside id="flyout" class="flyout" role="dialog" aria-modal="true" aria-labelledby="flyout-title">
  <header>
    <strong id="flyout-title">クイック操作</strong>
    <div style="display:flex; gap:6px; align-items:center;">
      <span class="muted tooltip-host" data-tip="ヒント:\nEnterで実行／Escで閉じる" data-tip-pos="bottom">？</span>
      <button id="flyout-close" class="secondary mini" aria-label="フライアウトを閉じる">?</button>
    </div>
  </header>
  <div class="content">
    <!-- 初期内容（必要なら自由に差し替え） -->
    <div class="row">
      <div class="card see-through">
        <h2 style="padding:0 0 8px 0;">タスクをすばやく作成</h2>
        <div class="body">
          <div class="row">
            <div><label>タイトル</label><input id="qx_t_title" placeholder="例: 仕様レビュー"/></div>
            <div><label>プロジェクト</label><select id="qx_t_project"></select></div>
          </div>
          <div class="row">
            <div><label>期限</label><input id="qx_t_due" type="date"/></div>
            <div><label>優先度</label>
              <select id="qx_t_prio">
                <option value="">-</option><option>高</option><option>中</option><option>低</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>担当（複数可）</label><select id="qx_t_assignees" multiple size="3"></select></div>
            <div><label>メモ</label><textarea id="qx_t_memo" placeholder="要点だけでOK"></textarea></div>
          </div>
        </div>
      </div>
      <div class="card see-through">
        <h2 style="padding:0 0 8px 0;">ショートカット</h2>
        <div class="body">
          <div class="toolbar">
            <button class="secondary tooltip-host" data-tip="今日以前が期限で未完了のタスクを抽出">? 遅延だけ</button>
            <button class="secondary tooltip-host" data-tip="カンバンに切替" onclick="gotoDashboardTab('board')">?? カンバン</button>
            <button class="secondary tooltip-host" data-tip="ガントに切替" onclick="gotoDashboardTab('gantt')">?? ガント</button>
          </div>
          <p class="hint">ヒント: Enterで「タスク作成」を実行できます。</p>
        </div>
      </div>
    </div>
  </div>
  <div class="actions">
    <button class="secondary" id="flyout-cancel">キャンセル(Esc)</button>
    <button id="flyout-submit">タスク作成</button>
  </div>
</aside>

<!-- ===== 右下フローティングボタン ===== -->
<div id="fab-stack" aria-live="polite" >
  <button class="fab-btn" id="btn_add_project" onclick="openProjectFormModal()" data-tip="新しいプロジェクトを右側のフライアウトから素早く作成します">
    ➕️ プロジェクト追加
  </button>
  <button class="fab-btn" id="btn_add_task" onclick="openTaskFormModal()" data-tip="選択したプロジェクトにタスクを追加します">
    ☑ タスク追加
  </button>
</div>
<div id="flyout-mask" class="flyout-mask" onclick="closeFlyout()"></div>

<!-- ▲▲▲ 追加ここまで ▲▲▲ -->
<!-- Center Modal -->
<div id="modal-mask" aria-hidden="true">
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header>
      <strong id="modal-title">タイトル</strong>
      <button class="close" aria-label="閉じる" onclick="closeModal()">?</button>
    </header>
    <div class="content" id="modal-content"></div>
  </div>
</div>


<!-- 添付管理モーダル -->
<div class="modal-backdrop" id="att-modal">
  <div class="modal-panel">
    <h3 id="att-modal-title">添付管理</h3>
    <div id="att-modal-list"></div>
    <div class="att-modal-row" style="margin-top:10px;">
      <input id="att-new-title" placeholder="名称（例: 設計資料）"/>
      <input id="att-new-url" placeholder="URL (https://... または Drive URL)"/>
      <button class="secondary" onclick="addAttachmentRow()">追加</button>
    </div>
    <div class="modal-actions">
      <button class="secondary" onclick="closeAttachmentModal()">キャンセル</button>
      <button class="primary" onclick="saveAttachmentModal()">保存</button>
    </div>
  </div>
</div>

<!-- アップデート表示モーダル -->
<div class="modal-backdrop" id="updates-modal">
  <div class="modal-panel">
    <h3>アップデート情報</h3>
    <div id="updates-body"></div>
    <div class="modal-actions">
      <button class="secondary" onclick="closeUpdatesModal()">閉じる</button>
    </div>
  </div>
</div>

<div id="menu-bar-bottom"></div>

</body>

</html>



